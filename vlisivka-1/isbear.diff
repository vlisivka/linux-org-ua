echo "1;" > Members/rangel.wlog
has changed regexes for color, size and font YaBBC tags in YaBBC.pl to deny extra text insertion.
has inserted "require $boardsdir/forum.master" into Admin.pl/AdminBoardRecount to get it working


Сбт Вер 29 13:09:03 EEST 2007
All users achieve new rlogs, generated from scratch by hand-made script.
Applied next patch to use those rlogs instead of wlogs
diff -u Sources.orig/Post.pl Sources/Post.pl
--- Sources.orig/Post.pl	2007-09-29 11:44:10.000000000 +0300
+++ Sources/Post.pl	2007-09-29 12:07:38.000000000 +0300
@@ -1852,14 +1852,15 @@
 		$recent{$thread} = 0;
 	}
 
-	fopen(WLOG, ">$memberdir/$username.wlog",1);
-	print WLOG "\$recentloaded = 1\;\n";
-	while(my($key, $val) = each(%recent)){
-		if($key == $thread) {$val++;}
-		print WLOG qq~\$recent{\'$key\'} \= $val;\n~;
-	}
-	print WLOG "\n1;";
-	fclose(WLOG);
+	&Recent_Save ($username);
+#	fopen(WLOG, ">$memberdir/$username.wlog",1);
+#	print WLOG "\$recentloaded = 1\;\n";
+#	while(my($key, $val) = each(%recent)){
+#		if($key == $thread) {$val++;}
+#		print WLOG qq~\$recent{\'$key\'} \= $val;\n~;
+#	}
+#	print WLOG "\n1;";
+#	fclose(WLOG);
 }
 
 1;
diff -u Sources.orig/Subs.pl Sources/Subs.pl
--- Sources.orig/Subs.pl	2007-09-29 11:44:10.000000000 +0300
+++ Sources/Subs.pl	2007-09-29 12:12:25.000000000 +0300
@@ -1430,12 +1430,28 @@
 
 sub Recent_Load {
 	my $who_to_load = $_[0];
-	my $needwrite=0;
-	if(-e "$memberdir/$who_to_load.wlog") {
-		unless ($recentloaded){ require "$memberdir/$who_to_load.wlog"; }
+#	my $needwrite=0;
+#	if(-e "$memberdir/$who_to_load.wlog") {
+#		unless ($recentloaded){ require "$memberdir/$who_to_load.wlog"; }
+#	}
+	if (-e "$memberdir/$who_to_load.rlog" && ! $recentloaded) {
+		fopen(RLOG, "$memberdir/$who_to_load.rlog");
+		%recent = map /(\d+)\t(\d+)/, <RLOG>;
+		fclose(RLOG);
+		$recentloaded = 1;
 	}
 }
 
+sub Recent_Save {
+	my $who_to_save = $_[0];
+	fopen(RLOG, ">$memberdir/$who_to_save.rlog");
+	print RLOG map "$_\t$recent{$_}\n", keys %recent;
+	fclose(RLOG);
+	undef %recent;
+	$recentloaded = 0;
+	if (!-s "$memberdir/$who_to_save.rlog") { unlink("$memberdir/$who_to_save.rlog"); }
+}
+
 sub Write_ForumMaster {
 	fopen(FORUMMASTER, ">$boardsdir/forum.master", 1);	
    	print FORUMMASTER qq~\$mloaded = 1;\n~;

Fixed not saving in ctb "moved" thread flags.
--- /home/isbear/MoveTopic.pl.orig	2007-10-02 23:22:58 +0300
+++ /home/isbear/MoveTopic.pl	2007-10-02 23:21:16 +0300
@@ -106,8 +106,10 @@
 				while (-e "$datadir/$newthreadid.txt") { $newthreadid++; }
 				# changes subject in message index to "Moved: Subject"
 				$msub=qq~[m]: $msub~;
-				# thread status - add (l)ocked and (m)oved ;)
+				# thread status - add (l)ocked and (m)oved ;) - remove (a)nnouncement
+				$mstate =~ s/a//ig;
 				$mstate .= "lm";
+				$orgstate = $mstate;
 				$buffer[$a] = qq~$newthreadid|$msub|$mname|$memail|$mdate|0|$username|$micon|$mstate\n~;
 			} else {
 				$buffer[$a] = "";
@@ -127,10 +129,11 @@
    # save newthread.ctb
 	&MessageTotals("load",$thread);
 	if (!$recycle) {
-		%$newthreadid  =  %$thread;
-		${$newthreadid}{'replies'} = 0 ;
-		${$newthreadid}{'views'} = 0 ;
-		${$newthreadid}{'lastposter'} = $username ;
+		%$newthreadid = %$thread;
+		${$newthreadid}{'replies'}      = 0;
+		${$newthreadid}{'views'}        = 0;
+		${$newthreadid}{'lastposter'}   = $username;
+		${$newthreadid}{'threadstatus'} = $orgstate;
 		&MessageTotals("update",$newthreadid);
 	}
 
Fixed inproper sorting of gallery images - third image in topic not displayed
13c13
< @attachments=sort {(split('\|',$b,2))[0] <=> (split('\|',$a,2))[0]} @attachments;
---
> @attachments=sort {(split('\|',$b))[6] <=> (split('\|',$a))[6]} @attachments;



Wed Oct  3 18:55:45 EEST 2007
Partially rewritten mkthumbs.cgi

Thu Oct  4 22:40:50 EEST 2007
Applied following patch to restore Home button in main menu.
Also accordingly modified Variables/Menu1.def. Maybe, later, will modify other two Menus.
--- Subs.pl.orig	2007-10-04 21:55:41 +0300
+++ Subs.pl	2007-10-04 22:01:22 +0300
@@ -201,7 +201,7 @@
 
 	$yyposition = $yytitle; $yytitle = "$mbname - $yytitle";
 	## remove search from menu if disabled by the admin ##
-	$yymenu = qq~<a href="$scripturl">$img{'home'}</a>$menusep<a href="$scripturl?action=help" style="cursor:help;">$img{'help'}</a>~;
+	$yymenu = qq~<a href="$scripturl">$img{'home'}</a>$menusep$img{'rules'}$menusep<a href="$scripturl?action=help" style="cursor:help;">$img{'help'}</a>~;
 	if ($maxsearchdisplay > -1){
 		$yymenu .= qq~$menusep<a href="$scripturl?action=search">$img{'search'}</a>~;
 	}

Fri Oct  5 22:47:06 EEST 2007
Закоментував у ubbc.js функцію, що забороняє надсилати двічі форму.
Доклав зміни для виправлення case-sensitive пошуку в українських текстах.
Увага, це брудиний хак!
--- Search.pl.orig	2007-10-05 21:28:38 +0300
+++ Search.pl	2007-10-05 22:40:37 +0300
@@ -190,6 +190,12 @@
 	my $searchmessage = $FORM{'msgfield'} eq 'on';
 	require "$sourcedir/Decoder.pl";
 	&scrambled($search);
+
+## UKRAINIAN CASE SEARCH FIX, UGLY.
+	use locale;
+	use POSIX 'locale_h';
+	setlocale (LC_CTYPE, 'uk_UA.koi8u');
+
 	$search =~ s/\A\s+//;
 	$search =~ s/\s+\Z//;
 	&ToHTML($search);

Sun Oct  7 20:27:58 EEST 2007
Have added next patch to allow direct board/category browsing from recent posts.
--- Recent.pl.orig	2007-10-07 20:24:50 +0300
+++ Recent.pl	2007-10-07 20:22:45 +0300
@@ -178,7 +178,7 @@
 sub RecentPosts {
 &spam_protection;
 	my $display = $INFO{'display'} ||= 10;
-	my( @memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify );
+	my( @memset, @categories, %data, $numfound, $curcat, %catname, %catid, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify );
 
 	$numfound=0;
 
@@ -197,6 +197,7 @@
 			if (!$iamadmin && $access ne "granted") {next;}
 			
 			$catname{$curboard} = $catname;
+			$catid{$curboard} = $catid;
 
 			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
 				for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
@@ -292,13 +293,14 @@
 		&ToChars($msub);
 		&ToChars($message);
 		&ToChars($boardname{$board});
+		&ToChars($catname{$board});
 		if($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
   <tr>
     <td width="5%" align="center" class="titlebg">$counter</td>
-    <td width="95%" class="titlebg">&nbsp;$catname{$board} / $boardname{$board} / <a href="$scripturl?num=$tnum/$c#$c"><u>$msub</u></a><br />
+    <td width="95%" class="titlebg">&nbsp;<a href="$scripturl?catselect=$catid{$board}">$catname{$board}</a> / <a href="$scripturl?board=$board">$boardname{$board}</a> / <a href="$scripturl?num=$tnum/$c#$c">$msub</a><br />
     &nbsp;<span class="small">$maintxt{'30'}: $mdate&nbsp;</span></td>
   </tr><tr>
     <td colspan="2" class="catbg">$maintxt{'109'} $tname | $maintxt{'197'} $mname</td>
   </tr><tr>
-    <td colspan="2" class="windowbg2" valign="top">$message</td>
+    <td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span></td>
   </tr><tr>
     <td colspan="2" class="catbg" align="right">
 ~;


Mon Oct  8 21:55:55 EEST 2007
Fixed wrong admincolumn behaviour.
--- MessageIndex.pl.orig	2007-10-08 21:10:46 +0300
+++ MessageIndex.pl	2007-10-08 21:47:29 +0300
@@ -258,7 +258,7 @@
 	# Print the header and board info.
 	&ToChars($boardname);
 	$curboardurl = $curposlinks ? qq~<a href="$scripturl?board=$currentboard" class="nav">$boardname</a>~ : $boardname;
-	if((($iammod && $modview == 1) || ($iamadmin && $adminview == 1) || ($iamgmod && $gmodview == 1)) && $sessionvalid == 1) {
+	if((($iammod && $modview == 1 && !$iamadmin && !$iamgmod) || ($iamadmin && $adminview == 1) || ($iamgmod && $gmodview == 1)) && $sessionvalid == 1) {
 		$yymain .= qq~<script language="JavaScript1.2" src="$ubbcjspath" type="text/javascript"></script>~;
 	}
 
@@ -268,7 +268,7 @@
 	my $modslink = qq~$showmods~;
 
 	#check howmany col's must be spanned ;)
-	if ((($iamadmin && $adminview >= 1) || ($iamgmod && $gmodview >= 1) || ($iammod && $modview >= 1)) && $sessionvalid == 1){
+	if ((($iamadmin && $adminview >= 1) || ($iamgmod && $gmodview >= 1) || ($iammod && $modview >= 1 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 		$colspan = 8;
 	}else{
 		$colspan = 7;
@@ -287,12 +287,11 @@
 		$polllink = qq~$menusep<a href="$scripturl?board=$INFO{'board'};action=post;title=CreatePoll">$img{'createpoll'}</a>~;
 	}
 	
-	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3)) && $sessionvalid == 1){
+	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 		$adminlink = qq~<img src="$imagesdir/locked.gif" alt="$messageindex_txt{'104'}" border="0" /><img src="$imagesdir/sticky.gif" alt="$messageindex_txt{'781'}" border="0" /><img src="$imagesdir/admin_move.gif" alt="$messageindex_txt{'132'}" border="0" /><img src="$imagesdir/admin_rem.gif" alt="$messageindex_txt{'54'}" border="0" />~;
 
 		$adminheader =~ s/<yabb admin>/$adminlink/g;
-	}
-	elsif ((($iamadmin && $adminview != 0) || ($iamgmod && $gmodview != 0) || ($iammod && $modview != 0)) && $sessionvalid == 1){
+	} elsif ((($iamadmin && $adminview != 0) || ($iamgmod && $gmodview != 0) || ($iammod && $modview != 0 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 		$adminlink = qq~$messageindex_txt{'2'}~;
 
 		$adminheader =~ s/<yabb admin>/$adminlink/g;
@@ -455,8 +454,7 @@
 	}
 	$admincol = $admincolumn;
 	$admincol =~ s/<yabb admin>/$adminbar/g;
-}
-elsif ((($iamadmin && $adminview == 2) || ($iamgmod && $gmodview == 2) || ($iammod && $modview == 2 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
+} elsif ((($iamadmin && $adminview == 2) || ($iamgmod && $gmodview == 2) || ($iammod && $modview == 2 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 	if ($currentboard ne $annboard && $counter<@anns) {
 		$adminbar = qq~&nbsp;~;
  	} else {
@@ -464,8 +462,7 @@
 	}
 	$admincol = $admincolumn;
 	$admincol =~ s/<yabb admin>/$adminbar/g;
-}
-elsif ((($iamadmin && $adminview == 1) || ($iamgmod && $gmodview == 1) || ($iammod && $modview == 1 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
+} elsif ((($iamadmin && $adminview == 1) || ($iamgmod && $gmodview == 1) || ($iammod && $modview == 1 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 	if ($currentboard ne $annboard && $counter<@anns) {
 		$adminbar = qq~&nbsp;~;
  	} else {
@@ -506,8 +503,8 @@
 
 	my $multiview=0;
 	my $tmptempfooter;
-	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3)) && $sessionvalid == 1){ $multiview=3; }
-	elsif ((($iamadmin && $adminview == 2) || ($iamgmod && $gmodview == 2) || ($iammod && $modview == 2)) && $sessionvalid == 1){ $multiview=2; }
+	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) { $multiview=3; }
+	elsif ((($iamadmin && $adminview == 2) || ($iamgmod && $gmodview == 2) || ($iammod && $modview == 2 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) { $multiview=2; }
 	
 	if ($multiview>=2) {
 		while (($catid, $listboards) = each(%cat)){
@@ -606,21 +603,20 @@
 	$messageindex_template =~ s/<yabb pageindex top>/$pageindex1/g;
 	$messageindex_template =~ s/<yabb pageindex bottom>/$pageindex2/g;
 
-	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3)) && $sessionvalid == 1){
+	if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) {
 
 	$messageindex_template =~ s/<yabb admin column>/$adminheader/g;
 
-	} elsif ((($iamadmin && $adminview != 0) || ($iamgmod && $gmodview != 0) || ($iammod && $modview != 0)) && $sessionvalid == 1){
+	} elsif ((($iamadmin && $adminview != 0) || ($iamgmod && $gmodview != 0) || ($iammod && $modview != 0 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) {
 	$messageindex_template =~ s/<yabb admin column>/$adminheader/g;
 	} else { $messageindex_template =~ s/<yabb admin column>//g; }
 
-	if ((($iamadmin && $adminview >= 2) || ($iamgmod && $gmodview >= 2) || ($iammod && $modview >= 2)) && $sessionvalid == 1){
+	if ((($iamadmin && $adminview >= 2) || ($iamgmod && $gmodview >= 2) || ($iammod && $modview >= 2 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1){
 		$formstart = qq~<form name="multiadmin" action="$scripturl?board=$currentboard;action=multiadmin" method="post" style="display: inline">~;
 		$formend = qq~<input type="hidden" name="allpost" value="$INFO{'start'}" /></form>~;
 		$messageindex_template =~ s/<yabb modupdate>/$formstart/g;
 		$messageindex_template =~ s/<yabb modupdateend>/$formend/g;
-	}
-	else {
+	} else {
 		$messageindex_template =~ s/<yabb modupdate>//g;
 		$messageindex_template =~ s/<yabb modupdateend>//g;
 	}
@@ -646,8 +642,8 @@
 	$pageindexjs
 	~;
 
-	if ((($iamadmin && $adminview >= 2) || ($iamgmod && $gmodview >= 2) || ($iammod && $modview >= 2)) && $sessionvalid == 1) {
-		if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3)) && $sessionvalid == 1) { $offset="7"; }
+	if ((($iamadmin && $adminview >= 2) || ($iamgmod && $gmodview >= 2) || ($iammod && $modview >= 2 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) {
+		if ((($iamadmin && $adminview == 3) || ($iamgmod && $gmodview == 3) || ($iammod && $modview == 3 && !$iamadmin && !$iamgmod)) && $sessionvalid == 1) { $offset="7"; }
 		else { $offset="8"; }
 		if ($sessionvalid == 1){
 			$yymain .= qq~

Tue Oct  9 22:59:30 EEST 2007
Fixed displaying of "Last registered:" when it is disabled.
Modified BoardIndex.{pl,template(x2)}

Thu Oct 25 00:56:57 EEST 2007
Have upgraded to 2.1. Most of previous changes are applied to code.
Partially modified scripts, that work with main page to accomodate
DB placement change.
Also changed Security.pl to fix IM replying problem. However, proper
fix should be applied to Post.pl to fix wrong form action string.
Partially changed templates. For example, many more icons in subBlack
are cropped (very inprofessionally...).
Maybe, some other changes also have applied, and I just forgot to
document them.

Fri Nov  9 12:15:39 EET 2007
Don't remember, if changed something else...
Well, added Novyny.pl and related.
Fixed novyny's [list] tag handling - it needs encapsulaton support.
Maybe, that fix isn't very efficient - but, at least, it does not uses
recursion.


Sun Nov 11 16:09:25 EET 2007
Applied next patch. Similar change has been applied to Smtp.pl, sub sendmail (one line).
--- Subs.pl.orig	2007-11-11 15:59:56 +0200
+++ Subs.pl	2007-11-11 15:59:34 +0200
@@ -705,6 +705,7 @@
 	# It's only a problem when sending emails, so no change to ToHTML.
 	$mbname =~ s/,/&#44;/ig;
 
+	$smtp_charset = $yycharset;
 	$fromheader = $from ? "$from" : "$mbname <$webmaster_email>";
 	$toheader   = $to   ? "$to"   : "$mbname $smtp_txt{'555'} <$webmaster_email>";
 	unless ($from) { $from = $webmaster_email; }
@@ -737,6 +738,7 @@
 			$smtp->datasend("From: $fromheader\r\n"); 
 			$smtp->datasend("X-Mailer: YaBB Net::SMTP\r\n"); 
 			$smtp->datasend("Subject: $subject\r\n");
+			$smtp->datasend("Content-Type: text/plain; charset=$smtp_charset\r\n");
 			$smtp->datasend("\r\n");
 			$smtp->datasend($message);
 			$smtp->dataend();
@@ -754,7 +756,8 @@
 		print MAIL "To: $toheader\n";
 		print MAIL "From: $fromheader\n";
 		print MAIL "X-Mailer: YaBB Sendmail\n";
-		print MAIL "Subject: $subject\n\n";
+		print MAIL "Subject: $subject\n";
+		print MAIL "Content-type: text/plain; charset=$smtp_charset\n";
 		$message =~ s/\r\n/\n/g;
 		print MAIL "$message\n";
 		close(MAIL);

Applied next patch to get addtional YaBBC tags.
Also added new English lng file - CYaBBC.lng
--- YaBBC.pl.orig	2007-11-11 16:18:55 +0200
+++ YaBBC.pl	2007-11-11 16:28:05 +0200
@@ -18,6 +18,7 @@
 if ($action eq 'detailedversion') { return 1; }
 
 LoadLanguage("Post");
+LoadLanguage("CYaBBC");
 
 $yyYaBBCloaded = 1;
 
@@ -226,6 +227,9 @@
 	$message =~ s~\[red\](.*?)\[/red\]~<span style="color:#FF0000;">$1</span>~isg;
 	$message =~ s~\[green\](.*?)\[/green\]~<span style="color:#0F0;">$1</span>~isg;
 	$message =~ s~\[blue\](.*?)\[/blue\]~<span style="color:#00F;">$1</span>~isg;
+	$message =~ s~\[flood\](.*?)\[/flood\]~<b>$cyabbc_txt{'flood'}: </b><br /><div class="editbg" style="overflow: auto;">$1</div>~isg;
+	$message =~ s~\[flame](.*?)\[/flame\]~<b>$cyabbc_txt{'flame'}: </b><br /><div class="editbg" style="overflow: auto;">$1</div>~isg;
+	$message =~ s~\[off(top(ic)?)?](.*?)\[/off(top(ic)?)?\]~<b>$cyabbc_txt{'offtop'}: </b><br /><div class="editbg" style="overflow: auto;">$3</div>~isg;
 	$message =~ s~\[edit\](.*?)\[/edit\]~<b>$post_txt{'603'}: </b><br /><div class="editbg" style="overflow: auto;">$1</div>~isg;
 	$message =~ s~\[timestamp\=([\d]{9,10})\]~&timeformat($1)~eisg;
 	$message =~ s~\[moved\]~$maintxt{'160'}~;

Mon Nov 12 19:06:07 EET 2007
Somewhat modified that thing to use own classes and enclose them into 'showover' class.
Have modified default and subBlack CSSes.
Have changed other CSSes, also put that matches into the wheel to match incapsulation.
But note, that, despite it works, it matches 1 - n, 2 - n-1, 3 - n-3 etc openong and closing tags levels.

Added two spaces around <yabbbr> in regex in Subs.pl/wrap to fix extra spaces around \n in YaBBC.pl/DoUBBC input.


Tue Nov 13 16:23:59 EET 2007
Have copied really attached images from yat to yabbfiles/Attachments
In future they should be registered in $vardir/attachments.txt .
Maybe, will wait for 2.2 upgrade - there is present rebuild attachments function.
With not attached files there are strange situation.

Fri Nov 16 01:32:17 EET 2007
Forgot to note: fixed space killing in quotes - YaBBC.pl/quotemsg or so...
Now try to change perms on boards.
And add Captcha for guests when posting.

Have applied next patches:
--- Post.pl.orig	2007-10-15 17:29:36.000000000 +0300
+++ Post.pl	2007-11-16 03:16:51.000000000 +0200
@@ -576,6 +576,21 @@
 
 	}
 
+	# Captcha for guests on posting
+	if ($iamguest && $enable_guestposting && $regcheck) {
+		&LoadLanguage ('flood');
+		&validation_code;
+		$yymain .= qq~
+  <tr class="windowbg">
+    <td><b>$floodtxt{'1'}:</b></td>
+    <td>$showcheck</td>
+  </tr><tr class="windowbg">
+    <td><b>$floodtxt{'3'}:</b></td>
+    <td><input type="text" maxlength="30" name="verification" id="verification" size="30" /></td>
+  </tr>
+~;
+	}
+
 	if ($enable_ubbc && $showyabbcbutt) {
 
 		# this is for the ubbc buttons
@@ -1181,9 +1196,9 @@
 	$testmessage =~ s~\[/td\].*?\[/tr\].*?\[/table\]~~g;
 	$testmessage =~ s/\[.*?\]//g;
 	if ($testmessage eq "" && $mess ne "" && $pollthread != 2) { fatal_error("$maintxt{'2'} $testmessage"); }
-	$message =~ s/\cM//g;
-	$message =~ s~\[([^\]]{0,30})\n([^\]]{0,30})\]~\[$1$2\]~g;
-	$message =~ s~\[/([^\]]{0,30})\n([^\]]{0,30})\]~\[/$1$2\]~g;
+#	$message =~ s/\cM//g; # \r alredy removed
+	$message =~ s~\[([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[$1$2\]~g;
+	$message =~ s~\[/([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[/$1$2\]~g;
 #	$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1$2~g;
 	&FromChars($message);
 	&ToHTML($message);
@@ -1327,6 +1342,23 @@
 		&Preview("$post_txt{'76'}") if ($FORM{'email'} eq '');
 		&Preview("$post_txt{'240'} $post_txt{'69'} $post_txt{'241'}") if ($FORM{'email'} !~ /[\w\-\.\+]+\@[\w\-\.\+]+\.(\w{2,4}$)/);
 		&Preview("$post_txt{'500'}") if (($FORM{'email'} =~ /(@.*@)|(\.\.)|(@\.)|(\.@)|(^\.)|(\.$)/) || ($FORM{'email'} !~ /^.+@\[?(\w|[-.])+\.[a-zA-Z]{2,4}|[0-9]{1,4}\]?$/));
+		# Check captcha.
+		if ($regcheck) {
+			&LoadLanguage ('Register');
+			&fatal_error("$floodtxt{'4'}") if ($FORM{'verification'} eq '');
+			&fatal_error("$register_txt{'240'} $floodtxt{'3'} $register_txt{'241'}") if ($FORM{'verification'} !~ /\A[0-9A-Za-z]+\Z/);
+
+			# Trying to figure out the mess we made while encrypting verification
+			$lastvalue        = 13;
+			$verificationtest = "";
+			for ($n = 0; $n < length "$FORM{'regdate'}"; $n++) {
+				$value = (substr("$FORM{'regdate'}", $n, 1)) + $lastvalue + 1;
+				$letter = substr("$FORM{'_session_id_'}", $value, 1);
+				$lastvalue = $value;
+				$verificationtest .= qq~$letter~;
+			}
+			&fatal_error("$floodtxt{'4'}") if ($verificationtest ne $FORM{'verification'});
+		}
 	}
 
 	# Get the form values
@@ -1414,9 +1446,9 @@
 		$subject =~ s/[\r\n]//g;
 		$doadsubject = $subject;
 		$message =~ s/\cM//g;
-		$message =~ s~\[([^\]]{0,30})\n([^\]]{0,30})\]~\[$1$2\]~g;
-		$message =~ s~\[/([^\]]{0,30})\n([^\]]{0,30})\]~\[/$1$2\]~g;
-		$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g;
+		$message =~ s~\[([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[$1$2\]~g;
+		$message =~ s~\[/([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[/$1$2\]~g;
+#		$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g;
 		&FromChars($message);
 		&ToHTML($message);
 		$message =~ s~\t~ \&nbsp; \&nbsp; \&nbsp;~g;
--- YaBBC.pl.orig	2007-11-16 03:17:50.000000000 +0200
+++ YaBBC.pl	2007-11-16 03:20:28.000000000 +0200
@@ -103,12 +103,6 @@
 	return $cnvmessage;
 }
 
-sub nstquotemsg {
-	$nstmessage = $_[0];
-	$nstmessage =~ s~(.*)\[quote+(\s+author=(.*?)\s*link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg;
-	return $nstmessage;
-}
-
 sub parseimgflash {
 	my $tmp_message = $_[0];
 	my $char_160    = '';
@@ -203,9 +197,9 @@
 	$message =~ s~\[code\]\n*(.+?)\n*\[/code\]~&codemsg($1)~eisg;
 	if ($message =~ /\#nosmileys/isg || $ns =~ "NS") { $message =~ s/\#nosmileys//isg; }
 	else { &MakeSmileys; }
-	$message =~ s~\[([^\]]{0,30})\n([^\]]{0,30})\]~\[$1$2\]~g;
-	$message =~ s~\[/([^\]]{0,30})\n([^\]]{0,30})\]~\[/$1$2\]~g;
-	$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g;
+	$message =~ s~\[([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[$1$2\]~g;
+	$message =~ s~\[/([^\]\[]{0,30})\n([^\]\[]{0,30})\]~\[/$1$2\]~g;
+#	$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g;
 	$message =~ s~\[b\](.*?)\[/b\]~<b>$1</b>~isg;
 	$message =~ s~\[i\](.*?)\[/i\]~<i>$1</i>~isg;
 	$message =~ s~\[u\](.*?)\[/u\]~<u>$1</u>~isg;
@@ -213,7 +207,7 @@
 	$message =~ s~\[glb\](.*?)\[/glb\]~<span style\=\"font-weight: bold\;\">$1</span>~isg;
 	$message =~ s~\[move\](.*?)\[/move\]~<marquee>$1</marquee>~isg;
 
-	while ($message =~ s~(\[quote+(\s+author=(.*?)link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\])~&nstquotemsg($1)~eisg) { }
+	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s+link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
 
 	$hardspace = qq~&nbsp;~;
 	$char_160  = chr(160);
--- Post.pl	2007-11-16 03:49:28 +0200
+++ Post.pl~	2007-11-16 03:37:15 +0200
@@ -586,9 +586,7 @@
     <td>$showcheck</td>
   </tr><tr class="windowbg">
     <td><b>$floodtxt{'3'}:</b></td>
-    <td><input type="text" maxlength="30" name="verification" id="verification" size="30" />
-    <input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" />
-    <input type="hidden" name="regdate" id="regdate" value="$regdate" /></td>
+    <td><input type="text" maxlength="30" name="verification" id="verification" size="30" /></td>
   </tr>
 ~;
 	}
to get working captcha on guestposts.
Also it fixes recent upstream fixes for linebreak deletion and removes some unnecessary code.

Applied next patch to fix not displaying fo Guest name in recents.
--- Recent.pl.orig	2007-11-16 04:16:44 +0200
+++ Recent.pl	2007-11-16 04:17:39 +0200
@@ -258,8 +258,8 @@
 			$tname = qq~<a href="$scripturl?action=viewprofile;username=$tusername">${$uid.$tusername}{'realname'}</a>~;
 		} elsif ($tusername !~ m~Guest~ && $trstart < $registrationdate) {
 			$tname = qq~$tusername - $maintxt{'470a'}~;
-		} else {
-			$tname = "$tusername";
+#		} else {
+#			$tname = "$tusername";
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -272,8 +272,8 @@
 			$mname = qq~<a href="$scripturl?action=viewprofile;username=$musername">${$uid.$musername}{'realname'}</a>~;
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
 			$mname = qq~$musername - $maintxt{'470a'}~;
-		} else {
-			$mname = "$musername";
+#		} else {
+#			$mname = "$musername";
 		}
 
 		$message = &Censor($message);

Sun Nov 18 10:48:57 EET 2007
Have applied the next patch to fix 000000 status problem and avoid possibility of
malicious users posting special threads
--- Post.pl.orig	2007-11-18 10:41:19 +0200
+++ Post.pl	2007-11-18 10:47:55 +0200
@@ -1699,7 +1699,8 @@
 
 	# set announcement flag according to status of current board
 	if ($newthreadid) {
-		$mstate = "0$thestatus";
+		if ($thestatus && ($iamadmin || $iamgmod || $iammod)) { $mstate = "0$thestatus"; }
+		else { $mstate = 0; }
 		if ($currentboard eq $annboard) { $mstate = "0a"; }
 
 		# This is a new thread. Save it.
@@ -1761,8 +1762,8 @@
 			($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate) = split(/\|/, $yyThreadLine);
 			$mreplies = ${$threadid}{'replies'};
 			if ($mstate =~ /l/i) { &fatal_error($post_txt{'90'}); }
-			$mstate = "0$thestatus";
-			if ($currentboard eq $annboard && $mstate !~ /a/i) { $mstate = "0a"; }
+			if ($thestatus && ($iamadmin || $iamgmod || $iamgmod)) { $mstate = "0$thestatus"; }
+			if ($currentboard eq $annboard) { $mstate = "0a"; }
 			$mreplies++;
 			fopen(BOARDFILE, "+<$boardsdir/$currentboard.txt", 1) || &write_error("211 $post_txt{'106'}: $post_txt{'23'} $currentboard.txt", 1);
 			seek BOARDFILE, 0, 0;

Have fixed inproper ">:(" smiley handling in bbcode.pl (really yabb hendles it as "&amp;gt;:(" >:()


Sat Nov 24 03:35:06 EET 2007
Yesterday have changed YaBBC.pl and css'es to add [hide] tag and remove hiding
from default offtop, flood, flame tags.

Further patch to disable possible thread status tampering and maybe fix 000 problem
--- ModifyMessage.pl	2007-11-24 03:37:35 +0200
+++ ModifyMessage.pl.new	2007-11-24 03:45:29 +0200
@@ -466,7 +466,7 @@
 	if ($tstate =~ /l/i) {
 		&fatal_error($post_txt{'90'});
 	}
-	if ($tstate !~ /a/i) {
+	if ($tstate !~ /a/i && $thestatus && ($iamadmin || $iamgmod || $iammod)) {
 		$tstate = "0$thestatus";
 	}

Sun Nov 25 05:12:34 EET 2007
New Decoder.pl (changed Serhiy Iehorov's (member "prapor")).
Not sure, if it help, but...
In future maybe, add some other, more ukrainian mechanism of generating text?..

Sun Nov 25 17:47:06 EET 2007
Applied next patch to get proper displaying of voted users number in multivote polls.
Also small code clearance.
--- Poll.pl.orig	2007-11-25 17:36:12 +0200
+++ Poll.pl	2007-11-25 17:37:58 +0200
@@ -328,23 +328,28 @@
 	&LoadCensorList;
 
 	fopen(FILE, "$datadir/$pollnum.poll");
-	$poll_question = <FILE>;
-	@poll_data     = <FILE>;
+	my $poll_question = <FILE>;
+	my @poll_data     = <FILE>;
 	fclose(FILE);
 	chomp $poll_question;
-	($poll_question, $poll_locked, $poll_uname, $poll_name, $poll_email, $poll_date, $guest_vote, $hide_results, $multi_vote, $poll_mod, $poll_modname, $poll_comment) = split(/\|/, $poll_question);
+	chomp @poll_data;
+
+	($poll_question, $poll_locked, $poll_uname, $poll_name, $poll_email, $poll_date, $guest_vote, $hide_results, $multi_vote, $poll_mod, $poll_modname, $poll_comment)
+			= split(/\|/, $poll_question);
 	&ToChars($poll_question);
 	&ToChars($poll_comment);
 
+	fopen(FILE, "$datadir/$pollnum.polled");
+	my @polled = <FILE>;
+	fclose(FILE);
+	chomp @polled;
+
 	$users_votetext = "";
 	$has_voted      = 0;
-	if (!$guest_vote && $iamguest) { $has_voted = 4; }
-	else {
-		fopen(FILE, "$datadir/$pollnum.polled");
-		@polled = <FILE>;
-		fclose(FILE);
+	if ((!$guest_vote || $poll_locked) && $iamguest) {
+		$has_voted = 4;
+	} else {
 		foreach $tmpLine (@polled) {
-			chomp $tmpline;
 			($voters_ip, $voters_name, $voters_vote, $vote_date) = split(/\|/, $tmpLine);
 			if ($iamguest && $voters_name eq "Guest" && lc $voters_ip eq lc $user_ip) { $has_voted = 1; last; }
 			elsif ($iamguest && $voters_name ne "Guest" && lc $voters_ip eq lc $user_ip) { $has_voted = 2; last; }
@@ -360,15 +365,14 @@
 
 	my @options;
 	my @votes;
-	my $totalvotes = 0;
+	my $totalvotes = @polled;
 	my $maxvote    = 0;
 	for (my $i = 0; $i < @poll_data; $i++) {
-		chomp $poll_data[$i];
 		($votes[$i], $options[$i]) = split(/\|/, $poll_data[$i]);
 
 		&ToChars($options[$i]);
 
-		$totalvotes += int($votes[$i]);
+#		$totalvotes += int($votes[$i]);
 		if (int($votes[$i]) >= $maxvote) { $maxvote = int($votes[$i]); }
 	}

Applied next patch to fix percents count, damaged by previous patch.
--- Poll.pl~	2007-11-25 17:38:22 +0200
+++ Poll.pl	2007-11-25 20:43:28 +0200
@@ -344,6 +344,8 @@
 	fclose(FILE);
 	chomp @polled;
 
+	my $totalvoted = @polled;
+
 	$users_votetext = "";
 	$has_voted      = 0;
 	if ((!$guest_vote || $poll_locked) && $iamguest) {
@@ -365,14 +367,14 @@
 
 	my @options;
 	my @votes;
-	my $totalvotes = @polled;
+	my $totalvotes = 0;
 	my $maxvote    = 0;
 	for (my $i = 0; $i < @poll_data; $i++) {
 		($votes[$i], $options[$i]) = split(/\|/, $poll_data[$i]);
 
 		&ToChars($options[$i]);
 
-#		$totalvotes += int($votes[$i]);
+		$totalvotes += int($votes[$i]);
 		if (int($votes[$i]) >= $maxvote) { $maxvote = int($votes[$i]); }
 	}
 
@@ -456,7 +458,7 @@
 				$footer .= qq~$options[$optnum]<br />~;
 			}
 		}
-		$footer .= qq~<br /><b>$polltxt{'17'}: $totalvotes</b>~;
+		$footer .= qq~<br /><b>$polltxt{'17'}: $totalvoted</b>~;
 		$width      = qq~~;
 		$deletevote = qq~<a href="$scripturl?action=undovote;num=$pollnum">$img{'deletevote'}</a>~;
 		if ($iamadmin && $displayvoters) { $deletevote .= $menusep; }

First correction in fixing "Form spoofing problem".
--- linux.org.ua/lib/yabb-2.1/Sources/Guardian.pl~	2007-10-15 17:29:36 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Guardian.pl	2007-11-25 22:57:16 +0200
@@ -32,7 +32,7 @@
 	if ($ENV{REQUEST_METHOD} eq 'POST') {
 		$fsession = $FORM{'formsession'};
 		chomp $fsession;
-		$returnseed = substr($fsession, length($fsession) - 4, length($fsession));
+		$returnseed = substr($fsession, length($fsession) - 4, 4);
 		$decryptformsession = substr($fsession, 0, length($fsession) - 4);
 		$testform = &encode_session($mbname, $returnseed);
 		chomp $testform;

Mon Nov 26 00:41:50 EET 2007
Have fixed ex-members in doshowthread on reply by commenting redefinition
of $/ and $| in new Decoder.pl.
Also have commented "left" Decoder.pl loading in Subs.pl/validation_code.

Applied next patch to clarify code in SetStatus and remove redundant file operations.
--- linux.org.ua/lib/yabb-2.1/Sources/SetStatus.pl	2007-10-15 17:29:36 +0300
+++ SetStatus.pl	2007-11-26 04:36:55 +0200
@@ -18,87 +18,71 @@
 if ($action eq 'detailedversion') { return 1; }
 
 sub SetStatus {
-	my $buffer;
 	my $start      = $INFO{'start'} || 0;
 	my $ctbid      = $INFO{'thread'};
 	my $thisstatus = "";
 	my $status     = substr($INFO{'action'}, 0, 1) || substr($FORM{'action'}, 0, 1);
-	my $ref        = $INFO{'ref'};
-	if ($iammod || $iamadmin || $iamgmod) {
-		my $threadid = $INFO{'thread'};
-		if (!$currentboard) {
-			&MessageTotals("load", $threadid);
-			$currentboard = ${$threadid}{'board'};
-		}
-		my $found = 0;
-		fopen(BOARDFILE, "$boardsdir/$currentboard.txt") || &fatal_error("test $txt{'23'} $currentboard.txt", 1);
-		@boardfile = <BOARDFILE>;
-		fclose(BOARDFILE);
-		fopen(BOARDFILE, ">$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
-
-		foreach my $line (@boardfile) {
-			chomp $line;
-			if ($line =~ m~\A$threadid\|~) {
-				$buffer = $line;
-				my ($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate);
-				($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate) = split(/\|/, $buffer);
-
-				if ($mstate !~ /0/) {
-					$mstate .= "0";
-					$line = qq~$mnum|$msub|$mname|$memail|$mdate|$mreplies|$musername|$micon|$mstate~;
-				}
 
-				$yydebug .= "Checking status of $threadid with the state of $mstate";
-				if ($mstate =~ /$status/) {
-					$yydebug .= " It was '$status'. removing<br />";
-					$mstate =~ s/$status//ig;
-
-					# Sticky-ing redirects to messageindex always
-					if ($status eq "s") {
-						$yySetLocation = qq~$scripturl?board=$currentboard~;
-					} else {
-						$yySetLocation = qq~$scripturl?num=$INFO{'thread'}/$start~;
-					}
-				} else {
-					$yydebug .= " It wasn't '$status'. adding<br />";
-					$mstate  .= "$status";
+	&fatal_error("$txt{'93'}") unless ($iammod || $iamadmin || $iamgmod);
+
+	my $threadid = $INFO{'thread'};
+	if (!$currentboard) {
+		&MessageTotals("load", $threadid);
+		$currentboard = ${$threadid}{'board'};
+	}
+
+	fopen(BOARDFILE, "$boardsdir/$currentboard.txt") || &fatal_error("test $txt{'23'} $currentboard.txt", 1);
+	@boardfile = <BOARDFILE>;
+	fclose(BOARDFILE);
+
+	fopen(BOARDFILE, ">$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
+	foreach my $line (@boardfile) {
+		chomp $line;
+		if ($line =~ m~\A$threadid\|~) {
+			my ($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate)
+					= split(/\|/o, $line);
+
+			$mstate .= "0" unless ($mstate =~ /0/o);
+
+			if ($mstate =~ /$status/i) {
+				$mstate =~ s/$status//ig;
+
+				if ($status eq "s") {
 					$yySetLocation = qq~$scripturl?board=$currentboard~;
+				} else {
+					$yySetLocation = qq~$scripturl?num=$threadid/$start~;
 				}
-				$thisstatus = qq~$mstate~;
-				print BOARDFILE "$mnum|$msub|$mname|$memail|$mdate|$mreplies|$musername|$micon|$mstate\n";
-			} elsif ($line =~ /\|/i) {
-				print BOARDFILE $line . "\n";
 			} else {
-
-				#this is a bad line
-				next;
+				$mstate  .= "$status";
+				$yySetLocation = qq~$scripturl?board=$currentboard~;
 			}
+			$thisstatus = qq~$mstate~;
+
+			print BOARDFILE
+				"$mnum|$msub|$mname|$memail|$mdate|$mreplies|$musername|$micon|$mstate\n";
+
+		} elsif ($line =~ /\|/o) {
+
+			print BOARDFILE $line . "\n";
+
+		} else {
+			#this is a bad line
+			next;
 		}
-		fclose(BOARDFILE);
-	} else {
-		&fatal_error("$txt{'93'}");
 	}
+	fclose(BOARDFILE);
+
 	fopen(CTBFILE, "$datadir/$ctbid.ctb");
 	@ctbfile = <CTBFILE>;
 	fclose(CTBFILE);
+
 	$ctbfile[5] = qq~$thisstatus\n~;
+
 	fopen(CTBFILE, ">$datadir/$ctbid.ctb");
 	print CTBFILE @ctbfile;
 	fclose(CTBFILE);
-	fopen(BOARDFILE, "$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
-	@boardfile = <BOARDFILE>;
-	fclose(BOARDFILE);
-	fopen(BOARDFILE, ">$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
 
-	foreach my $line (@boardfile) {
-		if ($line =~ /\|/ig) {
-			print BOARDFILE $line;
-		}
-	}
-	fclose(BOARDFILE);
-	if (!$INFO{'moveit'}) {
-		&redirectexit;
-	}
+	&redirectexit if (!$INFO{'moveit'});
 }
 
 1;


Fri Nov 30 20:17:28 EET 2007
Experimental patch to redirect in moved threads. Sorry for that.
--- Security.pl.orig	2007-11-30 19:47:47 +0200
+++ Security.pl	2007-11-30 20:12:57 +0200
@@ -48,6 +48,16 @@
 if ($curnum != '' && !$action) {
 
 	# Add 1 to the number of views of this thread.
+	&MessageTotals ('load', $curnum);
+	if (${$curnum}{'threadstatus'} =~ /m/) {
+		fopen (MOVED, "<$datadir/$curnum.txt");
+		my $mesg = (split /\|/, <MOVED>)[8];
+		fclose(MOVED);
+		if ($mesg =~ /\[link=[^\]]+num=(\d+)[\/\]]/) {
+			$yySetLocation = qq~$scripturl?num=$1~;
+			&redirectexit;
+		}
+	}
 	&MessageTotals("incview", $curnum);
 	unless ($username eq "Guest") {
 		$j           = 0;

Fri Nov 30 20:37:06 EET 2007
Applied patch to 1. Do more secure things 2. Do faster :)
Although, starting, I thought, that I did not applied previous patch :)
--- SetStatus.pl.orig	2007-11-30 20:15:47 +0200
+++ SetStatus.pl	2007-11-30 20:36:11 +0200
@@ -19,13 +19,15 @@
 
 sub SetStatus {
 	my $start      = $INFO{'start'} || 0;
-	my $ctbid      = $INFO{'thread'};
 	my $thisstatus = "";
 	my $status     = substr($INFO{'action'}, 0, 1) || substr($FORM{'action'}, 0, 1);
 
 	&fatal_error("$txt{'93'}") unless ($iammod || $iamadmin || $iamgmod);
 
 	my $threadid = $INFO{'thread'};
+	&fatal_error ($maintxt{'337'}) if ($threadid =~ /\D/);
+	my $ctbid    = $threadid;
+
 	if (!$currentboard) {
 		&MessageTotals("load", $threadid);
 		$currentboard = ${$threadid}{'board'};
@@ -37,11 +39,11 @@
 
 	fopen(BOARDFILE, ">$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
 	foreach my $line (@boardfile) {
-		chomp $line;
 		if ($line =~ m~\A$threadid\|~) {
 			my ($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate)
 					= split(/\|/o, $line);
-
+			
+			chomp $mstate;
 			$mstate .= "0" unless ($mstate =~ /0/o);
 
 			if ($mstate =~ /$status/i) {
@@ -60,14 +62,8 @@
 
 			print BOARDFILE
 				"$mnum|$msub|$mname|$memail|$mdate|$mreplies|$musername|$micon|$mstate\n";
-
 		} elsif ($line =~ /\|/o) {
-
-			print BOARDFILE $line . "\n";
-
-		} else {
-			#this is a bad line
-			next;
+			print BOARDFILE $line;
 		}
 	}
 	fclose(BOARDFILE);

Sat Dec  1 04:34:23 EET 2007
Applied patch to somewhat logicalize moved topics...
--- MoveTopic.pl.orig	2007-11-30 20:42:54 +0200
+++ MoveTopic.pl	2007-12-01 04:30:59 +0200
@@ -98,7 +98,7 @@
 				$mstate =~ s/a//ig;
 				$mstate .= "lm";
 				$orgstate = $mstate;
-				$buffer[$a] = qq~$newthreadid|$msub|$mname|$memail|$mdate|0|$username|$micon|$mstate\n~;
+				$buffer[$a] = qq~$newthreadid|$msub|$mname|$memail|$mdate|0|$username|exclamation|$mstate\n~;
 			} else {
 				$buffer[$a] = "";
 			}
@@ -114,31 +114,30 @@
 	print FROMBOARD @buffer;
 	fclose(FROMBOARD);
 
-	# save newthread.ctb
 	&MessageTotals("load", $thread);
 	@tmprepliers = @repliers;
-	if (!$recycle) {
-		%$newthreadid = %$thread;
-		${$newthreadid}{'replies'}      = 0;
-		${$newthreadid}{'views'}        = 0;
-		${$newthreadid}{'lastposter'}   = $username;
-		${$newthreadid}{'threadstatus'} = $orgstate;
-		&MessageTotals("update", $newthreadid);
-	}
 
 	# write new thread ('Moved:'+orig thread sub)
 	if (!$recycle) {
-		($tmpsub, @dummy) = split(/\|/, $messages[0]);
+		my $tmpip = (split /\|/, $messages[0])[7];
 		$tmpsub = qq~[m]: $tmpsub~;
 
-		(undef, undef, undef, $tmpdate, @dummy) = split(/\|/, $messages[$#messages]);
 		my ($boardtitle, undef, undef) = split(/\|/, $board{$toboard});
 
 		$tmpmessage = "[moved] [link=$scripturl?num=$thread/0]" . "$boardtitle" . "[/link] [move by] ${$uid.$username}{'realname'}.";
 		&FromChars($tmpmessage);
 		fopen(NEWTHREAD, ">$datadir/$newthreadid.txt") || &write_error("$post_txt{'23'} $newthreadid.txt", 1);
-		print NEWTHREAD qq~$tmpsub|||$tmpdate|$username|exclamation|0|$user_ip|$tmpmessage|0|$date|$username|\n~;
+		print NEWTHREAD qq~$msub|$mname|$memail|$mdate|$musername|exclamation|0|$tmpip|$tmpmessage||$date|$username|\n~;
 		fclose(NEWTHREAD);
+
+		# save newthread.ctb
+		%$newthreadid = %$thread;
+		${$newthreadid}{'replies'}      = 0;
+		${$newthreadid}{'views'}        = 0;
+		${$newthreadid}{'lastposter'}   = $username;
+		${$newthreadid}{'threadstatus'} = $orgstate;
+		&MessageTotals("update", $newthreadid);
+		
 		&modlog($newthreadid);
 	}
 
@@ -155,10 +154,12 @@
 	@origlinedatas = split(/\|/, $OrigThreadLine);
 
 	# set announcement state
-	if ($toboard eq $annboard && $origlinedatas[8] !~ /a/i) { $origlinedatas[8] .= "a"; }
-	elsif ($fromboard eq $annboard) { $origlinedatas[8] =~ s/a//ig; }
-	if    ($toboard   eq $annboard) { $origlinedatas[8] =~ s/l//ig; }
-	if    ($toboard   eq $annboard) { $origlinedatas[8] =~ s/s//ig; }
+	if ($toboard eq $annboard) {
+		$origlinedatas[8] .= "a" if ($origlinedatas[8] !~ /a/i);
+		$origlinedatas[8] =~ s/[ls]+//ig;
+	} elsif ($fromboard eq $annboard) {
+		$origlinedatas[8] =~ s/a//ig;
+	}
 	$newstatus = $origlinedatas[8];
 
 	$OrigThreadLine = join("|", @origlinedatas) . "\n";
@@ -199,8 +200,8 @@
 
 	# now fix all attachment board info
 	for ($a = 0; $a < @messages; $a++) {
-		(undef, undef, undef, undef, undef, undef, undef, undef, undef, undef, undef, undef, $mfn) = split(/\|/, $messages[$a]);
-		if ($mfn) { $last; }
+		$mfn = (split /\|/, $messages[$a])[12];
+		last if ($mfn);
 	}
 	undef @messages;
 
@@ -210,7 +211,6 @@
 		fopen(AMP, "+<$vardir/attachments.txt", 1) || &fatal_error("$txt{'23'} $vardir/attachments.txt", 1);
 		seek AMP, 0, 0;
 		@buffer = <AMP>;
-		truncate AMP, 0;
 		for ($a = 0; $a < @buffer; $a++) {
 			if ($buffer[$a] =~ m~\A$thread\|~) {
 				chomp $buffer[$a];
@@ -219,6 +219,7 @@
 				$buffer[$a] = join("|", @attachfile) . "\n";
 			}
 		}
+		truncate AMP, 0;
 		seek AMP, 0, 0;
 		print AMP @buffer;
 		fclose(AMP);


Sat Dec  1 04:44:22 EET 2007
Patch. Some strictness and so on.
--- RemoveTopic.pl.orig	2007-12-01 04:37:33 +0200
+++ RemoveTopic.pl	2007-12-01 04:42:33 +0200
@@ -18,10 +18,10 @@
 if ($action eq 'detailedversion') { return 1; }
 
 sub RemoveThread {
-	my ($threadline, $threadmessagecount, $a, $dummy, $amfn, @messages, @message);
+	my ($threadline, $threadmessagecount, $a, $amfn, @messages, @message);
+
 	$thread = $INFO{'thread'};
-	if ($thread =~ m~/~)  { &fatal_error($maintxt{'399'}); }
-	if ($thread =~ m~\\~) { &fatal_error($maintxt{'400'}); }
+	if ($thread =~ /\D/)  { &fatal_error($maintxt{'337'}); }
 	if (!$iammod && !$iamadmin && !$iamgmod && !$iamposter) {
 		&fatal_error("$maintxt{'73'}");
 	}
@@ -33,7 +33,6 @@
 	fopen(BOARDFILE, "+<$boardsdir/$currentboard.txt", 1) || &fatal_error("7543 $maintxt{'23'} $currentboard.txt", 1);
 	seek BOARDFILE, 0, 0;
 	my @buffer = <BOARDFILE>;
-	truncate BOARDFILE, 0;
 	for ($a = 0; $a < @buffer; $a++) {
 		if ($buffer[$a] =~ m~\A$thread\|~) {
 			$threadline = $buffer[$a];
@@ -41,13 +40,12 @@
 			last;
 		}
 	}
+	truncate BOARDFILE, 0;
 	seek BOARDFILE, 0, 0;
 	print BOARDFILE @buffer;
 	fclose(BOARDFILE);
 
 	if ($threadline) {
-		$threadmessagecount = $mreplies + 1;
-
 		fopen(FILE, "$datadir/$thread.txt") || &fatal_error("$maintxt{'23'} $thread.txt", 1);
 		@messages = <FILE>;
 		fclose(FILE);
@@ -63,8 +61,8 @@
 		&RemoveThreadFiles($thread);
 
 		for ($a = 0; $a < @messages; $a++) {
-			@message = split(/\|/, $messages[$a]);
-			if ($message[12] ne "") { $mfn = $message[12]; last; }
+			$mfn = (split /\|/, $messages[$a])[12];
+			last if ($mfn ne '');
 		}
 		undef @messages;
 
@@ -74,15 +72,15 @@
 			fopen(AMP, "+<$vardir/attachments.txt", 1) || &fatal_error("$txt{'23'} $vardir/attachments.txt", 1);
 			seek AMP, 0, 0;
 			my @buffer = <AMP>;
-			truncate AMP, 0;
 			for ($a = 0; $a < @buffer; $a++) {
 				if ($buffer[$a] =~ m~\A$thread\|~) {
 					chomp $buffer[$a];
-					($dummy, $dummy, $dummy, $dummy, $dummy, $dummy, $dummy, $amfn) = split(/\|/, $buffer[$a]);
+					my $amfn = (split /\|/, $buffer[$a])[7];
 					unlink("$uploaddir/$amfn");
 					$buffer[$a] = "";
 				}
 			}
+			truncate AMP, 0;
 			seek AMP, 0, 0;
 			print AMP @buffer;
 			fclose(AMP);

Sat Dec  1 05:23:05 EET 2007
Patch fights moved threads in recents and fixes future guests names.
Note, that only posts currently show board and cat as links
--- Recent.pl.orig	2007-12-01 04:55:46 +0200
+++ Recent.pl	2007-12-01 05:21:34 +0200
@@ -53,7 +53,7 @@
 			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
 				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
-				unless ($tstate =~ /h/) {
+				unless ($tstate =~ /[hm]/) {
 					$mtime = $tdate;
 					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
 					$numfound++;
@@ -106,7 +106,7 @@
 		} elsif ($tusername !~ m~Guest~ && $mtime < $registrationdate) {
 			$tname = qq~$tusername - $maintxt{'470a'}~;
 		} else {
-			$tname = "$tusername";
+			$tname .= " ($maintxt{'28'})";
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -120,7 +120,7 @@
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
 			$mname = qq~$musername - $maintxt{'470a'}~;
 		} else {
-			$mname = "$musername";
+			$mname .= " ($maintxt{'28'})";
 		}
 
 		$message = &Censor($message);
@@ -136,7 +136,7 @@
 		&ToChars($msub);
 		&ToChars($message);
 		&ToChars($boardname{$board});
-		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
+#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
 		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
 		$mdate = &timeformat($mdate);
@@ -200,7 +200,7 @@
 			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
 				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
-				unless ($tstate =~ /h/) {
+				unless ($tstate =~ /[hm]/) {
 					$mtime = $tdate;
 					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
 					$numfound++;
@@ -258,8 +258,8 @@
 			$tname = qq~<a href="$scripturl?action=viewprofile;username=$tusername">${$uid.$tusername}{'realname'}</a>~;
 		} elsif ($tusername !~ m~Guest~ && $trstart < $registrationdate) {
 			$tname = qq~$tusername - $maintxt{'470a'}~;
-#		} else {
-#			$tname = "$tusername";
+		} else {
+			$tname .= " ($maintxt{'28'})";
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -272,8 +272,8 @@
 			$mname = qq~<a href="$scripturl?action=viewprofile;username=$musername">${$uid.$musername}{'realname'}</a>~;
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
 			$mname = qq~$musername - $maintxt{'470a'}~;
-#		} else {
-#			$mname = "$musername";
+		} else {
+			$mname .= " ($maintxt{'28'})";
 		}
 
 		$message = &Censor($message);
@@ -289,7 +289,7 @@
 		&ToChars($message);
 		&ToChars($boardname{$board});
 		&ToChars($catname{$board});
-		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
+#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
 		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
 		$mdate = &timeformat($mdate);
@@ -357,7 +357,7 @@
 			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
 				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
-				unless ($tstate =~ /h/) {
+				unless ($tstate =~ /[hm]/) {
 					$mtime = $tdate;
 					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies";
 					$numfound++;
@@ -407,6 +407,8 @@
 			$mname = exists ${$uid.$musername}{'realname'} ? ${$uid.$musername}{'realname'} : $mname;
 			$mname ||= $txt{'470'};
 			$mname = qq~<a href="$scripturl?action=viewprofile;username=$useraccount{$musername}" title="$txt{'27'}: $musername">$mname</a>~;
+		} else {
+			$mname .= " ($maintxt{'28'})";
 		}
 		$mdate = &timeformat($mdate);
 
@@ -415,7 +417,7 @@
 		$msub =~ s/\ARe: //ig;
 
 		# Change [m] to Moved:
-		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
+#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
 		$yymain .= qq~          <tr>~;
 


Sat Dec  1 06:10:42 EET 2007
Patch adds board and cat links to search, fixes guestnames, fights move topics,
encloses message into .message class.
--- Search.pl.orig	2007-12-01 05:49:28 +0200
+++ Search.pl	2007-12-01 06:09:27 +0200
@@ -221,7 +221,7 @@
 	if ($searchtype != 3) { @search = split(/\s+/, lc $search); }
 	else { @search = (lc $search); }
 
-	my ($curboard, @threads, $curthread, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $ttime, @messages, $curpost, $mtime, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $subfound, $msgfound, $numfound, %data, $i, $board, $curcat, @categories, %catname, %cataccess, %openmemgr, @membergroups, %cats, @boardinfo, %boardinfo, @boards, $counter, $msgnum);
+	my ($curboard, @threads, $curthread, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $ttime, @messages, $curpost, $mtime, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $subfound, $msgfound, $numfound, %data, $i, $board, $curcat, @categories, %catname, %catid, %boardname, %cataccess, %openmemgr, @membergroups, %cats, @boardinfo, %boardinfo, @boards, $counter, $msgnum);
 	my $curtime = time + (3600 * ${$uid.$tusername}{'timeoffset'});
 	my $maxtime     = $curtime - (($maxage * 86400) + 1);
 	my $oldestfound = "01/10/37 $search_txt{'107'} 00:00:00";
@@ -237,6 +237,7 @@
 		foreach $cboard (@bdlist) {
 			($bname, $bperms, $bview) = split(/\|/, $board{"$cboard"});
 			$catname{$cboard} = $catname;
+			$catid{$board} = $catid;
 		}
 	}
 
@@ -256,7 +257,9 @@
 
 			($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $curthread);
 
-			if (!$iamadmin && !$iamgmod && $tstate =~ /h/i) { next threadcheck; }
+			if ($tsttate =~ /m/i || (!$iamadmin && !$iamgmod && $tstate =~ /h/i)) {
+				next threadcheck;
+			}
 			if ($userkind == 1) {
 				if ($tusername eq 'Guest') {
 					if ($tname !~ m~\A\Q$userspec\E\Z~i) { next threadcheck; }
@@ -353,7 +356,7 @@
 		} elsif ($tusername !~ m~Guest~ && $tnum < $registrationdate) {
 			$tname = qq~$tusername - $maintxt{'470a'}~;
 		} else {
-			$tname = "$tusername";
+			$tname .= "$maintxt{'28'}";
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -367,7 +370,7 @@
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
 			$mname = qq~$musername - $maintxt{'470a'}~;
 		} else {
-			$mname = "$musername";
+			$mname .= "$maintxt{'28'}";
 		}
 
 		$mdate = &timeformat($mdate);
@@ -395,21 +398,22 @@
 		}
 		&ToChars($msub);
 		&ToChars($message);
+		&ToChars($catname{$board});
 		&ToChars($boardname{$board});
 
 		# Change [m] to Moved:
-		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
+#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
   <tr>
     <td align="center" width="5%" class="titlebg"><span class="text1">&nbsp;$counter&nbsp;</span></td>
-    <td align="left" width="95%" class="titlebg"><span class="text1"><b>&nbsp;$catname{$board} / $boardname{$board} / <a href="$scripturl?num=$tnum/$msgnum#$msgnum"><span class="text1"><u>$msub</u></span></a></b></span><br />
+    <td align="left" width="95%" class="titlebg"><a href="$scripturl?catselect=$catid{$board}">&nbsp;$catname{$board}</a> / <a href="$scripturl?board=$board">$boardname{$board}</a> / <a href="$scripturl?num=$tnum/$msgnum#$msgnum">$msub</a><br />
     &nbsp;<span class="small">$search_txt{'30'}: $mdate</span></td>
   </tr><tr>
     <td align="left" colspan="2" class="catbg"><span class="catbg">$search_txt{'109'} $tname | $search_txt{'105'} $search_txt{'525'} $mname</span></td>
   </tr><tr>
-    <td align="left" height="80" colspan="2" class="windowbg2" valign="top">$message</td>
+    <td align="left" height="80" colspan="2" class="windowbg2" valign="top"><span class="message">$message</span></td>
   </tr><tr>
     <td align="right" colspan="2" class="catbg">&nbsp;
 ~;


Next patch, fixing typo in previous.
--- Search.pl.orig.1	2007-12-01 06:18:16 +0200
+++ Search.pl	2007-12-01 06:19:09 +0200
@@ -356,7 +356,7 @@
 		} elsif ($tusername !~ m~Guest~ && $tnum < $registrationdate) {
 			$tname = qq~$tusername - $maintxt{'470a'}~;
 		} else {
-			$tname .= "$maintxt{'28'}";
+			$tname .= " ($maintxt{'28'})";
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -370,7 +370,7 @@
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
 			$mname = qq~$musername - $maintxt{'470a'}~;
 		} else {
-			$mname .= "$maintxt{'28'}";
+			$mname .= " ($maintxt{'28'})";
 		}
 
 		$mdate = &timeformat($mdate);

Sat Dec  1 06:38:18 EET 2007
Well, now patch, that allows preview w/o captcha and (!) removes "(Guest)" from nicks.
--- Post.pl.orig	2007-12-01 06:28:30 +0200
+++ Post.pl	2007-12-01 06:37:34 +0200
@@ -1344,23 +1344,6 @@
 		&Preview("$post_txt{'76'}") if ($FORM{'email'} eq '');
 		&Preview("$post_txt{'240'} $post_txt{'69'} $post_txt{'241'}") if ($FORM{'email'} !~ /[\w\-\.\+]+\@[\w\-\.\+]+\.(\w{2,4}$)/);
 		&Preview("$post_txt{'500'}") if (($FORM{'email'} =~ /(@.*@)|(\.\.)|(@\.)|(\.@)|(^\.)|(\.$)/) || ($FORM{'email'} !~ /^.+@\[?(\w|[-.])+\.[a-zA-Z]{2,4}|[0-9]{1,4}\]?$/));
-		# Check captcha.
-		if ($regcheck) {
-			&LoadLanguage ('Register');
-			&fatal_error("$floodtxt{'4'}") if ($FORM{'verification'} eq '');
-			&fatal_error("$register_txt{'240'} $floodtxt{'3'} $register_txt{'241'}") if ($FORM{'verification'} !~ /\A[0-9A-Za-z]+\Z/);
-
-			# Trying to figure out the mess we made while encrypting verification
-			$lastvalue        = 13;
-			$verificationtest = "";
-			for ($n = 0; $n < length "$FORM{'regdate'}"; $n++) {
-				$value = (substr("$FORM{'regdate'}", $n, 1)) + $lastvalue + 1;
-				$letter = substr("$FORM{'_session_id_'}", $value, 1);
-				$lastvalue = $value;
-				$verificationtest .= qq~$letter~;
-			}
-			&fatal_error("$floodtxt{'4'}") if ($verificationtest ne $FORM{'verification'});
-		}
 	}
 
 	# Get the form values
@@ -1468,6 +1451,23 @@
 		$name  = ${$uid.$username}{'realname'};
 		$email = ${$uid.$username}{'email'};
 	} else {
+		# Check captcha.
+		if ($regcheck) {
+			&LoadLanguage ('Register');
+			&fatal_error("$floodtxt{'4'}") if ($FORM{'verification'} eq '');
+			&fatal_error("$register_txt{'240'} $floodtxt{'3'} $register_txt{'241'}") if ($FORM{'verification'} !~ /\A[0-9A-Za-z]+\Z/);
+
+			# Trying to figure out the mess we made while encrypting verification
+			$lastvalue        = 13;
+			$verificationtest = "";
+			for ($n = 0; $n < length "$FORM{'regdate'}"; $n++) {
+				$value = (substr("$FORM{'regdate'}", $n, 1)) + $lastvalue + 1;
+				$letter = substr("$FORM{'_session_id_'}", $value, 1);
+				$lastvalue = $value;
+				$verificationtest .= qq~$letter~;
+			}
+			&fatal_error("$floodtxt{'4'}") if ($verificationtest ne $FORM{'verification'});
+		}
 
 		# If user is Guest, then make sure the chosen name
 		# is not reserved or used by a member.
@@ -1475,7 +1475,7 @@
 		@memberlist = <FILE>;
 		fclose(FILE);
 		&memparse(@memberlist);
-		$name .= "(Guest)";
+#		$name .= "(Guest)";
 	}
 
 	my @poll_data;

Patch fixes typo.
--- Search.pl.orig.2	2007-12-01 07:01:45 +0200
+++ Search.pl	2007-12-01 07:04:56 +0200
@@ -237,7 +237,7 @@
 		foreach $cboard (@bdlist) {
 			($bname, $bperms, $bview) = split(/\|/, $board{"$cboard"});
 			$catname{$cboard} = $catname;
-			$catid{$board} = $catid;
+			$catid{$cboard} = $catid;
 		}
 	}

Sat Dec  1 15:20:21 EET 2007
Have changed English langpack encoding to KOI8-U.

Mon Dec  3 04:05:54 EET 2007
Patch fixes smilies eagerness...
--- YaBBC.pl.orig	2007-11-22 02:33:38 +0200
+++ YaBBC.pl	2007-12-03 04:05:16 +0200
@@ -38,8 +38,8 @@
 sub validwidth { return ($_[0] > 400 ? 400 : $_[0]); }
 
 sub MakeSmileys {
-	$message =~ s/\[smilie=(\S+\.(gif|jpg|png|bmp))\]/\<img border="0" src="$smiliesurl\/$1" alt="$post_txt{'287'}" \/\>/isg;
-	$message =~ s/\[smiley=(\S+\.(gif|jpg|png|bmp))\]/\<img border="0" src="$smiliesurl\/$1" alt="$post_txt{'287'}" \/\>/isg;
+	$message =~ s/\[smilie=(\S+?\.(gif|jpg|png|bmp))\]/\<img border="0" src="$smiliesurl\/$1" alt="$post_txt{'287'}" \/\>/isg;
+	$message =~ s/\[smiley=(\S+?\.(gif|jpg|png|bmp))\]/\<img border="0" src="$smiliesurl\/$1" alt="$post_txt{'287'}" \/\>/isg;
 	$message =~ s/(\W|\A)\;\)/$1\<img border="0" src="$defaultimagesdir\/wink.gif\" alt="$post_txt{'292'}" \/>/g;
 	$message =~ s/(\W|\A)\;\-\)/$1\<img border="0" src="$defaultimagesdir\/wink.gif\" alt="$post_txt{'292'}" \/>/g;
 	$message =~ s/(\W|\A)\;D/$1\<img border="0" src="$defaultimagesdir\/grin.gif\" alt="$post_txt{'293'}" \/>/g;

Thu Dec  6 22:32:48 EET 2007
Changed tabindex param in form input tags to put capcha in sequence later than message, but earlier than submit. (Post.pl)
Maybe, later will change order to nick-mail-message-preview-nosmilie-capcha-submit...

Sat Dec  8 11:34:49 EET 2007
Patch fixes subject cutting.
--- Post.pl.orig	2007-12-08 11:04:40.000000000 +0200
+++ Post.pl	2007-12-08 11:27:51.000000000 +0200
@@ -22,6 +22,8 @@
 LoadLanguage("FA");
 require "$sourcedir/Notify.pl";
 
+$set_subjectMaxLength ||= 50;
+
 sub Post {
 	if ($iamguest && $enable_guestposting == 0) { &fatal_error($post_txt{'165'}); }
 	if ($currentboard eq '') { &fatal_error($post_txt{'1'}); }
@@ -113,6 +115,7 @@
 			$msubject =~ s/\bre:\s+//ig;
 		}
 		$sub        = "Re: $msubject";
+		$set_subjectMaxLength += 4;
 		$settofield = "message";
 	}
 	$submittxt   = "$post_txt{'105'}";
@@ -521,7 +524,7 @@
 			$yymain .= qq~
 		      <tr>
 		        <td align="left" class="windowbg" width="23%"><b>$post_txt{'70'}:</b></td>
-		        <td align="left" class="windowbg" width="77%"><input type="text" name="subject" value="$sub" size="50" maxlength="50" tabindex="1" onchange="updatTopic()" /></td>
+		        <td align="left" class="windowbg" width="77%"><input type="text" name="subject" value="$sub" size="50" maxlength="$set_subjectMaxLength" tabindex="1" onchange="updatTopic()" /></td>
 		      </tr>
 			~;
 		}
@@ -1184,7 +1187,8 @@
 	$sub =~ s/&gt;/>/g;
 	&FromChars($sub);
 	$convertstr = $sub;
-	$convertcut = 50;
+	$set_subjectMaxLength += 4 if ($threadid);
+	$convertcut = $set_subjectMaxLength;
 	&CountChars;
 	$sub = $convertstr;
 	$sub =~ s/"/&quot;/g;
@@ -1438,7 +1442,8 @@
 		$subject =~ s/&gt;/>/g;
 		&FromChars($subject);
 		$convertstr = $subject;
-		$convertcut = 50;
+		$set_subjectMaxLength += 4 if ($threadid);
+		$convertcut = $set_subjectMaxLength;
 		&CountChars;
 		$subject = $convertstr;
 		$subject =~ s/"/&quot;/g;

Thu Dec 13 22:52:03 EET 2007
Patch fixes reply subject truncating on modify.
--- ModifyMessage.pl.orig	2007-12-11 23:43:03.000000000 +0200
+++ ModifyMessage.pl	2007-12-11 23:48:44.000000000 +0200
@@ -23,6 +23,8 @@
 }
 LoadLanguage("FA");
 
+$set_subjectMaxLength ||= 50;
+
 sub ModifyMessage {
 	my ($mfn);
 	if ($iamguest) { &fatal_error($post_txt{'223'}); }
@@ -93,6 +95,8 @@
 		chomp $curmessage;
 		($sub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $mlm, $mlmb, $mfn) = split(/\|/, $messages[$postid]);
 
+		$set_subjectMaxLength += 4 if ($postid);
+
 		$messagedate      = $mdate;
 		$registrationdate = ${$uid.$username}{'regtime'};
 
@@ -454,6 +458,7 @@
 		unless (($registrationdate < $messagedate && $musername eq $username) || $iammod || $iamadmin || $iamgmod) {
 			&fatal_error("$post_txt{'67'}");
 		}
+		$set_subjectMaxLength += 4;
 	} else {
 		&fatal_error("$post_txt{'580'} $postid");
 	}
@@ -499,7 +504,7 @@
 	$subject =~ s/&gt;/>/g;
 	&FromChars($subject);
 	$convertstr = $subject;
-	$convertcut = 50;
+	$convertcut = $set_subjectMaxLength;
 	&CountChars;
 	$subject = $convertstr;
 	$subject =~ s/"/&quot;/g;

Fri Dec 14 04:11:32 EET 2007
Have modified all templates css'es to fix inproper style of highlited text.

Sat Dec 15 02:43:11 EET 2007
Patch somewhat improves performance, fixes some small bugs and adds long link
cutting feature.
--- Subs.pl.orig	2007-12-14 13:38:01.000000000 +0200
+++ Subs.pl	2007-12-15 02:12:53.000000000 +0200
@@ -795,24 +795,17 @@
 
 sub CountChars {
 	$cliped = 0;
-	$convertstr =~ s/(\[ch\d{3,}?\])/ $1/ig;
-	while ($convertstr =~ m~\<.+?\>~g) { $convertstr =~ s/\s/&#32;/g; }
-	$convertstr =~ s/(\<.+?\>)/ $1 /ig;
+	$convertstr =~ s/(\[ch\d{3,}\])/ $1/ig;
+#	while ($convertstr =~ m~\<.+?\>~g) { $convertstr =~ s/\s/&#32;/g; }
+	$convertstr =~ s/<([^>]+?)>/ my $t=$1; $t =~ s^ ^&#32;^g; " <$t> " /sieg;
 	my @cwords = split(/\s/, $convertstr);
-	$convertstr = "";
-	my $curword;
-	foreach $curword (@cwords) {
-		$curword =~ s/&#32;/ /g;
-		$convertstr .= "$curword ";
-		if ($curword =~ m~\[ch\d{3,}?\]~ || $curword =~ m~\<.+?\>~) {
+	$convertstr = '';
+	foreach my $curword (@cwords) {
+		if ($curword =~ m~\[ch\d{3,}\]~i || $curword =~ m~<[^>]+?>~) {
+			$curword =~ s/&#32;/ /g;
 			$convertcut += length($curword);
-			if (length($convertstr) > $convertcut) {
-				$clipdiff = length($curword) - (length($convertstr) - $convertcut);
-				$convertcut += $clipdiff;
-				$cliped = 1;
-				last;
-			}
 		}
+		$convertstr .= "$curword ";
 		if (length($convertstr) > $convertcut) {
 			$cliped = 1;
 			last;
@@ -850,30 +843,12 @@
 	$wrapstr =~ s/ \Z//;
 }
 
-sub convFromChars {
-	$fcharno = $_[0];
-	if ($fcharno > 127) {
-		$tcharno = qq~\[ch$fcharno\]~;
-	} else {
-		$tcharno = qq~\&\#$fcharno\;~;
-	}
-	return $tcharno;
-}
-
-sub convToChars {
-	$fcharno = $_[0];
-	if ($fcharno > 127) {
-		$tcharno = qq~\&\#$fcharno\;~;
-	}
-	return $tcharno;
-}
-
 sub FromChars {
-	$_[0] =~ s/&#(\d{3,}?)\;/&convFromChars($1)/eisg;
+	$_[0] =~ s/&#(\d{3,});/ $1>127 ? "[ch$1]" : $& /seg;
 }
 
 sub ToChars {
-	$_[0] =~ s/\[ch(\d{3,}?)\]/&convToChars($1)/eisg;
+	$_[0] =~ s/\[ch(\d{3,})\]/ $1>127 ? "&#$1;" : '' /sieg;
 }
 
 sub ToHTML {
@@ -948,7 +923,7 @@
 }
 
 sub wrap2 {
-	$message =~ s~<a href=("?)(\S*)("?)(\starget="_blank")?>(\S{$linewrap})(\S*)</a>~<a href=$1$2$3$4>$5\n$6</a>~gi;
+	$message =~ s#<a href=(\S*?)(\s[^>]*)?>(\S{$linewrap,}?)</a># my $mess=$3; { $mess =~ s/\A((&.+?;|<.+?>|\[ch\d{3,}\]|.){$linewrap}).*\Z/$1.../s; } "<a href=$1$2>$mess</a>" #sieg;
 }
 
 sub BoardCountTotals {


Wed Dec 19 00:16:33 EET 2007
Added new no post group Banned.
Applied next patches and added BanWithGroup.pl, BanWithGroup.lng (three) + ban.png into default template.
Also added strrings to Main.lng $maintxt{'banwithgroup'}
It all makes system for users banning.
--- Load.pl.orig	2007-10-15 17:29:36 +0300
+++ Load.pl	2007-12-18 23:37:47 +0200
@@ -554,6 +554,18 @@
 		$attachperms = "";
 	}
 
+	my $is_banned = 0;
+	if ($title =~ /\[banned=(\d+),.*?\]/i) {
+		&LoadLanguage('BanWithGroup') if not defined %bangroup_txt;
+		$title = $bangroup_txt{'banuntil'} . &timeformat($1);
+		if ($1 < $date) {
+			$title = qq~<a href="$scripturl?action=ebwg;username=$user" title="$bangroup_txt{'buttexp'}">$title</a>~;
+		} elsif ($iamadmin || $iamgmod) {
+			$title = qq~<a href="$scripturl?action=ubwg;username=$user" title="$bangroup_txt{'buttunb'}">$title</a>~;
+		}
+		$is_banned = 1;
+	}
+
 	# The following puts some new has variables in if this user is the user browsing the board
 	if ($user eq $username) {
 		if ($tempgroup) {
@@ -599,6 +611,9 @@
 			}
 		}
 	}
+	if ($staff && !$is_banned) {
+		$addmembergroup{$user} .= qq~<a href="$scripturl?action=pbwg;username=$user">$maintxt{'banwithgroup'}</a><br />~;
+	}
 	$addmembergroup{$user} =~ s/<br \/>\Z//;
 
 	if ($username eq "Guest") {
--- SubList.pl.orig	2007-11-06 01:01:23 +0200
+++ SubList.pl	2007-12-18 14:45:48 +0200
@@ -18,6 +18,11 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
+'bwg',"BanWithGroup.pl&banwithgroup",
+'ubwg',"BanWithGroup.pl&unbanwithgroup",
+'ebwg',"BanWithGroup.pl&expirebanwithgroup",
+'pbwg',"BanWithGroup.pl&banwithgrouppassthrough",
+
 'novyny',"Novyny.pl&Novyny",
 'activate',"Register.pl&user_activation",
 'favorites',"Favorites.pl&Favorites",

Fix for sequential autolinks on separate lines (YaBBC.pl):
 	if ($autolinkurls) {
 		$message =~ s~&quot;&gt;~">~g;
 		$message =~ s~\[url\](.+?)\[\/url\]~$1 ~g;
-		$message =~ s~([^\w\"\=\[\]]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\)\s|\)\.\s|\&quot\;\)\s|\<\/|\[\/|\[\*)~$1\[url\=$2\]$2\[\/url\]$3~isg;
-		$message =~ s~([^\w\"\=\[\]]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\s|\)\s|\&quot\;\s)~$1\[url\=$2\]$2\[\/url\]$3~isg;
-		$message =~ s~([^\w\"\=\[\]]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\s)~$1\[url\=$2\]$2\[\/url\]$3~isg;
+		$message =~ s~([^\w\"\=\[\]]|^|\b|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\)\s|\)\.\s|\&quot\;\)\s|\<\/|\[\/|\[\*)~$1\[url\=$2\]$2\[\/url\]$3~ismg;
+		$message =~ s~([^\w\"\=\[\]]|^|\b|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\s|\)\s|\&quot\;\s)~$1\[url\=$2\]$2\[\/url\]$3~ismg;
+		$message =~ s~([^\w\"\=\[\]]|^|\b|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A)\\*(\w+?\:\/\/(?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\s)~$1\[url\=$2\]$2\[\/url\]$3~ismg;
 		$message =~ s~([^\"\=\[\]/\:\.(\://\w+)]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A|\()\\*(www\.[^\.](?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\)\s|\)\.\s|\&quot\;\)\s|\<\/|\[\/|\[\*)~$1\[url\=$2\]$2\[\/url\]$3~isg; 
 		$message =~ s~([^\"\=\[\]/\:\.(\://\w+)]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A|\()\\*(www\.[^\.](?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\.\s|\)\s|\&quot\;\s)~$1\[url\=$2\]$2\[\/url\]$3~isg; 
 		$message =~ s~([^\"\=\[\]/\:\.(\://\w+)]|[\n\b]|\[quote.*?\]|\[highlight\]|\[\*\]|\[td\]|\A|\()\\*(www\.[^\.](?:[\w\~\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)]+?)\.(?:[\w\~\.\;\:\,\$\-\+\!\*\?/\=\&\@\#\%\(\)\x80-\xFF]{1,})+?)(\s)~$1\[url\=$2\]$2\[\/url\]$3~isg; 
 	}


Fri Dec 21 03:47:45 EET 2007
Some small fixes in the language files.

Applied patch to get [diff] yabbc tag. Somewhat non-optimized...
And without admin control center part... Hard-coded colors...
But full version is not so version-portable... And in view of future
upgrade I not want to change engine too heavily.
--- YaBBC.pl.orig	2007-12-19 23:09:37 +0200
+++ YaBBC.pl	2007-12-21 12:26:37 +0200
@@ -181,6 +181,21 @@
 	return $_;
 }
 
+
+sub format_diff {
+	$_ = $_[0];
+	s/^(\+\+\+|---|\*\*\*|\@\@|[\d,ac]+)/<span style="color:#C0C">$1/mg;
+	s/^(\+|&gt;)/<span style="color:#494">$1/mg;
+	s/^(-|&lt;)/<span style="color:#944">$1/mg;
+	s/^ /<span style="color:#449">&nbsp;/mg;
+	s/^([!\\])/<span style="color:#894">!/mg;
+	s/^([^<])/<span style="color:#AAA">$1/mg;
+	s/$/<\/span>/mg;
+	s/<span style="color:#[0-9A-F]+"><\/span>//g;
+	return $_;
+}
+
+
 sub DoUBBC {
 	$message =~ s~\[code\]~ \[code\]~ig;
 	$message =~ s~\[/code\]~ \[/code\]~ig;
@@ -207,6 +222,7 @@
 	$message =~ s~\[glb\](.*?)\[/glb\]~<span style\=\"font-weight: bold\;\">$1</span>~isg;
 	$message =~ s~\[move\](.*?)\[/move\]~<marquee>$1</marquee>~isg;
 
+	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace">~ . &format_diff($1) . q~</div>~ ^egis;
 	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s+link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
 
 	$hardspace = qq~&nbsp;~;

Patch makes lines do not wrap. Although, it should be optimized...
--- YaBBC.pl	2007-12-21 12:26:37 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/YaBBC.pl	2007-12-21 13:17:52 +0200
@@ -192,6 +192,7 @@
 	s/^([^<])/<span style="color:#AAA">$1/mg;
 	s/$/<\/span>/mg;
 	s/<span style="color:#[0-9A-F]+"><\/span>//g;
+	s#>([^<]+)<# my $t = $1; $t =~ s/ /&nbsp;/g; qq^>$t<^#eg;
 	return $_;
 }
 
@@ -222,7 +223,7 @@
 	$message =~ s~\[glb\](.*?)\[/glb\]~<span style\=\"font-weight: bold\;\">$1</span>~isg;
 	$message =~ s~\[move\](.*?)\[/move\]~<marquee>$1</marquee>~isg;
 
-	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace">~ . &format_diff($1) . q~</div>~ ^egis;
+	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace;overflow:auto">~ . &format_diff($1) . q~</div>~ ^egis;
 	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s+link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
 
 	$hardspace = qq~&nbsp;~;

Optimization :) But it still wraps lines. Should see, how it done in [code].
--- YaBBC.pl	2007-12-21 13:17:52 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/YaBBC.pl	2007-12-21 13:33:19 +0200
@@ -192,7 +192,7 @@
 	s/^([^<])/<span style="color:#AAA">$1/mg;
 	s/$/<\/span>/mg;
 	s/<span style="color:#[0-9A-F]+"><\/span>//g;
-	s#>([^<]+)<# my $t = $1; $t =~ s/ /&nbsp;/g; qq^>$t<^#eg;
+#	s#>([^<]+)<# my $t = $1; $t =~ s/ /&nbsp;/g; qq^>$t<^#eg;
 	return $_;
 }
 
@@ -223,7 +223,7 @@
 	$message =~ s~\[glb\](.*?)\[/glb\]~<span style\=\"font-weight: bold\;\">$1</span>~isg;
 	$message =~ s~\[move\](.*?)\[/move\]~<marquee>$1</marquee>~isg;
 
-	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace;overflow:auto">~ . &format_diff($1) . q~</div>~ ^egis;
+	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace;overflow:auto;white-space:nowrap">~ . &format_diff($1) . q~</div>~ ^egis;
 	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s+link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
 
 	$hardspace = qq~&nbsp;~;

Thu Jan 10 16:53:38 EET 2008
Applied patch.
--- BoardIndex.pl	2007-10-15 17:29:36 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/BoardIndex.pl	2008-01-10 16:53:05 +0200
@@ -584,7 +584,7 @@
 		&ToChars($lssub);
 		$tmlsdatetime    = qq~($lsdatetime).<br />~;
 		$lastpostlink    = qq~$boardindex_txt{'236'} <b><a href="$scripturl?num=$lspostid/$lsreply#$lsreply"><b>$lssub</b></a></b>~;
-		$recentpostslink = qq~$boardindex_txt{'791'} <a href="$scripturl?action=recent">$boardindex_txt{'792'}</a> $boardindex_txt{'793'}~;
+		$recentpostslink = qq~$boardindex_txt{'791'} <a href="$scripturl?action=recent;display=8">$boardindex_txt{'792'}</a> $boardindex_txt{'793'}~;
 		$boardindex_template =~ s/<yabb lastpostlink>/$lastpostlink/g;
 		$boardindex_template =~ s/<yabb recentposts>/$recentpostslink/g;
 		$boardindex_template =~ s/<yabb lastpostdate>/$tmlsdatetime/g;


Tue Feb 12 23:28:15 EET 2008
moved s/&/&amp;/ before s/[ch...


Wed Feb 13 11:40:33 EET 2008
some changes to yabb2rss to handle [ch.. in subject

Thu Feb 28 02:33:21 EET 2008
Not added some fixes - I am now in post-illness period, so can crash the logs =)
Manually fixed ctb for thread in test_ph.

Sun Mar  2 01:39:22 EET 2008
New ukrainian agreement.txt. for english version will wait until Cthulhu ends translation.

Mon Mar 17 01:52:10 EET 2008
Have written script to find and fix ctbs, run it. Works.

Mon Mar 17 12:03:23 EET 2008
Applied patch, will see effect... already see, that it does not fixes tt problem.
--------------------------------------------------------------------
Author: Myhailo Danylenko <isbear@ukrpost.net>
Date: Mon Feb 18 15:15:08 EET 2008
Description:
 * new version of CountChars routine
 * fix slow-down by $&
 * some fixes in wrapping routine - will see, if it fix space eatin'
 * experimental fix to code linebreaks - dig it more...
 * fix of >> in [flash] handling
 * fix of old [quote] tag handling
 * various micro optimizations and style changes

diff -u -Naur yabb_o/lib/yabb-2.1/Sources/Subs.pl yabb_e/lib/yabb-2.1/Sources/Subs.pl
--- yabb_o/lib/yabb-2.1/Sources/Subs.pl	2007-12-15 02:14:29.000000000 +0200
+++ yabb_e/lib/yabb-2.1/Sources/Subs.pl	2008-02-18 14:52:42.000000000 +0200
@@ -794,27 +794,35 @@
 }
 
 sub CountChars {
-	$cliped = 0;
-	$convertstr =~ s/(\[ch\d{3,}\])/ $1/ig;
-#	while ($convertstr =~ m~\<.+?\>~g) { $convertstr =~ s/\s/&#32;/g; }
-	$convertstr =~ s/<([^>]+?)>/ my $t=$1; $t =~ s^ ^&#32;^g; " <$t> " /sieg;
-	my @cwords = split(/\s/, $convertstr);
-	$convertstr = '';
-	foreach my $curword (@cwords) {
-		if ($curword =~ m~\[ch\d{3,}\]~i || $curword =~ m~<[^>]+?>~) {
-			$curword =~ s/&#32;/ /g;
-			$convertcut += length($curword);
-		}
-		$convertstr .= "$curword ";
-		if (length($convertstr) > $convertcut) {
-			$cliped = 1;
-			last;
-		}
-	}
-	$convertstr =~ s/ (\<.+?\>) /$1/ig;
-	$convertstr =~ s/ (\[ch\d{3,}?\])/$1/ig;
-	$convertstr = substr($convertstr, 0, $convertcut);
-	$convertstr =~ s/ \Z//;
+	our ($convertstr, $convertcut);
+	our $cliped = 0;
+
+	$convertstr =~ m/\A(([^&\[<]|&(\w+|#\d+);|\[ch\d{3,}\]|<[^>]+>|.){0,$convertcut})(.?)/s;
+	$cliped     =  1 if length $4;
+	$convertstr =  $1;
+	$convertstr =~ s/\s*\Z//;
+
+# 	$cliped = 0;
+# 	$convertstr =~ s/(\[ch\d{3,}\])/ $1/ig;
+# #	while ($convertstr =~ m~\<.+?\>~g) { $convertstr =~ s/\s/&#32;/g; }
+# 	$convertstr =~ s/<([^>]+?)>/ my $t=$1; $t =~ s^ ^&#32;^g; " <$t> " /sieg;
+# 	my @cwords = split(/\s/, $convertstr);
+# 	$convertstr = '';
+# 	foreach my $curword (@cwords) {
+# 		if ($curword =~ m~\[ch\d{3,}\]~i || $curword =~ m~<[^>]+?>~) {
+# 			$curword =~ s/&#32;/ /g;
+# 			$convertcut += length($curword);
+# 		}
+# 		$convertstr .= "$curword ";
+# 		if (length($convertstr) > $convertcut) {
+# 			$cliped = 1;
+# 			last;
+# 		}
+# 	}
+# 	$convertstr =~ s/ (\<.+?\>) /$1/ig;
+# 	$convertstr =~ s/ (\[ch\d{3,}?\])/$1/ig;
+# 	$convertstr = substr($convertstr, 0, $convertcut);
+# 	$convertstr =~ s/ \Z//;
 }
 
 sub WrapChars {
@@ -844,7 +852,7 @@
 }
 
 sub FromChars {
-	$_[0] =~ s/&#(\d{3,});/ $1>127 ? "[ch$1]" : $& /seg;
+	$_[0] =~ s/&#(\d{3,});/ $1>127 ? "[ch$1]" : "&#$1;" /seg;
 }
 
 sub ToChars {
@@ -892,22 +900,25 @@
 
 sub wrap {
 	$message =~ s~ &nbsp; &nbsp; &nbsp;~\[tab\]~ig;
-	$message =~ s~<br \/>~\n~g;
-	$message =~ s~<br>~\n~g;
-	$message =~ s/((\[ch\d{3,}?\]){$linewrap})/$1\n/ig;
+	$message =~ s~<br \/>~\n~ig;
+	$message =~ s~<br>~\n~ig;
+	$message =~ s/((\[ch\d{3,}?\]|\S){$linewrap})/$1\n/ig;
 
 	&FromHTML($message);
 	$message =~ s~[\n\r]~ <yabbbr> ~g;
-	my @words = split(/\s/, $message);
+	my @words = split /\s/, $message;
 	$message = "";
 	foreach $cur (@words) {
-		if ($cur !~ m~www\.(\S+?)\.~ && $cur !~ m~[ht|f]tp://~ && $cur !~ m~\[\S*\]~ && $cur !~ m~\[\S*\s?\S*?\]~ && $cur !~ m~\[\/\S*\]~) { $cur =~ s~(\S{$linewrap})~$1\n~gi; }
-		if ($cur !~ m~\[table(\S*)\](\S*)\[\/table\]~ && $cur !~ m~\[url(\S*)\](\S*)\[\/url\]~ && $cur !~ m~\[flash(\S*)\](\S*)\[\/flash\]~ && $cur !~ m~\[img(\S*)\](\S*)\[\/img\]~) {
-			$cur =~ s~(\[\S*?\])~ $1 ~g;
-			@splitword = split(/\s/, $cur);
+		if ($cur !~ m~www\.(.+?)\.~ && $cur !~ m~(ht|f)tp://~ && $cur !~ m~\[.+?\]~) {
+			$cur =~ s~(.{$linewrap})~$1<yabbwrap>~g;
+		} elsif ($cur !~ m~\[table\](.*?)\[\/table\]~ && $cur !~ m~\[url(.*?)\](.*?)\[\/url\]~ && $cur !~ m~\[flash(.*?)\](.*?)\[\/flash\]~ && $cur !~ m~\[img(.*?)\](.*?)\[\/img\]~) {
+			$cur =~ s~(\[.*?\])~ $1 ~g;
+			@splitword = split /\s/, $cur;
 			$cur = "";
 			foreach $splitcur (@splitword) {
-				if ($splitcur !~ m~www\.(\S+?)\.~ && $splitcur !~ m~[ht|f]tp://~ && $splitcur !~ m~\[\S*\]~) { $splitcur =~ s~(\S{$linewrap})~$1<yabbwrap>~gi; }
+				if ($splitcur !~ m~www\.(.+?)\.~ && $splitcur !~ m~(ht|f)tp://~ && $splitcur !~ m~\[.+?\]~) {
+					$splitcur =~ s~(.{$linewrap})~$1<yabbwrap>~g;
+				}
 				$cur .= $splitcur;
 			}
 		}
diff -u -Naur yabb_o/lib/yabb-2.1/Sources/YaBBC.pl yabb_e/lib/yabb-2.1/Sources/YaBBC.pl
--- yabb_o/lib/yabb-2.1/Sources/YaBBC.pl	2007-12-24 19:21:48.000000000 +0200
+++ yabb_e/lib/yabb-2.1/Sources/YaBBC.pl	2008-02-18 14:12:18.000000000 +0200
@@ -107,9 +107,9 @@
 	my $tmp_message = $_[0];
 	my $char_160    = '';
 
-	$tmp_message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">>$3</a>~g;
+	$tmp_message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">$3</a>~g;
 	$char_160  = chr(160);
-	$hardspace = qq~&nbsp;~;
+	$hardspace = q~&nbsp;~;
 #	$tmp_message =~ s~\&nbsp\;~~g;
 	$tmp_message =~ s~\[img\](?:\s|\t|\n|$hardspace|$char_160)*(http\:\/\/)*(.+?)(?:\s|\t|\n|$hardspace|$char_160)*\[/img\]~<a href="http\:\/\/$2" alt="" border="0" target="_blank">http\:\/\/$2</a>~isg;
 	$tmp_message =~ s~\[img width=(\d+) height=(\d+)\](?:\s|\t|\n|$hardspace|$char_160)*(http\:\/\/)*(.+?)(?:\s|\t|\n|$hardspace|$char_160)*\[\/img\]~<a href="http:\\$4" alt="" target="_blank" border="0" onclick="window.open('http\:\/\/$4', 'image', 'resizable,width=$1,height=$2'); return false;">http:\/\/$4</a>~ig;
@@ -117,11 +117,12 @@
 
 }
 
+if (!$fontsizemax) { $fontsizemax = 72; }
+if (!$fontsizemin) { $fontsizemin = 6;  }
+
 sub sizefont {
 	## limit minimum and maximum font pitch as CSS does not restrict it at all. ##
 	my ($tsize, $ttext) = @_;
-	if    (!$fontsizemax)         { $fontsizemax = 72; }
-	if    (!$fontsizemin)         { $fontsizemin = 6; }
 	if    ($tsize < $fontsizemin) { $tsize       = $fontsizemin; }
 	elsif ($tsize > $fontsizemax) { $tsize       = $fontsizemax; }
 	my $resized = qq~<span style="font-size:$tsize\px;">$ttext</span>~;
@@ -166,7 +167,8 @@
 		# try to display text as it was originally intended
 		$code =~ s~ \&nbsp; \&nbsp; \&nbsp;~\t~ig;
 		$code =~ s~\&nbsp;~ ~ig;
-		$code =~ s~ ?\n ?~\[code_br\]~ig;            # we need to keep normal linebreaks inside <pre> tag
+#		$code =~ s~ ?\n ?~\[code_br\]~ig;            # we need to keep normal linebreaks inside <pre> tag
+		$code =~ s~\n~\[code_br\]~ig;            # we need to keep normal linebreaks inside <pre> tag
 		$code = qq~<pre class="code" style="margin: 0px; width: 90%; $height overflow: auto;">$code\[code_br\][code_br\]</pre>~;
 		$_ =~ s~CODE~$code~g;
 		return $_;
@@ -223,11 +225,13 @@
 	$message =~ s~\[glb\](.*?)\[/glb\]~<span style\=\"font-weight: bold\;\">$1</span>~isg;
 	$message =~ s~\[move\](.*?)\[/move\]~<marquee>$1</marquee>~isg;
 
+	$hardspace = q~&nbsp;~;
+	$char_160  = chr(160);
+
+	# FIXME: to css
 	$message =~ s^\[diff\]\s*(.*?)\s*\[/diff\]^ q~<div style="display:block;width:90%;border:1px dotted #444;background-color:#EED;padding:0.3em;font-family:monospace;overflow:auto;white-space:nowrap">~ . &format_diff($1) . q~</div>~ ^egis;
-	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s+link=(.*?)\s+date=(.*?)\s*)?\]\n*(.*?)\n*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
+	while ($message =~ s~(.*)\[quote(\s+author=(.*?)\s(?:\s|$hardspace)*link=(.*?)\s+date=(.*?)\s*)?\]\s*(.*?)\s*\[/quote\]~&quotemsg($1,$3,$4,$5,$6)~eisg) { };
 
-	$hardspace = qq~&nbsp;~;
-	$char_160  = chr(160);
 	$message =~ s~\[img\](?:\s|\t|\n|$hardspace|$char_160)*(http\:\/\/)*(.+?)(?:\s|\t|\n|$hardspace|$char_160)*\[/img\]~<img src="http\:\/\/$2" alt="" border="0" />~isg;
 	$message =~ s~\[img width=(\d+) height=(\d+)\](?:\s|\t|\n|$hardspace|$char_160)*(http\:\/\/)*(.+?)(?:\s|\t|\n|$hardspace|$char_160)*\[/img\]~restrictimage($1,$2,'http://'.$4)~eisg;
 
@@ -332,7 +336,7 @@
 	$message =~ s~\[/olist\]~</li></ol>~isg;
 	$message =~ s~</li><ol>~<ol>~isg;
 	$message =~ s~<ol></li>~<ol>~isg;
-	$message =~ s~\[\*\]~</li><li>~isg;
+#	$message =~ s~\[\*\]~</li><li>~isg;
 	$message =~ s~\[list\]~<ul>~isg;
 	$message =~ s~\[/list\]~</li></ul>~isg;
 	$message =~ s~</li><ul>~<ul>~isg;
@@ -356,9 +360,9 @@
 		if ($message =~ /\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]/) {
 			if ($3 =~ /http:\/\/(\S+?).swf/) {
 				if ($stealthurl) {
-					$message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$boardurl/YaBB.$yyext?action=dereferer;url=$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">>$3</a>~;
+					$message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$boardurl/YaBB.$yyext?action=dereferer;url=$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">$3</a>~;
 				} else {
-					$message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">>$3</a>~;
+					$message =~ s~\[flash\=(\S+?),(\S+?)](\S+?)\[\/flash\]~<b>$display_txt{'769'} ($1 x $2):</b> <a href="$3" target="_blank" onclick="window.open('$3', 'flash', 'resizable,width=$1,height=$2'); return false;">$3</a>~;
 
 				}
 			}

Trying to fix different problems, next patshes has been arised:
--- lib/yabb-2.1/Sources/Subs.pl~	2008-03-17 12:00:17 +0200
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-17 13:09:36 +0200
@@ -902,7 +902,7 @@
 	$message =~ s~ &nbsp; &nbsp; &nbsp;~\[tab\]~ig;
 	$message =~ s~<br \/>~\n~ig;
 	$message =~ s~<br>~\n~ig;
-	$message =~ s/((\[ch\d{3,}?\]|\S){$linewrap})/$1\n/ig;
+	$message =~ s/((\[ch\d{3,}?\]|&\S+?;|\S){$linewrap})/$1\n/ig;
 
 	&FromHTML($message);
 	$message =~ s~[\n\r]~ <yabbbr> ~g;

--- lib/yabb-2.1/Sources/Subs.pl~	2008-03-17 13:09:36 +0200
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-17 13:12:04 +0200
@@ -899,7 +899,7 @@
 }
 
 sub wrap {
-	$message =~ s~ &nbsp; &nbsp; &nbsp;~\[tab\]~ig;
+	$message =~ s~ &nbsp; &nbsp; &nbsp;~[tab]~ig;
 	$message =~ s~<br \/>~\n~ig;
 	$message =~ s~<br>~\n~ig;
 	$message =~ s/((\[ch\d{3,}?\]|&\S+?;|\S){$linewrap})/$1\n/ig;


--- lib/yabb-2.1/Sources/Subs.pl~	2008-03-17 13:12:04 +0200
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-17 13:15:35 +0200
@@ -899,7 +899,7 @@
 }
 
 sub wrap {
-	$message =~ s~ &nbsp; &nbsp; &nbsp;~[tab]~ig;
+#	$message =~ s~ &nbsp; &nbsp; &nbsp;~[tab]~ig;
 	$message =~ s~<br \/>~\n~ig;
 	$message =~ s~<br>~\n~ig;
 	$message =~ s/((\[ch\d{3,}?\]|&\S+?;|\S){$linewrap})/$1\n/ig;
@@ -929,7 +929,7 @@
 	$message =~ s~<yabbwrap>~\n~g;
 
 	&ToHTML($message);
-	$message =~ s~\[tab\]~ &nbsp; &nbsp; &nbsp;~ig;
+#	$message =~ s~\[tab\]~ &nbsp; &nbsp; &nbsp;~ig;
 	$message =~ s~\n~<br />~g;
 }

This fixes the wrong link-wrapping
--- lib/yabb-2.1/Sources/Subs.pl~	2008-03-17 20:29:04 +0200
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-17 20:29:10 +0200
@@ -902,7 +902,7 @@
 #	$message =~ s~ &nbsp; &nbsp; &nbsp;~[tab]~ig;
 	$message =~ s~<br \/>~\n~ig;
 	$message =~ s~<br>~\n~ig;
-	$message =~ s/((\[ch\d{3,}?\]|&\S+?;|\S){$linewrap})/$1\n/ig;
+#	$message =~ s/((\[ch\d{3,}?\]|&\S+?;|\S){$linewrap})/$1\n/ig;
 
 	&FromHTML($message);
 	$message =~ s~[\n\r]~ <yabbbr> ~g;

This de-applied - it does not did what intended to.
--- lib/yabb-2.1/Sources/Subs.pl~	2008-03-17 20:29:10 +0200
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-17 20:32:35 +0200
@@ -925,6 +925,7 @@
 		$message .= "$cur ";
 	}
 	$message =~ s~\[code\](.*?)\[\/code\]~&unwrap($1)~eisg;
+	$message =~ s~\[pre\](.*?)\[\/pre\]~&unwrap($1)~eisg;
 	$message =~ s~ <yabbbr> ~\n~g;
 	$message =~ s~<yabbwrap>~\n~g;



Sun, 23 Mar 2008 02:23:17 +0200
Applied patch (and added <yabb useronline> to Display.template's):
Author: Myhailo Danylenko
Date: Sun, 23 Mar 2008 02:03:50 +0200
Description: Adds routines to handle online status info, adds online indicator to posts

diff -u -Naur ext/lib/yabb-2.1/Languages/English/Display.lng online/lib/yabb-2.1/Languages/English/Display.lng
--- ext/lib/yabb-2.1/Languages/English/Display.lng	2007-10-13 01:19:16.000000000 +0300
+++ online/lib/yabb-2.1/Languages/English/Display.lng	2008-03-23 01:32:46.000000000 +0200
@@ -52,7 +52,8 @@
 '767' => "Next topic",
 '768' => "Previous topic",
 '769' => "Flash location",
-'888' => "Browsing topic"
+'888' => "Browsing topic",
+'online' => 'Online',
 );
 
 $display_polltxt{'2a'} = "Add Poll";
diff -u -Naur ext/lib/yabb-2.1/Languages/Ukrainian/Display.lng online/lib/yabb-2.1/Languages/Ukrainian/Display.lng
--- ext/lib/yabb-2.1/Languages/Ukrainian/Display.lng	2007-10-13 10:19:26.000000000 +0300
+++ online/lib/yabb-2.1/Languages/Ukrainian/Display.lng	2008-03-23 01:33:20.000000000 +0200
@@ -104,8 +104,9 @@
 #'769' => "Flash location",
 '769' => "Flash location",
 #'888' => "Browsing topic"
-'888' => "Browsing topic"
+'888' => "Browsing topic",
 #);
+'online' => 'Online',
 );
 #
 
diff -u -Naur ext/lib/yabb-2.1/Languages/Ukrainian_isb/Display.lng online/lib/yabb-2.1/Languages/Ukrainian_isb/Display.lng
--- ext/lib/yabb-2.1/Languages/Ukrainian_isb/Display.lng	2007-10-01 11:03:25.000000000 +0300
+++ online/lib/yabb-2.1/Languages/Ukrainian_isb/Display.lng	2008-03-23 01:34:22.000000000 +0200
@@ -67,7 +67,8 @@
 #?
 '769' => "Розташування Flash",
 #?
-'888' => "Переглядають гілку"
+'888' => "Переглядають гілку",
+'online' => 'На зв&prime;язку',
 );
 
 #
diff -u -Naur ext/lib/yabb-2.1/Sources/BoardIndex.pl online/lib/yabb-2.1/Sources/BoardIndex.pl
--- ext/lib/yabb-2.1/Sources/BoardIndex.pl	2008-01-10 16:53:05.000000000 +0200
+++ online/lib/yabb-2.1/Sources/BoardIndex.pl	2008-03-23 01:15:53.000000000 +0200
@@ -69,42 +69,57 @@
 	$lastposttime   = 0;
 	$lastthreadtime = 0;
 
-	my $checkadded = 0;
-	$users     = qq~<span class="small">~;
-	$guestlist = qq~<span class="small">~;
-	$guests    = 0;
-	$numusers  = 0;
-	fopen(VARLOG, "$vardir/log.txt");
-	@entries = <VARLOG>;
-	fclose(VARLOG);
-
-	foreach $curentry (@entries) {
-		chomp $curentry;
-		($name, $value, $last_ip) = split(/\|/, $curentry);
-		if (!$last_ip) { $last_ip = qq~</i></span><span class="error">$boardindex_txt{'no_ip'}</span><span class="small"><i>~; }
-		if ($name) {
-			if (-e ("$memberdir/$name.vars")) {
-				unless (${$uid.$name}{'realname'}) { &LoadUser($name); }
-				&LoadMiniUser($name);
-				$numusers++;
-				$users .= qq~$link{$name}~;
-				if (($iamadmin && $show_online_ip_admin) || ($iamgmod && $show_online_ip_gmod)) {
-					$users .= qq~<i> ($last_ip)</i>~;
-				}
-				$users .= qq~, ~;
-			} else {
-				$guests++;
-				if (($iamadmin && $show_online_ip_admin) || ($iamgmod && $show_online_ip_gmod)) {
-					$guestlist .= qq~<i>$last_ip</i>, ~;
-				}
+
+#	my $checkadded = 0;
+	my $users     = qq~<span class="small">~;
+	my $guestlist = qq~<span class="small">~;
+	my $guests    = 0;
+	my $numusers  = 0;
+
+	load_online_users;
+
+	foreach my $login ( keys %online_users ) {
+
+		my ( $value, $last_ip ) = split /\|/, $online_users{$login};
+
+		if ( not $last_ip ) {
+			$last_ip = qq(<span class="error">$boardindex_txt{'no_ip'}</span>)
+		}
+
+		if ( -e "$memberdir/$login.vars" ) {
+
+			LoadUser $login unless exists ${$uid.$login}{'realname'};
+			LoadMiniUser $login;
+
+			$numusers++;
+
+			$users .= "$link{$login}";
+			if ( ( $iamadmin and $show_online_ip_admin )
+			  or ( $iamgmod  and $show_online_ip_gmod  ) ) {
+
+				$users .= " <i>($last_ip)</i>"
+			}
+			$users .= qq~, ~;
+
+		} else {
+
+			$guests++;
+
+			if ( ( $iamadmin and $show_online_ip_admin )
+			  or ( $iamgmod  and $show_online_ip_gmod  ) ) {
+
+				$guestlist .= "<i>$last_ip</i>, "
 			}
 		}
 	}
-	$users =~ s~, \Z~~;
-	$users .= qq~</span>~;
-	if ($numusers) { $users .= qq~<br />~; }
-	$guestlist =~ s~, \Z~~;
-	$guestlist .= qq~</span>~;
+
+	$users  =~ s/, \Z//;
+	$users .=  "</span>";
+	$users .=  "<br />" if $numusers;
+
+	$guestlist  =~ s/, \Z//;
+	$guestlist .=  "</span>";
+
 
 #	$curforumurl = $curposlinks ? qq~<a href="$scripturl" class="nav">$mbname</a>~ : $mbname;
 	if (!$INFO{'catselect'}) {
diff -u -Naur ext/lib/yabb-2.1/Sources/Display.pl online/lib/yabb-2.1/Sources/Display.pl
--- ext/lib/yabb-2.1/Sources/Display.pl	2007-10-19 04:53:51.000000000 +0300
+++ online/lib/yabb-2.1/Sources/Display.pl	2008-03-23 01:38:16.000000000 +0200
@@ -727,6 +727,13 @@
 		$msgimg = qq~<a href="$scripturl?num=$viewnum/$counter#$counter"><img src="$imagesdir/$micon.gif" alt="" border="0" style="vertical-align: middle;" /></a>~;
 		$ipimg  = qq~<img src="$imagesdir/ip.gif" alt="" border="0" style="vertical-align: middle;" />~;
 
+		
+		my $online = ''; #/
+		if ( is_online ( ( $musername =~ m/^Guest/i or $exmem ) ? $mip : $musername ) ) {
+			$online = qq(<span class="online">$display_txt{'online'}</span><br />)
+		}
+
+
 		$posthandelblock =~ s/<yabb quote>/$template_quote/g;
 		$posthandelblock =~ s/<yabb modify>/$template_modify/g;
 		$posthandelblock =~ s/<yabb split>/$template_split/g;
@@ -750,6 +757,7 @@
 		$outblock =~ s/<yabb memberinfo>/$memberinfo/g;
 		$outblock =~ s/<yabb userlink>/$usernamelink/g;
 		$outblock =~ s/<yabb stars>/$star/g;
+		$outblock =~ s/<yabb useronline>/$online/g;
 		$outblock =~ s/<yabb subject>/$msub/g;
 		$outblock =~ s/<yabb msgimg>/$msgimg/g;
 		$outblock =~ s/<yabb msgdate>/$messdate/g;
diff -u -Naur ext/lib/yabb-2.1/Sources/Profile.pl online/lib/yabb-2.1/Sources/Profile.pl
--- ext/lib/yabb-2.1/Sources/Profile.pl	2007-10-15 17:29:36.000000000 +0300
+++ online/lib/yabb-2.1/Sources/Profile.pl	2008-03-23 01:58:14.000000000 +0200
@@ -1110,24 +1110,20 @@
                 ${$uid.$user}{'webtitle'} = $member{'webtitle'};
                 ${$uid.$user}{'weburl'}   = $member{'weburl'};
 		&UserAccount($user, "update");
-		&WriteLog;
+		&WriteLog; # FIXME: strange thing
 
 		if ($emailnewpass && $newpassemail == 1) {
 
 			# Write log
-			fopen(LOG, "$vardir/log.txt");
-			@entries = <LOG>;
-			fclose(LOG);
-			fopen(LOG, ">$vardir/log.txt", 1);
-			$field = "$user";
-			foreach $curentry (@entries) {
-				$curentry =~ s/\n//g;
-				($name, $value) = split(/\|/, $curentry);
-				if ($name ne "$field") {
-					print LOG "$curentry\n";
-				}
+			load_online_users;
+
+			delete $online_users{$user} if exists $online_users{$user};
+
+			fopen LOG, "> $vardir/log.txt", 1;
+			foreach my $login ( keys %online_users ) {
+				print LOG "$login|$online_users{$login}\n";
 			}
-			fclose(LOG);
+			fclose LOG;
 
 			if ($username eq $user) {
 				&UpdateCookie("delete");
@@ -1488,21 +1484,17 @@
 		~;
 	}
 
-	$online = qq~<img src="$imagesdir/off_led.png" alt="${$uid.$user}{'realname'} $profile_txt{'113'} $profile_txt{'687'}" />~;
-	fopen(FILE, "$vardir/log.txt");
-	@entries = <FILE>;
-	fclose(FILE);
-	foreach $curentry (@entries) {
-		chomp $curentry;
-		($name, $value) = split(/\|/, $curentry);
-		if ($name) {
-			&LoadUser($name);
-			if (lc $name eq lc $INFO{'username'}) {
-				$online = qq~<img src="$imagesdir/on_led.png" alt="${$uid.$user}{'realname'} $profile_txt{'113'} $profile_txt{'686'}" />~;
-			}
-		}
+
+	#"# Determine, if user is online
+	my $online = qq(<img src="$imagesdir/off_led.png" alt="${$uid.$user}{'realname'} $profile_txt{'113'} $profile_txt{'687'}" />);
+	
+	load_users_online;
+
+	if ( is_online $user ) {
+		$online = qq(<img src="$imagesdir/on_led.png" alt="${$uid.$user}{'realname'} $profile_txt{'113'} $profile_txt{'686'}" />)
 	}
 
+
 	# Hide empty profile fields from display
 	if ($addmembergroup{$user}) {
 		$showaddgr = $addmembergroup{$user};
diff -u -Naur ext/lib/yabb-2.1/Sources/Subs.pl online/lib/yabb-2.1/Sources/Subs.pl
--- ext/lib/yabb-2.1/Sources/Subs.pl	2008-03-17 20:36:41.000000000 +0200
+++ online/lib/yabb-2.1/Sources/Subs.pl	2008-03-23 00:51:18.000000000 +0200
@@ -56,6 +56,14 @@
 if (-e ("AdminIndex.cgi")) { $yyaext = "cgi"; }
 else { $yyaext = "pl"; }
 
+# data files state indication. U can use fullnames here.
+our %loaded = (
+	online_users => 0,
+);
+
+# login/ip => other log.txt info
+our %online_users;
+
 sub getnewid {
 	my $newid = int(time);
 	while (-e "$datadir/$newid.txt") { ++$newid; }
@@ -1809,6 +1817,41 @@
 	}
 }
 
+# loads online users info from log.txt
+# TODO: Fix other places to use this, add log saving routine?
+sub load_online_users {
+	if ( $loaded{online_users} ) {
+		return 1
+	}
+
+	if ( not open ONLINELOG, "< $vardir/log.txt" ) {
+		return 0
+	}
+
+	%online_users = map {
+			chomp;
+			m/^([^\|]+)\|(.*)$/;
+			$1 => $2
+		} <ONLINELOG>;
+#		} grep m/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\|/, <ONLINELOG>;
+
+	close ONLINELOG;
+
+	$snark_state{online_users} = 1;
+
+	return 1
+}
+
+# returns true (1) if user is online.
+# Intended for use with user logins. Or u should specify IP.
+# TODO: Add check for $username, Guest and Guest-xxx checking to not
+#       load log when it is not necessary?
+sub is_online {
+	load_online_users;
+
+	return exists $online_users{$_[0]}
+}
+
 sub Collapse_Load {
 	my (@userhide, $hidden);
 	$colbutton = 1;


Sun, 23 Mar 2008 14:20:12 +0200
Applied patch to fix guests non-onlineness (also changed Ukrainian translation):
--- lib/yabb-2.1/Sources/Display.pl~	2008-03-23 02:18:01 +0200
+++ lib/yabb-2.1/Sources/Display.pl	2008-03-23 14:18:37 +0200
@@ -504,6 +504,7 @@
 		}
 		$msub ||= $display_txt{'24'};
 		$messdate = &timeformat($mdate);
+		my $mip4online = $mip;
 		if ($iamadmin || $iamgmod && $gmod_access2{'ipban2'} eq "on") { $mip = $mip }
 		else { $mip = "$display_txt{'511'}"; }
 		$sendm = '';
@@ -729,7 +730,7 @@
 
 		
 		my $online = ''; #/
-		if ( is_online ( ( $musername =~ m/^Guest/i or $exmem ) ? $mip : $musername ) ) {
+		if ( is_online ( ( $musername =~ m/^Guest/i or $exmem ) ? $mip4online : $musername ) ) {
 			$online = qq(<span class="online">$display_txt{'online'}</span><br />)
 		}


Mon, 24 Mar 2008 00:13:56 +0200
Updated english rules.
Woohoo. What the hell is it all - that bunch of files in htdocs?? How to deal with it all?
What I should do with them? Seems, there are some mailinglist archives - are they still alive?
Should I modify permissions to allow writes, and what should write what there?


Sun, 30 Mar 2008 06:10:14 +0300
Have added Snark.pl, English Snark.lng, snark.css (only default),
snark_*.png (too), hunting.log and hunting.dat
In process applied next patches:
--- lib/yabb-2.1/Sources/SubList.pl~	2007-12-18 14:45:48 +0200
+++ lib/yabb-2.1/Sources/SubList.pl	2008-03-30 01:57:36 +0200
@@ -18,6 +18,11 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
+'huntlog',"Snark.pl&huntlog_show",
+'showguns',"Snark.pl&show_guns",
+'ghd',"Snark.pl&give_him_damage",
+'rmgwogu',"Snark.pl&revive_me_gwog",
+
 'bwg',"BanWithGroup.pl&banwithgroup",
 'ubwg',"BanWithGroup.pl&unbanwithgroup",
 'ebwg',"BanWithGroup.pl&expirebanwithgroup",
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 01:47:12 +0200
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 02:10:12 +0200
@@ -266,6 +266,8 @@
 
 	$yymain .= qq(\n</div>);
 
+	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
+	
 	&template;
 }
 
@@ -360,6 +362,9 @@
 	$yymain = qq( <div class="huntlog" >\n) .
 			join ( qq( <br />\n), huntlog_get qr/.*/, $count ) .
 			qq( <br />\n</div>);
+	
+	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
+	
 	&template;
 }
 
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 02:10:12 +0200
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 02:18:11 +0200
@@ -314,7 +314,7 @@
 	my $cdate = $date + ( 3600 * $timeoffset );
 
 	print  HUNTLOG map { "$cdate|$_|" . huntlog_format ( "$cdate|$_" ) . "\n" } @hunting_log;
-	fclose HUNTLOG;
+	fclose ( HUNTLOG );
 
 	@hunting_log = ( )
 }
@@ -333,7 +333,7 @@
 
 	my @retval;
 
-	while (<HUNTLOG>) {
+	while ( <HUNTLOG> ) {
 		chomp;
 		my ( $act, $row ) = ( split /\|/, $_ )[3,5];
 
@@ -344,7 +344,7 @@
 		last if @retval >= $num;
 	}
 
-	fclose HUNTLOG;
+	fclose ( HUNTLOG );
 
 	return @retval
 }
--- lib/yabb-2.1/Sources/SubList.pl~	2008-03-30 01:57:36 +0200
+++ lib/yabb-2.1/Sources/SubList.pl	2008-03-30 02:24:41 +0200
@@ -18,6 +18,7 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
+'testpanel',"Snark.pl&test_panel",
 'huntlog',"Snark.pl&huntlog_show",
 'showguns',"Snark.pl&show_guns",
 'ghd',"Snark.pl&give_him_damage",
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 02:18:11 +0200
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 02:33:00 +0200
@@ -653,6 +653,19 @@
 	return $head;
 }
 
+sub test_panel {
+	my $target = $INFO{'target'} || $username;
+	my $place = $INFO{'place'} || '1234/12';
+
+	my $result = panel $target, $place;
+	my $header = snark_header;
+
+	$yymain = qq(<div class="message">Header: <b>$header</b> <br /> $result</div>);
+	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
+
+	&template;
+}
+
 =pod
 	called on any weapon use. params t (target), g (weapon id), p (tid/postnum)
 =cut
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 02:49:24 +0200
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 02:52:12 +0200
@@ -193,7 +193,7 @@
 		return $snark_txt{'guest'}
 	}
 
-	if ( not -f "$membersdir/$login.vars" ) {
+	if ( not -f "$memberdir/$login.vars" ) {
 		return $login
 	}
 
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 04:03:38 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 04:05:06 +0300
@@ -562,7 +562,7 @@
 
 	load_online_users;
 
-	if ( not is_online $login or not $starlog{$username}{life} ) {
+	if ( not is_online $target or not $starlog{$username}{life} ) {
 		return $retval .
 		qq(<div class="snarkpanel"><img src="$imagesdir/snark_panel_closed.png" /></div>)
 	}
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 04:31:15 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 04:55:43 +0300
@@ -259,9 +259,10 @@
 	$yymain = qq( <div class="gundsccontainer">\n);
 
 	foreach my $gun ( keys %damage ) {
-		$yymain .= qq( <div class="gundsc" >\n)	.
-				gun_dsc ( $gun ) .
-				qq(\n</div> );
+		
+		my $dsc = gun_dsc $gun;
+		$dsc =~ s/\n/ <br \/> /g;
+		$yymain .= qq( <div class="gundsc" >\n$dsc\n</div> );
 	}
 
 	$yymain .= qq(\n</div>);


This patch should fix line breaks in board.txt on old non-converted strings.
recyclebin.txt has been fixed manually
--- lib/yabb-2.1/Sources/SetStatus.pl~	2007-11-30 20:39:37 +0200
+++ lib/yabb-2.1/Sources/SetStatus.pl	2008-03-30 05:28:21 +0300
@@ -40,10 +40,11 @@
 	fopen(BOARDFILE, ">$boardsdir/$currentboard.txt") || &fatal_error("$txt{'23'} $currentboard.txt", 1);
 	foreach my $line (@boardfile) {
 		if ($line =~ m~\A$threadid\|~) {
+			chomp $line;
+
 			my ($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate)
 					= split(/\|/o, $line);
 			
-			chomp $mstate;
 			$mstate .= "0" unless ($mstate =~ /0/o);
 
 			if ($mstate =~ /$status/i) {


These patches will show poll results on voting page.
it is simpler too
--- lib/yabb-2.1/Sources/Poll.pl~	2007-11-25 20:43:28 +0200
+++ lib/yabb-2.1/Sources/Poll.pl	2008-03-30 05:42:48 +0300
@@ -518,36 +518,32 @@
 				$options[$i] = $message;
 			}
 
-			if ($has_voted) {
-
-				# Display Poll Results
-				$pollpercent = 0;
-				$pollbar     = 0;
-				if ($totalvotes ne 0 && $maxvote ne 0) {
-					$pollpercent = int(1000 * $votes[$i] / $totalvotes);
-					$pollpercent = $pollpercent / 10;
-					$pollbar     = int(150 * $votes[$i] / $maxvote);
+			my $input = '';
+			if ( not $has_voted ) {
+				
+				if ( $multi_vote ) {
+					$input = qq~<input type="checkbox" name="option$i" value="$i" />~;
+				} else {
+					$input = qq~<input type="radio" name="option" value="$i" />~;
 				}
+			}
 
-				$pollmain .= qq~
-				<div style="clear: both;">
-                <div style="float: left; width: 50%; text-align: right;"><b>$options[$i]&nbsp;&nbsp;</b></div>
-                <div style="float: left; text-align: left;">&nbsp;<img src="$imagesdir/poll_left.gif" align="middle" alt="" /><img src="$imagesdir/poll_middle.gif" height="12" width="$pollbar" align="middle" alt="" /><img src="$imagesdir/poll_right.gif" align="middle" alt="" /> $votes[$i] ($pollpercent%)</div>
-				</div>~;
-
-			} else {
-
-				# Display Poll Options
-				if ($multi_vote) { $input = qq~<input type="checkbox" name="option$i" value="$i" />~; }
-				else { $input = qq~<input type="radio" name="option" value="$i" />~; }
-
-				$pollmain .= qq~
-				<div style="clear: both;">
-                <div style="float: left; width: 25px; text-align: right;">$input</div>
-                <div style="float: left; text-align: left;"><b>$options[$i]</b></div>
-				</div>~;
-
+			# Display Poll Results
+			$pollpercent = 0;
+			$pollbar     = 0;
+			if ($totalvotes ne 0 && $maxvote ne 0) {
+				$pollpercent = int(1000 * $votes[$i] / $totalvotes);
+				$pollpercent = $pollpercent / 10;
+				$pollbar     = int(150 * $votes[$i] / $maxvote);
 			}
+
+			$pollmain .= qq~
+			<div style="clear: both;">
+        <div style="float: left; width: 25px; text-align: right;">$input</div>
+	<div style="float: left; width: 50%; text-align: right;"><b>$options[$i]&nbsp;&nbsp;</b></div>
+	<div style="float: left; text-align: left;">&nbsp;<img src="$imagesdir/poll_left.gif" align="middle" alt="" /><img src="$imagesdir/poll_middle.gif" height="12" width="$pollbar" align="middle" alt="" /><img src="$imagesdir/poll_right.gif" align="middle" alt="" /> $votes[$i] ($pollpercent%)</div>
+			</div>~;
+
 		}
 	}
 	$pollmain .= qq~
--- lib/yabb-2.1/Sources/Poll.pl~	2008-03-30 05:42:48 +0300
+++ lib/yabb-2.1/Sources/Poll.pl	2008-03-30 05:53:10 +0300
@@ -539,8 +539,8 @@
 
 			$pollmain .= qq~
 			<div style="clear: both;">
-        <div style="float: left; width: 25px; text-align: right;">$input</div>
 	<div style="float: left; width: 50%; text-align: right;"><b>$options[$i]&nbsp;&nbsp;</b></div>
+        <div style="float: left; width: 25px; text-align: right;">$input</div>
 	<div style="float: left; text-align: left;">&nbsp;<img src="$imagesdir/poll_left.gif" align="middle" alt="" /><img src="$imagesdir/poll_middle.gif" height="12" width="$pollbar" align="middle" alt="" /><img src="$imagesdir/poll_right.gif" align="middle" alt="" /> $votes[$i] ($pollpercent%)</div>
 			</div>~;
 

Mon, 31 Mar 2008 06:33:03 +0300
patch adds snark system testing routine
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 05:01:15 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 16:27:36 +0300
@@ -536,7 +536,7 @@
 	How to translate?
 	Add tooltips? It's useful!
 =cut
-sub panel {
+sub snark_panel {
 	my $target = shift;
 	my $place = shift;
 
@@ -658,12 +658,16 @@
 	my $target = $INFO{'target'} || $username;
 	my $place = $INFO{'place'} || '1234/12';
 
-	my $result = panel $target, $place;
+	open_huntdata or fatal_error $snark_txt{'erropendata'};
+
+	my $result = snark_panel $target, $place;
 	my $header = snark_header;
 
 	$yymain = qq(<div class="message">Header: <b>$header</b> <br /> $result</div>);
 	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 
+	close_huntdata or fatal_error $snark_txt{'errclosedata'};
+
 	&template;
 }
 

fix
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 16:34:01 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 16:36:00 +0300
@@ -428,7 +428,7 @@
 		return 0
 	}
 
-	if ( not open STARLOG, '+<', "$vardir/hunting.dat" ) {
+	if ( not open ( STARLOG, '+<', "$vardir/hunting.dat" ) ) {
 		return 0
 	}
 

fix for non-resolving names
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 16:40:50 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 16:40:56 +0300
@@ -438,6 +438,8 @@
 
 	$loaded{starlog_write} = 1;
 	$modified{starlog}     = 0;
+
+	return 1
 }
 
 =pod

fix for corrupting datas on save and wrong exit status
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 16:40:56 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 16:42:43 +0300
@@ -455,7 +455,8 @@
 		seek STARLOG, 0, SEEK_SET;
 
 		foreach my $login ( keys %starlog ) {
-			print STARLOG	$starlog{$login}{life}         . '|' .
+			print STARLOG	$login                         . '|' .
+					$starlog{$login}{life}         . '|' .
 					$starlog{$login}{max_life}     . '|' .
 					$starlog{$login}{ammo}         . '|' .
 					$starlog{$login}{death_date}   . '|' .
@@ -474,6 +475,8 @@
 	$loaded{starlog}       = 1;
 	$loaded{starlog_write} = 0;
 	$modified{starlog}     = 0;
+
+	return 1
 }
 
 =pod

add log write testing to test
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 16:42:43 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 17:24:11 +0300
@@ -673,6 +673,12 @@
 
 	close_huntdata or fatal_error $snark_txt{'errclosedata'};
 
+	my @guns = keys %damage;
+	my $gun = $guns[ int ( rand @guns ) ];
+	add_log "$username|$target|$gun|$place";
+	add_log "$username|$target|damage|0";
+	write_log;
+	
 	&template;
 }
 
fix for test
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 17:24:11 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 17:26:43 +0300
@@ -674,10 +674,10 @@
 	close_huntdata or fatal_error $snark_txt{'errclosedata'};
 
 	my @guns = keys %damage;
-	my $gun = $guns[ int ( rand @guns ) ];
-	add_log "$username|$target|$gun|$place";
-	add_log "$username|$target|damage|0";
-	write_log;
+	my $gun = $guns[ int rand @guns ];
+	huntlog_add "$username|$target|$gun|$place";
+	huntlog_add "$username|$target|damage|0";
+	huntlog_write;
 	
 	&template;
 }

fix log non-show
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 17:36:47 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 17:46:21 +0300
@@ -291,6 +291,8 @@
 	} elsif ( $arg =~ /^\d+$/) {
 		$row =~ s/<amount>/$arg/g;
 	}
+
+	return $row
 }
 
 =pod

allow gundescriptions to look good in non-default templates
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 17:46:21 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 19:02:00 +0300
@@ -262,7 +262,7 @@
 		
 		my $dsc = gun_dsc $gun;
 		$dsc =~ s/\n/ <br \/> /g;
-		$yymain .= qq( <div class="gundsc" >\n$dsc\n</div> );
+		$yymain .= qq( <div class="gundsc" >\n<span class="windowbg" >$dsc</span>\n</div> );
 	}
 
 	$yymain .= qq(\n</div>);
@@ -362,9 +362,9 @@
 		$count = 10
 	}
 
-	$yymain = qq( <div class="huntlog" >\n) .
+	$yymain = qq( <div class="huntlog" >\n<span class="windowbg" >) .
 			join ( qq( <br />\n), huntlog_get qr/.*/, $count ) .
-			qq( <br />\n</div>);
+			qq(</span> <br />\n</div>);
 	
 	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 	
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 19:02:00 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 19:04:19 +0300
@@ -362,9 +362,9 @@
 		$count = 10
 	}
 
-	$yymain = qq( <div class="huntlog" >\n<span class="windowbg" >) .
+	$yymain = qq( <div class="huntlog" >\n<div class="windowbg" >) .
 			join ( qq( <br />\n), huntlog_get qr/.*/, $count ) .
-			qq(</span> <br />\n</div>);
+			qq(</div> <br />\n</div>);
 	
 	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 	
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 19:04:19 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 19:06:20 +0300
@@ -262,7 +262,7 @@
 		
 		my $dsc = gun_dsc $gun;
 		$dsc =~ s/\n/ <br \/> /g;
-		$yymain .= qq( <div class="gundsc" >\n<span class="windowbg" >$dsc</span>\n</div> );
+		$yymain .= qq( <div class="gundsc" ><div class="windowbg" >\n$dsc\n</div></div> );
 	}
 
 	$yymain .= qq(\n</div>);
@@ -362,9 +362,9 @@
 		$count = 10
 	}
 
-	$yymain = qq( <div class="huntlog" >\n<div class="windowbg" >) .
+	$yymain = qq( <div class="huntlog" ><div class="windowbg" >\n) .
 			join ( qq( <br />\n), huntlog_get qr/.*/, $count ) .
-			qq(</div> <br />\n</div>);
+			qq(\n</div></div>);
 	
 	$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 	
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 19:06:20 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 19:11:50 +0300
@@ -262,7 +262,7 @@
 		
 		my $dsc = gun_dsc $gun;
 		$dsc =~ s/\n/ <br \/> /g;
-		$yymain .= qq( <div class="gundsc" ><div class="windowbg" >\n$dsc\n</div></div> );
+		$yymain .= qq(<div class="windowbg" >\n$dsc\n</div>);
 	}
 
 	$yymain .= qq(\n</div>);

show panel in thread view
--- lib/yabb-2.1/Sources/Display.pl~	2008-03-30 19:55:03 +0300
+++ lib/yabb-2.1/Sources/Display.pl	2008-03-30 19:55:08 +0300
@@ -733,6 +733,12 @@
 		if ( is_online ( ( $musername =~ m/^Guest/i or $exmem ) ? $mip4online : $musername ) ) {
 			$online = qq(<span class="online">$display_txt{'online'}</span><br />)
 		}
+
+		if ( $snark_enabled ) {
+			require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
+			$star = snark_panel ( $musername, "$viewnum/$counter" );
+			$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
+		}
 		
 		$posthandelblock =~ s/<yabb quote>/$template_quote/g;
 		$posthandelblock =~ s/<yabb modify>/$template_modify/g;

add log on main page
--- /home/isbear/BoardIndex.pl	2008-03-23 02:05:57 +0200
+++ lib/yabb-2.1/Sources/BoardIndex.pl	2008-03-30 20:07:49 +0300
@@ -633,6 +633,15 @@
 
 	$yymain .= qq~$boardindex_template~;
 
+#	$snark_enable=1;
+	if ( $snark_enable ) {
+		require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
+		$yymain .= 	q(<div class="huntlog" ><div class="windowbg" >) .
+				join ( q(<br />), huntlog_get ( qr/.*/, 5 ) ) .
+				q(</div></div>);
+		$yyinlinestyle .= qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
+	}
+
 	if ($imnewcount > 0) {
 		if ($imnewcount > 1) { $en = "s"; $en2 = "$boardindex_imtxt{'47'}"; }
 		else { $en = ""; $en2 = "$boardindex_imtxt{'48'}"; }

reverse log results
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 20:13:31 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-30 20:13:47 +0300
@@ -343,13 +343,13 @@
 		next if not $act =~ m/$filter/;
 
 		push @retval, $row;
-
-		last if @retval >= $num;
 	}
 
 	fclose ( HUNTLOG );
 
-	return @retval
+	@retval = reverse @retval;
+	$#retval = $num if $num < $#retval;
+	return  @retval
 }
 
 sub huntlog_show {

change forum header
--- /home/isbear/Subs.pl	2008-03-30 20:18:04 +0300
+++ lib/yabb-2.1/Sources/Subs.pl	2008-03-30 20:22:47 +0300
@@ -267,7 +267,12 @@
 	$yyboardname = "$mbname";
 	$yytime      = &timeformat($date, 1);
 
-	if ($regdisable) {
+	if ( $snark_enable ) {
+
+		require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
+		$yyuname = snark_header ( $username );
+		
+	} elsif ( $regdisable ) {
 		$yyuname = $iamguest ? qq~$maintxt{'248'} $maintxt{'28'}. $maintxt{'249'} <a href="$scripturl?action=login">$maintxt{'34'}</a>.~ : qq~$maintxt{'247'} $realname, ~;
 	} else {
 		$yyuname = $iamguest ? qq~$maintxt{'248'} $maintxt{'28'}. $maintxt{'249'} <a href="$scripturl?action=login">$maintxt{'34'}</a> $maintxt{'377'} <a href="$scripturl?action=register">$maintxt{'97'}</a>.~ : qq~$maintxt{'247'} $realname, ~;

Add finishing commas to allow normal phrase flow
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-03-30 04:58:10 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-03-30 20:26:42 +0300
@@ -21,10 +21,10 @@
 	dead_star	=> '+',
 
 	notkilled	=> 'nobody yet',
-	head_no		=> 'Hello, <user>!',
-	head_live	=> "Hello, <user>, you have <a href=\"$scripturl?action=showguns\"><life> stars of life and <ammo> stars of ammo</a>",
-	head_dead	=> 'Hello, <user>, you are killed by <killer>.',
-	head_revive	=> qq( <a href="$scripturl?action=rmgwogu" > Hello, <user>, you are dead, but you can now rise to life... </a> ),
+	head_no		=> 'Hello, <user>, ',
+	head_live	=> "Hello, <user>, you have <a href=\"$scripturl?action=showguns\"><life> stars of life and <ammo> stars of ammo</a>, ",
+	head_dead	=> 'Hello, <user>, you are killed by <killer>, ',
+	head_revive	=> qq(<a href="$scripturl?action=rmgwogu" >Hello, <user>, you are dead, but you can now rise to life</a>, ),
 
 	gdsc1		=> '',
 	gdsc2		=> "\nDescription: ",
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-03-30 20:26:42 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-03-30 20:29:22 +0300
@@ -62,7 +62,7 @@
 	dscgun_chainplus => 'Old-good well-balanced CE\'s personal Chaingun++',
 	dscgun_backplus  => 'Back-Firing Gun 9000 - neverseen ease of self-shooting!',
 	dscgun_patrick	 => 'Mad Slack Mojoheads around! Beware!',
-	dscgun_znewad	 => 'SLOVNYK.NET: ZNEWADYTY 1) zwilnyty wid wad',
+	dscgun_znewad	 => 'ZNEWADYTY 1) zwilnyty wid wad',
 	dscgun_tristar	 => 'BPS\'s Three Metheorit Sisters attack. Three spaceships, falling right one after another by the same traectory to allow last to reach Earth face.',
 	dscgun_rlsaber	 => 'Jedai Red Light Saber',
 	dscgun_escalibur => 'Deadly battle doobina Escalibur',

add ammo/hp increase on posting
--- lib/yabb-2.1/Sources/Post.pl~	2007-12-08 11:31:04 +0200
+++ lib/yabb-2.1/Sources/Post.pl	2008-03-30 21:01:36 +0300
@@ -1826,6 +1826,10 @@
 				}
 			}
 			&ManageMemberinfo("update", $username, '', '', $grp_after, ${$uid.$username}{'postcount'});
+
+			require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
+			snark_ammo_up ( );
+
 		} else {
 			&UserAccount($username, "update", "lastpost");
 			&UserAccount($username, "update", "lastonline");

fix log non-displaying of negative damage
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 23:27:11 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-30 23:42:16 +0300
@@ -288,7 +288,7 @@
 
 	if ( $arg =~ s/\/(\d+)$/\/$1#$1/ ) { # :(
 		$row =~ s/<place>(.*?)<\/place>/<a href=\"$scripturl?num=$arg\">$1<\/a>/g;
-	} elsif ( $arg =~ /^\d+$/) {
+	} elsif ( $arg =~ /^[+-]?\d+$/) {
 		$row =~ s/<amount>/$arg/g;
 	}
 

fix background for closed panel
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-30 23:56:37 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 00:07:31 +0300
@@ -572,7 +572,7 @@
 
 	if ( not is_online $target or not $starlog{$username}{life} ) {
 		return $retval .
-		qq(<div class="snarkpanel"><img src="$imagesdir/snark_panel_closed.png" /></div>)
+		qq(<img src="$imagesdir/snark_panel_closed.png" style="width: 133px" />)
 	}
 
 	my $cdate = $date + ( 3600 * $timeoffset );

allow posts to use per-css variant panel images
--- ../../../lib/yabb-2.1/Sources/Display.pl~	2008-03-30 19:55:08 +0300
+++ ../../../lib/yabb-2.1/Sources/Display.pl	2008-03-31 04:16:42 +0300
@@ -736,7 +736,7 @@
 
 		if ( $snark_enabled ) {
 			require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
-			$star = snark_panel ( $musername, "$viewnum/$counter" );
+			$star = snark_panel ( $musername, "$viewnum/$counter", $counter % $cssnum );
 			$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 		}
 		

(Here Snark.pl has changed to handle post css variant in upper
and downer panel images before this change, images added accordingly)
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 04:12:23 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 04:24:46 +0300
@@ -547,7 +547,7 @@
 sub snark_panel {
 	my $target  = shift;
 	my $place   = shift;
-	my $variant = shift || '';
+	my $variant = shift || 0;
 
 	load_huntdata;
 

typo
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 04:24:46 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 04:36:39 +0300
@@ -69,7 +69,7 @@
 }
 =cut
 
-$loaaded{'Snark.pl'} = 1;
+$loaded{'Snark.pl'} = 1;
 
 =pod
 

fix wrong dates - we will save gm time, timeformat will format it for us
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 04:36:39 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 04:45:34 +0300
@@ -315,9 +315,9 @@
 		return 0
 	}
 
-	my $cdate = $date + ( 3600 * $timeoffset );
+#	my $cdate = $date + ( 3600 * $timeoffset );
 
-	print  HUNTLOG map { "$cdate|$_|" . huntlog_format ( "$cdate|$_" ) . "\n" } @hunting_log;
+	print  HUNTLOG map { "$date|$_|" . huntlog_format ( "$date|$_" ) . "\n" } @hunting_log;
 	fclose ( HUNTLOG );
 
 	@hunting_log = ( )
@@ -577,7 +577,7 @@
 		qq(<img src="$imagesdir/snark_panel_closed.png" style="width: 133px" />)
 	}
 
-	my $cdate = $date + ( 3600 * $timeoffset );
+#	my $cdate = $date + ( 3600 * $timeoffset );
 
 	$retval .= qq~<div class="snarkpanel"><img src="$imagesdir/snark_panel_up${variant}.png" />~;
 
@@ -596,7 +596,7 @@
 			$active = 0
 		}
 
-		if ( $damage{$gun}{load} > $cdate - $starlog{$username}{shot_date} ) {
+		if ( $damage{$gun}{load} > $date - $starlog{$username}{shot_date} ) {
 			$active = 0
 		}
 
@@ -638,14 +638,14 @@
 
 	load_huntdata;
 
-	my $cdate = $date + ( 3600 * $timeoffset );
+#	my $cdate = $date + ( 3600 * $timeoffset );
 	my $head;
 
 	if ( not exists $starlog{$username} and not try_add_to_data $username ) {
 		$head = $snark_txt{'head_no'}
 	} elsif ( $starlog{$username}{life} ) {
 		$head = $snark_txt{'head_live'}
-	} elsif ( $starlog{$username}{death_date} < $cdate ) {
+	} elsif ( $starlog{$username}{death_date} < $date ) {
 		$head = $snark_txt{'head_revive'}
 	} else {
 		$head = $snark_txt{'head_dead'}
@@ -704,7 +704,7 @@
 	fatal_error $snark_txt{'invaldmg'} . $dtype
 			if $dtype !~ m/^\w+$/ or not exists $damage{$dtype};
 
-	my $cdate = $date + ( 3600 * $timeoffset );
+#	my $cdate = $date + ( 3600 * $timeoffset );
 #	my ( $lsec, $lmin, $lhour, $ldate, $lmon, undef ) = gmtime $cdate;
 	fatal_error $snark_txt{'nosnarks'}
 			unless $snark_enabled;
@@ -728,7 +728,7 @@
 		$err = $snark_txt{'cantloaduser'} . $username
 	}
 
-	if ( not $err and $starlog{$username}{shot_date} + $damage{$dtype}{load} > $cdate ) {
+	if ( not $err and $starlog{$username}{shot_date} + $damage{$dtype}{load} > $date ) {
 		$err = $snark_txt{'loading'}
 	}
 
@@ -742,7 +742,7 @@
 		my $dmg = $starlog{$username}{life};
 
 		$starlog{$username}{life} = 0;
-		$starlog{$username}{death_date} = $cdate + 600;
+		$starlog{$username}{death_date} = $date + 600;
 		$starlog{$username}{deaths_count}++;
 
 		$modified{starlog} = 1;
@@ -806,7 +806,7 @@
 
 				$starlog{$target}{life}       = 0;
 				$starlog{$target}{killed_by}  = $username;
-				$starlog{$target}{death_date} = $cdate + $damage{$dtype}{termin};
+				$starlog{$target}{death_date} = $date + $damage{$dtype}{termin};
 				$starlog{$target}{deaths_count}++;
 				
 				$starlog{$username}{has_killed}++;
@@ -857,9 +857,9 @@
 				}
 				
 				if ( not $starlog{$target}{life} and
-				$starlog{$target}{death_date} < $cdate + $damage{$dtype}{termin} ) {
+				$starlog{$target}{death_date} < $date + $damage{$dtype}{termin} ) {
 					
-					$starlog{$target}{death_date} = $cdate + $damage{$dtype}{termin};
+					$starlog{$target}{death_date} = $date + $damage{$dtype}{termin};
 					huntlog_add "$username|$target|rekill|$damage{$dtype}{termin}"
 				}
 			}
@@ -891,7 +891,7 @@
 				huntlog_add "$username|$dtype|cost|$cost"
 			}
 
-			$starlog{$username}{shot_date} = $cdate;
+			$starlog{$username}{shot_date} = $date;
 
 			$modified{starlog} = 1;
 		}
@@ -930,15 +930,15 @@
 		$err = $snark_txt{'younotdead'}
 	}
 
-	my $cdate = $date + ( 3600 * $timeoffset );
+#	my $cdate = $date + ( 3600 * $timeoffset );
 
-	if ( not $err and $starlog{$username}{death_date} > $cdate ) {
+	if ( not $err and $starlog{$username}{death_date} > $date ) {
 		$err = $snark_txt{'restmore'}
 	}
 
 	if ( not $err ) {
 		$starlog{$username}{life}      = $starlog{$username}{max_life};
-		$starlog{$username}{shot_date} = $cdate;
+		$starlog{$username}{shot_date} = $date;
 		$modified{starlog} = 1;
 
 		huntlog_add "I'z-chan|$username|izrevive|$starlog{$username}{life}"

do not use "Today" in dates - we fix log, so.. (maybe we unfix someday log)
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 04:54:36 +0300
@@ -282,7 +282,7 @@
 	my $row = $snark_txt{'logevt_'.$act};
 	$row = $row->[ int rand @{$row} ];
 
-	$edate = timeformat $edate;
+	$edate = timeformat $edate, 1;
 	$row =~ s/<date>/$edate/g;
 	$row =~ s/<actor>/ get_nickname $who /eg;
 	$row =~ s/<target>/ get_nickname $whom /eg;

fix
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 05:07:21 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 05:12:11 +0300
@@ -737,7 +737,7 @@
 	}
 
 
-	if ( $target eq 'yurchor' ) {
+	if ( not $err and $target eq 'yurchor' ) {
 		
 		my $dmg = $starlog{$username}{life};
 
fix boojim non-recognizing
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 05:12:11 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 05:14:46 +0300
@@ -737,7 +737,7 @@
 	}
 
 
-	if ( not $err and $target eq 'yurchor' ) {
+	if ( not $err and $login eq 'yurchor' ) {
 		
 		my $dmg = $starlog{$username}{life};
 

fix killer for boojim case
--- ../../../lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 05:14:46 +0300
+++ ../../../lib/yabb-2.1/Sources/Snark.pl	2008-03-31 05:18:30 +0300
@@ -744,6 +744,8 @@
 		$starlog{$username}{life} = 0;
 		$starlog{$username}{death_date} = $date + 600;
 		$starlog{$username}{deaths_count}++;
+		$starlog{$username}{killed_by} = 'Boojim';
+		# Should'we apply cost?
 
 		$modified{starlog} = 1;
 

filter forum main page log
--- lib/yabb-2.1/Sources/BoardIndex.pl~	2008-03-30 20:14:45 +0300
+++ lib/yabb-2.1/Sources/BoardIndex.pl	2008-03-31 06:30:18 +0300
@@ -636,7 +636,7 @@
 	if ( $snark_enable ) {
 		require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
 		$yymain .= 	q(<div class="huntlog" ><div class="windowbg" >) .
-				join ( q(<br />), huntlog_get ( qr/.*/, 5 ) ) .
+				join ( q(<br />), huntlog_get ( qr/(kill|revive|bomb|patrick|tristar|rlsaber|esca|boyan|giggle|watch)/, 5 ) ) .
 				q(</div></div>);
 		$yyinlinestyle .= qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
 	}



Comment no more necessary (and even more) test routine
--- linux.org.ua/lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 05:32:53 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Snark.pl	2008-03-31 07:03:07 +0300
@@ -643,6 +643,7 @@
 	return $head;
 }
 
+=pod
 sub test_panel {
 	my $target = $INFO{'target'} || $username;
 	my $place = $INFO{'place'} || '1234/12';
@@ -665,6 +666,7 @@
 	
 	&template;
 }
+=cut
 
 =pod
 	called on any weapon use. params t (target), g (weapon id), p (tid/postnum)

--- linux.org.ua/lib/yabb-2.1/Sources/SubList.pl~	2008-03-30 02:24:41 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/SubList.pl	2008-03-31 07:02:16 +0300
@@ -18,7 +18,6 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
-'testpanel',"Snark.pl&test_panel",
 'huntlog',"Snark.pl&huntlog_show",
 'showguns',"Snark.pl&show_guns",
 'ghd',"Snark.pl&give_him_damage",

fix wrong option name
--- lib/yabb-2.1/Sources/Display.pl~	2008-03-31 04:16:42 +0300
+++ lib/yabb-2.1/Sources/Display.pl	2008-03-31 07:08:36 +0300
@@ -734,7 +734,7 @@
 			$online = qq(<span class="online">$display_txt{'online'}</span><br />)
 		}
 
-		if ( $snark_enabled ) {
+		if ( $snark_enable ) {
 			require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
 			$star = snark_panel ( $musername, "$viewnum/$counter", $counter % $cssnum );
 			$yyinlinestyle = qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 07:03:07 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-31 07:09:09 +0300
@@ -689,7 +689,7 @@
 #	my $cdate = $date + ( 3600 * $timeoffset );
 #	my ( $lsec, $lmin, $lhour, $ldate, $lmon, undef ) = gmtime $cdate;
 	fatal_error $snark_txt{'nosnarks'}
-			unless $snark_enabled;
+			unless $snark_enable;
 #			unless $lmon == 4 and $ldate == 1;
 


Mon, 31 Mar 2008 20:12:41 +0300
No, in a such way it can't be. I should note chages.
Added ukrainian translation, added ability to not hit self, added three weapons,
but have not noted it all there! Also not updated english translation!!!
there are new string in dscgun - 11 and three weapons

add offline shooting flag
--- /home/isbear/Snark.pl~	2008-03-31 19:57:14 +0300
+++ /home/isbear/Snark.pl	2008-03-31 21:37:04 +0300
@@ -117,45 +117,45 @@
 &LoadLanguage ('Snark') if not $loaded{'Snark.lng'};
 
 our %damage = (
-	giggle => { amount => 0,       cost => 0,  load => 60,  area => 0,  dead => 1, termin => 0,   self => 1, level => 0 },
-	boyan  => { amount => 0,       cost => 0,  load => 120, area => 0,  dead => 1, termin => 0,   self => 1, level => 0 },
-	star   => { amount => 1,       cost => 1,  load => 40,  area => 0,  dead => 0, termin => 300, self => 0, level => 1 },
-	plus   => { amount => 3,       cost => 3,  load => 60,  area => 0,  dead => 0, termin => 420, self => 0, level => 2 },
-	ban    => { amount => '100%',  cost => 9,  load => 120, area => 0,  dead => 0, termin => 900, self => 0, level => 4 },
-	bomb   => { amount => '2d13',  cost => 25, load => 90,  area => 1,  dead => 1, termin => 600, self => 1, level => 1 },
-	minus  => { amount => -3,      cost => 3,  load => 45,  area => -1, dead => 0, termin => 0,   self => 1, level => 1 },
-	heal   => { amount => '-34%',  cost => 1,  load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, level => 2 },
-	revive => { amount => '-100%', cost => 20, load => 180, area => 1,  dead => 1, termin => 0,   self => 1, level => 3 },
+	giggle => { amount => 0,       cost => 0,  load => 60,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
+	boyan  => { amount => 0,       cost => 0,  load => 120, area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
+	star   => { amount => 1,       cost => 1,  load => 40,  area => 0,  dead => 0, termin => 300, self => 0, offline => 0, level => 1 },
+	plus   => { amount => 3,       cost => 3,  load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
+	ban    => { amount => '100%',  cost => 9,  load => 120, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
+	bomb   => { amount => '2d13',  cost => 25, load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
+	minus  => { amount => -3,      cost => 3,  load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
+	heal   => { amount => '-34%',  cost => 1,  load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
+	revive => { amount => '-100%', cost => 20, load => 180, area => 1,  dead => 1, termin => 0,   self => 1, offline => 1, level => 3 },
 
 	# old cthulhu - lvm scene
-	messiah   => { amount => '-100%', cost => 0,        load => 120,  area => 0,  dead => 1, termin => 0,   self => 1, level => -1, owner => 'lvm' },
+	messiah   => { amount => '-100%', cost => 0,        load => 120,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'lvm' },
 	# just what forum admin needs
-	ungrave   => { amount => '-100%', cost => '33%',    load => 3600, area => 3,  dead => 1, termin => 0,   self => 0, level => -1, owner => 'ISBear' },
+	ungrave   => { amount => '-100%', cost => '33%',    load => 3600, area => 3,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'ISBear' },
 	# I like SSG
-	ssb       => { amount => '14d2',  cost => 22,       load => 300,  area => 0,  dead => 0, termin => 720, self => 0, level => -1, owner => 'ISBear' },
+	ssb       => { amount => '14d2',  cost => 22,       load => 300,  area => 0,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'ISBear' },
 	# big bro, noblesse oblige
-	watch     => { amount => 0,       cost => 0,        load => 10,   area => 0,  dead => 1, termin => 0,   self => 0, level => -1, owner => 'Praporshic' },
+	watch     => { amount => 0,       cost => 0,        load => 10,   area => 0,  dead => 1, termin => 0,   self => 0, offline => 0, level => -1, owner => 'Praporshic' },
 	# second-time given plusgun
-	chainplus => { amount => 3,       cost => 3,        load => 10,   area => 0,  dead => 0, termin => 420, self => 0, level => -1, owner => 'Praporshic' },
+	chainplus => { amount => 3,       cost => 3,        load => 10,   area => 0,  dead => 0, termin => 420, self => 0, offline => 1, level => -1, owner => 'Praporshic' },
 	# just for ease of self-shooting
-	backplus  => { amount => 3,       cost => -3,       load => 60,   area => -1, dead => 0, termin => 300, self => 1, level => -1, owner => 'Cthulhu' },
+	backplus  => { amount => 3,       cost => -3,       load => 60,   area => -1, dead => 0, termin => 300, self => 1, offline => 1, level => -1, owner => 'Cthulhu' },
 	# old saying about moderator-mojohead
-	patrick   => { amount => '100%',  cost => 100,      load => 300,  area => 2,  dead => 0, termin => 600, self => 1, level => -1, owner => 'Cthulhu' },
+	patrick   => { amount => '100%',  cost => 100,      load => 300,  area => 2,  dead => 0, termin => 600, self => 1, offline => 0, level => -1, owner => 'Cthulhu' },
 	# frequently-discussed question
-	znewad    => { amount => '-100%', cost => 10,       load => 60,   area => 0,  dead => 0, termin => 0,   self => 1, level => -1, owner => 'DalekiyObriy' },
+	znewad    => { amount => '-100%', cost => 10,       load => 60,   area => 0,  dead => 0, termin => 0,   self => 1, offline => 1, level => -1, owner => 'DalekiyObriy' },
 	# the only person, about which I know, that he has breaked into some machine
-	tristar   => { amount => '30d2',  cost => 70,       load => 900,  area => 1,  dead => 0, termin => 720, self => 0, level => -1, owner => 'Abram' },
+	tristar   => { amount => '30d2',  cost => 70,       load => 900,  area => 1,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'Abram' },
 	# according to avatar, by request of working peoples...
-	rlsaber   => { amount => '6d4',   cost => '6d4',    load => 90,   area => 0,  dead => 0, termin => 360, self => 0, level => -1, owner => 'Piktor' },
+	rlsaber   => { amount => '6d4',   cost => '6d4',    load => 90,   area => 0,  dead => 0, termin => 360, self => 0, offline => 0, level => -1, owner => 'Piktor' },
 	# the only active female being on forum (except early anatolijd =) )
 	# just the way to show to someone, that his (probably, target is male) actions are not good
-	escalibur => { amount => '100%',  cost => 'damage', load => 100,  area => 0,  dead => 0, termin => 30,  self => 0, level => -1, owner => 'myroslava' },
+	escalibur => { amount => '100%',  cost => 'damage', load => 100,  area => 0,  dead => 0, termin => 30,  self => 0, offline => 0, level => -1, owner => 'myroslava' },
 	# each stick have two ends
-	esca_res  => { amount => '-100%', cost => 'damage', load => 100,  area => 0,  dead => 1, termin => 0,   self => 0, level => -1, owner => 'myroslava' },
+	esca_res  => { amount => '-100%', cost => 'damage', load => 100,  area => 0,  dead => 1, termin => 0,   self => 0, offline => 0, level => -1, owner => 'myroslava' },
 	# cost - depending on damage, namely, on durability of someone's head
-	pjata     => { amount => '10%',   cost => 'damage', load => 50,   area => 0,  dead => 0, termin => 30,  self => 0, level => -1, owner => 'Olexandr_Kravchuk' },
+	pjata     => { amount => '10%',   cost => 'damage', load => 50,   area => 0,  dead => 0, termin => 30,  self => 0, offline => 0, level => -1, owner => 'Olexandr_Kravchuk' },
 	# 
-	flambring => { amount => '1d3',   cost => 1,        load => 5,    area => 1,  dead => 0, termin => 360, self => 0, level => -1, owner => 'Olexandr_Kravchuk' },
+	flambring => { amount => '1d3',   cost => 1,        load => 5,    area => 1,  dead => 0, termin => 360, self => 0, offline => 0, level => -1, owner => 'Olexandr_Kravchuk' },
 );
 
 $loaded{guns} = 1;
@@ -236,6 +236,7 @@
 		$snark_txt{'gdsc6'} . $snark_txt{'gdsc6_'.$damage{$gun}{area}} .
 		$snark_txt{'gdsc7'} . $snark_txt{'gdsc7_'.$damage{$gun}{dead}} .
 		$snark_txt{'gdsc11'} . $snark_txt{'gdsc7_'.$damage{$gun}{self}} .
+		$snark_txt{'gdsc12'} . $snark_txt{'gdsc7_'.$damage{$gun}{offline}} .
 		$snark_txt{'gdsc8'} . $damage{$gun}{termin} .
 		( $damage{$gun}{level} != -1 ? 
 			$snark_txt{'gdsc9'} . $damage{$gun}{level} :
@@ -560,7 +561,7 @@
 
 	load_online_users;
 
-	if ( not is_online $target or not $starlog{$username}{life} ) {
+	if ( not $starlog{$username}{life} ) {
 		return $retval .
 		qq(<img src="$imagesdir/snark_panel_closed.png" style="width: 133px" />)
 	}
@@ -579,9 +580,13 @@
 		}
 		
 		my $active = 1;
+		
+		if ( not $damage{$gun}{offline} and not is_online $target ) {
+			next
+		}
 
 		if ( not $starlog{$target}{life} and not $damage{$gun}{dead} ) {
-			$active = 0
+			next
 		}
 
 		if ( $damage{$gun}{load} > $date - $starlog{$username}{shot_date} ) {
@@ -727,8 +732,8 @@
 	}
 
 
-	if ( not $err and $login eq 'yurchor' ) {
-		
+	if ( not $err and $login eq 'yurchor' and $username ne 'yurchor' ) {
+
 		my $dmg = $starlog{$username}{life};
 
 		$starlog{$username}{life} = 0;
@@ -739,9 +744,9 @@
 
 		$modified{starlog} = 1;
 
-		huntlog_add "$username|Boojim|$dtype|$place";
-		huntlog_add "Boojim|$username|damage|$dmg";
-		huntlog_add "Boojim|$username|kill|600";
+		huntlog_add "$username|Boojum|$dtype|$place";
+		huntlog_add "Boojum|$username|damage|$dmg";
+		huntlog_add "Boojum|$username|kill|600";
 
 	} elsif ( not $err ) {
 
@@ -756,7 +761,7 @@
 
 		} elsif ( $damage{$dtype}{area} == 0 ) {
 
-			if ( is_online $login ) {
+			if ( is_online $login or $damage{$dtype}{offline} ) {
 
 				@targets = ( $login );
 			# 

fixed offline permissions for prapor's guns
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 21:41:57 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-31 21:44:47 +0300
@@ -134,9 +134,9 @@
 	# I like SSG
 	ssb       => { amount => '14d2',  cost => 22,       load => 300,  area => 0,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'ISBear' },
 	# big bro, noblesse oblige
-	watch     => { amount => 0,       cost => 0,        load => 10,   area => 0,  dead => 1, termin => 0,   self => 0, offline => 0, level => -1, owner => 'Praporshic' },
+	watch     => { amount => 0,       cost => 0,        load => 10,   area => 0,  dead => 1, termin => 0,   self => 0, offline => 1, level => -1, owner => 'Praporshic' },
 	# second-time given plusgun
-	chainplus => { amount => 3,       cost => 3,        load => 10,   area => 0,  dead => 0, termin => 420, self => 0, offline => 1, level => -1, owner => 'Praporshic' },
+	chainplus => { amount => 3,       cost => 3,        load => 10,   area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => -1, owner => 'Praporshic' },
 	# just for ease of self-shooting
 	backplus  => { amount => 3,       cost => -3,       load => 60,   area => -1, dead => 0, termin => 300, self => 1, offline => 1, level => -1, owner => 'Cthulhu' },
 	# old saying about moderator-mojohead

sync lang accordingly
--- lib/yabb-2.1/Languages/Ukrainian/Snark.lng~	2008-03-31 20:05:36 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/Snark.lng	2008-03-31 21:43:20 +0300
@@ -41,6 +41,7 @@
 	gdsc7_0		=> 'не діє',
 	gdsc7_1		=> 'діє',
 	gdsc11		=> "\nНа стріляючого: ",
+	gdsc12		=> "\nНа неприсутніх: ",
 	gdsc8		=> "\nВбиває на: ",
 	gdsc9		=> " секунд\nПотребує рівень: ",
 	gdsc10		=> " секунд\nВласник: ",

added panel checking for self-shooting flag
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 21:44:47 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-03-31 21:49:37 +0300
@@ -585,6 +585,10 @@
 			next
 		}
 
+		if ( $username eq $target and not $damage{$gun}{self} ) {
+			next
+		}
+
 		if ( not $starlog{$target}{life} and not $damage{$gun}{dead} ) {
 			next
 		}

sync for english lang
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-03-31 15:41:29 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-03-31 22:10:44 +0300
@@ -41,6 +41,8 @@
 	gdsc7_0		=> 'not applicable',
 	gdsc7_1		=> 'applicable',
 	gdsc8		=> "\nDeath time: ",
+	gdsc11		=> "\nSelf-applicability: ",
+	gdsc12		=> "\nOffline-applicability: ",
 	gdsc9		=> " seconds\nRequired level: ",
 	gdsc10		=> " seconds\nOwner: ",
 	gdscend		=> '',
@@ -58,6 +60,7 @@
 
 	dscgun_messiah	 => 'Messiah Hand',
 	dscgun_ungrave	 => 'Ungrave Spell - just what every necroadmin needs...',
+	dscgun_ssb	 => 'Super Shot Ban - choice of each doomer',
 	dscgun_watch	 => 'Big Brother Watches You!',
 	dscgun_chainplus => 'Old-good well-balanced CE\'s personal Chaingun++',
 	dscgun_backplus  => 'Back-Firing Gun 9000 - neverseen ease of self-shooting!',
@@ -67,6 +70,8 @@
 	dscgun_rlsaber	 => 'Sith Red Light Saber',
 	dscgun_escalibur => 'Deadly battle doobina Escalibur',
 	dscgun_esca_res  => 'Magic angelic resurrecting stick Escalibur - every doobina have the other end...',
+	dscgun_pjata	 => 'True Masters use just their heels to defend self',
+	dscgun_flambring => 'There are ancient legends about Kantid, dark flame angel, defender of weak. This is definitely him - Flamebringer - where he leaves his signs soon begins flame.',
 
 
 	gunname_giggle	=> 'Giggle',
@@ -81,6 +86,7 @@
 
 	gunname_messiah	  => 'Messiah Hand',
 	gunname_ungrave	  => 'Ungrave Spell',
+	gunname_ssb 	  => 'SSB',
 	gunname_watch	  => 'Big Brother&prime;s Eye',
 	gunname_chainplus => 'CE&prime;s personal Chaingun++',
 	gunname_backplus  => 'Cthulhu&prime;s personal Back-Firing Gun 9000',
@@ -90,6 +96,8 @@
 	gunname_rlsaber   => 'Red Light Saber',
 	gunname_escalibur => 'Escalibur (battle mode)',
 	gunname_esca_res  => 'Escalibur (resurrect mode)',
+	gunname_pjata	  => 'Heel',
+	gunname_flambring => 'Flamebringer',
 
 
 	gunsign_giggle	=> '<span style="color:yellow">:-)</span>',
@@ -104,6 +112,7 @@
 
 	gunsign_messiah	  => '<span style="color:brown">{M}</span>',
 	gunsign_ungrave	  => '<span style="color:darkgreen">{U}</span>',
+	gunsign_ssb       => 'SSB',
 	gunsign_watch	  => '&lt;@&gt;',
 	gunsign_chainplus => '<span style="color:darkred">+++</span>',
 	gunsign_backplus  => '<span style="color:darkred">BFG</span>',
@@ -113,6 +122,8 @@
 	gunsign_rlsaber   => '<span style="color:brightred">&nbsp;!&nbsp;</span>',
 	gunsign_escalibur => '<span style="color:darkred">-##</span>',
 	gunsign_esca_res  => '<span style="color:darkred">(:)</span>',
+	gunsign_pjata     => '<span style="color:#FFDDAA">o_E</span>',
+	gunsign_flambring => '<span style="color:#FFCC55">{$}</span>',
 
 
 	logevt_cost	=> [ '[<date>] <actor> has spended <amount> stars' ],
@@ -120,7 +131,7 @@
 	logevt_kill	=> [ '[<date>] <actor> has killed <target> (<amount> secs)' ],
 	logevt_rekill	=> [ '[<date>] <actor> damages the corpse of <target> (<amount> secs)' ],
 	logevt_izrevive => [ '[<date>] <actor>: <target>, <target>, you can\'t die even before the story starts!' ],
-	logevt_boojim   => [ '[<date>] <actor> disappeared - his snark is boojim!' ],
+	logevt_boojim   => [ '[<date>] <actor> disappeared - his snark is boojum!' ],
 	
 	logevt_giggle	=> [ '[<date>] <actor> ROFLs from <target>\'s <place>post</place>',
 				'[<date>] <actor> LOLs on <target>\'s <place>post</place>' ],
@@ -138,6 +149,7 @@
 
 	logevt_messiah	 => [ '[<date>] <actor> returns <target> to life with soft touch of hand' ],
 	logevt_ungrave	 => [ '[<date>] <actor> does terrible Ungrave Spell dark mess...' ],
+	logevt_ssb	 => [ '[<date>] <actor> shoots <target> with SSB' ],
 	logevt_watch	 => [ '[<date>] Big Brother watches <target>',
 					'[<date>] <target>, Big Brother is watching You!' ],
 	logevt_chainplus => [ '[<date>] Ta-ta-ta-ta! <actor> opens rapid fire to <target>' ],
@@ -148,6 +160,8 @@
 	logevt_rlsaber   => [ '[<date>] There are red splashes... Someone\'s life has been ended.' ],
 	logevt_escalibur => [ '[<date>] Pi-piru-piru-piru-pi-piru-pi!..' ],
 	logevt_esca_res  => [ '[<date>] Pi-piru-pi-pi!..' ],
+	logevt_pjata     => [ '[<date>] Fast, like thunder, gesture of <actor>\'s heel, and <target> have now star nimb around head' ],
+	logevt_flambring => [ '[<date>] Oh! It\'s becomes hot here!' ],
 );
 
 $loaded{'Snark.lng'} = 1;

fix for wrong log minus-damage amount and extra rekills on zero-termin guns
--- lib/yabb-2.1/Sources/Snark.pl~	2008-03-31 23:33:12 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 00:02:21 +0300
@@ -828,7 +828,7 @@
 
 				if ( $starlog{$target}{life} > $starlog{$target}{max_life} ) {
 
-					$dmg -= $starlog{$target}{life} - $starlog{$target}{max_life};
+					$dmg -= $starlog{$target}{max_life} - $starlog{$target}{life};
 					$starlog{$target}{life} = $starlog{$target}{max_life};
 				}
 
@@ -850,7 +850,7 @@
 
 				} elsif ( $starlog{$target}{life} > $starlog{$target}{max_life} ) {
 
-					$dmg -= $starlog{$target}{life} - $starlog{$target}{max_life};
+					$dmg -= $starlog{$target}{max_life} - $starlog{$target}{life};
 					$starlog{$target}{life} = $starlog{$target}{max_life};
 				}
 
@@ -861,7 +861,7 @@
 					$full_damage += $dmg;
 				}
 				
-				if ( not $starlog{$target}{life} and
+				if ( not $starlog{$target}{life} and $damage{$dtype}{termin} and
 				$starlog{$target}{death_date} < $date + $damage{$dtype}{termin} ) {
 					
 					$starlog{$target}{death_date} = $date + $damage{$dtype}{termin};

small balancing
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 00:02:21 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 00:17:58 +0300
@@ -117,15 +117,15 @@
 &LoadLanguage ('Snark') if not $loaded{'Snark.lng'};
 
 our %damage = (
-	giggle => { amount => 0,       cost => 0,  load => 60,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
-	boyan  => { amount => 0,       cost => 0,  load => 120, area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
-	star   => { amount => 1,       cost => 1,  load => 40,  area => 0,  dead => 0, termin => 300, self => 0, offline => 0, level => 1 },
-	plus   => { amount => 3,       cost => 3,  load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
-	ban    => { amount => '100%',  cost => 9,  load => 120, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
-	bomb   => { amount => '2d13',  cost => 25, load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
-	minus  => { amount => -3,      cost => 3,  load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
-	heal   => { amount => '-34%',  cost => 1,  load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
-	revive => { amount => '-100%', cost => 20, load => 180, area => 1,  dead => 1, termin => 0,   self => 1, offline => 1, level => 3 },
+	giggle => { amount => 0,       cost => 0,         load => 60,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
+	boyan  => { amount => 0,       cost => 0,         load => 120, area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
+	star   => { amount => 1,       cost => 1,         load => 40,  area => 0,  dead => 0, termin => 300, self => 0, offline => 0, level => 1 },
+	plus   => { amount => 3,       cost => 3,         load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
+	ban    => { amount => '100%',  cost => 'damage',  load => 120, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
+	bomb   => { amount => '2d13',  cost => 25,        load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
+	minus  => { amount => -3,      cost => 3,         load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
+	heal   => { amount => '-34%',  cost => 1,         load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
+	revive => { amount => '-100%', cost => 20,        load => 180, area => 1,  dead => 1, termin => 0,   self => 1, offline => 1, level => 3 },
 
 	# old cthulhu - lvm scene
 	messiah   => { amount => '-100%', cost => 0,        load => 120,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'lvm' },

more balancing
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 00:17:58 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 00:26:45 +0300
@@ -121,14 +121,14 @@
 	boyan  => { amount => 0,       cost => 0,         load => 120, area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
 	star   => { amount => 1,       cost => 1,         load => 40,  area => 0,  dead => 0, termin => 300, self => 0, offline => 0, level => 1 },
 	plus   => { amount => 3,       cost => 3,         load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
-	ban    => { amount => '100%',  cost => 'damage',  load => 120, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
+	ban    => { amount => '100%',  cost => 'damage',  load => 300, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
 	bomb   => { amount => '2d13',  cost => 25,        load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
 	minus  => { amount => -3,      cost => 3,         load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
-	heal   => { amount => '-34%',  cost => 1,         load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
+	heal   => { amount => '-34%',  cost => 3,         load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
 	revive => { amount => '-100%', cost => 20,        load => 180, area => 1,  dead => 1, termin => 0,   self => 1, offline => 1, level => 3 },
 
 	# old cthulhu - lvm scene
-	messiah   => { amount => '-100%', cost => 0,        load => 120,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'lvm' },
+	messiah   => { amount => '-100%', cost => 0,        load => 180,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'lvm' },
 	# just what forum admin needs
 	ungrave   => { amount => '-100%', cost => '33%',    load => 3600, area => 3,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'ISBear' },
 	# I like SSG


Wed, 02 Apr 2008 01:45:59 +0300
add boardindex header with link
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-03-31 22:10:44 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-04-01 12:52:47 +0300
@@ -9,7 +9,7 @@
 	youdead		=> 'Sorry, someone has killed you',
 	loading		=> 'Sorry, you cannot shoot so rapidly, wait until weapon will be prepared',
 	outofammo	=> 'Sorry, you are out of ammo',
-	restmore	=> 'Oh, Pedro, dear, wait, I\'m too busy now!',
+	restmore	=> 'Oh, man, I\'m so busy!',
 	cantloadyou	=> 'Internal error happened - cannot load info about user: ',
 	erropendata	=> 'Intarnal error happened - cannot load any data',
 	errclosedata	=> 'Internal error happened - cannot save data',
@@ -26,6 +26,8 @@
 	head_dead	=> 'Hello, <user>, you are killed by <killer>, ',
 	head_revive	=> qq(<a href="$scripturl?action=rmgwogu" >Hello, <user>, you are dead, but you can now rise to life</a>, ),
 
+	bi_huntlog	=> 'Log: ',
+
 	gdsc1		=> '',
 	gdsc2		=> "\nDescription: ",
 	gdsc3		=> "\nDamage: ",
--- lib/yabb-2.1/Languages/Ukrainian/Snark.lng~	2008-04-01 12:05:05 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/Snark.lng	2008-04-01 12:54:18 +0300
@@ -26,6 +26,8 @@
 	head_dead	=> 'Привіт, <user>, ви зараз труп завдяки <killer>, ',
 	head_revive	=> qq(<a href="$scripturl?action=rmgwogu" >Ура, <user>, ви поки мертві, але вже можете ожити</a>, ),
 
+	bi_huntlog	=> 'Хід подій: ',
+
 	gdsc1		=> '',
 	gdsc2		=> "\nОпис: ",
 	gdsc3		=> "\nПошкодження: ",
--- lib/yabb-2.1/Sources/BoardIndex.pl~	2008-04-01 12:43:08 +0300
+++ lib/yabb-2.1/Sources/BoardIndex.pl	2008-04-01 12:56:10 +0300
@@ -635,7 +635,7 @@
 
 	if ( $snark_enable ) {
 		require "$sourcedir/Snark.pl" if not $loaded{'Snark.pl'};
-		$yymain .= 	qq(<div class="huntlog" ><div class="windowbg" >) .
+		$yymain .= 	qq(<div class="huntlog" ><div class="windowbg" ><div class="catbg"><a href="$scripturl?action=huntlog" >$snark_txt{'bi_huntlog'}</a></div>) .
 				join ( q(<br />), huntlog_get ( qr/(kill|revive|bomb|patrick|tristar|rlsaber|esca|boyan|giggle|watch)/, 5 ) ) .
 				q(</div></div>);
 		$yyinlinestyle .= qq(<link rel="stylesheet" href="$forumstylesurl/default/snark.css" type="text/css" />);

fix revived chars to have too many load time
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 10:31:17 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 13:07:43 +0300
@@ -856,6 +856,8 @@
 
 				if ( $dmg ) {
 
+					$starlog{$target}{shot_date} = $date;
+
 					$modified{starlog} = 1;
 					huntlog_add "$username|$target|damage|$dmg";
 					$full_damage += $dmg;

huntlog header, fragcount, sorted gunlist
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 13:07:43 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 13:16:08 +0300
@@ -248,7 +248,7 @@
 
 	$yymain = qq( <div class="gundsccontainer">\n);
 
-	foreach my $gun ( keys %damage ) {
+	foreach my $gun ( sort keys %damage ) {
 		
 		my $dsc = gun_dsc $gun;
 		$dsc =~ s/\n/ <br \/> /g;
@@ -352,7 +352,7 @@
 		$count = 10
 	}
 
-	$yymain = qq( <div class="huntlog" ><div class="windowbg" >\n) .
+	$yymain = qq( <div class="huntlog" ><div class="windowbg" ><div class="catbg" >$snark_txt{'huntlog_header'}</div>\n) .
 			join ( qq( <br />\n), huntlog_get qr/.*/, $count ) .
 			qq(\n</div></div>);
 	
@@ -551,7 +551,7 @@
 									$starlog{$target}{life} )
 		. ( qq(<img src="$imagesdir/snark_dstar.png" alt="*" />\n) x
 					( $starlog{$target}{max_life} - $starlog{$target}{life} ) )
-		. qq(</div>);
+		. qq(</div>\n<div class="snarkfrags">$snark_txt{'snarkpanelfrags'}$starlog{$target}{has_killed}/$starlog{$target}{deaths_count}</div>);
 
 	if ( not exists $starlog{$username} ) {
 		if ( not try_add_to_data $username ) {
--- lib/yabb-2.1/Languages/Ukrainian/Snark.lng~	2008-04-01 12:54:18 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/Snark.lng	2008-04-01 13:20:57 +0300
@@ -19,6 +19,7 @@
 	guest		=> 'Гість',
 	life_star	=> '*',
 	dead_star	=> '+',
+	snarkpanelfrags => 'Фрагів/смертей: ',
 
 	notkilled	=> 'ніким допоки',
 	head_no		=> 'Добрий день :), <user> ',
@@ -27,6 +28,7 @@
 	head_revive	=> qq(<a href="$scripturl?action=rmgwogu" >Ура, <user>, ви поки мертві, але вже можете ожити</a>, ),
 
 	bi_huntlog	=> 'Хід подій: ',
+	huntlog_header	=> qq(Хід подій <a href="$scripturl?action=showguns">(опис зброї - тут)</a>: ),
 
 	gdsc1		=> '',
 	gdsc2		=> "\nОпис: ",
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-04-01 12:52:47 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-04-01 13:31:37 +0300
@@ -19,6 +19,7 @@
 	guest		=> 'Guest',
 	life_star	=> '*',
 	dead_star	=> '+',
+	snarkpanelfrags => 'Frags/Deaths: ',
 
 	notkilled	=> 'nobody yet',
 	head_no		=> 'Hello, <user>, ',
@@ -27,6 +28,7 @@
 	head_revive	=> qq(<a href="$scripturl?action=rmgwogu" >Hello, <user>, you are dead, but you can now rise to life</a>, ),
 
 	bi_huntlog	=> 'Log: ',
+	huntlog_header	=> qq(Events log <a href="$scripturl?action=showguns">(guns descriptions are here)</a>: ),
 
 	gdsc1		=> '',
 	gdsc2		=> "\nDescription: ",

expand killer nick in header
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 13:16:08 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 15:05:09 +0300
@@ -652,7 +652,7 @@
 	$head =~ s/<ammo>/$starlog{$username}{ammo}/ig; # FIXME: link to gun descs
 	$head =~ s/<life>/$starlog{$username}{life}\/$starlog{$username}{max_life}/ig;
 	if ( $starlog{$username}{killed_by} ) {
-		$head =~ s/<killer>/$starlog{$username}{killed_by}/ig;
+		$head =~ s/<killer>/ get_nickname $starlog{$username}{killed_by} /ige;
 	} else {
 		$head =~ s/<killer>/$snark_txt{'notkilled'}/ig;
 	}

log system rewrite
--- /home/isbear/Snark.pl.orig	2008-04-01 15:26:22 +0300
+++ /home/isbear/Snark.pl	2008-04-01 15:23:38 +0300
@@ -266,10 +266,14 @@
 	formats and returns provided log row for displaying in html
 =cut
 sub huntlog_format {
-	my ( $edate, $who, $whom, $act, $arg ) = split /\|/, scalar shift;
+	my ( $edate, $who, $whom, $act, $arg, $num ) = split /\|/, scalar shift;
 
 	my $row = $snark_txt{'logevt_'.$act};
-	$row = $row->[ int rand @{$row} ];
+	if ( $num =~ m/^\d+$/ ) {
+		$row = $row->[ $num % @{$row} ];
+	} else {
+		return $num;
+	}
 
 	$edate = timeformat $edate, 1;
 	$row =~ s/<date>/$edate/g;
@@ -306,7 +310,8 @@
 
 #	my $cdate = $date + ( 3600 * $timeoffset );
 
-	print  HUNTLOG map { "$date|$_|" . huntlog_format ( "$date|$_" ) . "\n" } @hunting_log;
+#	print  HUNTLOG map { "$date|$_|" . huntlog_format ( "$date|$_" ) . "\n" } @hunting_log;
+	print  HUNTLOG map { "$date|$_|" . int ( rand 100 ) . "\n" } @hunting_log;
 	fclose ( HUNTLOG );
 
 	@hunting_log = ( )
@@ -328,18 +333,19 @@
 
 	while ( <HUNTLOG> ) {
 		chomp;
-		my ( $act, $row ) = ( split /\|/, $_ )[3,5];
+		my ( $date, $who, $whom, $act, $arg, $row ) = split /\|/, $_;
 
 		next if not $act =~ m/$filter/;
 
-		push @retval, $row;
+		push @retval, "$date|$who|$whom|$act|$arg|$row";
+#		push @retval, $row;
 	}
 
 	fclose ( HUNTLOG );
 
 	@retval = reverse @retval;
 	$#retval = $num if $num < $#retval;
-	return  @retval
+	return  map { huntlog_format $_ } @retval
 }
 
 sub huntlog_show {

fix remaining boojim's
--- lib/yabb-2.1/Languages/English/Snark.lng~	2008-04-01 13:31:37 +0300
+++ lib/yabb-2.1/Languages/English/Snark.lng	2008-04-01 15:35:03 +0300
@@ -3,7 +3,7 @@
 our %snark_txt = (
 	invaluname	=> 'Invalid user name in request: ',
 	invaldmg	=> 'Invalid damage type in request: ',
-	nosnarks	=> 'Sorry, \'Tis too late, all Snarks have gone - that ones, that claw, and ones, that bite, and even Boojims',
+	nosnarks	=> 'Sorry, \'Tis too late, all Snarks have gone - that ones, that claw, and ones, that bite, and even Boojums',
 	havenogun	=> 'Sorry, you have no such gun: ',
 	deadyet		=> 'Sorry, he is perished yet: ',
 	youdead		=> 'Sorry, someone has killed you',
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 15:26:26 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 15:35:44 +0300
@@ -749,7 +749,7 @@
 		$starlog{$username}{life} = 0;
 		$starlog{$username}{death_date} = $date + 600;
 		$starlog{$username}{deaths_count}++;
-		$starlog{$username}{killed_by} = 'Boojim';
+		$starlog{$username}{killed_by} = 'Boojum';
 		# Should'we apply cost?
 
 		$modified{starlog} = 1;

balancing
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 15:35:44 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 16:53:35 +0300
@@ -121,7 +121,7 @@
 	boyan  => { amount => 0,       cost => 0,         load => 120, area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => 0 },
 	star   => { amount => 1,       cost => 1,         load => 40,  area => 0,  dead => 0, termin => 300, self => 0, offline => 0, level => 1 },
 	plus   => { amount => 3,       cost => 3,         load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
-	ban    => { amount => '100%',  cost => 'damage',  load => 300, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
+	ban    => { amount => '100%',  cost => 'damage',  load => 900, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
 	bomb   => { amount => '2d13',  cost => 25,        load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
 	minus  => { amount => -3,      cost => 3,         load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
 	heal   => { amount => '-34%',  cost => 3,         load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
@@ -130,7 +130,7 @@
 	# old cthulhu - lvm scene
 	messiah   => { amount => '-100%', cost => 0,        load => 180,  area => 0,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'lvm' },
 	# just what forum admin needs
-	ungrave   => { amount => '-100%', cost => '33%',    load => 3600, area => 3,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'ISBear' },
+	ungrave   => { amount => '-100%', cost => '33%',    load => 1900, area => 3,  dead => 1, termin => 0,   self => 1, offline => 1, level => -1, owner => 'ISBear' },
 	# I like SSG
 	ssb       => { amount => '14d2',  cost => 22,       load => 300,  area => 0,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'ISBear' },
 	# big bro, noblesse oblige
@@ -138,13 +138,13 @@
 	# second-time given plusgun
 	chainplus => { amount => 3,       cost => 3,        load => 10,   area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => -1, owner => 'Praporshic' },
 	# just for ease of self-shooting
-	backplus  => { amount => 3,       cost => -3,       load => 60,   area => -1, dead => 0, termin => 300, self => 1, offline => 1, level => -1, owner => 'Cthulhu' },
+	backplus  => { amount => 3,       cost => -3,       load => 10,   area => -1, dead => 0, termin => 300, self => 1, offline => 1, level => -1, owner => 'Cthulhu' },
 	# old saying about moderator-mojohead
-	patrick   => { amount => '100%',  cost => 100,      load => 300,  area => 2,  dead => 0, termin => 600, self => 1, offline => 0, level => -1, owner => 'Cthulhu' },
+	patrick   => { amount => '100%',  cost => 100,      load => 480,  area => 2,  dead => 0, termin => 600, self => 1, offline => 0, level => -1, owner => 'Cthulhu' },
 	# frequently-discussed question
 	znewad    => { amount => '-100%', cost => 10,       load => 60,   area => 0,  dead => 0, termin => 0,   self => 1, offline => 1, level => -1, owner => 'DalekiyObriy' },
 	# the only person, about which I know, that he has breaked into some machine
-	tristar   => { amount => '30d2',  cost => 70,       load => 900,  area => 1,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'Abram' },
+	tristar   => { amount => '30d2',  cost => 70,       load => 720,  area => 1,  dead => 0, termin => 720, self => 0, offline => 0, level => -1, owner => 'Abram' },
 	# according to avatar, by request of working peoples...
 	rlsaber   => { amount => '6d4',   cost => '6d4',    load => 90,   area => 0,  dead => 0, termin => 360, self => 0, offline => 0, level => -1, owner => 'Piktor' },
 	# the only active female being on forum (except early anatolijd =) )
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 16:53:35 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 16:59:23 +0300
@@ -140,7 +140,7 @@
 	# just for ease of self-shooting
 	backplus  => { amount => 3,       cost => -3,       load => 10,   area => -1, dead => 0, termin => 300, self => 1, offline => 1, level => -1, owner => 'Cthulhu' },
 	# old saying about moderator-mojohead
-	patrick   => { amount => '100%',  cost => 100,      load => 480,  area => 2,  dead => 0, termin => 600, self => 1, offline => 0, level => -1, owner => 'Cthulhu' },
+	patrick   => { amount => '100%',  cost => 100,      load => 360,  area => 2,  dead => 0, termin => 600, self => 1, offline => 0, level => -1, owner => 'Cthulhu' },
 	# frequently-discussed question
 	znewad    => { amount => '-100%', cost => 10,       load => 60,   area => 0,  dead => 0, termin => 0,   self => 1, offline => 1, level => -1, owner => 'DalekiyObriy' },
 	# the only person, about which I know, that he has breaked into some machine
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 16:59:23 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 17:08:35 +0300
@@ -123,7 +123,7 @@
 	plus   => { amount => 3,       cost => 3,         load => 60,  area => 0,  dead => 0, termin => 420, self => 0, offline => 0, level => 2 },
 	ban    => { amount => '100%',  cost => 'damage',  load => 900, area => 0,  dead => 0, termin => 900, self => 0, offline => 0, level => 4 },
 	bomb   => { amount => '2d13',  cost => 25,        load => 90,  area => 1,  dead => 1, termin => 600, self => 1, offline => 0, level => 1 },
-	minus  => { amount => -3,      cost => 3,         load => 45,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
+	minus  => { amount => -3,      cost => 3,         load => 30,  area => -1, dead => 0, termin => 0,   self => 1, offline => 1, level => 1 },
 	heal   => { amount => '-34%',  cost => 3,         load => 90,  area => 0,  dead => 0, termin => 0,   self => 0, offline => 1, level => 2 },
 	revive => { amount => '-100%', cost => 20,        load => 180, area => 1,  dead => 1, termin => 0,   self => 1, offline => 1, level => 3 },
 

fix self-fragging
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 17:08:35 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-01 17:32:36 +0300
@@ -819,8 +819,10 @@
 				$starlog{$target}{killed_by}  = $username;
 				$starlog{$target}{death_date} = $date + $damage{$dtype}{termin};
 				$starlog{$target}{deaths_count}++;
-				
-				$starlog{$username}{has_killed}++;
+			
+				if ( $target ne $username ) {
+					$starlog{$username}{has_killed}++;
+				}
 
 				$modified{starlog} = 1;
 				huntlog_add "$username|$target|damage|$dmg";

fix life non-update on new posts
--- lib/yabb-2.1/Sources/Snark.pl~	2008-04-01 17:32:36 +0300
+++ lib/yabb-2.1/Sources/Snark.pl	2008-04-02 00:54:32 +0300
@@ -491,8 +491,8 @@
 
 		if ( ${$uid.$login}{postcount} % 50 == 0 ) {
 
-			$startlog{$login}{max_life}++;
-			$startlog{$login}{life}++;
+			$starlog{$login}{max_life}++;
+			$starlog{$login}{life}++;
 		}
 
 		$starlog{$login}{ammo}++;



Sun, 06 Apr 2008 01:22:28 +0300
Have formatted and placed snark log in htdocs/2008-04-01/
Applied patch, disables snark features almost completely
(ammo increasing routine in Post.pl still works).
--- lib/yabb-2.1/Sources/SubList.pl~	2008-04-02 22:23:09 +0300
+++ lib/yabb-2.1/Sources/SubList.pl	2008-04-06 01:21:48 +0300
@@ -18,11 +18,11 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
-'regenfullog',"Snark.pl&regenfullog",
-'huntlog',"Snark.pl&huntlog_show",
-'showguns',"Snark.pl&show_guns",
-'ghd',"Snark.pl&give_him_damage",
-'rmgwogu',"Snark.pl&revive_me_gwog",
+#'regenfullog',"Snark.pl&regenfullog",
+#'huntlog',"Snark.pl&huntlog_show",
+#'showguns',"Snark.pl&show_guns",
+#'ghd',"Snark.pl&give_him_damage",
+#'rmgwogu',"Snark.pl&revive_me_gwog",
 
 'bwg',"BanWithGroup.pl&banwithgroup",
 'ubwg',"BanWithGroup.pl&unbanwithgroup",




Sat, 19 Apr 2008 02:09:57 +0300
Next patches applied to add banlog to ban system.
Also they show to usual user his self-banning abilities. =)
--- lib/yabb-2.1/Languages/English/BanWithGroup.lng~	2007-12-19 02:57:24 +0200
+++ lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-04-18 23:37:30 +0300
@@ -1,30 +1,42 @@
 
 %bangroup_txt = (
-'onlyadmin' => 'You are not allowed to access this section',
-'invaluname' => 'Invalid username: ',
-'invalterm' => 'Termin should be a number: ',
-'nomain' => 'Main group not found: ',
-'nolower' => 'You can only lengthen ban termin. Current termin (minutes): ',
-'nobadmin' => 'For security reasons you cannot ban username "admin"',
+
+'notallowed'  => 'You are not allowed to access this section',
+'invaluname'  => 'Invalid username: ',
+'invalterm'   => 'Termin should be a number: ',
+'invalreason' => 'Reason contains strange chars: ',
+'nomain'      => 'Main group not found: ',
+'nolower'     => 'You can only lengthen ban termin. Current termin (minutes): ',
+'nobadmin'    => 'For security reasons you cannot ban username "admin"',
 
 'notbanned' => 'User is not banned',
-'noaddid' => 'Addidtional group not found',
+'noaddid'   => 'Addidtional group not found',
 
 'notexpired' => 'Ban is not expired',
 
-'cof' => 'Cannot open for writing file: ',
+'cof'       => 'Cannot open file: ',
+'cannotlog' => 'Cannot save log record',
 
-'unamefield' => 'User login',
+'unamefield'  => 'User login',
 'terminfield' => 'Ban termin<br /><span class="small">m - minutes, h - hours, d - days, M - months</span>',
-'submit' => 'Ban',
-'title' => 'Banning',
+'reasonfield' => 'Reason:',
+'submit'    => 'Ban',
+'title'     => 'Banning',
 'titleuser' => 'Ban member ',
 
+'banlogtitle' => 'Banning log',
+'blog1' => ' has banned ',
+'blog2' => ' until ',
+'blog3' => ' with gid ',
+
 'banuntil' => 'Banned until ',
-'buttban' => 'Ban',
-'buttunb' => 'Remove active ban',
-'buttexp' => 'Remove expired ban',
+'buttban'  => 'Ban',
+'buttunb'  => 'Remove active ban',
+'buttexp'  => 'Remove expired ban',
+
 );
 
+$loaded{'BanWithGroup.lng'} = 1;
+
 1;
 
--- lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng~	2007-12-19 02:58:22 +0200
+++ lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-04-19 00:18:10 +0300
@@ -1,30 +1,42 @@
 
 %bangroup_txt = (
-'onlyadmin' => 'Вам не дозволено',
-'invaluname' => 'Невірне ім\'я користувача: ',
-'invalterm' => 'Термін має бути числом: ',
-'nomain' => 'Не знайдено основної групи: ',
-'nolower' => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
-'nobadmin' => 'З міркувань безпеки ви не можете забанити користувача admin',
+
+'notallowed'  => 'Вам не дозволено',
+'invaluname'  => 'Невірне ім\'я користувача: ',
+'invalterm'   => 'Термін має бути числом: ',
+'invalreason' => 'Причина бану містить дивні символи: ',
+'nomain'      => 'Не знайдено основної групи: ',
+'nolower'     => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
+'nobadmin'    => 'З міркувань безпеки ви не можете забанити користувача admin',
 
 'notbanned' => 'Користувач не забанений',
-'noaddid' => 'Не знайдено додаткової групи',
+'noaddid'   => 'Не знайдено додаткової групи',
 
 'notexpired' => 'Час бану ще не сплинув',
 
-'cof' => 'Не вдається відкрити для запису файл: ',
+'cof'       => 'Не вдається відкрити файл: ',
+'cannotlog' => 'Не вдається зареєструвати подію у журналі',
 
-'unamefield' => 'Логін користувача',
+'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
-'submit' => 'Забанити',
-'title' => 'Бан',
-'titleuser' => 'Забанити ',
+'reasonfield' => 'Причина бану',
+'submit'      => 'Забанити',
+'title'       => 'Бан',
+'titleuser'   => 'Забанити ',
+
+'banlogtitle' => 'Часопис банів',
+'blog1' => ' забанив ',
+'blog2' => ' до ',
+'blog3' => ' групою ',
 
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
 'buttunb' => 'Зняти діючий бан',
 'buttexp' => 'Зняти вичерпаний бан',
+
 );
 
+$loaded{'BanWithGroup.lng'} = 1;
+
 1;
 
--- lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng~	2007-12-19 02:58:49 +0200
+++ lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-04-19 00:37:20 +0300
@@ -1,30 +1,42 @@
 
 %bangroup_txt = (
-'onlyadmin' => 'Вам не дозволено',
-'invaluname' => 'Невірне ім\'я користувача: ',
-'invalterm' => 'Термін має бути числом: ',
-'nomain' => 'Не знайдено основної групи: ',
-'nolower' => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
+
+'notallowed'  => 'Вам не дозволено',
+'invaluname'  => 'Невірне ім\'я користувача: ',
+'invalterm'   => 'Термін має бути числом: ',
+'invalreason' => 'Причина бану містить дивні символи: ',
+'nomain'   => 'Не знайдено основної групи: ',
+'nolower'  => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
 'nobadmin' => 'З міркувань безпеки ви не можете забанити користувача admin',
 
 'notbanned' => 'Користувач не забанений',
-'noaddid' => 'Не знайдено додаткової групи',
+'noaddid'   => 'Не знайдено додаткової групи',
 
 'notexpired' => 'Час бану ще не сплинув',
 
-'cof' => 'Не вдається відкрити для запису файл: ',
+'cof'       => 'Не вдається відкрити для запису файл: ',
+'cannotlog' => 'Не вдалося зареєструвати акт у часописі банів',
 
-'unamefield' => 'Логін користувача',
+'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
-'submit' => 'Забанити',
-'title' => 'Бан',
+'reasonfield' => 'Причина бану',
+'submit'    => 'Забанити',
+'title'     => 'Бан',
 'titleuser' => 'Забанити ',
 
+'banlogtitle' => 'Часопис банів',
+'blog1' => ' забанив ',
+'blog2' => ' до ',
+'blog3' => ' групою ',
+
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
 'buttunb' => 'Зняти діючий бан',
 'buttexp' => 'Зняти вичерпаний бан',
+
 );
 
+$loaded{'BanWithGroup.lng'} = 1;
+
 1;
 
--- lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng~	2008-04-19 00:37:20 +0300
+++ lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-04-19 00:50:38 +0300
@@ -28,6 +28,7 @@
 'blog1' => ' забанив ',
 'blog2' => ' до ',
 'blog3' => ' групою ',
+'blog4' => ' зняв бан з ',
 
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
--- lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng~	2008-04-19 00:18:10 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-04-19 00:49:52 +0300
@@ -28,6 +28,7 @@
 'blog1' => ' забанив ',
 'blog2' => ' до ',
 'blog3' => ' групою ',
+'blog4' => ' зняв бан з ',
 
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
--- lib/yabb-2.1/Languages/English/BanWithGroup.lng~	2008-04-18 23:37:30 +0300
+++ lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-04-19 00:49:07 +0300
@@ -28,6 +28,7 @@
 'blog1' => ' has banned ',
 'blog2' => ' until ',
 'blog3' => ' with gid ',
+'blog4' => ' has unbanned ',
 
 'banuntil' => 'Banned until ',
 'buttban'  => 'Ban',
--- lib/yabb-2.1/Sources/SubList.pl~	2008-04-06 01:21:48 +0300
+++ lib/yabb-2.1/Sources/SubList.pl	2008-04-19 00:58:15 +0300
@@ -24,10 +24,11 @@
 #'ghd',"Snark.pl&give_him_damage",
 #'rmgwogu',"Snark.pl&revive_me_gwog",
 
-'bwg',"BanWithGroup.pl&banwithgroup",
-'ubwg',"BanWithGroup.pl&unbanwithgroup",
-'ebwg',"BanWithGroup.pl&expirebanwithgroup",
-'pbwg',"BanWithGroup.pl&banwithgrouppassthrough",
+'bwg',"BanWithGroup.pl&ban_with_group",
+'ubwg',"BanWithGroup.pl&unban_with_group",
+'ebwg',"BanWithGroup.pl&expire_ban_with_group",
+'pbwg',"BanWithGroup.pl&ban_with_group_passthrough",
+'bwglog',"BanWithGroup.pl&ban_log_show",
 
 'novyny',"Novyny.pl&Novyny",
 'activate',"Register.pl&user_activation",
--- lib/yabb-2.1/Sources/SubList.pl~	2008-04-19 00:58:15 +0300
+++ lib/yabb-2.1/Sources/SubList.pl	2008-04-19 01:00:37 +0300
@@ -28,7 +28,7 @@
 'ubwg',"BanWithGroup.pl&unban_with_group",
 'ebwg',"BanWithGroup.pl&expire_ban_with_group",
 'pbwg',"BanWithGroup.pl&ban_with_group_passthrough",
-'bwglog',"BanWithGroup.pl&ban_log_show",
+'bwglog',"BanWithGroup.pl&show_ban_log",
 
 'novyny',"Novyny.pl&Novyny",
 'activate',"Register.pl&user_activation",
--- /home/isbear/BanWithGroup.pl.orig	2008-04-19 00:54:31 +0300
+++ /home/isbear/BanWithGroup.pl	2008-04-19 00:54:05 +0300
@@ -1,16 +1,64 @@
 
-&LoadLanguage('BanWithGroup');
+# Ban With Group
 
-sub banwithgroup {
-	my $login = $FORM{'username'} || $INFO{'username'};
-	my $termin = $FORM{'termin'} || $INFO{'termin'};
-
-	&fatal_error($bangroup_txt{'invaluname'} . $login) if $login !~ /^[A-Za-z0-9\@#_\-.]+$/;
-	&fatal_error($bangroup_txt{'invalterm'} . $termin) if $termin =~ /[^0-9 mhdM]/;
-	$termin = '0' if $termin !~ /[0-9mhdM]/;
+# adds user to 'Banned' group (with denial permissions)
+# and sets his position group into temporary additional group,
+# that carries info about ban end time and original user's position.
 
-	&fatal_error($bangroup_txt{'onlyadmin'}) unless ($iamadmin || $iamgmod || $iammod || $login eq $username);
-	&fatal_error($bangroup_txt{'nobadmin'}) if ($login eq 'admin');
+# FIXME: we should define upper limit for ban termin.
+
+return if $loaded{'BanWithGroup.pl'};
+
+$loaded{'BanWithGroup.pl'} = 1;
+
+LoadLanguage ( 'BanWithGroup' ) if not $loaded{'BanWithGroup.lng'};
+
+sub main_ban_gid {
+
+	foreach ( keys %NoPost ) {
+		next unless $NoPost{$_} =~ /^Banned\|/i;
+
+		return $_;
+	}
+
+	# FIXME
+	fatal_error $bangroup_txt{'nomain'} . 'Banned'
+}
+
+sub ban_with_group {
+
+	my $login  = $FORM{'username'} || $INFO{'username'};
+	my $termin = $FORM{'termin'}   || $INFO{'termin'};
+	my $reason = $FORM{'reason'}   || $INFO{'reason'} || '';
+
+	if ( $login !~ /^[A-Za-z0-9\@#_\-.]+$/ ) {
+		fatal_error $bangroup_txt{'invaluname'} . $login
+	}
+
+	if ( $termin =~ /[^0-9 mhdM]/ ) {
+		fatal_error $bangroup_txt{'invalterm'} . $termin
+	}
+
+	if ( $termin !~ /[0-9mhdM]/ ) {
+		$termin = '0'
+	}
+
+	# FIXME
+	if ( $reason =~ /[\x00-\x1F\x7F]/ ) {
+		fatal_error $bangroup_txt{'invalreason'} . $reason;
+	}
+
+	FromChars $reason;
+	ToHTML    $reason;
+
+	unless ( ( ( $iamadmin or $iamgmod or $iammod ) and $sessionvalid )
+		 or $login eq $username ) {
+		fatal_error $bangroup_txt{'notallowed'}
+	}
+
+	if ( $login eq 'admin' ) {
+		fatal_error $bangroup_txt{'nobadmin'}
+	}
 
 	$termin =~ s/(\d)\s+(\D)/$1$2/g;
 	$termin =~ s/(\d)(\s+|$)/$1h /g;
@@ -21,84 +69,102 @@
 	$termin =~ s/d/*60*60*24+/g;
 	$termin =~ s/M/*60*60*24*30+/g;
 	$termin .= $date;
-	$termin = eval $termin;
+	$termin  = eval $termin;
 
-	my $mainbanid;
-	foreach (keys %NoPost) {
-		next unless $NoPost{$_} =~ /^Banned\|/i;
-		$mainbanid = $_;
-		last;
-	}
-	&fatal_error($bangroup_txt{'nomain'} . 'Banned') unless (defined $mainbanid);
+	my $mainbanid = main_ban_gid;
 
-	&LoadUser ($login) unless exists ${$uid.$login}{'addgroups'};
-	if (${$uid.$login}{'addgroups'} =~ /(^|,)$mainbanid(,|$)/) {
-		if ($NoPost{${$uid.$login}{'position'}} =~ /^\[banned=(\d+),(.*?)\]\|/i) {
-			&fatal_error($bangroup_txt{'nolower'} . int(($1 - $date) / 60 + 1)) if ($1 > $termin);
+	LoadUser $login unless exists ${$uid.$login}{'addgroups'};
+
+	if ( ${$uid.$login}{'addgroups'} =~ /(^|,)$mainbanid(,|$)/ ) {
+		if ( $NoPost{${$uid.$login}{'position'}} =~ /^\[banned=(\d+),(.*?)\]\|/i ) {
+			if ( $1 > $termin ) {
+				fatal_error $bangroup_txt{'nolower'} .
+					    int ( ( $1 - $date ) / 60 + 1 )
+			}
 
 			$NoPost{${$uid.$login}{'position'}} =~ s/^\[banned=\d+,(.*?)\]\|/[banned=$termin,$1]|/i;
-			&save_groups;
+			save_groups;
 
 			our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
-			&redirectexit;
+			redirectexit;
 		}
-		${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/;
+
+		${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/
 	}
 
 	my $newid = keys %NoPost;
-	++$newid while (exists $NoPost{$newid});
+
+	++$newid while exists $NoPost{$newid};
+
 	$NoPost{$newid} = "[banned=$termin,${$uid.$login}{'position'}]|1|ban.png||0|0|0|0|0|0|0";
-	&save_groups;
+	save_groups;
+
+	${$uid.$login}{'addgroups'} = join ',', ( split ( /,/, ${$uid.$login}{'addgroups'} ), $mainbanid );
+	${$uid.$login}{'position'}  = $newid;
+	UserAccount $login, 'update';
 
-	${$uid.$login}{'addgroups'} = join ',', (split (/,/, ${$uid.$login}{'addgroups'}), $mainbanid);
-	${$uid.$login}{'position'} = $newid;
-	&UserAccount ($login, 'update');
+	push_ban_log $username, $login, $newid, $termin, $reason
+			or fatal_error $bangroup_txt{'cannotlog'};
 
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
-	&redirectexit;
+	redirectexit;
 }
 
-sub unbanwithgroup {
+sub unban_with_group {
 	my $login = $INFO{'username'};
 
-	&fatal_error($bangroup_txt{'invaluname'} . $login) if $login !~ /^[A-Za-z0-9\@#_\-.]+$/;
-	&fatal_error($bangroup_txt{'onlyadmin'}) unless ($iamadmin || $iamgmod);
+	if ( $login !~ /^[A-Za-z0-9\@#_\-.]+$/ ) {
+		fatal_error $bangroup_txt{'invaluname'} . $login
+	}
 
-	my $mainbanid;
-	foreach (keys %NoPost) {
-		next unless $NoPost{$_} =~ /^Banned\|/i;
-		$mainbanid = $_;
-		last;
+	if ( not ( $iamadmin or $iamgmod ) ) {
+		fatal_error $bangroup_txt{'notallowed'}
 	}
-	&fatal_error($bangroup_txt{'nomain'} . 'Banned') unless defined $mainbanid;
 
-	&LoadUser ($login) unless exists ${$uid.$login}{'addgroups'};
-	&fatal_error($bangroup_txt{'notbanned'}) if ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/;
+	my $mainbanid = main_ban_gid;
+	
+	LoadUser $login unless exists ${$uid.$login}{'addgroups'};
+
+	if ( ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/ ) {
+		fatal_error $bangroup_txt{'notbanned'}
+	}
 	
 	my $addid = ${$uid.$login}{'position'};
-	&fatal_error($bangroup_txt{'noaddid'}) if $NoPost{$addid} !~ /^\[banned=\d+,(.*?)\]\|/i;
 
-	${$uid.$login}{'position'} = $1;
+	if ( $NoPost{$addid} !~ /^\[banned=\d+,(.*?)\]\|/i ) {
+		fatal_error $bangroup_txt{'noaddid'}
+	}
+
+	${$uid.$login}{'position'}  =  $1;
 	${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/;
-	&UserAccount ($login, 'update');
+	UserAccount $login, 'update';
 
 	delete $NoPost{$addid};
-	&save_groups;
+	save_groups;
+
+	# push_ban_log $username, $login, $addid, 'unban', ''
+	# 		or fatal_error $bangroup_txt{'cannotlog'};
 
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
-	&redirectexit;
+	redirectexit
 }
 
-sub banwithgrouppassthrough {
-	my $login = $INFO{'username'};
+sub ban_with_group_passthrough {
+
+	my $login  = $INFO{'username'};
 	my $termin = $INFO{'termin'} || 1;
-	$login =~ s/[^A-Za-z0-9\@#_\-.]+//g;
-	$termin =~ s/[^\dmhdM]//g;
-	&fatal_error($bangroup_txt{'onlyadmin'}) unless ($iamadmin || $iamgmod || $iammod || $login eq $username);
+	my $reason = $INFO{'reason'} || '';
+
+	$login  =~ s/[^A-Za-z0-9\@#_\-.]+//g;
+	$termin =~ s/[^\dmhdM]+/ /g;
+	$reason =~ s/[\x00-\x1F\x7F]+//g; # FIXME
+
+	ToHTML $reason;
+	
+	my  @ti = $login ? ( 4, 1, 2, 3 ) : ( 1, 2, 3, 4 );
 
-	my @ti = $login ? (3, 1, 2) : (1, 2, 3);
 	our $yytitle = $bangroup_txt{ $login ? 'titleuser' : 'title' } . $login;
-	our $yymain = qq~
+	our $yymain  = qq~
 	<form action="$scripturl?action=bwg" method="post" >
 	<table cellpadding="4" cellspacing="1" border="0" width="60%" align="center" class="bordercolor" style="margin: 1em 20%;"><tr>
 		<td colspan="2" class="titlebg"><b>$yytitle</b></td>
@@ -109,61 +175,125 @@
 		<td class="windowbg">$bangroup_txt{'terminfield'}</td>
 		<td class="windowbg2"><input type="text" name="termin" value="$termin" tabindex="$ti[1]" style="width: 100%" /></td>
 	</tr><tr>
-		<td colspan="2" class="catbg"><input type="submit" name="submit" value="$bangroup_txt{'submit'}" tabindex="$ti[2]" style="width: 100%" /></td>
+		<td class="windowbg">$bangroup_txt{'reasonfield'}</td>
+		<td class="windowbg2"><input type="text" name="reason" value="$reason" tabindex="$ti[2]" style="width: 100%" /></td>
+	</tr><tr>
+		<td colspan="2" class="catbg"><input type="submit" name="submit" value="$bangroup_txt{'submit'}" tabindex="$ti[3]" style="width: 100%" /></td>
 	</tr></table>
 	</form>
 ~;
 
-	&template;
+	template;
+
 	exit;
 }
 
-sub expirebanwithgroup {
-	my $login = $INFO{'username'};
+sub expire_ban_with_group {
 
-	&fatal_error($bangroup_txt{'invaluname'} . $login) if $login !~ /^[A-Za-z0-9\@#_\-.]+$/;
+	my $login = $INFO{'username'};
 
-	my $mainbanid;
-	foreach (keys %NoPost) {
-		next unless $NoPost{$_} =~ /^Banned\|/i;
-		$mainbanid = $_;
-		last;
+	if ( $login !~ /^[A-Za-z0-9\@#_\-.]+$/ ) {
+		fatal_error $bangroup_txt{'invaluname'} . $login
 	}
-	&fatal_error($bangroup_txt{'nomain'} . 'Banned') unless defined $mainbanid;
 
-	&LoadUser ($login) unless exists ${$uid.$login}{'addgroups'};
-	&fatal_error($bangroup_txt{'notbanned'}) if ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/;
+	my $mainbanid = main_ban_gid;
+
+	LoadUser $login if not exists ${$uid.$login}{'addgroups'};
+
+	if ( ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/ ) {
+		fatal_error $bangroup_txt{'notbanned'}
+	}
 
 	my $addid = ${$uid.$login}{'position'};
-	&fatal_error($bangroup_txt{'noaddid'}) if $NoPost{$addid} !~ /^\[banned=(\d+),(.*?)\]\|/i;
 
-	&fatal_error($bangroup_txt{'notexpired'} . &timeformat($1)) if ($date < $1);
+	if ( $NoPost{$addid} !~ /^\[banned=(\d+),(.*?)\]\|/i ) {
+		fatal_error $bangroup_txt{'noaddid'}
+	}
+
+	if ( $date < $1 ) {
+		fatal_error $bangroup_txt{'notexpired'} . &timeformat ( $1 )
+	}
 
-	${$uid.$login}{'position'} = $2;
+	${$uid.$login}{'position'}  =  $2;
 	${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/;
-	&UserAccount ($login, 'update');
+	UserAccount $login, 'update';
 
 	delete $NoPost{$addid};
-	&save_groups;
+	save_groups;
 
+	# push_ban_log $username, $login, $addid, 'expire', ''
+	# 		or fatal_error $bangroup_txt{'cannotlog'};
+	
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
-	&redirectexit;
+	redirectexit
 }
 
-sub save_groups {
-	fopen (GRP, ">$vardir/membergroups.txt") or &fatal_error($bangroup_txt{'cof'} . "$vardir/membergroups.txt");
+sub push_ban_log {
+	my ( $who, $whom, $gid, $termin, $reason ) = shift;
 
-	foreach (keys %Group) {
-		print GRP "\$Group{'$_'} = '$Group{$_}';\n";
-	}
-	foreach (keys %NoPost) {
-		print GRP "\$NoPost{'$_'} = '$NoPost{$_}';\n";
-	}
-	foreach (keys %Post) {
-		print GRP "\$Post{'$_'} = '$Post{$_}';\n";
+	fopen ( BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
+
+	print BANLOG "$date|$who|$whom|$gid|$termin|$reason\n";
+
+	fclose BANLOG;
+
+	return 1
+}
+
+sub show_ban_log {
+
+	fopen ( BANLOG, "< $vardir/banwithgroup.log" )
+			or fatal_error $bangroup_txt{'cof'} . "$vardir/banwithgroup.log";
+
+	our $yytitle = $bangroup_txt{'banlogtitle'};
+	
+	our $yymain  = qq(<div class="windowbg"><div class="catbg">$bangroup_txt{'banlogtitle'}</div>);
+	
+	while ( <BANLOG> ) {
+		chomp;
+
+		my ( $date, $who, $whom, $termin, $reason ) = split /\|/, $_;
+		
+		LoadUser  $who  if not exists ${$uid.$who}{'realname'};
+		LoadUser  $whom if not exists ${$uid.$whom}{'realname'};
+		$who    = ${$uid.$who}{'realname'}  || $bangroup_txt{'nonick'};
+		$whom   = ${$uid.$whom}{'realname'} || $bangroup_txt{'nonick'};
+		$date   = timeformat $date;
+		ToChars   $reason;
+
+		# FIXME: organize as table? make it template?
+		if ( $termin eq 'expire' or $termin eq 'unban' ) {
+
+			$yymain .= qq([$date] $who$bangroup_txt{'blog4'}$whom$bangroup_txt{'blog3'}$gid<br/>\n);
+
+		} else {
+
+			$termin = timeformat $termin;
+			$yymain .= qq([$date] $who$bangroup_txt{'blog1'}$whom$bangroup_txt{'blog2'}$termin$bangroup_txt{'blog3'}$gid<br/>\n);
+		}
 	}
 
-	print GRP "\n1;\n";
-	fclose (GRP);
+	$yymain .= qq(</div>);
+
+	fclose BANLOG;
+
+	template;
+	exit;
+}
+
+sub save_groups {
+
+	fopen ( GRP, "> $vardir/membergroups.txt" )
+		or fatal_error $bangroup_txt{'cof'} . "$vardir/membergroups.txt";
+
+	print GRP map "\$Group{'$_'} = '$Group{$_}';\n",   keys %Group;
+	print GRP map "\$NoPost{'$_'} = '$NoPost{$_}';\n", keys %NoPost;
+	print GRP map "\$Post{'$_'} = '$Post{$_}';\n",     keys %Post;
+	print GRP     "\n1;\n";
+
+	fclose GRP;
 }
 
+1;
+
+# The End
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 00:55:55 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:02:42 +0300
@@ -25,6 +25,18 @@
 	fatal_error $bangroup_txt{'nomain'} . 'Banned'
 }
 
+sub push_ban_log {
+	my ( $who, $whom, $gid, $termin, $reason ) = shift;
+
+	fopen ( BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
+
+	print BANLOG "$date|$who|$whom|$gid|$termin|$reason\n";
+
+	fclose BANLOG;
+
+	return 1
+}
+
 sub ban_with_group {
 
 	my $login  = $FORM{'username'} || $INFO{'username'};
@@ -142,8 +154,8 @@
 	delete $NoPost{$addid};
 	save_groups;
 
-	# push_ban_log $username, $login, $addid, 'unban', ''
-	# 		or fatal_error $bangroup_txt{'cannotlog'};
+	push_ban_log $username, $login, $addid, 'unban', ''
+			or fatal_error $bangroup_txt{'cannotlog'};
 
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
 	redirectexit
@@ -221,25 +233,13 @@
 	delete $NoPost{$addid};
 	save_groups;
 
-	# push_ban_log $username, $login, $addid, 'expire', ''
-	# 		or fatal_error $bangroup_txt{'cannotlog'};
+	push_ban_log $username, $login, $addid, 'expire', ''
+			or fatal_error $bangroup_txt{'cannotlog'};
 	
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
 	redirectexit
 }
 
-sub push_ban_log {
-	my ( $who, $whom, $gid, $termin, $reason ) = shift;
-
-	fopen ( BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
-
-	print BANLOG "$date|$who|$whom|$gid|$termin|$reason\n";
-
-	fclose BANLOG;
-
-	return 1
-}
-
 sub show_ban_log {
 
 	fopen ( BANLOG, "< $vardir/banwithgroup.log" )
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:02:42 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:23:19 +0300
@@ -115,7 +115,7 @@
 	${$uid.$login}{'position'}  = $newid;
 	UserAccount $login, 'update';
 
-	push_ban_log $username, $login, $newid, $termin, $reason
+	push_ban_log ( $username, $login, $newid, $termin, $reason )
 			or fatal_error $bangroup_txt{'cannotlog'};
 
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
@@ -154,7 +154,7 @@
 	delete $NoPost{$addid};
 	save_groups;
 
-	push_ban_log $username, $login, $addid, 'unban', ''
+	push_ban_log ( $username, $login, $addid, 'unban', '' )
 			or fatal_error $bangroup_txt{'cannotlog'};
 
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
@@ -233,7 +233,7 @@
 	delete $NoPost{$addid};
 	save_groups;
 
-	push_ban_log $username, $login, $addid, 'expire', ''
+	push_ban_log ( $username, $login, $addid, 'expire', '' )
 			or fatal_error $bangroup_txt{'cannotlog'};
 	
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
@@ -283,7 +283,7 @@
 
 sub save_groups {
 
-	fopen ( GRP, "> $vardir/membergroups.txt" )
+	fopen ( GRP, ">$vardir/membergroups.txt" )
 		or fatal_error $bangroup_txt{'cof'} . "$vardir/membergroups.txt";
 
 	print GRP map "\$Group{'$_'} = '$Group{$_}';\n",   keys %Group;
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:23:19 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:31:35 +0300
@@ -37,6 +37,19 @@
 	return 1
 }
 
+sub save_groups {
+
+	fopen ( GRP, ">$vardir/membergroups.txt" )
+		or fatal_error $bangroup_txt{'cof'} . "$vardir/membergroups.txt";
+
+	print GRP map "\$Group{'$_'} = '$Group{$_}';\n",   keys %Group;
+	print GRP map "\$NoPost{'$_'} = '$NoPost{$_}';\n", keys %NoPost;
+	print GRP map "\$Post{'$_'} = '$Post{$_}';\n",     keys %Post;
+	print GRP     "\n1;\n";
+
+	fclose ( GRP );
+}
+
 sub ban_with_group {
 
 	my $login  = $FORM{'username'} || $INFO{'username'};
@@ -275,25 +288,12 @@
 
 	$yymain .= qq(</div>);
 
-	fclose BANLOG;
+	fclose ( BANLOG );
 
 	template;
 	exit;
 }
 
-sub save_groups {
-
-	fopen ( GRP, ">$vardir/membergroups.txt" )
-		or fatal_error $bangroup_txt{'cof'} . "$vardir/membergroups.txt";
-
-	print GRP map "\$Group{'$_'} = '$Group{$_}';\n",   keys %Group;
-	print GRP map "\$NoPost{'$_'} = '$NoPost{$_}';\n", keys %NoPost;
-	print GRP map "\$Post{'$_'} = '$Post{$_}';\n",     keys %Post;
-	print GRP     "\n1;\n";
-
-	fclose GRP;
-}
-
 1;
 
 # The End
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:31:35 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:34:48 +0300
@@ -26,7 +26,7 @@
 }
 
 sub push_ban_log {
-	my ( $who, $whom, $gid, $termin, $reason ) = shift;
+	my ( $who, $whom, $gid, $termin, $reason ) = @_;
 
 	fopen ( BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
 
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:34:48 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:37:55 +0300
@@ -265,7 +265,7 @@
 	while ( <BANLOG> ) {
 		chomp;
 
-		my ( $date, $who, $whom, $termin, $reason ) = split /\|/, $_;
+		my ( $date, $who, $whom, $gid, $termin, $reason ) = split /\|/, $_;
 		
 		LoadUser  $who  if not exists ${$uid.$who}{'realname'};
 		LoadUser  $whom if not exists ${$uid.$whom}{'realname'};
--- a/lib/yabb-2.1/Sources/Load.pl	2007-12-20 01:57:20 +0200
+++ b/lib/yabb-2.1/Sources/Load.pl	2008-04-16 23:43:53 +0300
@@ -611,9 +611,13 @@
 			}
 		}
 	}
-	if (!$is_banned && $staff && $sessionvalid == 1) {
+
+	if ( not $is_banned and ( ( $staff and $sessionvalid == 1 ) or
+				  $user eq $username ) ) {
+
 		$addmembergroup{$user} .= qq~<a href="$scripturl?action=pbwg;username=$user">$maintxt{'banwithgroup'}</a><br />~;
 	}
+
 	$addmembergroup{$user} =~ s/<br \/>\Z//;
 
 	if ($username eq "Guest") {
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:37:55 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 01:45:00 +0300
@@ -282,7 +282,7 @@
 		} else {
 
 			$termin = timeformat $termin;
-			$yymain .= qq([$date] $who$bangroup_txt{'blog1'}$whom$bangroup_txt{'blog2'}$termin$bangroup_txt{'blog3'}$gid<br/>\n);
+			$yymain .= qq([$date] $who$bangroup_txt{'blog1'}$whom$bangroup_txt{'blog2'}$termin$bangroup_txt{'blog3'}$gid$bangroup_txt{'blog5'}$reason<br/>\n);
 		}
 	}
 
--- lib/yabb-2.1/Languages/English/BanWithGroup.lng~	2008-04-19 00:49:07 +0300
+++ lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-04-19 01:49:15 +0300
@@ -25,10 +25,12 @@
 'titleuser' => 'Ban member ',
 
 'banlogtitle' => 'Banning log',
+'nonick' => '(unnamed)',
 'blog1' => ' has banned ',
 'blog2' => ' until ',
 'blog3' => ' with gid ',
 'blog4' => ' has unbanned ',
+'blog5' => ' with reason: ',
 
 'banuntil' => 'Banned until ',
 'buttban'  => 'Ban',
--- lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng~	2008-04-19 00:49:52 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-04-19 01:48:10 +0300
@@ -25,10 +25,12 @@
 'titleuser'   => 'Забанити ',
 
 'banlogtitle' => 'Часопис банів',
+'nonick' => '(невідомий)',
 'blog1' => ' забанив ',
 'blog2' => ' до ',
 'blog3' => ' групою ',
 'blog4' => ' зняв бан з ',
+'blog5' => '. Причина: ',
 
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
--- lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng~	2008-04-19 00:50:38 +0300
+++ lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-04-19 01:47:13 +0300
@@ -25,10 +25,12 @@
 'titleuser' => 'Забанити ',
 
 'banlogtitle' => 'Часопис банів',
+'nonick' => 'невідомий',
 'blog1' => ' забанив ',
 'blog2' => ' до ',
 'blog3' => ' групою ',
 'blog4' => ' зняв бан з ',
+'blog5' => '. Причина: ',
 
 'banuntil' => 'Забанено до ',
 'buttban' => 'Забанити користувача',
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 01:45:00 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 02:31:59 +0300
@@ -109,8 +109,11 @@
 
 			$NoPost{${$uid.$login}{'position'}} =~ s/^\[banned=\d+,(.*?)\]\|/[banned=$termin,$1]|/i;
 			save_groups;
+	
+			push_ban_log ( $username, $login, ${$uid.$login}{'position'}, $termin, $reason )
+					or fatal_error $bangroup_txt{'cannotlog'};
 
-			our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
+			our $yySetLocation = "$scripturl?action=bwglog";
 			redirectexit;
 		}
 
@@ -131,7 +134,7 @@
 	push_ban_log ( $username, $login, $newid, $termin, $reason )
 			or fatal_error $bangroup_txt{'cannotlog'};
 
-	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
+	our $yySetLocation = "$scripturl?action=bwglog";
 	redirectexit;
 }
 
@@ -170,7 +173,7 @@
 	push_ban_log ( $username, $login, $addid, 'unban', '' )
 			or fatal_error $bangroup_txt{'cannotlog'};
 
-	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
+	our $yySetLocation = "$scripturl?action=bwglog";
 	redirectexit
 }
 
@@ -249,7 +252,7 @@
 	push_ban_log ( $username, $login, $addid, 'expire', '' )
 			or fatal_error $bangroup_txt{'cannotlog'};
 	
-	our $yySetLocation = "$scripturl?action=viewprofile;username=$login";
+	our $yySetLocation = "$scripturl?action=bwglog";
 	redirectexit
 }
 

Sat, 19 Apr 2008 12:24:27 +0300
Applied next patches
fix to not allow guests ban guests (maybe, add explicit check?)
--- lib/yabb-2.1/Sources/BanWithGroup.pl~	2008-04-19 02:31:59 +0300
+++ lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 11:56:16 +0300
@@ -98,7 +98,10 @@
 
 	my $mainbanid = main_ban_gid;
 
-	LoadUser $login unless exists ${$uid.$login}{'addgroups'};
+	unless ( exists ${$uid.$login}{'addgroups'} ) {
+		LoadUser ( $login )
+			or fatal_error $bangroup_txt{'cantloaduser'} . $login
+	}
 
 	if ( ${$uid.$login}{'addgroups'} =~ /(^|,)$mainbanid(,|$)/ ) {
 		if ( $NoPost{${$uid.$login}{'position'}} =~ /^\[banned=(\d+),(.*?)\]\|/i ) {
@@ -151,7 +154,10 @@
 
 	my $mainbanid = main_ban_gid;
 	
-	LoadUser $login unless exists ${$uid.$login}{'addgroups'};
+	unless ( exists ${$uid.$login}{'addgroups'} ) {
+		LoadUser ( $login )
+			or fatal_error $bangroup_txt{'cantloaduser'} . $login
+	}
 
 	if ( ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/ ) {
 		fatal_error $bangroup_txt{'notbanned'}
@@ -226,7 +232,10 @@
 
 	my $mainbanid = main_ban_gid;
 
-	LoadUser $login if not exists ${$uid.$login}{'addgroups'};
+	unless ( exists ${$uid.$login}{'addgroups'} ) {
+		LoadUser ( $login )
+			or fatal_error $bangroup_txt{'cantloaduser'} . $login
+	}
 
 	if ( ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/ ) {
 		fatal_error $bangroup_txt{'notbanned'}
--- lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng~	2008-04-19 01:47:13 +0300
+++ lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-04-19 12:00:23 +0300
@@ -14,8 +14,9 @@
 
 'notexpired' => 'Час бану ще не сплинув',
 
-'cof'       => 'Не вдається відкрити для запису файл: ',
-'cannotlog' => 'Не вдалося зареєструвати акт у часописі банів',
+'cof'            => 'Не вдається відкрити для запису файл: ',
+'cannotlog'      => 'Не вдалося зареєструвати акт у часописі банів',
+'cannotloaduser' => 'Не вдалося завантажити інформацію про користувача ',
 
 'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
--- lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng~	2008-04-19 01:48:10 +0300
+++ lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-04-19 11:59:25 +0300
@@ -14,8 +14,9 @@
 
 'notexpired' => 'Час бану ще не сплинув',
 
-'cof'       => 'Не вдається відкрити файл: ',
-'cannotlog' => 'Не вдається зареєструвати подію у журналі',
+'cof'            => 'Не вдається відкрити файл ',
+'cannotlog'      => 'Не вдається зареєструвати подію у журналі',
+'cannotloaduser' => 'Не вдалося завантажити інформацію про користувача ',
 
 'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
--- lib/yabb-2.1/Languages/English/BanWithGroup.lng~	2008-04-19 01:49:15 +0300
+++ lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-04-19 11:58:20 +0300
@@ -14,8 +14,9 @@
 
 'notexpired' => 'Ban is not expired',
 
-'cof'       => 'Cannot open file: ',
-'cannotlog' => 'Cannot save log record',
+'cof'            => 'Cannot open file: ',
+'cannotlog'      => 'Cannot save log record',
+'cannotloaduser' => 'Cannot load user: ',
 
 'unamefield'  => 'User login',
 'terminfield' => 'Ban termin<br /><span class="small">m - minutes, h - hours, d - days, M - months</span>',

Fix to dangerous code in LoadMiniUser and
fix to LoadUser to return proper status on error
--- lib/yabb-2.1/Sources/Load.pl~	2008-04-19 01:41:35 +0300
+++ lib/yabb-2.1/Sources/Load.pl	2008-04-19 12:12:39 +0300
@@ -194,7 +194,7 @@
 	my $user = $_[0];
 	my $setting;
 	if (${$uid.$user}{'realname'} ne "") { return 1; }
-	if ($user eq "") { return 1; }
+	if ($user eq "") { return 1; }		### ?
 	$yyload .= qq~Loaded $user <br />~;
 	if (-e "$memberdir/$user.vars") {
 		fopen(LOADUSER, "$memberdir/$user.vars");
@@ -253,6 +253,9 @@
 			'im_imspop'     => "$settings[29]",
 			'cathide'       => "$settings[30]",
 			'postlayout'    => "$settings[31]",);
+	} else {
+
+		return 0;
 	}
 	if (${$uid.$user}{'weburl'} && ${$uid.$user}{'weburl'} !~ m~\Ahttp://~) { ${$uid.$user}{'weburl'} = "http://${$uid.$user}{'weburl'}"; }
 	&ToChars(${$uid.$user}{'realname'});
@@ -642,14 +645,15 @@
 	}
 	$memberaddgroup{$user} = ${$uid.$user}{'addgroups'};
 
-	$starnum = "0";
-	if ($stars eq "") { $stars = "0"; }
-	$memberstartemp = '';
-	while ($stars ne "$starnum") {
-		$memberstartemp .= qq(<img src="$imagesdir/$starpic" border="0" alt="*" />);
-		++$starnum;
+
+	if ( $stars =~ /\D/ ) {
+		$stars = 0
 	}
-	$memberstar{$user} = $memberstartemp;
+
+	$memberstar{$user} =
+		qq(<img src="$imagesdir/$starpic" border="0" alt="*" />)
+		x $stars;
+
 
 	return 1;
 }

have changed BanWithGroup.pl: %s/cantloaduser/cannotloaduser/


Wed, 23 Apr 2008 20:18:55 +0300
patch shows link to attached file in recent posts
--- /home/isbear/Recent.pl.old	2008-04-23 19:47:06 +0300
+++ /home/isbear/Recent.pl	2008-04-23 20:08:28 +0300
@@ -225,12 +225,15 @@
 
 			$threadfrom = @mess > $display ? @mess - $display : 0;
 			for ($ii = $threadfrom; $ii < @mess + 1; $ii++) {
-				if ($mess[$ii]) {
-					($msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns) = split(/\|/, $mess[$ii]);
-					$mtime = $mdate;
-					$messages[$numfound] = "$mtime|$curboard|$tnum|$ii|$tusername|$tname|$msub|$mname|$memail|$mdate|$musername|$micon|$mattach|$mip|$message|$mns|$tstate|$tstart";
-					$numfound++;
-				}
+				next if not $mess[$ii];
+
+				chomp $mess[$ii];
+
+				my ( $msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $mlm, $mlmb, $mfn )
+						= split /\|/, $mess[$ii];
+				
+				$messages[$numfound] = "$mdate|$curboard|$tnum|$ii|$tusername|$tname|$msub|$mname|$memail|$mdate|$musername|$micon|$mip|$message|$mns|$mfn|$tstate|$tstart";
+				$numfound++;
 			}
 		}
 	}
@@ -245,7 +248,8 @@
 		$yymain .= qq~<hr class="hr"><b>$txt{'170'}</b><hr>~;
 	}
 	for ($i = 0; $i < $numfound; $i++) {
-		($dummy, $board, $tnum, $c, $tusername, $tname, $msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $tstate, $trstart) = split(/\|/, $messages[$i]);
+		my ( undef, $board, $tnum, $c, $tusername, $tname, $msub, $mname, $memail, $mdate, $musername, $micon, $mip, $text, $mns, $mfn, $tstate, $trstart )
+					= split /\|/, $messages[$i];
 		$displayname = $mname;
 
 		if ($tusername ne 'Guest' && -e ("$memberdir/$tusername.vars")) { &LoadUser($tusername); }
@@ -276,7 +280,7 @@
 			$mname .= " ($maintxt{'28'})";
 		}
 
-		$message = &Censor($message);
+		$message = &Censor($text); # damned global...
 		$msub    = &Censor($msub);
 		&wrap;
 		if ($enable_ubbc) {
@@ -291,6 +295,14 @@
 		&ToChars($catname{$board});
 #		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
+		my $attach='';
+		if ( $mfn and -e "$uploaddir/$mfn" ) {
+			$attach = qq~
+	<hr class="hr" style="width: 100%" />
+	<span class="small" style="float: left; width: 49%" ><a href="$uploadurl/$mfn" target="_blank"><img src="$imagesdir/paperclip.gif" border="0" align="middle" alt="" /> $mfn</a></span>
+~;
+		}
+
 		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
@@ -302,7 +314,7 @@
   </tr><tr>
     <td colspan="2" class="catbg">$maintxt{'109'} $tname | $maintxt{'197'} $mname</td>
   </tr><tr>
-    <td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span></td>
+    <td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span>$attach</td>
   </tr><tr>
     <td colspan="2" class="catbg" align="right">
 ~;



Sat, 26 Apr 2008 00:36:07 +0300
Patch adds "trash" for deleted members...
Also have changed Paths.pl, but it now should not be overwritten!
--- lib/yabb-2.1/Sources/Profile.pl~	2008-03-23 02:19:45 +0200
+++ lib/yabb-2.1/Sources/Profile.pl	2008-04-25 23:56:26 +0300
@@ -982,22 +982,36 @@
 		&KillModerator($member{'username'});
 
 		if ($iamadmin) {
-			unlink("$memberdir/$member{'username'}.dat");
-			unlink("$memberdir/$member{'username'}.vars");
-			unlink("$memberdir/$member{'username'}.msg");
-			unlink("$memberdir/$member{'username'}.log");
-			unlink("$memberdir/$member{'username'}.rlog");
-			unlink("$memberdir/$member{'username'}.outbox");
-			unlink("$memberdir/$member{'username'}.storage");
+			rename("$memberdir/$member{'username'}.dat",    "$membertrashdir/$member{'username'}.dat");
+			rename("$memberdir/$member{'username'}.vars",   "$membertrashdir/$member{'username'}.vars");
+			rename("$memberdir/$member{'username'}.msg",    "$membertrashdir/$member{'username'}.msg");
+			rename("$memberdir/$member{'username'}.log",    "$membertrashdir/$member{'username'}.log");
+			rename("$memberdir/$member{'username'}.rlog",   "$membertrashdir/$member{'username'}.rlog");
+			rename("$memberdir/$member{'username'}.outbox", "$membertrashdir/$member{'username'}.outbox");
+			rename("$memberdir/$member{'username'}.storage","$membertrashdir/$member{'username'}.storage");
+#			unlink("$memberdir/$member{'username'}.dat");
+#			unlink("$memberdir/$member{'username'}.vars");
+#			unlink("$memberdir/$member{'username'}.msg");
+#			unlink("$memberdir/$member{'username'}.log");
+#			unlink("$memberdir/$member{'username'}.rlog");
+#			unlink("$memberdir/$member{'username'}.outbox");
+#			unlink("$memberdir/$member{'username'}.storage");
 			$noteuser = $member{'username'};
 		} elsif ($member{'username'} eq $user) {
-			unlink("$memberdir/$user.dat");
-			unlink("$memberdir/$user.vars");
-			unlink("$memberdir/$user.msg");
-			unlink("$memberdir/$user.log");
-			unlink("$memberdir/$user.rlog");
-			unlink("$memberdir/$user.outbox");
-			unlink("$memberdir/$user.storage");
+			rename("$memberdir/$user.dat",    "$membertrashdir/$user.dat");
+			rename("$memberdir/$user.vars",   "$membertrashdir/$user.vars");
+			rename("$memberdir/$user.msg",    "$membertrashdir/$user.msg");
+			rename("$memberdir/$user.log",    "$membertrashdir/$user.log");
+			rename("$memberdir/$user.rlog",   "$membertrashdir/$user.rlog");
+			rename("$memberdir/$user.outbox", "$membertrashdir/$user.outbox");
+			rename("$memberdir/$user.storage","$membertrashdir/$user.storage");
+#			unlink("$memberdir/$user.dat");
+#			unlink("$memberdir/$user.vars");
+#			unlink("$memberdir/$user.msg");
+#			unlink("$memberdir/$user.log");
+#			unlink("$memberdir/$user.rlog");
+#			unlink("$memberdir/$user.outbox");
+#			unlink("$memberdir/$user.storage");
 			$noteuser = $user;
 		}
 
@@ -1008,7 +1022,7 @@
 		&getMailFiles;
 		&MemberIndex("remove", $noteuser);
 
-		if (!$iamadmin) {
+		if (!$iamadmin) { # ?? change to $user eq $member{'username'} ?
 			require "$sourcedir/LogInOut.pl";
 			&Logout;
 		}
--- /home/isbear/linux.org.ua/lib/yabb-2.1/Sources/Profile.pl~	2008-04-25 23:56:26 +0300
+++ /home/isbear/linux.org.ua/lib/yabb-2.1/Sources/Profile.pl	2008-04-26 00:21:15 +0300
@@ -981,38 +981,19 @@
 		# For security, remove username from mod position
 		&KillModerator($member{'username'});
 
-		if ($iamadmin) {
-			rename("$memberdir/$member{'username'}.dat",    "$membertrashdir/$member{'username'}.dat");
-			rename("$memberdir/$member{'username'}.vars",   "$membertrashdir/$member{'username'}.vars");
-			rename("$memberdir/$member{'username'}.msg",    "$membertrashdir/$member{'username'}.msg");
-			rename("$memberdir/$member{'username'}.log",    "$membertrashdir/$member{'username'}.log");
-			rename("$memberdir/$member{'username'}.rlog",   "$membertrashdir/$member{'username'}.rlog");
-			rename("$memberdir/$member{'username'}.outbox", "$membertrashdir/$member{'username'}.outbox");
-			rename("$memberdir/$member{'username'}.storage","$membertrashdir/$member{'username'}.storage");
-#			unlink("$memberdir/$member{'username'}.dat");
-#			unlink("$memberdir/$member{'username'}.vars");
-#			unlink("$memberdir/$member{'username'}.msg");
-#			unlink("$memberdir/$member{'username'}.log");
-#			unlink("$memberdir/$member{'username'}.rlog");
-#			unlink("$memberdir/$member{'username'}.outbox");
-#			unlink("$memberdir/$member{'username'}.storage");
+		$membertrashdir ||= "$memberdir/../Trash"; # FIXME
+
+		if ( $iamadmin or $user eq $member{'username'} ) {
+
+			for my $ext (qw( vars passes log rlog msg outbox storage ims imstore )) {
+				next if not -e "$memberdir/$member{'username'}.$ext";
+
+				rename ( "$memberdir/$member{'username'}.$ext",
+				         "$membertrashdir/$member{'username'}.$ext" )
+				or unlink ( "$memberdir/$member{'username'}.$ext" )
+			}
+
 			$noteuser = $member{'username'};
-		} elsif ($member{'username'} eq $user) {
-			rename("$memberdir/$user.dat",    "$membertrashdir/$user.dat");
-			rename("$memberdir/$user.vars",   "$membertrashdir/$user.vars");
-			rename("$memberdir/$user.msg",    "$membertrashdir/$user.msg");
-			rename("$memberdir/$user.log",    "$membertrashdir/$user.log");
-			rename("$memberdir/$user.rlog",   "$membertrashdir/$user.rlog");
-			rename("$memberdir/$user.outbox", "$membertrashdir/$user.outbox");
-			rename("$memberdir/$user.storage","$membertrashdir/$user.storage");
-#			unlink("$memberdir/$user.dat");
-#			unlink("$memberdir/$user.vars");
-#			unlink("$memberdir/$user.msg");
-#			unlink("$memberdir/$user.log");
-#			unlink("$memberdir/$user.rlog");
-#			unlink("$memberdir/$user.outbox");
-#			unlink("$memberdir/$user.storage");
-			$noteuser = $user;
 		}
 
 		opendir(DIRECTORY, "$datadir");
--- lib/yabb-2.1/Sources/Profile.pl~	2008-04-26 00:21:15 +0300
+++ lib/yabb-2.1/Sources/Profile.pl	2008-04-26 00:40:22 +0300
@@ -985,7 +985,7 @@
 
 		if ( $iamadmin or $user eq $member{'username'} ) {
 
-			for my $ext (qw( vars passes log rlog msg outbox storage ims imstore )) {
+			for my $ext (qw( vars log rlog msg outbox storage ims imstore )) {
 				next if not -e "$memberdir/$member{'username'}.$ext";
 
 				rename ( "$memberdir/$member{'username'}.$ext",



Sun, 27 Apr 2008 17:40:13 +0300
New routine to show only new posts
Also added appropriate language files and css files.
css is ready only for default and subblack and should be improved later.
--- lib/yabb-2.1/Sources/SubList.pl~	2008-04-19 01:00:37 +0300
+++ lib/yabb-2.1/Sources/SubList.pl	2008-04-26 01:43:55 +0300
@@ -18,6 +18,9 @@
 if($action eq 'detailedversion') { return 1; }
 
 %director=(
+
+'newmesg',"Recent.pl&new_messages",
+
 #'regenfullog',"Snark.pl&regenfullog",
 #'huntlog',"Snark.pl&huntlog_show",
 #'showguns',"Snark.pl&show_guns",
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 01:41:34 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 01:52:53 +0300
@@ -322,6 +322,8 @@
 					# make separate routine for $.. => %.. processing?
 					# but we still need to know $pdate...
 					
+					$postnum++;
+
 					if ( $pdate < $oldest_date ) {
 						$prev = \%retpost;
 						next;
@@ -334,7 +336,6 @@
 
 					push @retthread, \%retpost;
 
-					$postnum++;
 				}
 
 				fclose ( THREAD );
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 01:52:53 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 01:57:07 +0300
@@ -446,9 +446,9 @@
 					if ( exists $curpost->{file} ) {
 						$file = qq(<hr class="hr" style="width: 100%" />
 						<span class="small" style="float: left; width: 49%" >
-							<a href="$uploadurl/$file" target="_blank" >
+							<a href="$uploadurl/$curpost->{file}" target="_blank" >
 								<img src="$imagesdir/paperclip.gif" border="0" align="middle" />
-								$file
+								$curpost->{file}
 							</a>
 						</span>);
 					}
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 01:57:07 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 01:59:48 +0300
@@ -478,6 +478,8 @@
 
 	$yytitle = 'Under Construction :))';
 
+	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
+
 	template;
 	exit;
 }
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 01:59:48 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 02:15:49 +0300
@@ -180,8 +180,8 @@
 
 	if ( $id eq 'Guest' ) {
 		$retval{type} = 'guest';
-	} elsif ( -e "$memberdir/$muid.vars" ) {
-		$retval{uid}   = $muid;
+	} elsif ( -e "$memberdir/$id.vars" ) {
+		$retval{uid}  = $id;
 		$retval{type} = 'user';
 	} else { # load user just to know, if he is ex... o_O but... and this requires extra arg - date...
 		$retval{type} = 'ex';
@@ -201,7 +201,7 @@
 	}
 
 	if ( not $iamguest and exists $user->{uid} ) {
-		$retval = qq(<a href="$scripturl?action=vievprofile;username=${user->{uid}}" >$retval</a>)
+		$retval = qq(<a href="$scripturl?action=vievprofile;username=$user->{uid}" >$retval</a>)
 	}
 
 	return $retval
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 02:15:49 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 02:23:53 +0300
@@ -378,7 +378,7 @@
 	# emulates that.
 
 	my $navbar = qq(<a href="$scripturl" >$boardname</a>);
-	my $nbsep  = q( &rquot; );
+	my $nbsep  = q( &raquo; );
 
 	$yymain .= qq(<form action="$scripturl?action=unimplemented" method="post" >); #???
 
@@ -445,15 +445,15 @@
 					my $file = '';
 					if ( exists $curpost->{file} ) {
 						$file = qq(<hr class="hr" style="width: 100%" />
-						<span class="small" style="float: left; width: 49%" >
+						<div class="attachment" >
 							<a href="$uploadurl/$curpost->{file}" target="_blank" >
 								<img src="$imagesdir/paperclip.gif" border="0" align="middle" />
 								$curpost->{file}
 							</a>
-						</span>);
+						</div>);
 					}
 					
-					$yymain .= qq(<div class="messagecontainer" >
+					$yymain .= qq(<div class="postcontainer" >
 						<div class="postheader" >
 							$icon
 							From $author on $posted
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 02:23:53 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 02:46:38 +0300
@@ -406,10 +406,11 @@
 				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}" class="icon" />);
 
 				$yymain .= qq(<div class="threadcontainer" >
-				<div class="threadheader">
+				<div class="titlebg">
 					$icon 
 					Started by $author on $started
 					<div class="navbar" >$navbar</div>
+					<right>Mark: <input class="cboxmarkread" type="checkbox" name="tid$curthread->{id}" checked="checked" /></right>
 				</div>);
 
 				foreach my $curpost ( @{$curthread->{n}} ) {
@@ -445,7 +446,7 @@
 					my $file = '';
 					if ( exists $curpost->{file} ) {
 						$file = qq(<hr class="hr" style="width: 100%" />
-						<div class="attachment" >
+						<div class="windowbg2" >
 							<a href="$uploadurl/$curpost->{file}" target="_blank" >
 								<img src="$imagesdir/paperclip.gif" border="0" align="middle" />
 								$curpost->{file}
@@ -453,19 +454,19 @@
 						</div>);
 					}
 					
-					$yymain .= qq(<div class="postcontainer" >
-						<div class="postheader" >
+					$yymain .= qq(<div class="windowbg" >
+						<div class="windowbg2" >
 							$icon
 							From $author on $posted
 							<div class="postsubj" >$postlink</div>
+							<hr class="hr" style="width: 100%" />
 						</div>
 						$message
 						$file
 					</div>);
 				}
 
-				$yymain .= qq(<input class="cboxmarkread" type="checkbox" name="tid$curthread->{id}" checked="checked" />
-						</div>); #???
+				$yymain .= qq(</div>);
 			}
 
 			$yymain .= qq(</div>);
@@ -478,7 +479,7 @@
 
 	$yytitle = 'Under Construction :))';
 
-	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
+#	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
 
 	template;
 	exit;
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 02:46:38 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 02:49:54 +0300
@@ -410,7 +410,7 @@
 					$icon 
 					Started by $author on $started
 					<div class="navbar" >$navbar</div>
-					<right>Mark: <input class="cboxmarkread" type="checkbox" name="tid$curthread->{id}" checked="checked" /></right>
+					<div class="readmark" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
 				</div>);
 
 				foreach my $curpost ( @{$curthread->{n}} ) {
@@ -479,7 +479,7 @@
 
 	$yytitle = 'Under Construction :))';
 
-#	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
+	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
 
 	template;
 	exit;
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 02:49:54 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 02:59:53 +0300
@@ -406,11 +406,11 @@
 				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}" class="icon" />);
 
 				$yymain .= qq(<div class="threadcontainer" >
-				<div class="titlebg">
+				<div class="catbg">
 					$icon 
 					Started by $author on $started
-					<div class="navbar" >$navbar</div>
-					<div class="readmark" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
+					<div style="float: left;  width: 80%" >$navbar</div>
+					<div style="float: right; width: 15%" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
 				</div>);
 
 				foreach my $curpost ( @{$curthread->{n}} ) {
@@ -455,7 +455,7 @@
 					}
 					
 					$yymain .= qq(<div class="windowbg" >
-						<div class="windowbg2" >
+						<div class="titlebg" >
 							$icon
 							From $author on $posted
 							<div class="postsubj" >$postlink</div>
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 02:59:53 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 03:06:53 +0300
@@ -403,14 +403,13 @@
 				my $author  = nm_user_link $curthread->{owner};
 				my $started = timeformat   $curthread->{date};
 				# FIXME: check, add state handling.
-				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}" class="icon" />);
+				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}.gif" />);
 
 				$yymain .= qq(<div class="threadcontainer" >
-				<div class="catbg">
-					$icon 
+				<div class="catbg" >
+					<div style="float: left;  width: 88%" >$icon $navbar</div>
+					<div style="float: right; width: 10%" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
 					Started by $author on $started
-					<div style="float: left;  width: 80%" >$navbar</div>
-					<div style="float: right; width: 15%" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
 				</div>);
 
 				foreach my $curpost ( @{$curthread->{n}} ) {
@@ -440,7 +439,7 @@
 					wrap2; # >:(
 					ToChars $message; # hate that...
 
-					my $icon     = qq(<img src="$imagesdir/$curpost->{icon}" class="icon" />);
+					my $icon     = qq(<img src="$imagesdir/$curpost->{icon}.gif" />);
 					my $postlink = qq(<a href="$scripturl?num=$curthread->{id}/$curpost->{num}\#$curpost->{num}" >$curpost->{num} $subject</a>);
 
 					my $file = '';
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 03:06:53 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 03:08:30 +0300
@@ -406,7 +406,7 @@
 				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}.gif" />);
 
 				$yymain .= qq(<div class="threadcontainer" >
-				<div class="catbg" >
+				<div class="titlebg" >
 					<div style="float: left;  width: 88%" >$icon $navbar</div>
 					<div style="float: right; width: 10%" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
 					Started by $author on $started
@@ -454,11 +454,10 @@
 					}
 					
 					$yymain .= qq(<div class="windowbg" >
-						<div class="titlebg" >
+						<div class="catbg" >
 							$icon
 							From $author on $posted
 							<div class="postsubj" >$postlink</div>
-							<hr class="hr" style="width: 100%" />
 						</div>
 						$message
 						$file
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 03:08:30 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 03:13:47 +0300
@@ -433,6 +433,8 @@
 
 						if ( exists $curpost->{nosm} ) {
 							our $ns = 'NS'; # the same...
+						} else {
+							unset $ns
 						}
 						&DoUBBC;
 					}
--- lib/yabb-2.1/Sources/Recent.pl~	2008-04-26 03:13:47 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-04-26 03:16:26 +0300
@@ -436,6 +436,8 @@
 						} else {
 							unset $ns
 						}
+
+						# FIXME: should set global $displayname for /me >:(
 						&DoUBBC;
 					}
 					wrap2; # >:(
--- Recent.pl.orig	2008-04-26 11:36:06 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Recent.pl	2008-04-27 16:24:37 +0300
@@ -14,12 +14,14 @@
 #               Your source for web hosting, web design, and domains.         #
 ###############################################################################
 
-
 $recentplver = 'YaBB 2.1 $Revision: 1.1 $';
 if ($action eq 'detailedversion') { return 1; }
 
+LoadLanguage ( 'Recent' );
+
 # Sub RecentTopics shows all the most recently posted topics
 # Meaning each thread will show up ONCE in the list.
+# removed - have no use
 
 # Sub RecentPosts will show the 10 last POSTS
 # Even if they are all from the same thread
@@ -27,152 +29,6 @@
 # Sub RecentTopicList is just a plain list (without body text)
 # Same as Sub RecentTopics.
 
-sub RecentTopics {
-	&spam_protection;
-	my $display = $INFO{'display'} ||= 10;
-	my (@memset, @categories, %data, $numfound, $curcat, %catname, %catid, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
-
-	$numfound = 0;
-
-	unless ($mloaded == 1) { require "$boardsdir/forum.master"; }
-	foreach $catid (@categoryorder) {
-		$boardlist = $cat{$catid};
-
-		(@bdlist) = split(/\,/, $boardlist);
-		($catname, $catperms) = split(/\|/, $catinfo{"$catid"});
-		$cataccess = &CatAccess($catperms);
-		if (!$cataccess) { next; }
-
-		foreach $curboard (@bdlist) {
-			($boardname{$curboard}, $boardperms, $boardview) = split(/\|/, $board{"$curboard"});
-
-			my $access = &AccessCheck($curboard, '', $boardperms);
-			if (!$iamadmin && $access ne "granted") { next; }
-
-			$catname{$curboard} = $catname;
-
-			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
-			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
-				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
-				unless ($tstate =~ /[hm]/) {
-					$mtime = $tdate;
-					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
-					$numfound++;
-				}
-			}
-			fclose(REC_BDTXT);
-		}
-	}
-
-	@data     = reverse sort @data;
-	$numfound = 0;
-
-	for ($i = 0; $i < @data; $i++) {
-		($mtime, $curboard, $tnum, $treplies, $tusername, $tname, $tstate) = split(/\|/, $data[$i]);
-		unless ($tstate =~ /h/) {
-			fopen(REC_THRETXT, "$datadir/$tnum.txt") || next;
-			while (<REC_THRETXT>) { $message = $_; }
-
-			# get only the last post for this thread.
-			fclose(REC_THRETXT);
-			chomp $message;
-
-			if ($message) {
-				($msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns) = split(/\|/, $message);
-				$messages[$numfound] = "$curboard|$tnum|$treplies|$tusername|$tname|$msub|$mname|$memail|$mdate|$musername|$micon|$mattach|$mip|$message|$mns|$tstate";
-				$numfound++;
-			}
-			if ($numfound == $display) { last; }
-		}
-	}
-
-	if ($numfound > 0) {
-		$counter = 1;
-		&LoadCensorList;
-	} else {
-		$yymain .= qq~<hr class="hr" /><b>$txt{'170'}</b><hr />~;
-	}
-	for ($i = 0; $i < $numfound; $i++) {
-		($board, $tnum, $c, $tusername, $tname, $msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $tstate) = split(/\|/, $messages[$i]);
-		$displayname = $mname;
-
-		if ($tusername ne 'Guest' && -e ("$memberdir/$tusername.vars")) { &LoadUser($tusername); }
-		if (${$uid.$tusername}{'regtime'}) {
-			$registrationdate = ${$uid.$tusername}{'regtime'};
-		} else {
-			$registrationdate = int(time);
-		}
-		if (${$uid.$tusername}{'regdate'} && $mtime > $registrationdate) {
-			$tname = qq~<a href="$scripturl?action=viewprofile;username=$tusername">${$uid.$tusername}{'realname'}</a>~;
-		} elsif ($tusername !~ m~Guest~ && $mtime < $registrationdate) {
-			$tname = qq~$tusername - $maintxt{'470a'}~;
-		} else {
-			$tname .= " ($maintxt{'28'})";
-		}
-
-		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
-		if (${$uid.$musername}{'regtime'}) {
-			$registrationdate = ${$uid.$musername}{'regtime'};
-		} else {
-			$registrationdate = int(time);
-		}
-		if (${$uid.$musername}{'regdate'} && $mdate > $registrationdate) {
-			$mname = qq~<a href="$scripturl?action=viewprofile;username=$musername">${$uid.$musername}{'realname'}</a>~;
-		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
-			$mname = qq~$musername - $maintxt{'470a'}~;
-		} else {
-			$mname .= " ($maintxt{'28'})";
-		}
-
-		$message = &Censor($message);
-		$msub    = &Censor($msub);
-
-		&wrap;
-		if ($enable_ubbc) {
-			$ns = $mns;
-			if (!$yyYaBBCloaded) { require "$sourcedir/YaBBC.pl"; }
-			&DoUBBC;
-		}
-		&wrap2;
-		&ToChars($msub);
-		&ToChars($message);
-		&ToChars($boardname{$board});
-#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
-
-		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
-		$mdate = &timeformat($mdate);
-		$yymain .= qq~
-<table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
-  <tr>
-    <td width="5%" align="center" class="titlebg">$counter</td>
-    <td width="95%" class="titlebg">&nbsp;$catname{$board} / $boardname{$board} / <a href="$scripturl?num=$tnum/$c#$c"><u>$msub</u></a><br />
-    &nbsp;<span class="small">$maintxt{'30'}: $mdate&nbsp;</span></td>
-  </tr><tr>
-    <td colspan="2" class="catbg">$maintxt{'109'} $tname | $maintxt{'197'} $mname</td>
-  </tr><tr>
-    <td colspan="2" class="windowbg2" valign="top"><div style="max-height: 150px; width: 100%; overflow: auto;">$message</div></td>
-  </tr><tr>
-    <td colspan="2" class="catbg" align="right">
-~;
-		if ($tstate != 1) {
-			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum/$c#$c;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
-		}
-		$yymain .= qq~
-    </td>
-  </tr>
-</table><br />
-~;
-		++$counter;
-	}
-
-	$yymain .= qq~
-<font size="1"><a href="$cgi">$txt{'236'}</a> $txt{'237'}<br /></font>
-~;
-	$yytitle = $txt{'214'};
-	&template;
-	exit;
-}
-
 sub nm_user_struct {
 	my $id = shift;
 	my %retval;
@@ -196,33 +52,185 @@
 	my $retval = $user->{nick};
 
 	if ( $user->{type} eq 'guest' ) {
-		$retval .= " ($maintxt{'28'})";
+		$retval .= $recent_txt{guest};
 	} elsif ( $user->{type} eq 'ex' ) {
-		$retval .= " - $maintxt{'470a'}";
+		$retval .= $recent_txt{ex};
 	}
 
-	if ( not $iamguest and exists $user->{uid} ) {
+	# actually, guests cannot view this now, but we can use this routine
+	# in some other place...
+	if ( exists $user->{uid} and not $iamguest ) {
 		$retval = qq(<a href="$scripturl?action=vievprofile;username=$user->{uid}" >$retval</a>)
 	}
 
 	return $retval
 }
 
-sub new_messages {
+# template - I separated this to see, how it will be,
+# if we will use templatetoolkit, this is just code, that
+# emulates that.
 
-	# cat: id, name,
-	#  board: id, name
-	#   thread: id = date, name, owner, icon, state
-	#    post: num, date, name, text, owner, icon, nosm, file
+sub nm_template {
+
+	my $a = shift;
+
+	foreach my $err ( @{$a->{err}} ) {
+		$yymain .= qq(
+		<div class="error" >
+			<div class="title">$recent_txt{'etitle_file'}$err->{src}$recent_txt{'etitle_sub'}$err->{func}</div>
+			$err->{text}
+		</div>);
+	}
+
+	if ( not exists $a->{content} or not @{$a->{content}} ) {
+		$yymain .= qq(
+		<div class="error" >
+			$recent_txt{err_nonewposts}
+		</div>);
+		
+		$yytitle = $recent_txt{'nonewmesg_title'};
+		$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="$forumstylesurl/$usestyle/new_messages.css" />);
+		
+		template;
+
+		return;
+	}
+
+	my $navbar = qq(<a href="$scripturl" >$mbname</a>);
+	my $nbsep  = q( &raquo; );
+
+	$yymain .= qq(
+	<form action="$scripturl?action=newmarkread" method="post" >); #???
+
+	foreach my $curcat ( @{$a->{content}} ){
+
+		ToChars $curcat->{name};
+		my $navbar = qq($navbar$nbsep<a href="$scripturl?catselect=$curcat->{id}">$curcat->{name}</a>);
+
+		$yymain .= qq(
+		<div class="category" >);
+
+		foreach my $curboard ( @{$curcat->{n}} ) {
+
+			ToChars $curboard->{name};
+			my $navbar = qq($navbar$nbsep<a href="$scripturl?board=$curboard->{id}">$curboard->{name}</a>);
+
+			$yymain .= qq(
+			<div class="board" >);
+
+			foreach my $curthread ( @{$curboard->{n}}) {
+
+# cat:      id, name,
+#  board:   id, name
+#   thread: id = date, name, owner, icon, state
+#    post:  num, date, name, owner, icon, text, nosm, file
+
+				ToChars $curthread->{name};
+				my $navbar  = qq($navbar$nbsep<a href="$scripturl?num=$curthread->{id}">$curthread->{name}</a>);
+				my $author  = nm_user_link $curthread->{owner};
+				my $started = timeformat   $curthread->{date};
+				# FIXME: add state handling?
+				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}.gif" class="icon" />);
+
+				$yymain .= qq(
+				<div class="thread" >
+					<div class="title" >
+						$icon <div class="subject" >$navbar</div>
+						<div class="mark" >$recent_txt{mark}<input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
+						$recent_txt{started}$author$recent_txt{on}$started
+					</div>);
+
+				foreach my $curpost ( @{$curthread->{n}} ) {
+
+					ToChars $curpost->{name};
+					my $subject = Censor $curpost->{name};
+					my $author  = nm_user_link $curpost->{owner};
+					my $posted  = timeformat   $curpost->{date};
+
+					our $message = Censor $curpost->{text}; # damned globals
+					wrap; # ...
+					if ( $enable_ubbc ) {
+						if ( not $loaded{'YaBBC.pl'} ) {
+							require "$sourcedir/YaBBC.pl"
+						}
+
+						if ( exists $curpost->{nosm} ) {
+							our $ns = 'NS'; # the same...
+						} else {
+							undef $ns
+						}
+
+						our $displayname = $curpost->{owner}->{nick}; # ...
+						&DoUBBC;
+					}
+					wrap2; # >:(
+					ToChars $message; # hate that...
+
+					my $icon     = qq(<img src="$imagesdir/$curpost->{icon}.gif" class="icon" />);
+
+					my $file = '';
+					if ( exists $curpost->{file} ) {
+						$file = qq(<div class="attachment" >
+							<a href="$uploadurl/$curpost->{file}" target="_blank" >
+								<img src="$imagesdir/paperclip.gif" class="icon" />
+								$curpost->{file}
+							</a>
+						</div>);
+					}
+					
+					$yymain .= qq(
+					<div class="post" >
+						<div class="title" >
+							<div class="num" >$curpost->{num}</div>
+							$icon
+							<div class="subject" ><a href="$scripturl?num=$curthread->{id}/$curpost->{num}\#$curpost->{num}" >$subject</a></div>
+							$recent_txt{posted}$author$recent_txt{on}$posted
+						</div>
+						<div class="message">
+							$message
+						</div>
+						$file
+					</div>);
+				}
+
+				$yymain .= qq(
+				</div>);
+			}
+
+			$yymain .= qq(
+			</div>);
+		}
+
+		$yymain .= qq(
+		</div>);
+	}
+
+	$yymain .= qq(
+		<input id="markreadsubmit" type="submit" name="markread" value="$recent_txt{markbutton}" />
+	</form>);
+
+	$yytitle = $recent_txt{'newmesg_title'};
+
+	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="$forumstylesurl/$usestyle/new_messages.css" />);
+
+	template;
+}
+
+sub new_messages {
 
 	spam_protection;
 
+	if ( $iamguest ) {
+		fatal_error $recent_txt{noguest}
+	}
+
 	my %show_boards;
-	my @retval;
+	my @retall;
+	my @err;
 
 	if ( exists $INFO{board} and exists $board{$INFO{board}} ) {
 
-		$show_boards{$INFO{board}} = 1 # $board{$INFO{board}}
+		$show_boards{$INFO{board}} = 1
 
 	} elsif ( exists $INFO{catselect} and exists $cat{$INFO{catselect}} ) {
 
@@ -237,6 +245,11 @@
 
 	getlog;
 
+	# cat:      id, name,
+	#  board:   id, name
+	#   thread: id = date, name, owner, icon, state
+	#    post:  num, date, name, owner, icon, text, nosm, file
+
 	foreach my $curcat ( @categoryorder ) {
 
 		my ( $catname, $catperms ) = split /\|/, $catinfo{$curcat};
@@ -247,6 +260,7 @@
 
 		my @retcat;
 
+		NM_BOARD:
 		foreach my $curboard ( split /,/, $cat{$curcat} ) {
 
 			next if not exists $show_boards{$curboard};
@@ -263,24 +277,39 @@
 				$oldest_date = $yyuserlog{"$curboard--mark"}
 			}
 			
-			fopen ( BOARD, "< $boardsdir/$curboard.txt" ); # err?
+			if ( not fopen ( BOARD, "< $boardsdir/$curboard.txt" ) ) {
+
+				push @err, {
+					func => 'new_messages',
+					src  => 'Recent.pl',
+					text => "$recent_txt{'err_cantopen'}'$boardsdir/$curboard.txt'"
+				}; # FIXME: this can be generated in some way
+				
+				next NM_BOARD;
+			};
 
 			my @retboard;
 
+			NM_THREAD:
 			while ( <BOARD> ) {
 				chomp;
 
-				# ?
 				my ( $tid, $tsub, $tnick, $tmail, $lpdate, $replies,
 				     $tuid, $ticon, $state ) = split /\|/, $_;
 
 				my $oldest_date = $oldest_date;
 
-				# FIXME: not handles tid--unread
-				if ( $yyuserlog{$tid} > $oldest_date ) {
+				# o_O
+				if ( exists $yyuserlog{$tid} and
+				     ( not exists $yyuserlog{"$tid--unread"} or
+				       $yyuserlog{"$tid--unread"} < $yyuserlog{$tid} ) and
+				     $yyuserlog{$tid} > $oldest_date ) {
+
 					$oldest_date = $yyuserlog{$tid}
 				}
 
+				# add poll handling?
+
 				if ( $lpdate < $oldest_date ) {
 					last # ?
 				}
@@ -289,7 +318,16 @@
 					next
 				}
 
-				fopen ( THREAD, "< $datadir/$tid.txt" );
+				if ( not fopen ( THREAD, "< $datadir/$tid.txt" ) ) {
+
+					push @err, {
+						func => 'new_messages',
+						src  => 'Recent.pl',
+						text => "$recent_txt{'err_cantopen'}'$datadir/$tid.txt'"
+					}; # FIXME
+						
+					next NM_THREAD;
+				};
 
 				my $prev;
 				my @retthread;
@@ -306,7 +344,7 @@
 						num   => $postnum,
 						date  => $pdate,
 						name  => $sub,
-						icon  => $icon, # url?
+						icon  => $icon,
 						text  => $text,
 						owner => nm_user_struct ( $puid, $nick )
 					);
@@ -316,13 +354,18 @@
 					}
 
 					if ( $attfile and -e "$uploaddir/$attfile" ) {
+
 						$retpost{file} = $attfile
-					}
 
-					# FIXME: ugly.
-					# make separate routine for $.. => %.. processing?
-					# but we still need to know $pdate...
-					
+					} elsif ( $attfile ) {
+
+						push @err, {
+							func => 'new_messages',
+							src  => 'Recent.pl',
+							text => "$tid/$postnum$recent_txt{'err_delattach'}$attfile"
+						}; # FIXME
+					};
+
 					$postnum++;
 
 					if ( $pdate < $oldest_date ) {
@@ -348,8 +391,8 @@
 					date  => $tid,
 					name  => $tsub,
 					owner => nm_user_struct ( $tuid, $tnick ),
-					icon  => $ticon, # optional? url?
-					state => $state, # optional? process?
+					icon  => $ticon,
+					state => $state, # maybe, instead, supply possible actions menu?
 					n     => \@retthread
 				}
 			}
@@ -367,125 +410,42 @@
 
 		next if not @retcat;
 
-		push @retval, {
+		push @retall, {
 			id   => $curcat,
 			name => $catname,
 			n    => \@retcat
 		}
 	}
 
-	# template - I separated this to see, how it will be,
-	# if we will use templatetoolkit, this is just code, that
-	# emulates that.
-
-	my $navbar = qq(<a href="$scripturl" >$boardname</a>);
-	my $nbsep  = q( &raquo; );
-
-	$yymain .= qq(<form action="$scripturl?action=unimplemented" method="post" >); #???
-
-	foreach my $curcat ( @retval ){
+	nm_template {
+		err     => \@err,
+		content => \@retall
+	};
 
-		ToChars $curcat->{name};
-		my $navbar = qq($navbar$nbsep<a href="$scripturl?catselect=$curcat->{id}">$curcat->{name}</a>);
-
-		$yymain .= qq(<div class="catcontainer" >);
-
-		foreach my $curboard ( @{$curcat->{n}} ) {
-
-			ToChars $curboard->{name};
-			my $navbar = qq($navbar$nbsep<a href="$scripturl?board=$curboard->{id}">$curboard->{name}</a>);
-
-			$yymain .= qq(<div class="boardcontainer" >);
-
-			foreach my $curthread ( @{$curboard->{n}}) {
-
-				ToChars $curthread->{name};
-				my $navbar  = qq($navbar$nbsep<a href="$scripturl?num=$curthread->{id}">$curthread->{name}</a>);
-				my $author  = nm_user_link $curthread->{owner};
-				my $started = timeformat   $curthread->{date};
-				# FIXME: check, add state handling.
-				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}.gif" />);
-
-				$yymain .= qq(<div class="threadcontainer" >
-				<div class="titlebg" >
-					<div style="float: left;  width: 88%" >$icon $navbar</div>
-					<div style="float: right; width: 10%" >Mark: <input type="checkbox" name="tid$curthread->{id}" checked="checked" /></div>
-					Started by $author on $started
-				</div>);
-
-				foreach my $curpost ( @{$curthread->{n}} ) {
-
-	# cat:      id, name,
-	#  board:   id, name
-	#   thread: id = date, name, owner, icon, state
-	#    post:  num, date, name, owner, icon, text, nosm, file
-
-					ToChars $curpost->{name};
-					my $subject = Censor $curpost->{name};
-					my $author  = nm_user_link $curpost->{owner};
-					my $posted  = timeformat   $curpost->{date};
-
-					our $message = Censor $curpost->{text}; # damned globals
-					wrap; # ...
-					if ( $enable_ubbc ) {
-						if ( not $loaded{'YaBBC.pl'} ) {
-							require "$sourcedir/YaBBC.pl"
-						}
-
-						if ( exists $curpost->{nosm} ) {
-							our $ns = 'NS'; # the same...
-						} else {
-							unset $ns
-						}
-
-						# FIXME: should set global $displayname for /me >:(
-						&DoUBBC;
-					}
-					wrap2; # >:(
-					ToChars $message; # hate that...
+	exit;
+}
 
-					my $icon     = qq(<img src="$imagesdir/$curpost->{icon}.gif" />);
-					my $postlink = qq(<a href="$scripturl?num=$curthread->{id}/$curpost->{num}\#$curpost->{num}" >$curpost->{num} $subject</a>);
+sub nm_mark_read {
+	
+	if ( $iamguest ) {
+		fatal_error $recent_txt{'err_noguest'}
+	}
 
-					my $file = '';
-					if ( exists $curpost->{file} ) {
-						$file = qq(<hr class="hr" style="width: 100%" />
-						<div class="windowbg2" >
-							<a href="$uploadurl/$curpost->{file}" target="_blank" >
-								<img src="$imagesdir/paperclip.gif" border="0" align="middle" />
-								$curpost->{file}
-							</a>
-						</div>);
-					}
-					
-					$yymain .= qq(<div class="windowbg" >
-						<div class="catbg" >
-							$icon
-							From $author on $posted
-							<div class="postsubj" >$postlink</div>
-						</div>
-						$message
-						$file
-					</div>);
-				}
+	getlog;
 
-				$yymain .= qq(</div>);
-			}
+	foreach my $key ( keys %FORM ) {
 
-			$yymain .= qq(</div>);
-		}
+		next if $key !~ m/\Atid(\d+)\Z/s;
+		next if $FORM{$key} eq '';
+		next if not -e "$datadir/$1.txt";
 
-		$yymain .= qq(</div>);
+		modlog $1
 	}
 
-	$yymain .= qq(<input class="submitmarkread" type="submit" name="markread" value="Mark checked threads as read" /></form>); #???
+	dumplog;
 
-	$yytitle = 'Under Construction :))';
-
-	$yyinlinestyle = qq(<link rel="stylesheet" type="text/css" href="http://linux.org.ua/temp.css" />);
-
-	template;
-	exit;
+	$yySetLocation = $scripturl;
+	redirectexit
 }
 
 sub RecentPosts {
@@ -577,9 +537,9 @@
 		if (${$uid.$tusername}{'regdate'} && $trstart > $registrationdate) {
 			$tname = qq~<a href="$scripturl?action=viewprofile;username=$tusername">${$uid.$tusername}{'realname'}</a>~;
 		} elsif ($tusername !~ m~Guest~ && $trstart < $registrationdate) {
-			$tname = qq~$tusername - $maintxt{'470a'}~;
+			$tname = qq($tusername$recent_txt{ex});
 		} else {
-			$tname .= " ($maintxt{'28'})";
+			$tname .= $recent_txt{guest};
 		}
 
 		if ($musername ne 'Guest' && -e ("$memberdir/$musername.vars")) { &LoadUser($musername); }
@@ -591,9 +551,9 @@
 		if (${$uid.$musername}{'regdate'} && $mdate > $registrationdate) {
 			$mname = qq~<a href="$scripturl?action=viewprofile;username=$musername">${$uid.$musername}{'realname'}</a>~;
 		} elsif ($musername !~ m~Guest~ && $mdate < $registrationdate) {
-			$mname = qq~$musername - $maintxt{'470a'}~;
+			$mname = qq($musername$recent_txt{ex});
 		} else {
-			$mname .= " ($maintxt{'28'})";
+			$mname .= $recent_txt{guest};
 		}
 
 		$message = &Censor($text); # damned global...
@@ -614,8 +574,8 @@
 		my $attach='';
 		if ( $mfn and -e "$uploaddir/$mfn" ) {
 			$attach = qq~
-	<hr class="hr" style="width: 100%" />
-	<span class="small" style="float: left; width: 49%" ><a href="$uploadurl/$mfn" target="_blank"><img src="$imagesdir/paperclip.gif" border="0" align="middle" alt="" /> $mfn</a></span>
+			<hr class="hr" style="width: 100%" />
+			<span class="small" style="float: left; width: 49%" ><a href="$uploadurl/$mfn" target="_blank"><img src="$imagesdir/paperclip.gif" border="0" align="middle" alt="" /> $mfn</a></span>
 ~;
 		}
 
@@ -623,32 +583,27 @@
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
-  <tr>
-    <td width="5%" align="center" class="titlebg">$counter</td>
-    <td width="95%" class="titlebg">&nbsp;<a href="$scripturl?catselect=$catid{$board}">$catname{$board}</a> / <a href="$scripturl?board=$board">$boardname{$board}</a> / <a href="$scripturl?num=$tnum/$c#$c">$msub</a><br />
-    &nbsp;<span class="small">$maintxt{'30'}: $mdate&nbsp;</span></td>
-  </tr><tr>
-    <td colspan="2" class="catbg">$maintxt{'109'} $tname | $maintxt{'197'} $mname</td>
-  </tr><tr>
-    <td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span>$attach</td>
-  </tr><tr>
-    <td colspan="2" class="catbg" align="right">
-~;
+	<tr>
+		<td width="5%" align="center" class="titlebg">$counter</td>
+		<td width="95%" class="titlebg">&nbsp;<a href="$scripturl?catselect=$catid{$board}">$catname{$board}</a> / <a href="$scripturl?board=$board">$boardname{$board}</a> / <a href="$scripturl?num=$tnum/$c#$c">$msub</a><br />
+		<span class="small">$recent_txt{on}$mdate</span></td>
+	</tr><tr>
+		<td colspan="2" class="catbg">$recent_txt{started}$tname | $recent_txt{posted}$mname</td>
+	</tr><tr>
+		<td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span>$attach</td>
+	</tr><tr>
+		<td colspan="2" class="catbg" align="right">~;
 		if ($tstate != 1) {
 			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum/$c#$c;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
 		}
-		$yymain .= qq~
-    </td>
-  </tr>
+		$yymain .= qq~</td>
+	</tr>
 </table><br />
 ~;
 		++$counter;
 	}
 
-	$yymain .= qq~
-<font size="1"><a href="$cgi">$txt{'236'}</a> $txt{'237'}<br /></font>
-~;
-	$yytitle = $txt{'214'};
+	$yytitle = $display . $recent_txt{recent_title};
 	&template;
 	exit;
 }


Sun, 27 Apr 2008 23:40:19 +0300
Fix for access rights:
--- lib/yabb-2.1/Sources/Recent.pl	2008-04-27 23:25:02 +0300
+++ /home/isbear/tmp/Sources/Recent.pl	2008-04-27 16:02:00 +0300
@@ -254,7 +254,7 @@
 
 		my ( $catname, $catperms ) = split /\|/, $catinfo{$curcat};
 
-		if ( not CatAccess $catperms ) {
+		if ( not CatAccess ( $curcat, $catperms ) ) {
 			next
 		}
 

Small fix for calling convention of getlog - to not produce extra vars.
--- linux.org.ua/lib/yabb-2.1/Sources/BoardIndex.pl~	2008-04-01 17:59:39 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/BoardIndex.pl	2008-04-27 23:42:37 +0300
@@ -166,8 +166,11 @@
 			$cat_boardcnt{$catid}++;
 		}
 	}
+
 	&BoardTotals("load", @loadboards);
-	&getlog(@goodboards);
+
+	getlog;
+
 	foreach $curboard (@loadboards) {
 		chomp $curboard;
 		$lastposttime = ${$uid.$curboard}{'lastposttime'};
--- linux.org.ua/lib/yabb-2.1/Sources/Display.pl~	2008-03-31 07:08:36 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Display.pl	2008-04-27 23:45:38 +0300
@@ -34,7 +34,9 @@
 		# comparing times in the username.log and the boardnumber.txt files.
 		if (!$iamguest && $max_log_days_old) {
 			$mnum = $INFO{'num'};
-			&getlog($mnum);
+
+			getlog;
+
 			$dlp = $yyuserlog{$mnum} || 0;
 			$dlpb = $yyuserlog{"$currentboard--mark"} || 0;
 			$dlp = $dlp > $dlpb ? $dlp : $dlpb;
@@ -96,7 +98,9 @@
 	# Mark current board as read if called from Last Post.
 	&BoardTotals("load", $currentboard);
 	if ($mnum == ${$uid.$currentboard}{'lastpostid'}) {
-		&getlog($currentboard);
+
+		getlog;
+
 		my $lastboardvisit = $yyuserlog{$currentboard} ? $yyuserlog{$currentboard} : 0;
 		if ($mdate > $lastboardvisit) {
 			&dumplog($currentboard);
--- linux.org.ua/lib/yabb-2.1/Sources/MessageIndex.pl~	2007-10-15 19:14:55 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/MessageIndex.pl	2008-04-27 23:47:35 +0300
@@ -357,9 +357,9 @@
 
 	# Begin printing the message index for current board.
 	$counter = $start;
-	my @logthreads = @threads;
-	push(@logthreads, "$curboard--mark");
-	&getlog(@logthreads);
+
+	getlog;
+
 	foreach (@threads) {
 		($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate) = split(/\|/, $_);
 
--- linux.org.ua/lib/yabb-2.1/Sources/Favorites.pl~	2007-10-15 19:12:27 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Favorites.pl	2008-04-27 23:51:11 +0300
@@ -75,9 +75,6 @@
 
 	&LoadCensorList;
 
-	# Print the header and board info.
-#	$curboardurl = $curposlinks ? qq~<a href="$scripturl?board=$currentboard" class="nav">$boardname</a>~ : $boardname;
-
 	my $homelink = qq~<a href="$scripturl" class="nav">$mbname</a>~;
 	my $catlink  = qq~<a href="$scripturl?action=favorites" class="nav">$img_txt{'70'}</a>~;
 
@@ -95,9 +92,9 @@
 
 	# Begin printing the message index for current board.
 	$counter = $start;
-	my @logthreads = @threads;
-	push(@logthreads, "$curboard--mark");
-	&getlog(@logthreads);
+
+	getlog;
+
 	foreach (@threads) {
 		($mnum, $msub, $mname, $memail, $mdate, $mreplies, $musername, $micon, $mstate) = split(/\|/, $_);
 
--- lib/yabb-2.1/Sources/Display.pl~	2008-04-27 23:45:38 +0300
+++ lib/yabb-2.1/Sources/Display.pl	2008-04-28 00:03:01 +0300
@@ -89,24 +89,26 @@
 
 	($boardname, $boardperms, $boardview) = split(/\|/, $board{"$currentboard"});
 
-	&ToChars($boardname);
+	ToChars $boardname;
 
 	# Mark current thread as read.
-	($mnum, $tmpa, $tmpa, $tmpa, $mdate) = split(/\|/, $yyThreadLine);
-	&dumplog($mnum, $date);
+	($mnum, undef, undef, undef, $mdate) = split(/\|/, $yyThreadLine);
+	modlog $mnum;
 
+	# FIXME: WTF?? It's hack - we have not really seen that list!
 	# Mark current board as read if called from Last Post.
 	&BoardTotals("load", $currentboard);
 	if ($mnum == ${$uid.$currentboard}{'lastpostid'}) {
 
-		getlog;
+		my $lastboardvisit = $yyuserlog{$currentboard} || 0;
 
-		my $lastboardvisit = $yyuserlog{$currentboard} ? $yyuserlog{$currentboard} : 0;
 		if ($mdate > $lastboardvisit) {
-			&dumplog($currentboard);
+			modlog $currentboard;
 		}
 	}
 
+	dumplog;
+
 	$views = ${$viewnum}{'views'} - 1;
 
 	# Check to make sure this thread isn't locked.


Sat, 10 May 2008 04:00:20 +0300
Patches, that add permission checks to post delete routine
For now it removes files into Trash dir, after two-three days I'll remove
that functionality.
--- lib/yabb-2.1/Sources/BoardIndex.pl~	2008-04-27 23:42:37 +0300
+++ lib/yabb-2.1/Sources/BoardIndex.pl	2008-05-10 02:37:02 +0300
@@ -602,7 +602,7 @@
 		&ToChars($lssub);
 		$tmlsdatetime    = qq~($lsdatetime).<br />~;
 		$lastpostlink    = qq~$boardindex_txt{'236'} <b><a href="$scripturl?num=$lspostid/$lsreply#$lsreply"><b>$lssub</b></a></b>~;
-		$recentpostslink = qq~$boardindex_txt{'791'} <a href="$scripturl?action=recent;display=8">$boardindex_txt{'792'}</a> $boardindex_txt{'793'}~;
+		$recentpostslink = qq~$boardindex_txt{'791'} <a href="$scripturl?action=recent;display=10">$boardindex_txt{'792'}</a> $boardindex_txt{'793'}~;
 		$boardindex_template =~ s/<yabb lastpostlink>/$lastpostlink/g;
 		$boardindex_template =~ s/<yabb recentposts>/$recentpostslink/g;
 		$boardindex_template =~ s/<yabb lastpostdate>/$tmlsdatetime/g;
--- lib/yabb-2.1/Sources/Display.pl~	2008-04-28 00:03:01 +0300
+++ lib/yabb-2.1/Sources/Display.pl	2008-05-10 03:14:12 +0300
@@ -602,7 +602,7 @@
 		my $posthandelblock = $posthandellist;
 		my $contactblock    = $contactlist;
 
-		if ($mstate !~ /l/i) {
+		if ($mstate !~ /l/i) { # FIXME: not checks access rights.
 			unless (($enable_guestposting == 0 && $iamguest) || &AccessCheck($currentboard, 2) ne "granted" || ($annboard eq $currentboard && !$iamadmin && !$iamgmod)) {
 				$template_quote = qq~$menusep<a href="$scripturl?action=post;num=$viewnum;quote=$counter;title=PostReply">$img{'replyquote'}</a>~;
 			}
@@ -615,12 +615,14 @@
 				$template_split = qq~$menusep<a href="$scripturl?board=$currentboard;action=split2;thread=$viewnum;postid=$counter">$img{'admin_split'}</a>~;
 			}
 			if ($iammod || $iamadmin || $iamgmod || ($username eq $musername && !$iamguest && !$exmem && $nodelallowed == 0) && $sessionvalid == 1) {
-				$template_delete = qq~$menusep<span style="cursor: pointer; cursor: hand;" onclick="uncheckAllBut($counter);">$img{'delete'}</span>~;
+#				$template_delete = qq~$menusep<span style="cursor: pointer; cursor: hand;" onclick="uncheckAllBut($counter);">$img{'delete'}</span>~;
+				$template_delete = qq~$menusep<a href="$scripturl?action=multidel;thread=$viewnum;message=$counter" >$img{'delete'}</a>~;
 
 				if (($iammod && $mdmod eq 1) || ($iamadmin && $mdadmin eq 1) || ($iamgmod && $mdglobal eq 1) && $sessionvalid == 1) {
 					$template_admin = qq~<input type="checkbox" class="$css" style="border: 0px;" name="del$counter" value="$counter" />~;
 				} else {
-					$template_admin = qq~ <input type="checkbox" class="$css" style="border: 0px; visibility: hidden; display: none;" name="del$counter" value="$counter" />~;
+#					$template_admin = qq~ <input type="checkbox" class="$css" style="border: 0px; visibility: hidden; display: none;" name="del$counter" value="$counter" />~;
+					$template_admin = qq~~;
 				}
 			} else {
 				$template_delete = "";
--- /home/isbear/ModifyMessage.pl.old	2008-05-10 03:00:28 +0300
+++ lib/yabb-2.1/Sources/ModifyMessage.pl	2008-05-10 03:01:24 +0300
@@ -527,7 +527,7 @@
 	$message =~ s/\cM//g;
 	$message =~ s~\[([^\]]{0,30})\n([^\]]{0,30})\]~\[$1$2\]~g;
 	$message =~ s~\[/([^\]]{0,30})\n([^\]]{0,30})\]~\[/$1$2\]~g;
-	$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g;
+	$message =~ s~(\w+://[^<>\s\n\"\]\[]+)\n([^<>\s\n\"\]\[]+)~$1\n$2~g; # "
 	&ToHTML($message);
 	$message =~ s/\t/ \&nbsp; \&nbsp; \&nbsp;/g;
 	$message =~ s~\n~<br />~g;
@@ -535,7 +535,7 @@
 		$tsub  = $subject;
 		$ticon = $icon;
 	}
-	$yyThreadLine = qq~$tnum|$tsub|$tname|$temail|$tdate|$treplies|$tusername|$ticon|$tstate\n~;
+	$yyThreadLine = qq($tnum|$tsub|$tname|$temail|$tdate|$treplies|$tusername|$ticon|$tstate\n);
 
 	if ($mip =~ /$user_ip/) { $useredit_ip = $mip; }
 	else { $useredit_ip = "$mip $user_ip"; }
@@ -633,162 +633,358 @@
 		&ManageThreadNotify("delete", $thread, $username);
 	}
 
-	$yySetLocation = qq~$scripturl?num=$threadid/$start#$postid~;
+	$yySetLocation = qq($scripturl?num=$threadid/$start#$postid);
 	&redirectexit;
 }
 
-sub MultiDel {
-	$yySetLocation = qq~$scripturl?num=$INFO{'thread'}/$INFO{'start'}~;
+# All this sub represents premature optimization :(
+sub remove_atts {
 
-	$thread = $INFO{'thread'};
+	my $attfiles = shift;
+	if ( not ref $attfiles ) {
+		$attfiles = [ $attfiles ]
+	}
 
-	fopen(FILE, "$datadir/$thread.txt", 1) || &fatal_error("$post_txt{'23'} $thread.txt", 1);
-	@messages = <FILE>;
-	fclose(FILE);
-	$messcount = @messages;
-
-	# check all checkboxes, delete posts if checkbox is ticked
-	$kill = 0;
-
-	for ($count = $messcount; $count > -1; $count--) {
-		if ($FORM{"del$count"} ne '') {
-			@message = split(/\|/, $messages[$count]);
-			if ($message[12] ne "") { &remove_att($message[12]); }
-			splice(@messages, $count, 1);
-			$kill++;
-
-			# decrease members post count if not in a zero post count board
-			if (!${$uid.$currentboard}{'zero'}) {
-				$musername = $message[4];
-				if ($musername ne 'Guest') {
-					if (!${$uid.$musername}{'password'}) {
-						&LoadUser($musername);
-					}
-					if (${$uid.$musername}{'postcount'} > 0) {
-						${$uid.$musername}{'postcount'}--;
-						&UserAccount($musername, "update");
-					}
-					if (${$uid.$musername}{'position'}) {
-						$grp_after = qq~${$uid.$musername}{'position'}~;
-					} else {
-						foreach $postamount (sort { $b <=> $a } keys %Post) {
-							if (${$uid.$musername}{'postcount'} > $postamount) {
-								($title, undef) = split(/\|/, $Post{$postamount}, 2);
-								$grp_after = $title;
-								last;
-							}
+	if ( not fopen ( ATTLIST, "+< $vardir/attachments.txt" ) ) {
+		# what to do here?
+		return 0
+	}
+
+	my @attachments = <ATTLIST>;
+
+	# make regex to match all files in list at once for one grep lookup
+	my $attfile_rx = '\|(';
+	my $first = 1;
+	foreach my $attfile ( @$attfiles ) {
+
+		if ( -e "$uploaddir/$attfile" ) { # do it later?
+			if ( not -e "$uploadtrashdir/$attfile" ) { # paranoid :(
+				rename "$uploaddir/$attfile", "$uploadtrashdir/$attfile"
+			}
+
+			if ( -e "$uploaddir/$attfile" ) {
+				unlink "$uploaddir/$attfile"
+			}
+		}
+		
+		$attfile_rx .= quotemeta $attfile;
+
+		if ( not $first ) {
+			$attfile_rx .= '|'
+		} else {
+			undef $first
+		}
+	}
+	$attfile_rx .= ')\Z';
+
+	my $num = @attachments;
+	@attachments = grep !m/$attfile_rx/, @attachments; # FIXME: check shompness!!
+
+	if ( @attachments != $num ) {
+		seek     ATTLIST, 0, 0;
+		print    ATTLIST  @attachments;
+		truncate ATTLIST, tell ATTLIST;
+	}
+
+	fclose ( ATTLIST );
+
+	return 1
+}
+
+# tid arref/num
+# I wanted to make an utility function from that, but failed :(
+# it is either too expensive or too unmaintainable.
+# so, security checks and fatal errors are present here.
+# IMHO, we just need a routine to load thread into form of hash
+# this can be wasteful if used on many threads, but for such
+# actions we can work directly or make 'unload' routine.
+# then all security checks can be done before calling utility routine.
+sub delete_posts {
+
+	my $tid = shift;
+
+
+	MessageTotals 'load', $tid;
+
+	# I know about that strange checks in Security, but
+	# they are strange and in this case they, imho, will not
+	# work... - there is used 'thread' instead of 'num'
+	our $curboard = ${$tid}{board};
+
+	# hm. now it checks for postthread ('1') rights.
+	# but we also have '2' - postreply rights.
+
+	# we use '1' (postthread) to restrict board changing, and so,
+	# require it only if we need to remove entire thread...
+	# we use '2' (postreply) to restrict reply changing...
+
+	# damn. we should require '1' only for first thread post...
+	# and require '2' for any of non-first posts o_O
+	# Ok, now it does so.
+
+	# all that AccessCheck stuff so complicated...
+	# unix oga-rwx is much better.
+
+	unless ( $iamadmin or $iamgmod or $iammod and $sessionvalid ) {
+		if ( not CatAccess ( ( split /\|/, $catinfo{${$uid.$curboard}{cat}} )[1] ) or
+		     AccessCheck ( $curboard, 0, ( split /\|/, $board{$curboard} )[1] ) ne 'granted' ) {
+			fatal_error 'access denied' # FIXME
+		} elsif ( ${$tid}{threadstatus} =~ m/l/i ) {
+			fatal_error 'thread locked' # FIXME
+		}
+	}
+
+
+	if ( not fopen ( THREAD, "$datadir/$tid.txt", 1 ) ) {
+		fatal_error "$post_txt{'23'} $tid.txt", 1
+	}
+
+	my @messages = <THREAD>;
+
+	fclose ( THREAD );
+
+	my $pids = shift;
+	if ( not ref $pids ) {
+		$pids = [ $pids ]
+	}
+
+	my @killatts;
+	my %killpc;
+	my $killboardpc;
+
+	foreach my $pid ( @$pids ) {
+
+		my ( $pdate, $puid, $attfile ) = ( split /\|/, $messages[$pid] )[3,4,12];
+
+		if ( $pid > $#messages ) {
+			fatal_error 'wrong pid' # FIXME
+		}
+
+		# FIXME: o_O one more check: ex-memberness
+		unless ( $iamadmin or $iamgmod or $iammod and $sessionvalid ) {
+			unless ( $puid eq $username and # non-admin must own post to delete it
+			         $puid ne 'Guest' ) {
+				fatal_error 'not own post' # FIXME
+			} elsif ( $tlnodelflag and # timelock
+	 	              $date > $pdate + $tlnodeltime * 24 * 60 * 60 ) {
+				fatal_error 'locked post' # FIXME
+			} elsif ( ( $pid == 0 and # starting post - check thread posting perms
+			            AccessCheck ( $curboard, 1 ) ne 'granted' ) or
+			          ( $pid != 0 and # reply - chneck reply posting perms
+			            AccessCheck ( $curboard, 2 ) ne 'granted' ) ) {
+				fatal_error 'access denied' # FIXME
+			}
+		}
+
+		chomp $attfile;
+		push @killatts, $attfile;
+
+		$killpc{$puid}++;
+		$killboardpc++;
+
+		splice @messages, $pid, 1;
+	}
+
+	# decrease members post count if not in a zero post count board
+	if ( not ${$uid.$curboard}{zero} ) {
+		foreach my $puid ( keys %killpc ) {
+			if ( $puid eq 'Guest' ) {
+				next
+			}
+
+			LoadUser $puid;
+
+			if ( ${$uid.$puid}{postcount} > 0 ) {
+			
+				${$uid.$puid}{postcount} -= $killpc{$puid};
+				if ( ${$uid.$puid}{postcount} < 0 ) {
+					${$uid.$puid}{postcount} = 0
+				}
+
+				UserAccount $puid, 'update';
+
+				# WTF with this - why so strange things organization?
+				# it shouldn't be here
+				my $grp_after = ${$uid.$puid}{position};
+				if ( not $grp_after ) {
+					foreach my $postamount ( reverse sort keys %Post ) {
+						if ( ${$uid.$puid}{postcount} > $postamount ) {
+							( $grp_after, undef ) = split /\|/, $Post{$postamount}, 2;
+							last;
 						}
 					}
-					&ManageMemberinfo("update", $musername, '', '', $grp_after, ${$uid.$musername}{'postcount'});
-					&Recent_Write("decr", $thread, $username);
 				}
+
+				ManageMemberinfo 'update', $puid, '', '', $grp_after, ${$uid.$puid}{postcount};
+			}
+
+			Recent_Load $tid;
+			if ( exists $recent{$puid} and $recent{$puid} > 0 ) {
+				$recent{$puid} -= $killpc{$puid};
+				if ( $recent{$puid} <= 0 ) {
+					delete $recent{$puid}
+				}
+				Recent_Save $tid;
 			}
 		}
 	}
 
-	my $nmes = scalar @messages;
-	if ($nmes < 1) {
+	if ( -d "$datatrashdir" ) { # even more paranoid - just while test it all to not lose info while testing
+		rename "$datadir/$tid.txt", "$datatrashdir/$date-$tid.txt"
+	}
+
+	# delete entire thread, this *does not* affects post counters,
+	# so they are decreased before.
+	if ( @messages < 1 ) {
 
 		# all post was deleted, call removethread
 		require "$sourcedir/Favorites.pl";
-		$INFO{'ref'} = "delete";
-		&RemFav($thread);
-		$iamposter = ($message[4] eq $username) ? 1 : 0;
+		$INFO{'ref'} = 'delete';
+		&RemFav ( $tid );
+
+		# This is weird thing... we should check, is it actually works now.
+		# Seems to be planned to be initialized in Security or somewhere else
+		# If it is not working - then we should fix that in other place, not here.
+		#our $iamposter = 1; # Security checks are done before.
 		require "$sourcedir/RemoveTopic.pl";
 		&RemoveThread;
+
+		exit # to be sure
 	}
 
+	remove_atts \@killatts if @killatts;
+
 	# if thread has not been deleted: update thread, update message index details ...
-	fopen(FILE, ">$datadir/$thread.txt", 1) || &fatal_error("$post_txt{'23'} $thread.txt", 1);
-	print FILE @messages;
-	fclose(FILE);
+	if ( not fopen ( THREAD, "> $datadir/$tid.txt", 1 ) ) {
+		fatal_error "$post_txt{'23'} $tid.txt", 1
+	}
+
+	print THREAD @messages;
+
+	fclose ( THREAD );
 
-	my (@firstmessage) = split(/\|/, $messages[0]);
-	my (@lastmessage)  = split(/\|/, $messages[$#messages]);
+	my ( $sub, $icon ) = ( split /\|/, $messages[0] )[0,5];
+	my ( $lpnick, $lpdate, $lpuid ) =
+						( split /\|/, $messages[$#messages] )[1,3,4];
 
 	# update the current thread
-	&MessageTotals("load", $thread);
-	${$thread}{'replies'} = $#messages;
-	${$thread}{'lastposter'} = $lastmessage[4] eq "Guest" ? qq~Guest-$lastmessage[1]~ : $lastmessage[4];
-	&MessageTotals("update", $thread);
+	${$tid}{'replies'}    = $#messages;
+	${$tid}{'lastposter'} = $lpuid eq 'Guest' ? qq(Guest-$lpnick) : $lpuid;
+	MessageTotals 'update', $tid;
 
 	# update the current board.
-	&BoardTotals("load", $currentboard);
-	${$uid.$currentboard}{'messagecount'} -= $kill;
-	&BoardTotals("update", $currentboard);
-
-	$threadline = '';
-	fopen(BOARDFILE, "+<$boardsdir/$currentboard.txt", 1) || &fatal_error("$subs_txt{'23'} $currentboard.txt", 1);
-	seek BOARDFILE, 0, 0;
-	@buffer = <BOARDFILE>;
-	truncate BOARDFILE, 0;
-	seek BOARDFILE, 0, 0;
-
-	for ($a = 0; $a < @buffer; $a++) {
-		if ($buffer[$a] =~ m~\A$thread\|~) {
-			$threadline = $buffer[$a];
-			splice(@buffer, $a, 1);
+	BoardTotals 'load', $curboard;
+	if ( ${$uid.$curboard}{messagecount} > 0 ) { # to be sure :D
+		${$uid.$curboard}{messagecount} -= $killboardpc;
+		if ( ${$uid.$curboard}{messagecount} < 0 ) {
+			${$uid.$curboard}{messagecount} = 0
+		}
+		BoardTotals 'update', $curboard;
+	}
+
+	if ( not fopen ( BOARD, "+< $boardsdir/$curboard.txt", 1 ) ) {
+		fatal_error "$subs_txt{'23'} $curboard.txt", 1
+	}
+
+	my @buffer = <BOARD>;
+
+	my $threadline = '';
+
+	for ( my $num = 0; $num < @buffer; $num++ ) {
+		if ( $buffer[$num] =~ m/\A$tid\|/ ) {
+			$threadline = $buffer[$num];
+			splice @buffer, $num, 1;
 			last;
 		}
 	}
 
 	chomp $threadline;
 
-	@newthreadline = split(/\|/, $threadline);
+	my @newthreadline = split /\|/, $threadline;
 
-	$newthreadline[1] = $firstmessage[0];         # subject of first message
-	$newthreadline[7] = $firstmessage[5];         # icon of first message
-	$newthreadline[4] = $lastmessage[3];          # date of last message
-	$newthreadline[5] = ${$thread}{'replies'};    # replay number
-	$NewThreadLine = join("|", @newthreadline) . "\n";
-
-	$inserted = 0;
-	for ($a = 0; $a < @buffer; $a++) {
-		@boardthreadline = split(/\|/, $buffer[$a]);
-		if (!$inserted && $boardthreadline[4] < $newthreadline[4]) {
-			print BOARDFILE $NewThreadLine;
+	$newthreadline[1] = $sub;
+	$newthreadline[7] = $icon;
+	$newthreadline[4] = $lpdate;
+	$newthreadline[5] = ${$tid}{replies};
+	my $NewThreadLine = join ( '|', @newthreadline ) . "\n";
+
+	seek BOARD, 0, 0;
+
+	my $inserted = 0;
+	for ( my $num = 0; $num < @buffer; $num++ ) {
+		# Here appears cURL :)
+		my $curlpdate = ( split /\|/, $buffer[$num] )[4];
+		if ( not $inserted and $curlpdate < $newthreadline[4] ) {
+			print BOARD $NewThreadLine;
 			$inserted = 1;
 		}
-		print BOARDFILE $buffer[$a];
+		print BOARD $buffer[$num];
 	}
-	if (!$inserted) {
-		print BOARDFILE $NewThreadLine;
+
+	if ( not $inserted ) {
+		print BOARD $NewThreadLine;
 	}
-	fclose(BOARDFILE);
-	&dumplog($board);
 
-	fclose(BOARDFILE);
+	truncate BOARD, tell BOARD;
 
-	&BoardSetLastInfo($currentboard);
+	fclose ( BOARD );
 
-	if ($INFO{'d'} eq '1') {
-		$postid = $postid > ${$thread}{'replies'} ? ${$thread}{'replies'} : $postid;
-		my $start = int($postid / $maxmessagedisplay) * $maxmessagedisplay;
-		$yySetLocation = qq~$scripturl?num=$threadid/$start#$postid~;
-	}
-	&redirectexit;
+# why? we have not seen board. Or supply date to mark with...
+# which relationship between $board and $curboard?
+#	dumplog $board;
+
+	BoardSetLastInfo $curboard; # TODO: check, is it required
+
+	return 1
 }
 
-sub remove_att {
-	my $rematt = $_[0];
-	chomp $rematt;
-	if (-e ("$uploaddir/$rematt")) {
-		fopen(AMV, "$vardir/attachments.txt");
-		my @attachments = <AMV>;
-		fclose(AMV);
-		fopen(AMV, ">$vardir/attachments.txt");
-		foreach $row (@attachments) {
-			chomp $row;
-			my ($amthreadid, $amreplies, $amthreadsub, $amposter, $amcurrentboard, $amkb, $amdate, $amfn) = split(/\|/, $row);
-			if ($rematt ne $amfn) {
-				print AMV qq~$amthreadid|$amreplies|$amthreadsub|$amposter|$currentboard|$amkb|$amdate|$amfn\n~;
-			}
+sub MultiDel {
+	
+	my $tid = $INFO{'thread'};
+
+	if ( $tid =~ /\D/s ) {
+		fatal_error $post_txt{337} # check
+	}
+
+	if ( exists $INFO{message} ) {
+
+		my $pid = $INFO{message};
+
+		if ( $pid =~ /\D/s ) {
+			fatal_error "wrong post id" # FIXME
 		}
-		fclose(AMV);
-		unlink("$uploaddir/$rematt");
+
+		delete_posts $tid, $pid
+
 	} else {
-		return 0;
+
+		my @pids;
+
+		foreach my $arg ( keys %FORM ) {
+			next if $arg !~ /\Adel(\d+)\Z/i;
+			next if $FORM{$arg} eq '';
+
+			push @pids, $1;
+		}
+
+		delete_posts $tid, \@pids
 	}
+
+	my $pid   = $INFO{messages} || $INFO{start};
+	if ( $pid > ${$tid}{replies} ) {
+		$pid  = ${$tid}{replies}
+	}
+
+	# Actually, isn't necessary
+	my $start = int ( $pid / $maxmessagedisplay ) * $maxmessagedisplay;
+
+	# Hm, now it also can be called from lastmessages - do we need
+	# referer analysing?
+	our $yySetLocation = qq($scripturl?num=$tid/$start#$pid);
+
+	redirectexit
 }
 
 1;
+
+# The End # vim: set tabstop=4: #
--- lib/yabb-2.1/Sources/ModifyMessage.pl~	2008-05-10 03:01:24 +0300
+++ lib/yabb-2.1/Sources/ModifyMessage.pl	2008-05-10 03:25:05 +0300
@@ -845,7 +845,8 @@
 		# This is weird thing... we should check, is it actually works now.
 		# Seems to be planned to be initialized in Security or somewhere else
 		# If it is not working - then we should fix that in other place, not here.
-		#our $iamposter = 1; # Security checks are done before.
+		# It does not works :( so, uncommented
+		our $iamposter = 1; # Security checks are done before.
 		require "$sourcedir/RemoveTopic.pl";
 		&RemoveThread;
 
--- lib/yabb-2.1/Sources/ModifyMessage.pl~	2008-05-10 03:25:05 +0300
+++ lib/yabb-2.1/Sources/ModifyMessage.pl	2008-05-10 03:39:44 +0300
@@ -829,10 +829,6 @@
 		}
 	}
 
-	if ( -d "$datatrashdir" ) { # even more paranoid - just while test it all to not lose info while testing
-		rename "$datadir/$tid.txt", "$datatrashdir/$date-$tid.txt"
-	}
-
 	# delete entire thread, this *does not* affects post counters,
 	# so they are decreased before.
 	if ( @messages < 1 ) {
@@ -853,6 +849,10 @@
 		exit # to be sure
 	}
 
+	if ( -d "$datatrashdir" ) { # even more paranoid - just while test it all to not lose info while testing
+		rename "$datadir/$tid.txt", "$datatrashdir/$date-$tid.txt"
+	}
+
 	remove_atts \@killatts if @killatts;
 
 	# if thread has not been deleted: update thread, update message index details ...


Patch adds menus to new posts page.
--- /home/isbear/Recent.pl.old	2008-05-10 04:25:53 +0300
+++ lib/yabb-2.1/Sources/Recent.pl	2008-05-10 04:43:02 +0300
@@ -41,7 +41,8 @@
 	if ( $id eq 'Guest' ) {
 		$retval{type} = 'guest';
 	} elsif ( -e "$memberdir/$id.vars" ) {
-		$retval{uid}  = $id;
+#		$retval{uid}  = $id;
+		$retval{url}  = "$scripturl?action=viewprofile;username=$id";
 		$retval{type} = 'user';
 	} else {
 		$retval{type} = 'ex';
@@ -50,7 +51,8 @@
 	return \%retval
 }
 
-sub nm_user_link {
+# No big need in this sub, just lasting shorthand
+sub nm_template_user {
 	my $user   = shift;
 	my $retval = $user->{nick};
 
@@ -60,15 +62,50 @@
 		$retval .= $recent_txt{ex};
 	}
 
-	# actually, guests cannot view this now, but we can use this routine
-	# in some other place...
-	if ( exists $user->{uid} and not $iamguest ) {
-		$retval = qq(<a href="$scripturl?action=vievprofile;username=$user->{uid}" >$retval</a>)
+	# Guest-check is actually a "control" - move from here?
+	if ( exists $user->{url} and not $iamguest ) {
+		$retval = qq(<a href="$user->{url}" >$retval</a>)
 	}
 
 	return $retval
 }
 
+# FIXME
+sub nm_menu_struct {
+	return map {
+		\{
+			url  => "$scripturl?action=$_",
+			name => "$img{$_}"
+		}
+	} @_;
+}
+
+sub nm_template_menu {
+	my $menu = shift;
+
+	if ( not @$menu ) {
+		return '';
+	}
+
+	my $menusep = qq( | );
+	my $retval  = '';
+
+	foreach my $button ( @{$menu} ) {
+
+		my $retbutt = $button->{name};
+
+		if ( exists $button->{url} ) {
+			$retbutt = qq(<a href="$button->{url}" >$retbutt</a>)
+		}
+
+		$retval .= $menusep if length $retval;
+
+		$retval .= $retbutt;
+	}
+
+	return qq(<div class="menu">$retval</div>);
+}
+
 sub nm_poll_struct {
 	
 	my $tid = shift;
@@ -99,6 +136,25 @@
 	
 	fclose ( POLL );
 
+	# FIXME
+	my @pollmenu;
+
+	if ( not $locked and $puid eq $username and $have_poll_access ) { # FIXME
+		if ( not $tlnomodflag or $pdate + $tlnomodtime * 60 * 60 * 24 > $date ) {
+			push @pollmenu, {
+				name => $img_polltxt{39},
+				url  => qq($scripturl?action=modify;thread=$tid;message=Poll) # FIXME
+			}
+		}
+
+		if ( not $tlnodelflag or $pdate + $tlnodeltime * 60 * 60 * 24 > $date ) {
+			push @pollmenu, {
+				name => $img_polltxt{27},
+				url  => qq($scripturl?action=post;num=$tid;title=AddPoll) # FIXME
+			}
+		}
+	}
+
 	my %retpoll = (
 		id    => $tid,
 		name  => $sub,
@@ -108,6 +164,8 @@
 		opts  => \@retopts,
 	);
 
+	$retpoll{menu} = \@pollmenu if @pollmenu;
+
 	return \%retpoll
 }
 
@@ -167,10 +225,11 @@
 
 				ToChars $curthread->{name};
 				my $navbar  = qq($navbar$nbsep<a href="$scripturl?num=$curthread->{id}">$curthread->{name}</a>);
-				my $author  = nm_user_link $curthread->{owner};
-				my $started = timeformat   $curthread->{date};
+				my $author  = nm_template_user $curthread->{owner};
+				my $started = timeformat       $curthread->{date};
 				# FIXME: add state handling?
 				my $icon    = qq(<img src="$imagesdir/$curthread->{icon}.$imgext" class="icon" />);
+				my $menu    = nm_template_menu $curthread->{menu};
 
 				$yymain .= qq(
 				<div class="thread" >
@@ -184,8 +243,9 @@
 					my $curpoll = $curthread->{poll};
 
 					ToChars $curpoll->{name};
-					my $author = nm_user_link $curpoll->{owner};
-					my $posted = timeformat   $curpoll->{date};
+					my $author = nm_template_user $curpoll->{owner};
+					my $posted = timeformat       $curpoll->{date};
+					my $menu   = nm_template_menu $curpoll->{menu};
 
 					$yymain .= qq(
 					<div class="poll" >
@@ -209,6 +269,7 @@
 
 						if ( $total ) { # FIXME that all :(
 							my $percent = int ( $curopt->{votes} * 100 / $total );
+							# all goes to css except width.
 							$image = qq(<div class="image" style="width: 30%; height: 1em; margin-right: 10%; float: right" ><img src="$imagesdir/poll_left.gif" /><img src="$imagesdir/poll_middle.gif" style="width: $percent%; height: inherit" alt="$percent\%" /><img src="$imagesdir/poll_right.gif" /></div>);
 						}
 
@@ -217,15 +278,17 @@
 					}
 
 					$yymain .= qq(
+						$menu
 					</div>);
 				}
 				
 				foreach my $curpost ( @{$curthread->{n}} ) {
 
 					ToChars $curpost->{name};
-					my $subject = Censor $curpost->{name};
-					my $author  = nm_user_link $curpost->{owner};
-					my $posted  = timeformat   $curpost->{date};
+					my $subject = Censor           $curpost->{name};
+					my $author  = nm_template_user $curpost->{owner};
+					my $posted  = timeformat       $curpost->{date};
+					my $menu    = nm_template_menu $curpost->{menu};
 
 					our $message = Censor $curpost->{text}; # damned globals
 					wrap; # ...
@@ -270,10 +333,12 @@
 							$message
 						</div>
 						$file
+						$menu
 					</div>);
 				}
 
 				$yymain .= qq(
+					$menu
 				</div>);
 			}
 
@@ -327,10 +392,14 @@
 
 	# cat:      id, name,
 	#  board:   id, name
-	#   thread: id = date, name, owner, icon, state, poll
-	#    poll:  id,  date, name, owner, text
+	#   thread: id = date, name, owner, menu, icon, state, poll
+	#    poll:  id,  date, name, owner, menu, text
 	#     opt:  name, votes
-	#    post:  num, date, name, owner, icon, text, nosm, file
+	#    post:  num, date, name, owner, menu, icon, text, nosm, file
+	#
+	# uid:      type, name, url
+	#
+	# menuitem: name, url # priority?
 
 	foreach my $curcat ( @categoryorder ) {
 
@@ -370,6 +439,21 @@
 				next NM_BOARD;
 			};
 
+			my ( $have_post_access, $have_reply_access );
+			our $have_poll_access; # :( FIXME
+
+			if ( AccessCheck ( $curboard, 1, $boardperms ) eq 'granted' ) {
+				$have_post_access = 1
+			}
+
+			if ( AccessCheck ( $curboard, 2 ) eq 'granted' ) {
+				$have_reply_access = 1
+			}
+
+			if ( AccessCheck ( $curboard, 3 ) eq 'granted' ) {
+				$have_poll_access = 1
+			}
+
 			my @retboard;
 
 			NM_THREAD:
@@ -460,6 +544,41 @@
 						}; # FIXME
 					};
 
+					# FIXME
+					my @postmenu;
+
+					if ( $state !~ m/l/i ) {
+						if ( $have_reply_access ) {
+							push @postmenu, {
+								name => $img_txt{145},
+								url  => qq($scripturl?action=post;num=$tid;quote=$postnum;title=PostReply)
+							};
+
+							if ( $puid eq $username ) {
+								if ( not $tlnomodflag or
+								     $pdate + $tlnomodtime * 60 * 60 * 24 > $date ) {
+									push @postmenu, {
+										name => $img_txt{66},
+										url  => qq($scripturl?action=modify;board=$curboard;thread=$tid;message=$postnum)
+									}
+								}
+							}
+						}
+						
+						if ( $have_post_access and
+						     $puid eq $username ) {
+							if ( not $tlnodelflag or
+							     $pdate + $tlnodeltime * 60 * 60 * 24 > $date ) {
+								push @postmenu, {
+									name => $img_txt{121},
+									url  => qq($scripturl?action=multidel;thread=$tid;message=$postnum)
+								}
+							}
+						}
+					}
+
+					$retpost{menu} = \@postmenu if @postmenu;
+
 					$postnum++;
 
 					if ( $pdate < $oldest_date ) {
@@ -479,6 +598,46 @@
 
 				next if not @retthread;
 
+				# FIXME
+				my @threadmenu = (
+					{
+						name => $img_txt{627},
+						url  => qq($scripturl?action=markunread;board=$curboard;thread=$tid)
+					},
+					{ # FIXME: Check for presence of fav and reverse to 72/remfav
+						name => $img_txt{71},
+						url  => qq($scripturl?action=addfav;fav=$tid)
+					},
+					{ # FIXME: Check for presence
+						name => $img_txt{131},
+						url  => qq($scripturl?action=notify;thread=$tid)
+					},
+					{
+						name => $img_txt{707},
+						url  => qq($scripturl?action=sendtopic;thread=$tid)
+					},
+					{
+						name => $img_txt{465},
+						url  => qq($scripturl?action=print;num=$tid)
+					}
+				);
+
+				if ( $state !~ m/l/i ) {
+					if ( $have_reply_access ) {
+						push @threadmenu, {
+							name => $img_txt{146},
+							url  => qq($scripturl?action=post;num=$tid;title=PostReply)
+						}
+					}
+
+					if ( $have_poll_access and not -e "$datadir/$tid.poll" ) {	
+						push @threadmenu, {
+							name => $img_polltxt{2},
+							url  => qq($scripturl?action=post;num=$tid;title=AddPoll)
+						}
+					}
+				}
+
 				my %retthread = (
 					id    => $tid,
 					date  => $tid,
@@ -486,6 +645,7 @@
 					owner => nm_user_struct ( $tuid, $tnick ),
 					icon  => $ticon,
 					state => $state, # instead, supply possible actions?
+					menu  => \@threadmenu,
 					n     => \@retthread
 				);


Sun, 17 Aug 2008 23:06:26 +0300
Patch to encode subjects into base64
--- Subs.pl~	2008-08-17 22:58:10 +0300
+++ Subs.pl	2008-08-17 23:05:52 +0300
@@ -755,6 +755,12 @@
 	$smtp_server     =~ s/\s+$//g;
 	if (!$to) { return; }
 
+	# Encode subject into base64 with directly specified encoding
+	eval q^
+		use MIME::Base64 qw(encode_base64);
+		$subject = '=?' . uc ( $smtp_charset ) . '?B?' . encode_base64 ( $subject, '' ) . '?=';
+	^;
+
 	# Thanks to Graham J for your contribution to this routine
 	if ($mailtype == 1) {
 		require "$sourcedir/Smtp.pl";



Sun, 02 Nov 2008 22:10:05 +0200
Patch to add "safety lock" to banhammer.

--- var/yabb-2.1/Variables/Menu1.def~	2007-10-13 03:18:25 +0300
+++ var/yabb-2.1/Variables/Menu1.def	2008-11-02 18:48:31 +0200
@@ -31,7 +31,14 @@
 'remfav' => "<span class=\"imgcatbg\">$img_txt{'72'}</span>",
 'help' => "<span class=\"imgmenu\">$img_txt{'119'}</span>",
 'home' => "<span class=\"imgmenu\">$img_txt{'103'}</span>",
+
+### SAFETY LOCK ###
+'safetylock' => "Поставити на запобіжник",
+'safetyunlock' => "Зняти з запобіжника",
+### SAFETY LOCK ###
+
 'rules' => "<a  class=\"imgmenu\" style=\"color:red\" href=\"YaBB.pl?num=1075310952\">Правила</a>",
+
 'im_config' => "<span class=\"imgwindowbg\">$img_txt{'323'}</span>",
 'im_delete' => "<span class=\"imgwindowbg\">$img_txt{'412'}</span>",
 'im_inbox' => "<span class=\"imgwindowbg\">$img_txt{'316'}</span>",
diff -u -Naur lib/yabb-2.1/Sources/BanWithGroup.pl ../lib/yabb-2.1/Sources/BanWithGroup.pl
--- lib/yabb-2.1/Sources/BanWithGroup.pl	2008-04-19 12:18:57.000000000 +0300
+++ ../lib/yabb-2.1/Sources/BanWithGroup.pl	2008-11-02 17:02:29.000000000 +0200
@@ -1,11 +1,11 @@
 
-# Ban With Group
+#=head1 Ban With Group
 
-# adds user to 'Banned' group (with denial permissions)
-# and sets his position group into temporary additional group,
-# that carries info about ban end time and original user's position.
+#adds user to 'Banned' group (with denial permissions)
+#and sets his position group into temporary additional group,
+#that carries info about ban end time and original user's position.
 
-# FIXME: we should define upper limit for ban termin.
+#=cut
 
 return if $loaded{'BanWithGroup.pl'};
 
@@ -13,18 +13,45 @@
 
 LoadLanguage ( 'BanWithGroup' ) if not $loaded{'BanWithGroup.lng'};
 
-sub main_ban_gid {
+#=head1 TODO
 
-	foreach ( keys %NoPost ) {
-		next unless $NoPost{$_} =~ /^Banned\|/i;
+#change lng: bangroup_txt{nomain} -> {nogroup}, generalize text accordingly
 
-		return $_;
-	}
+#add records into banlog about safety lock?
 
-	# FIXME
-	fatal_error $bangroup_txt{'nomain'} . 'Banned'
+#move group_id to Subs.pl?
+
+#B<FIXME> we should define upper limit for ban termin.
+
+#B<FIXME> do something about fatal_error in group_gid.
+
+#=head1 FUNCTIONS
+
+#=head2 group_gid B<group_name>
+
+#B<Warning> This function raises fatal error in error case.
+
+#Searches for No Post group and returns it's id. Case does not matter.
+
+#=cut
+
+sub group_gid {
+	my $name = quotemeta $_[0];
+
+	foreach my $id ( keys %NoPost ) {
+		return $id
+			if $NoPost{$id} =~ /^$name\|/i;
+	};
+
+	fatal_error $bangroup_txt{'nogroup'} . $name;
 }
 
+#=head2 push_ban_log B<who, whom, gid, termin, reason>
+
+#Writes record about taken action into banlog, additionally providing timestamp
+
+#=cut
+
 sub push_ban_log {
 	my ( $who, $whom, $gid, $termin, $reason ) = @_;
 
@@ -37,6 +64,12 @@
 	return 1
 }
 
+#=head2 save_groups
+
+#Saves current state of membergroups into $vardir/membergroups.txt
+
+#=cut
+
 sub save_groups {
 
 	fopen ( GRP, ">$vardir/membergroups.txt" )
@@ -50,6 +83,69 @@
 	fclose ( GRP );
 }
 
+#=head2 safety_lock
+
+#Adds current user (admin or gmod) to group 'Safety Lock'
+
+#=cut
+
+sub safety_lock {
+
+	unless ( $iamadmin or $iamgmod ) {
+		fatal_error $bangroup_txt{'notallowed'};
+	}
+
+	unless ( exists ${$uid.$username}{'addgroups'} ) {
+		# generally, this should be not necessary, just for sure..
+		LoadUser ( $username )
+			or fatal_error $bangroup_txt{'cannotloaduser'} . $username
+	}
+
+	my $lockgid = group_gid ( 'Safety Lock' );
+
+	unless ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+		${$uid.$username}{'addgroups'} = join ',', ( split ( /,/, ${$uid.$username}{'addgroups'} ), $lockgid );
+		UserAccount $username, 'update';
+	}
+	
+	our $yySetLocation = "$scripturl?action=viewprofile;username=$username";
+	redirectexit;
+}
+
+#=head2 safety_unlock
+
+#Removes group 'Safety Lock' from a list of current user groups
+
+#=cut
+
+sub safety_unlock {
+
+	unless ( exists ${$uid.$username}{'addgroups'} ) {
+		# generally, this should be not necessary, just for sure..
+		LoadUser ( $username )
+			or fatal_error $bangroup_txt{'cannotloaduser'} . $username
+	}
+
+	my $lockgid = group_gid ( 'Safety Lock' );
+
+	if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+		${$uid.$username}{'addgroups'} =~ s/(^|,)$lockgid(,|$)/$1/;
+		UserAccount $username, 'update';
+	}
+	
+	our $yySetLocation = "$scripturl?action=viewprofile;username=$username";
+	redirectexit;
+}
+
+
+#=head2 ban_with_group
+
+#B<FORM> username, termin, reason
+
+#Processes request to ban with group B<username> for B<termin> with B<reason>
+
+#=cut
+
 sub ban_with_group {
 
 	my $login  = $FORM{'username'} || $INFO{'username'};
@@ -96,7 +192,7 @@
 	$termin .= $date;
 	$termin  = eval $termin;
 
-	my $mainbanid = main_ban_gid;
+	my $mainbanid = group_gid ( 'Banned' );
 
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
@@ -141,6 +237,14 @@
 	redirectexit;
 }
 
+#=head2 unban_with_group
+
+#B<URL> username
+
+#Forcely unbans B<username> (before termin expiration) (admin, gmod)
+
+#=cut
+
 sub unban_with_group {
 	my $login = $INFO{'username'};
 
@@ -152,7 +256,7 @@
 		fatal_error $bangroup_txt{'notallowed'}
 	}
 
-	my $mainbanid = main_ban_gid;
+	my $mainbanid = group_gid ( 'Banned' );
 	
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
@@ -183,6 +287,14 @@
 	redirectexit
 }
 
+#=head2 ban_with_group_passthrough
+
+#B<URL> [username, termin, reason]
+
+#Shows form to send request for banning B<username>
+
+#=cut
+
 sub ban_with_group_passthrough {
 
 	my $login  = $INFO{'username'};
@@ -222,6 +334,14 @@
 	exit;
 }
 
+#=head2 expire_ban_with_group
+
+#B<URL> username
+
+#Removes expired ban from B<username>
+
+#=cut
+
 sub expire_ban_with_group {
 
 	my $login = $INFO{'username'};
@@ -230,7 +350,7 @@
 		fatal_error $bangroup_txt{'invaluname'} . $login
 	}
 
-	my $mainbanid = main_ban_gid;
+	my $mainbanid = group_gid ( 'Banned' );
 
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
@@ -265,6 +385,12 @@
 	redirectexit
 }
 
+#=head2 show_ban_log
+
+#Generates ban log page
+
+#=cut
+
 sub show_ban_log {
 
 	fopen ( BANLOG, "< $vardir/banwithgroup.log" )
@@ -308,4 +434,10 @@
 
 1;
 
+#=head1 AUTHORS
+
+#Myhailo Danylenko <isbear@ukrpost.net>
+
+#=cut
+
 # The End
diff -u -Naur lib/yabb-2.1/Sources/SubList.pl ../lib/yabb-2.1/Sources/SubList.pl
--- lib/yabb-2.1/Sources/SubList.pl	2008-04-26 11:35:29.000000000 +0300
+++ ../lib/yabb-2.1/Sources/SubList.pl	2008-11-02 16:35:55.000000000 +0200
@@ -14,6 +14,16 @@
 #               Your source for web hosting, web design, and domains.         #
 ###############################################################################
 
+#=head1 Sub List
+#
+#List of url B<action>s and corresponding files/subs to use for it's processing
+#
+#=head1 Actions provided:
+#
+#
+#
+#=cut
+#
 $sublistplver = 'YaBB 2.1 $Revision: 1.1 $';
 if($action eq 'detailedversion') { return 1; }
 
@@ -22,11 +32,24 @@
 'newmesg',"Recent.pl&new_messages",
 'newmarkread',"Recent.pl&nm_mark_read",
 
-#'regenfullog',"Snark.pl&regenfullog",
-#'huntlog',"Snark.pl&huntlog_show",
-#'showguns',"Snark.pl&show_guns",
-#'ghd',"Snark.pl&give_him_damage",
-#'rmgwogu',"Snark.pl&revive_me_gwog",
+#=head3 Snark actions (commented)
+#
+#'regenfullog',"Snark.pl&regenfullog",
+#'huntlog',"Snark.pl&huntlog_show",
+#'showguns',"Snark.pl&show_guns",
+#'ghd',"Snark.pl&give_him_damage",
+#'rmgwogu',"Snark.pl&revive_me_gwog",
+#
+#=head3 Safety lock actions
+#
+#=cut
+
+'safetylock',"BanWithGroup.pl&safety_lock",
+'safetyunlock',"BanWithGroup.pl&safety_unlock",
+
+#=head3 Ban with group actions
+#
+#=cut
 
 'bwg',"BanWithGroup.pl&ban_with_group",
 'ubwg',"BanWithGroup.pl&unban_with_group",
@@ -34,7 +57,16 @@
 'pbwg',"BanWithGroup.pl&ban_with_group_passthrough",
 'bwglog',"BanWithGroup.pl&show_ban_log",
 
+#=head3 Novyny actions
+#
+#=cut
+
 'novyny',"Novyny.pl&Novyny",
+
+#=head3 Other actions
+#
+#=cut
+
 'activate',"Register.pl&user_activation",
 'favorites',"Favorites.pl&Favorites",
 'addfav',"Favorites.pl&AddFav",
diff -u -Naur lib/yabb-2.1/Sources/Subs.pl ../lib/yabb-2.1/Sources/Subs.pl
--- lib/yabb-2.1/Sources/Subs.pl	2008-08-18 00:05:45.000000000 +0300
+++ ../lib/yabb-2.1/Sources/Subs.pl	2008-11-02 17:11:41.000000000 +0200
@@ -246,6 +246,19 @@
 		$yymenu .= qq~$menusep<a href="$scripturl?action=logout">$img{'logout'}</a>~;
 	}
 
+	### SAFETY LOCK ###
+	if ( $iamadmin or $iamgmod ) {
+		$yymenu .= qq~$menusep<a href="$scripturl?action=safetylock">$img{'safetylock'}</a>~;
+	} elsif ( ${$uid.$username}{'addgroups'} ) {
+		require "$sourcedir/BanWithGroup.pl"
+			if not $loaded{'BanWithGroup.pl'};
+		my $lockgid = group_gid ( 'Safety Lock' );
+		if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+			$yymenu .= qq~$menusep<a href="$scripturl?action=safetyunlock">$img{'safetyunlock'}</a>~;
+		}
+	}
+	### SAFETY LOCK ###
+
 	$yyimages        = $imagesdir;
 	$yydefaultimages = $defaultimagesdir;
 	$yystyle         = qq~<link rel="stylesheet" href="$forumstylesurl/$usestyle.css" type="text/css" />~;
diff -u -Naur lib/yabb-2.1/Languages/English/BanWithGroup.lng ../lib/yabb-2.1/Languages/English/BanWithGroup.lng
--- lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-04-19 11:58:20.000000000 +0300
+++ ../lib/yabb-2.1/Languages/English/BanWithGroup.lng	2008-11-02 18:40:52.000000000 +0200
@@ -5,7 +5,7 @@
 'invaluname'  => 'Invalid username: ',
 'invalterm'   => 'Termin should be a number: ',
 'invalreason' => 'Reason contains strange chars: ',
-'nomain'      => 'Main group not found: ',
+'nogroup'     => 'Group not found: ',
 'nolower'     => 'You can only lengthen ban termin. Current termin (minutes): ',
 'nobadmin'    => 'For security reasons you cannot ban username "admin"',
 
diff -u -Naur lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng ../lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng
--- lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-04-19 11:59:25.000000000 +0300
+++ ../lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng	2008-11-02 18:41:20.000000000 +0200
@@ -5,7 +5,7 @@
 'invaluname'  => 'Невірне ім\'я користувача: ',
 'invalterm'   => 'Термін має бути числом: ',
 'invalreason' => 'Причина бану містить дивні символи: ',
-'nomain'      => 'Не знайдено основної групи: ',
+'nogroup'     => 'Не знайдено групи ',
 'nolower'     => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
 'nobadmin'    => 'З міркувань безпеки ви не можете забанити користувача admin',
 
diff -u -Naur lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng ../lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng
--- lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-04-19 12:00:23.000000000 +0300
+++ ../lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng	2008-11-02 18:41:54.000000000 +0200
@@ -5,7 +5,7 @@
 'invaluname'  => 'Невірне ім\'я користувача: ',
 'invalterm'   => 'Термін має бути числом: ',
 'invalreason' => 'Причина бану містить дивні символи: ',
-'nomain'   => 'Не знайдено основної групи: ',
+'nogroup'  => 'Не знайдено групу ',
 'nolower'  => 'Ви можете лише подовжити бан. Поточний термін (хвилин): ',
 'nobadmin' => 'З міркувань безпеки ви не можете забанити користувача admin',



diff -u -Naur lib/yabb-2.1/Sources/Load.pl ../lib/yabb-2.1/Sources/Load.pl
--- lib/yabb-2.1/Sources/Load.pl	2008-04-19 12:12:39.000000000 +0300
+++ ../lib/yabb-2.1/Sources/Load.pl	2008-11-02 17:04:03.000000000 +0200
@@ -256,7 +256,20 @@
 	} else {
 
 		return 0;
-	}
+	};#"
+
+	### SAFETY LOCK ###
+	if ( ${$uid.$user}{'addgroups'} ) {
+		# FIXME: move to Subs.pl...
+		# FIXME: how to deal with usual moderators?
+		require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
+		my $lockgid = group_gid ( 'Safety Lock' );
+		if ( ${$uid.$user}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+			${$uid.$user}{'position'} = '';
+		};
+	};
+	### SAFETY LOCK ###
+
 	if (${$uid.$user}{'weburl'} && ${$uid.$user}{'weburl'} !~ m~\Ahttp://~) { ${$uid.$user}{'weburl'} = "http://${$uid.$user}{'weburl'}"; }
 	&ToChars(${$uid.$user}{'realname'});
 	&LoadMiniUser($user);



--- /home/isbear/Load.pl.old	2008-11-02 20:51:24 +0200
+++ /home/isbear/Load.pl	2008-11-02 20:51:07 +0200
@@ -154,8 +154,22 @@
 			$iamadmin  = (${$uid.$username}{'position'} eq 'Administrator' && $sessionvalid == 1) ? 1 : 0;
 			$iamgmod   = (${$uid.$username}{'position'} eq 'Global Moderator' && $sessionvalid == 1) ? 1 : 0;
 			if ($sessionvalid == 1) { ${$uid.$username}{'session'} = $cursession; }
-			#### FIXME: Fixed wrong admin column behaviour
-			if ($iamadmin || $iamgmod) { $iammod = 0; }
+			if ($iamadmin or $iamgmod) {
+				### FIXME: Kludge for right admin column show
+				$iammod = 0;
+				### SAFETY LOCK ###
+				if ( ${$uid.$user}{'addgroups'} ) {
+					# FIXME: move to Subs.pl...
+					# FIXME: how to deal with usual moderators?
+					require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
+					my $lockgid = group_gid ( 'Safety Lock' );
+					if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+						$iamadmin = 0;
+						$aimgmod  = 0;
+					};
+				};
+				### SAFETY LOCK ###
+			};
 			&CalcAge($username, "calc");
 		}
 	} else {
@@ -259,15 +273,15 @@
 	};#"
 
 	### SAFETY LOCK ###
-	if ( ${$uid.$user}{'addgroups'} ) {
-		# FIXME: move to Subs.pl...
-		# FIXME: how to deal with usual moderators?
-		require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
-		my $lockgid = group_gid ( 'Safety Lock' );
-		if ( ${$uid.$user}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
-			${$uid.$user}{'position'} = '';
-		};
-	};
+#	if ( ${$uid.$user}{'addgroups'} ) {
+#		# FIXME: move to Subs.pl...
+#		# FIXME: how to deal with usual moderators?
+#		require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
+#		my $lockgid = group_gid ( 'Safety Lock' );
+#		if ( ${$uid.$user}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+#			${$uid.$user}{'position'} = '';
+#		};
+#	};
 	### SAFETY LOCK ###
 
 	if (${$uid.$user}{'weburl'} && ${$uid.$user}{'weburl'} !~ m~\Ahttp://~) { ${$uid.$user}{'weburl'} = "http://${$uid.$user}{'weburl'}"; }


--- lib/yabb-2.1/Sources/Load.pl~	2008-11-02 20:54:42 +0200
+++ lib/yabb-2.1/Sources/Load.pl	2008-11-02 21:02:41 +0200
@@ -158,14 +158,14 @@
 				### FIXME: Kludge for right admin column show
 				$iammod = 0;
 				### SAFETY LOCK ###
-				if ( ${$uid.$user}{'addgroups'} ) {
+				if ( ${$uid.$username}{'addgroups'} ) {
 					# FIXME: move to Subs.pl...
 					# FIXME: how to deal with usual moderators?
 					require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
 					my $lockgid = group_gid ( 'Safety Lock' );
 					if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 						$iamadmin = 0;
-						$aimgmod  = 0;
+						$iamgmod  = 0;
 					};
 				};
 				### SAFETY LOCK ###


--- lib/yabb-2.1/Sources/Load.pl~	2008-11-02 21:02:41 +0200
+++ lib/yabb-2.1/Sources/Load.pl	2008-11-02 21:51:56 +0200
@@ -270,20 +270,7 @@
 	} else {
 
 		return 0;
-	};#"
-
-	### SAFETY LOCK ###
-#	if ( ${$uid.$user}{'addgroups'} ) {
-#		# FIXME: move to Subs.pl...
-#		# FIXME: how to deal with usual moderators?
-#		require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
-#		my $lockgid = group_gid ( 'Safety Lock' );
-#		if ( ${$uid.$user}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
-#			${$uid.$user}{'position'} = '';
-#		};
-#	};
-	### SAFETY LOCK ###
-
+	}
 	if (${$uid.$user}{'weburl'} && ${$uid.$user}{'weburl'} !~ m~\Ahttp://~) { ${$uid.$user}{'weburl'} = "http://${$uid.$user}{'weburl'}"; }
 	&ToChars(${$uid.$user}{'realname'});
 	&LoadMiniUser($user);


Tue, 04 Nov 2008 21:34:37 +0200
Patch to unset $staff as well as $iamadmin and $iamgmod.

--- lib/yabb-2.1/Sources/Load.pl~	2008-11-02 21:51:56 +0200
+++ lib/yabb-2.1/Sources/Load.pl	2008-11-04 21:34:10 +0200
@@ -166,6 +166,7 @@
 					if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 						$iamadmin = 0;
 						$iamgmod  = 0;
+						$staff    = 0;
 					};
 				};
 				### SAFETY LOCK ###




Tue, 16 Dec 2008 21:51:56 +0200
Patch to verify usernames and mails against banlist.

--- linux.org.ua/lib/yabb-2.1/Sources/Subs.pl~	2008-11-02 20:28:49 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/Subs.pl	2008-12-16 21:34:31 +0200
@@ -1931,4 +1931,71 @@
 	}
 }
 
+
+# Moved here from Register.pl,
+# as Post.pl also needs it
+# to check guest's credentails
+sub reg_banning {
+
+	my $ban_user  = $_[0];
+	my $ban_email = $_[1];
+
+	if ($username eq "admin" && $iamadmin) { return 0; }
+	my (@banlist, $banned, $ban_time);
+	my $bansize = -s "$vardir/ban.txt";
+	if ($bansize > 9) {
+		fopen(BAN, "$vardir/ban.txt");
+		@banlist = <BAN>;
+		fclose(BAN);
+	} else {
+		return 0;
+	}
+	$ban_time = int(time);
+
+	foreach my $line (@banlist) {
+		chomp $line;
+		my ($dummy, $bannedlst) = split(/\|/, $line);
+		my @banned = split(/\,/, $bannedlst);
+		if ($dummy eq "I") {    # IP BANNING
+			foreach my $ipbanned (@banned) {
+				my $str_len = length($ipbanned);
+				my $comp_ip = substr($user_ip, 0, $str_len);
+				if ($ipbanned eq $comp_ip) {
+					fopen(LOG, ">>$vardir/ban_log.txt");
+					print LOG "$ban_time|$user_ip\n";
+					fclose(LOG);
+					&UpdateCookie("delete", $ban_user);
+					$username = "Guest";
+					&fatal_error("I: $security_txt{'678'}$security_txt{'430'}!");
+					&redirectinternal;
+				}
+			}
+		} elsif ($dummy eq "E") {    # EMAIL BANNING
+			foreach my $emailbanned (@banned) {
+				if (lc $emailbanned eq lc $ban_email) {
+					fopen(LOG, ">>$vardir/ban_log.txt");
+					print LOG "$ban_time|$emailbanned ($user_ip)\n";
+					fclose(LOG);
+					&UpdateCookie("delete", $ban_user);
+					$username = "Guest";
+					&fatal_error("E: $security_txt{'678'}$security_txt{'430'}!");
+					&redirectinternal;
+				}
+			}
+		} elsif ($dummy eq "U") {    # USERNAME BANNING
+			foreach my $namebanned (@banned) {
+				if (lc $namebanned eq lc $ban_user) {
+					fopen(LOG, ">>$vardir/ban_log.txt");
+					print LOG "$ban_time|$namebanned ($user_ip)\n";
+					fclose(LOG);
+					&UpdateCookie("delete", $ban_user);
+					$username = "Guest";
+					&fatal_error("U: $security_txt{'678'}$security_txt{'430'}!");
+					&redirectinternal;
+				}
+			}
+		}
+	}
+}
+
 1;
--- linux.org.ua/lib/yabb-2.1/Sources/Post.pl~	2008-03-30 21:11:11 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Post.pl	2008-12-16 21:44:22 +0200
@@ -1348,6 +1348,7 @@
 		&Preview("$post_txt{'76'}") if ($FORM{'email'} eq '');
 		&Preview("$post_txt{'240'} $post_txt{'69'} $post_txt{'241'}") if ($FORM{'email'} !~ /[\w\-\.\+]+\@[\w\-\.\+]+\.(\w{2,4}$)/);
 		&Preview("$post_txt{'500'}") if (($FORM{'email'} =~ /(@.*@)|(\.\.)|(@\.)|(\.@)|(^\.)|(\.$)/) || ($FORM{'email'} !~ /^.+@\[?(\w|[-.])+\.[a-zA-Z]{2,4}|[0-9]{1,4}\]?$/));
+		&reg_banning($FORM{'name'}, $FORM{'email'});
 	}
 
 	# Get the form values
--- linux.org.ua/lib/yabb-2.1/Sources/Register.pl~	2007-10-15 17:29:36 +0300
+++ linux.org.ua/lib/yabb-2.1/Sources/Register.pl	2008-12-16 21:50:17 +0200
@@ -230,69 +230,7 @@
 	exit;
 }
 
-sub reg_banning {
-
-	$ban_user  = $_[0];
-	$ban_email = $_[1];
-
-	if ($username eq "admin" && $iamadmin) { return 0; }
-	my (@banlist, $banned, $ban_time, $dummy, $line);
-	my $bansize = -s "$vardir/ban.txt";
-	if ($bansize > 9) {
-		fopen(BAN, "$vardir/ban.txt");
-		@banlist = <BAN>;
-		fclose(BAN);
-	} else {
-		return 0;
-	}
-	$ban_time = int(time);
-
-	foreach $line (@banlist) {
-		@banned = ();
-		chomp $line;
-		($dummy, $bannedlst) = split(/\|/, $line);
-		@banned = split(/\,/, $bannedlst);
-		if ($dummy eq "I") {    # IP BANNING
-			foreach $ipbanned (@banned) {
-				$str_len = length($ipbanned);
-				$comp_ip = substr($user_ip, 0, $str_len);
-				if ($ipbanned eq $comp_ip) {
-					fopen(LOG, ">>$vardir/ban_log.txt");
-					print LOG "$ban_time|$user_ip\n";
-					fclose(LOG);
-					&UpdateCookie("delete", $ban_user);
-					$username = "Guest";
-					&fatal_error("I: $security_txt{'678'}$security_txt{'430'}!");
-					&redirectinternal;
-				}
-			}
-		} elsif ($dummy eq "E") {    # EMAIL BANNING
-			foreach $emailbanned (@banned) {
-				if (lc $emailbanned eq lc $ban_email) {
-					fopen(LOG, ">>$vardir/ban_log.txt");
-					print LOG "$ban_time|$emailbanned ($user_ip)\n";
-					fclose(LOG);
-					&UpdateCookie("delete", $ban_user);
-					$username = "Guest";
-					&fatal_error("E: $security_txt{'678'}$security_txt{'430'}!");
-					&redirectinternal;
-				}
-			}
-		} elsif ($dummy eq "U") {    # USERNAME BANNING
-			foreach $namebanned (@banned) {
-				if (lc $namebanned eq lc $ban_user) {
-					fopen(LOG, ">>$vardir/ban_log.txt");
-					print LOG "$ban_time|$namebanned ($user_ip)\n";
-					fclose(LOG);
-					&UpdateCookie("delete", $ban_user);
-					$username = "Guest";
-					&fatal_error("U: $security_txt{'678'}$security_txt{'430'}!");
-					&redirectinternal;
-				}
-			}
-		}
-	}
-}
+# sub reg_banning has been moved to Subs.pl
 
 sub Register2 {
 	if ($regdisable && $iamguest) { &fatal_error("$register_txt{'3'}"); }



Thu, 18 Dec 2008 21:51:07 +0200
Patch fixes uninitialized template for new members...
Maybe, that SubBlack bug is related to this.

--- linux.org.ua/lib/yabb-2.1/Sources/Register.pl~	2008-12-16 21:50:17 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/Register.pl	2008-12-18 21:50:31 +0200
@@ -373,7 +373,7 @@
 	${$uid.$reguser}{'dsttimeoffset'} = $dstoffset;
 	${$uid.$reguser}{'hidemail'}      = $member{'hideemail'};
 	${$uid.$reguser}{'timeformat'}    = qq~MM D+ YYYY @ HH:mm:ss*~;
-	${$uid.$reguser}{'template'}      = $new_template;
+	${$uid.$reguser}{'template'}      = $default_template;
 	${$uid.$reguser}{'language'}      = $member{'language'};
 	${$uid.$reguser}{'pageindex'}     = qq~1|1|1~;




Sun, 28 Dec 2008 13:36:33 +0200
Patch to fix js, that does not recognizes two-digit browser versions

--- linux.org.ua/lib/yabb-2.1/Sources/Post.pl~	2008-12-16 21:44:22 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/Post.pl	2008-12-28 13:35:29 +0200
@@ -321,6 +321,7 @@
 <script language="JavaScript1.2" src="$ubbcjspath" type="text/javascript"></script>
 <script language="JavaScript1.2" type="text/javascript">
 <!--
+var bver = parseFloat ( navigator.appVersion );
 ~;
 
 	$moresmilieslist   = "";
@@ -607,7 +608,7 @@
 		<div style="width: 391px; float:left;">
         <script language="JavaScript1.2" type="text/javascript">
         <!--
-        if((navigator.appName == "Netscape" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Microsoft Internet Explorer" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Opera" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "WebTV Plus Receiver" && navigator.appVersion.charAt(0) >= 3) || (navigator.appName == "Konqueror" && navigator.appVersion.charAt(0) >= 2)) {
+        if((navigator.appName == "Netscape" && bver >= 4) || (navigator.appName == "Microsoft Internet Explorer" && bver >= 4) || (navigator.appName == "Opera" && bver >= 4) || (navigator.appName == "WebTV Plus Receiver" && bver >= 3) || (navigator.appName == "Konqueror" && bver >= 2)) {
           HAND = "style='cursor: pointer; cursor: hand;'";
           document.write("<img src='$defaultimagesdir/url.gif' onclick='hyperlink();' "+HAND+" align='top' width='23' height='22' alt='$post_txt{'257'}' title='$post_txt{'257'}' border='0' />");
           document.write("<img src='$defaultimagesdir/ftp.gif' onclick='ftp();' "+HAND+" align='top' width='23' height='22' alt='$post_txt{'434'}' title='$post_txt{'434'}' border='0' />");
@@ -715,7 +716,7 @@
         <td width="77%" valign="middle" class="windowbg2">
         <script language="JavaScript1.2" type="text/javascript">
         <!--
-        if((navigator.appName == "Netscape" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Microsoft Internet Explorer" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Opera" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Konqueror" && navigator.appVersion.charAt(0) >= 2)) {
+        if((navigator.appName == "Netscape" && bver >= 4) || (navigator.appName == "Microsoft Internet Explorer" && bver >= 4) || (navigator.appName == "Opera" && bver >= 4) || (navigator.appName == "Konqueror" && bver >= 2)) {
           HAND = "style='cursor: pointer; cursor: hand;'";
           document.write("<img src='$imagesdir/smiley.gif' onclick='smiley();' "+HAND+" align='bottom' alt='$post_txt{'287'}' title='$post_txt{'287'}' border='0'> ");
           document.write("<img src='$imagesdir/wink.gif' onclick='wink();' "+HAND+" align='bottom' alt='$post_txt{'292'}' title='$post_txt{'292'}' border='0'> ");
@@ -806,7 +807,7 @@
 	smilieurl = new Array($smilie_url_array)
 	smiliecode = new Array($smilie_code_array)
 
-        if((navigator.appName == "Netscape" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Microsoft Internet Explorer" && navigator.appVersion.charAt(0) >= 4) || (navigator.appName == "Opera" && navigator.appVersion.charAt(0) >= 4)) {
+        if((navigator.appName == "Netscape" && bver >= 4) || (navigator.appName == "Microsoft Internet Explorer" && bver >= 4) || (navigator.appName == "Opera" && bver >= 4)) {
 
           document.write('<table class="bordercolor" height="120" width="120" border="0" cellpadding="2" cellspacing="1" align="center"><tr>');
           document.write('<td height="15" align="center" valign="middle" class="titlebg"><span class="small"><b>$post_smiltxt{'1'}</b></span></td>');




	   
Fri, 30 Jan 2009 20:22:53 +0200
Patch fixes logo displaying in konquerror.
--- htdocs/yabbfiles/Templates/Forum/default.css~	2008-01-12 08:37:53 +0200
+++ htdocs/yabbfiles/Templates/Forum/default.css	2009-01-30 20:18:29 +0200
@@ -387,6 +387,7 @@
 }
 #llogo>*{
 padding:0 5%;
+width:40%;
 font-weight:bold;
 font-family:sans-serif;
 }
@@ -399,5 +400,6 @@
 color:red;
 }
 #llogo>div{
+text-align:right;
 float:right;
 }
--- htdocs/yabbfiles/Templates/Forum/gray.css~	2007-12-14 04:10:37 +0200
+++ htdocs/yabbfiles/Templates/Forum/gray.css	2009-01-30 20:20:06 +0200
@@ -371,6 +371,7 @@
 }
 #llogo>*{
 padding:0 5%;
+width:40%;
 font-weight:bold;
 font-family:sans-serif;
 }
@@ -383,5 +384,6 @@
 color:red;
 }
 #llogo>div{
+text-align:right;
 float:right;
 }




Sun, 08 Mar 2009 00:36:34 +0200
Wordlist capcha.
diff --git a/lib/yabb-2.1/Sources/Decoder.pl b/lib/yabb-2.1/Sources/Decoder.pl
index 8bb6081..25f68c5 100644
--- a/lib/yabb-2.1/Sources/Decoder.pl
+++ b/lib/yabb-2.1/Sources/Decoder.pl
@@ -14,28 +14,201 @@
 #               Your source for web hosting, web design, and domains.         #
 ###############################################################################
 
-$decoderplver = 'YaBB 2.1 $Revision: 1.2* $';
-if ($action eq 'detailedversion') { return 1; }
+use strict;
+use warnings;
 
+use Encode;
 use GD;
-#select(STDOUT);
-#$| = 1;
-#undef $/;
-sub convert {
-	my $value            = 13;
-	my $testdate         = $INFO{'regdate'};
-	my $testsession      = $INFO{'_session_id_'};
-	my $verificationtest = '';
-	
-	foreach (split //, $testdate) {
+
+our $action;
+our $decoderplver = 'YaBB 2.1 $Revision: 1.2* $';
+if ($action eq 'detailedversion') { return 1; }
+
+our (%INFO, %FORM);
+our $vardir;
+our ($user_ip, $username, $date);
+our $yycharset;
+our $capcha_dict_file ||= "$vardir/wordlist.txt";
+
+# LOG CAPCHA
+
+## Writes capcha ansver for current user into log.
+## Returns string, that was written to log (there can be changes in that string).
+## Pass undef to remove capcha entry for current user/ip.
+## A: string
+## R: string
+sub write_capcha_entry {
+	my $value = $_[0];
+	if (defined $value) {
+		$value =~ s/[\n|]+//go;
+	}
+	fopen (*LOG, "+<$vardir/capcha.log") or return undef;
+	binmode LOG, ':encoding(UTF-8)';
+	my @log;
+	while (<LOG>) {
+		my ($ip, $uname, $timestamp) = split /\|/o;
+		if (($user_ip ne $ip or $username ne $uname) and $timestamp + 15 * 60 > $date) {
+			push @log, $_;
+		}
+	}
+	seek LOG, 0, 0;
+	if (defined $value) {
+		print LOG "$user_ip|$username|$date|$value\n" or $value = undef;
+	}
+	print LOG @log;
+	truncate LOG, tell LOG;
+	fclose (*LOG);
+	return $value;
+}
+
+## Finds in log associated with a given IP and username capcha ansver value and returns it.
+## R: string or undef
+sub read_capcha_entry {
+	fopen (*LOG, "<$vardir/capcha.log") or return undef;
+	binmode LOG, ':encoding(UTF-8)';
+	my $value = undef;
+	my $vtimestamp = 0;
+	while (<LOG>) {
+		chomp;
+		my ($ip, $uname, $timestamp, $capchaansver) = split /\|/o;
+		if ($user_ip eq $ip and $username eq $uname and $timestamp + 15 * 60 > $date and $vtimestamp < $timestamp) {
+			$value      = $capchaansver;
+			$vtimestamp = $timestamp;
+		}
+	}
+	fclose (*LOG);
+	return $value;
+}
+
+## Gets capcha text for graphical representation and returns characters of it in list.
+## R: array or undef
+sub getcapchatext_log {
+	my $word = read_capcha_entry ();
+	if (defined $word) {
+		return split (//o, $word);
+	}
+	return undef;
+}
+
+## Checks given capcha ansver against capcha log entry.
+## A: string
+## R: boolean
+sub checkcapcha_log {
+	my $ansver = $_[0];
+	my $word   = read_capcha_entry ();
+
+	if (not defined $word) {
+		return undef;
+	}
+
+	$ansver = decode ($yycharset, $ansver);
+
+	return $ansver eq $word;
+}
+
+# DICT CAPCHA
+
+## Reads random word from dictionary, writes to capcha log and returns written word.
+## R: string or undef
+sub newcapcha_dict {
+	my $maxwordlen = 15;
+	my $minwordlen = 4;
+	# No need for flock here.
+	open DICT, '<', $capcha_dict_file or return undef;
+	my $size = (stat DICT)[7];
+	my $value;
+	do {
+		my $pos = (int (rand ($size/2 - $maxwordlen)) - $maxwordlen)*2;
+		seek DICT, $pos, 0;
+		<DICT>;
+		$value = <DICT>;
+		chomp $value;
+	} while (length ($value) < $minwordlen);
+	close DICT;
+	$value = decode ('UTF-8', $value);
+	return write_capcha_entry ($value);
+}
+
+sub getcapchatext_dict {
+	return getcapchatext_log ();
+}
+
+sub checkcapcha_dict {
+	if (not checkcapcha_log ($_[0])) {
+		newcapcha_dict ();
+		return 0;
+	}
+	write_capcha_entry (undef);
+	return 1;
+}
+
+# URI CAPCHA
+
+## Gets capcha text from given two string (usually extracted from form or uri params).
+## A: string (regdate), string (session id)
+## R: string or undef
+sub extractcapchatext_uri {
+	my $value       = 13;
+	my $testdate    = $_[0];
+	my $testsession = $_[1];
+	my $text        = '';
+
+	if (not length ($testdate) or $testdate =~ /\D/) {
+		return undef;
+	}
+
+	foreach (split //o, $testdate) {
 		$value += $_ + 1;
-		$verificationtest .= substr ($testsession, $value, 1);
+		if (length ($testsession) < $value+1) {
+			return undef;
+		}
+		$text .= substr ($testsession, $value, 1);
 	}
 
-	my $imgx = length ($verificationtest) * 18 + 10 + rand(5);
-	my $imgy = 30+rand(5);
-	my $font = "$vardir/VeraMoBI.ttf";
+	return $text;
+}
+
+## Gets capcha text for graphical representation from user-specified url params regdate and _session_id_.
+## R: string or undef
+sub getcapchatext_uri {
+	my $text = extractcapchatext_uri ( $INFO{'regdate'}, $INFO{'_session_id_'} );
+	
+	if (not defined $text) {
+		return undef;
+	}
 
+	return split (//o, $text);
+}
+
+## Checks capcha ansver, obtained from form, using uri params for image generation.
+## A: string
+## R: boolean or undef
+sub checkcapcha_uri {
+	my $ansver = $_[0];
+	my $text   = extractcapchatext_uri ( $FORM{'regdate'}, $FORM{'_session_id_'} );
+
+	if (not defined $text) {
+		return undef;
+	}
+
+	return $text eq $ansver;
+}
+
+# CAPCHA IMAGE GENERATOR
+
+## Generates image with capcha.
+## Calls one of getcapchatext_* routines to get text value.
+## Otherwise, image will contain "internal error" string.
+sub convert {
+	my @verificationtest = getcapchatext_dict ();
+	if (not defined $verificationtest[0]) {
+		@verificationtest = ( qw(I N T E R N A L . E R R O R) );
+	}
+
+	my $letcnt = scalar (@verificationtest);
+	my $imgx = $letcnt * 18 + 10 + rand(5);
+	my $imgy = 30+rand(5);
+	my $font = "$vardir/DejaVuSans.ttf";
 	my $im = GD::Image->newPalette ($imgx, $imgy);
 	my $bg = $im->colorAllocate (255,255,255);
 	my @foreground = (
@@ -43,19 +216,20 @@ sub convert {
 		$im->colorAllocate (rand(128), rand(64)+128, rand(128)+64)
 	);
 	$im->transparent ($bg);
-#	$im->interlaced ('true');
-	my $i = 10;
+	my $i = $letcnt + 5;
 	$im->line (rand($imgx), rand($imgy), rand($imgx), rand($imgy), $foreground[rand(@foreground)])
 			while ($i--);
 	my $x = 12;
-	foreach (split //, $verificationtest) {
-		$im->stringFT ($foreground[rand(@foreground)], $font, 15 + rand(6), rand, $x, 20 + rand(10), $_);
+	foreach (@verificationtest) {
+		$im->stringFT ($foreground[rand(@foreground)], $font, 15 + rand(6), rand(0.7), $x, 20 + rand(10), $_);
 		$x += 12 + rand(6);
 	}
-#	binmode STDOUT;
 	print "Content-type: image/png\n\n", $im->png;
 }
 
+## Search Easter Egg routine.
+## Produces fatal errors with funny text on certain search strings.
+## A: string
 sub scrambled {
 	if ($_[0] =~ /\AIs UBB Good\?\Z/i) { &fatal_error("Many llamas have pondered this question for ages. They each came up with logical answers to this question, each being quite different. The consensus of their answers: UBB is a decent piece of software made by a large company. They, however, lack a strong supporting community, charge a lot for their software and the employees are very biased towards their own products. And so, once again, let it be written into the books that<br /><a href=\"http://www.yabbforum.com\">YaBB</a> is the greatest community software there ever was!"); }
 	if ($_[0] =~ /\AWhat is a Shoeb\?\Z/i) { &fatal_error("There are many things in life you don't want to ask, and this is one of them.<br />And once you are over the first shock you are in for at least another one.<br /> My advice.... read in between the lines and you'll get the hang of his writing.<br /><br /><a href=\"http://www.clickopedia.com\"><img src=\"http://www.clickopedia.com/coolalien.gif\" alt=\"Shoeb Omar - http://www.clickopedia.com\" border=\"0\" /><a/>"); }
@@ -71,3 +245,4 @@ sub scrambled {
 }
 
 1;
+
diff --git a/lib/yabb-2.1/Sources/Post.pl b/lib/yabb-2.1/Sources/Post.pl
index b370268..25210a3 100644
--- a/lib/yabb-2.1/Sources/Post.pl
+++ b/lib/yabb-2.1/Sources/Post.pl
@@ -575,15 +575,17 @@ function showimage() {
 		</tr>
 		~;
 		} else {
-			$hidestatus = qq~<input type="hidden" value="$thestatus" name="topicstatus" />~;
+			$hidestatus = qq~<input type="hidden" value="$thestatus" name="topicstatus" />~; #/
 		}
 
 	}
 
-	# Captcha for guests on posting
+	# Capcha for guests on posting
 	if ($iamguest && $enable_guestposting && $regcheck) {
 		&LoadLanguage ('flood');
 		&validation_code;
+		require "$sourcedir/Decoder.pl";
+		&newcapcha_dict;
 		$yymain .= qq~
   <tr class="windowbg">
     <td><b>$floodtxt{'1'}:</b></td>
@@ -1458,22 +1460,13 @@ sub Post2 {
 		$name  = ${$uid.$username}{'realname'};
 		$email = ${$uid.$username}{'email'};
 	} else {
-		# Check captcha.
+		&LoadLanguage ('Register');
+		# Check capcha.
 		if ($regcheck) {
-			&LoadLanguage ('Register');
-			&fatal_error("$floodtxt{'4'}") if ($FORM{'verification'} eq '');
-			&fatal_error("$register_txt{'240'} $floodtxt{'3'} $register_txt{'241'}") if ($FORM{'verification'} !~ /\A[0-9A-Za-z]+\Z/);
-
-			# Trying to figure out the mess we made while encrypting verification
-			$lastvalue        = 13;
-			$verificationtest = "";
-			for ($n = 0; $n < length "$FORM{'regdate'}"; $n++) {
-				$value = (substr("$FORM{'regdate'}", $n, 1)) + $lastvalue + 1;
-				$letter = substr("$FORM{'_session_id_'}", $value, 1);
-				$lastvalue = $value;
-				$verificationtest .= qq~$letter~;
+			require "$sourcedir/Decoder.pl";
+			if (not checkcapcha_dict ( $FORM{'verification'})) {
+				&fatal_error ("$floodtxt{'4'}");
 			}
-			&fatal_error("$floodtxt{'4'}") if ($verificationtest ne $FORM{'verification'});
 		}
 
 		# If user is Guest, then make sure the chosen name
@@ -1482,6 +1475,11 @@ sub Post2 {
 		@memberlist = <FILE>;
 		fclose(FILE);
 		&memparse(@memberlist);
+		foreach (@memberlist) {
+			if ($_ eq $name) {
+				&fatal_error ($register_txt{473});
+			}
+		}
 #		$name .= "(Guest)";
 	}
 


Sun, 08 Mar 2009 20:01:53 +0200
Messages in bwg log, fixed non-integer termins.
diff --git a/lib/yabb-2.1/Languages/English/BanWithGroup.lng b/lib/yabb-2.1/Languages/English/BanWithGroup.lng
index a302663..f2a048d 100644
--- a/lib/yabb-2.1/Languages/English/BanWithGroup.lng
+++ b/lib/yabb-2.1/Languages/English/BanWithGroup.lng
@@ -1,5 +1,7 @@
 
-%bangroup_txt = (
+our %loaded;
+
+our %bangroup_txt = (
 
 'notallowed'  => 'You are not allowed to access this section',
 'invaluname'  => 'Invalid username: ',
@@ -20,10 +22,13 @@
 
 'unamefield'  => 'User login',
 'terminfield' => 'Ban termin<br /><span class="small">m - minutes, h - hours, d - days, M - months</span>',
-'reasonfield' => 'Reason:',
-'submit'    => 'Ban',
-'title'     => 'Banning',
-'titleuser' => 'Ban member ',
+'reasonfield' => 'Reason',
+'mesgfield'   => 'Message',
+'bansubmit'   => 'Ban',
+'mesgsubmit'  => 'Write',
+'title'       => 'Banning',
+'titleuser'   => 'Ban member ',
+'titlemesg'   => 'Add message',
 
 'banlogtitle' => 'Banning log',
 'nonick' => '(unnamed)',
diff --git a/lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng b/lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng
index a339460..f11c286 100644
--- a/lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng
+++ b/lib/yabb-2.1/Languages/Ukrainian/BanWithGroup.lng
@@ -1,5 +1,7 @@
 
-%bangroup_txt = (
+our %loaded;
+
+our %bangroup_txt = (
 
 'notallowed'  => 'Вам не дозволено',
 'invaluname'  => 'Невірне ім\'я користувача: ',
@@ -21,9 +23,12 @@
 'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
 'reasonfield' => 'Причина бану',
-'submit'      => 'Забанити',
+'mesgfield'   => 'Повідомлення',
+'bansubmit'   => 'Забанити',
+'mesgsubmit'  => 'Записати',
 'title'       => 'Бан',
 'titleuser'   => 'Забанити ',
+'titlemesg'   => 'Повідомлення',
 
 'banlogtitle' => 'Часопис банів',
 'nonick' => '(невідомий)',
diff --git a/lib/yabb-2.1/Sources/BanWithGroup.pl b/lib/yabb-2.1/Sources/BanWithGroup.pl
index 5631817..128e3e3 100644
--- a/lib/yabb-2.1/Sources/BanWithGroup.pl
+++ b/lib/yabb-2.1/Sources/BanWithGroup.pl
@@ -1,94 +1,79 @@
-
-#=head1 Ban With Group
-
-#adds user to 'Banned' group (with denial permissions)
-#and sets his position group into temporary additional group,
-#that carries info about ban end time and original user's position.
-
-#=cut
+#
+# Banning users with a special groups.
+#
+# © 2007-2009 Myhailo Danylenko <isbear@ukrpost.net>
+#
+
+use strict;
+use warnings;
+no strict qw(refs); # >:( ${$uid.$login}{...}
+use Encode;
+
+our (%FORM, %INFO);
+our ($yySetLocation, $yycharset, $scripturl, $uid, $date);
+our ($username, $iamadmin, $iamgmod, $iammod, $sessionvalid);
+our (%Group, %Post, %NoPost);
+our (%bangroup_txt);
+our ($vardir);
+our %loaded;
 
 return if $loaded{'BanWithGroup.pl'};
-
 $loaded{'BanWithGroup.pl'} = 1;
 
 LoadLanguage ( 'BanWithGroup' ) if not $loaded{'BanWithGroup.lng'};
 
-#=head1 TODO
-
-#change lng: bangroup_txt{nomain} -> {nogroup}, generalize text accordingly
-
-#add records into banlog about safety lock?
-
-#move group_id to Subs.pl?
-
-#B<FIXME> we should define upper limit for ban termin.
-
-#B<FIXME> do something about fatal_error in group_gid.
-
-#=head1 FUNCTIONS
-
-#=head2 group_gid B<group_name>
-
-#B<Warning> This function raises fatal error in error case.
-
-#Searches for No Post group and returns it's id. Case does not matter.
+# TODO
+#
+# change lng: bangroup_txt{nomain} -> {nogroup}, generalize text accordingly
+# add records into banlog about safety lock?
+# move group_id and save_groups to Subs.pl?
+# FIXME we should define upper limit for ban termin.
 
-#=cut
+# UTILITY ROUTINES
 
+## group_gid
+## Searches for No Post group and returns it's id. Case does not matter.
+## A: string (group name)
+## R: number (group id) or undef
 sub group_gid {
 	my $name = quotemeta $_[0];
-
 	foreach my $id ( keys %NoPost ) {
-		return $id
-			if $NoPost{$id} =~ /^$name\|/i;
+		if ($NoPost{$id} =~ /^$name\|/i) {
+			return $id
+		}
 	};
-
-	fatal_error $bangroup_txt{'nogroup'} . $name;
+	return undef;
 }
 
-#=head2 push_ban_log B<who, whom, gid, termin, reason>
-
-#Writes record about taken action into banlog, additionally providing timestamp
-
-#=cut
-
+## push_ban_log
+## Writes record about taken action into banlog, additionally providing timestamp.
+## A: string (who acts), string (object of action), number (group id), number (ban termin), string (message)
+## R: boolean
 sub push_ban_log {
 	my ( $who, $whom, $gid, $termin, $reason ) = @_;
-
-	fopen ( BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
-
+	$reason = decode ( $yycharset, $reason ); # XXX
+	fopen ( *BANLOG, ">> $vardir/banwithgroup.log" ) or return 0;
+	binmode BANLOG, ":encoding(UTF-8)"; # XXX
 	print BANLOG "$date|$who|$whom|$gid|$termin|$reason\n";
-
-	fclose BANLOG;
-
+	fclose ( *BANLOG );
 	return 1
 }
 
-#=head2 save_groups
-
-#Saves current state of membergroups into $vardir/membergroups.txt
-
-#=cut
-
+## save_groups
+## Saves current state of membergroups into $vardir/membergroups.txt
 sub save_groups {
-
-	fopen ( GRP, ">$vardir/membergroups.txt" )
+	fopen ( *GRP, ">$vardir/membergroups.txt" )
 		or fatal_error $bangroup_txt{'cof'} . "$vardir/membergroups.txt";
-
+#	binmode GRP, ":encoding($yycharset)"; # XXX
 	print GRP map "\$Group{'$_'} = '$Group{$_}';\n",   keys %Group;
 	print GRP map "\$NoPost{'$_'} = '$NoPost{$_}';\n", keys %NoPost;
 	print GRP map "\$Post{'$_'} = '$Post{$_}';\n",     keys %Post;
 	print GRP     "\n1;\n";
-
-	fclose ( GRP );
+	fclose ( *GRP );
 }
 
-#=head2 safety_lock
-
-#Adds current user (admin or gmod) to group 'Safety Lock'
-
-#=cut
-
+## safety_lock
+## Adds current user (admin or gmod) to group 'Safety Lock'
 sub safety_lock {
 
 	unless ( $iamadmin or $iamgmod ) {
@@ -98,39 +83,41 @@ sub safety_lock {
 	unless ( exists ${$uid.$username}{'addgroups'} ) {
 		# generally, this should be not necessary, just for sure..
 		LoadUser ( $username )
-			or fatal_error $bangroup_txt{'cannotloaduser'} . $username
+			or fatal_error ( $bangroup_txt{'cannotloaduser'} . $username );
 	}
 
 	my $lockgid = group_gid ( 'Safety Lock' );
+	if ( not defined $lockgid ) {
+		fatal_error ( $bangroup_txt{'nogroup'} . 'Safety Lock' );
+	}
 
 	unless ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 		${$uid.$username}{'addgroups'} = join ',', ( split ( /,/, ${$uid.$username}{'addgroups'} ), $lockgid );
-		UserAccount $username, 'update';
+		UserAccount ( $username, 'update' );
 	}
 	
-	our $yySetLocation = "$scripturl?action=viewprofile;username=$username";
-	redirectexit;
+	$yySetLocation = "$scripturl?action=viewprofile;username=$username";
+	redirectexit ();
 }
 
-#=head2 safety_unlock
-
-#Removes group 'Safety Lock' from a list of current user groups
-
-#=cut
-
+## safety_unlock
+## Removes group 'Safety Lock' from a list of current user groups
 sub safety_unlock {
 
 	unless ( exists ${$uid.$username}{'addgroups'} ) {
 		# generally, this should be not necessary, just for sure..
 		LoadUser ( $username )
-			or fatal_error $bangroup_txt{'cannotloaduser'} . $username
+			or fatal_error ( $bangroup_txt{'cannotloaduser'} . $username );
 	}
 
 	my $lockgid = group_gid ( 'Safety Lock' );
+	if ( not defined $lockgid ) {
+		fatal_error ( $bangroup_txt{'nogroup'} . 'Safety Lock' );
+	}
 
 	if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 		${$uid.$username}{'addgroups'} =~ s/(^|,)$lockgid(,|$)/$1/;
-		UserAccount $username, 'update';
+		UserAccount ( $username, 'update' );
 	}
 	
 	our $yySetLocation = "$scripturl?action=viewprofile;username=$username";
@@ -138,47 +125,40 @@ sub safety_unlock {
 }
 
 
-#=head2 ban_with_group
-
-#B<FORM> username, termin, reason
-
-#Processes request to ban with group B<username> for B<termin> with B<reason>
-
-#=cut
-
+## ban_with_group
+## Processes request to ban 'username' for 'termin' with 'reason'.
 sub ban_with_group {
-
 	my $login  = $FORM{'username'} || $INFO{'username'};
 	my $termin = $FORM{'termin'}   || $INFO{'termin'};
 	my $reason = $FORM{'reason'}   || $INFO{'reason'} || '';
 
 	if ( $login !~ /^[A-Za-z0-9\@#_\-.]+$/ ) {
-		fatal_error $bangroup_txt{'invaluname'} . $login
+		fatal_error ( $bangroup_txt{'invaluname'} . $login );
 	}
 
 	if ( $termin =~ /[^0-9 mhdM]/ ) {
-		fatal_error $bangroup_txt{'invalterm'} . $termin
+		fatal_error ( $bangroup_txt{'invalterm'} . $termin );
 	}
 
 	if ( $termin !~ /[0-9mhdM]/ ) {
-		$termin = '0'
+		$termin = '0';
 	}
 
-	# FIXME
+	# XXX
 	if ( $reason =~ /[\x00-\x1F\x7F]/ ) {
-		fatal_error $bangroup_txt{'invalreason'} . $reason;
+		fatal_error ( $bangroup_txt{'invalreason'} . $reason );
 	}
 
-	FromChars $reason;
-	ToHTML    $reason;
+	FromChars ( $reason );
+	ToHTML    ( $reason );
 
 	unless ( ( ( $iamadmin or $iamgmod or $iammod ) and $sessionvalid )
 		 or $login eq $username ) {
-		fatal_error $bangroup_txt{'notallowed'}
+		fatal_error ( $bangroup_txt{'notallowed'} );
 	}
 
 	if ( $login eq 'admin' ) {
-		fatal_error $bangroup_txt{'nobadmin'}
+		fatal_error ( $bangroup_txt{'nobadmin'} );
 	}
 
 	$termin =~ s/(\d)\s+(\D)/$1$2/g;
@@ -190,30 +170,32 @@ sub ban_with_group {
 	$termin =~ s/d/*60*60*24+/g;
 	$termin =~ s/M/*60*60*24*30+/g;
 	$termin .= $date;
-	$termin  = eval $termin;
+	$termin  = eval "int($termin)"; # XXX
 
 	my $mainbanid = group_gid ( 'Banned' );
+	if ( not defined $mainbanid ) {
+		fatal_error ( $bangroup_txt{'nogroup'} . 'Banned' );
+	}
 
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
-			or fatal_error $bangroup_txt{'cannotloaduser'} . $login
+			or fatal_error ( $bangroup_txt{'cannotloaduser'} . $login );
 	}
 
 	if ( ${$uid.$login}{'addgroups'} =~ /(^|,)$mainbanid(,|$)/ ) {
 		if ( $NoPost{${$uid.$login}{'position'}} =~ /^\[banned=(\d+),(.*?)\]\|/i ) {
 			if ( $1 > $termin ) {
-				fatal_error $bangroup_txt{'nolower'} .
-					    int ( ( $1 - $date ) / 60 + 1 )
+				fatal_error ( $bangroup_txt{'nolower'} . int ( ( $1 - $date ) / 60 + 1 ) );
 			}
 
 			$NoPost{${$uid.$login}{'position'}} =~ s/^\[banned=\d+,(.*?)\]\|/[banned=$termin,$1]|/i;
-			save_groups;
+			save_groups ();
 	
 			push_ban_log ( $username, $login, ${$uid.$login}{'position'}, $termin, $reason )
 					or fatal_error $bangroup_txt{'cannotlog'};
 
-			our $yySetLocation = "$scripturl?action=bwglog";
-			redirectexit;
+			$yySetLocation = "$scripturl?action=bwglog";
+			redirectexit ();
 		}
 
 		${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/
@@ -224,77 +206,68 @@ sub ban_with_group {
 	++$newid while exists $NoPost{$newid};
 
 	$NoPost{$newid} = "[banned=$termin,${$uid.$login}{'position'}]|1|ban.png||0|0|0|0|0|0|0";
-	save_groups;
+	save_groups ();
 
 	${$uid.$login}{'addgroups'} = join ',', ( split ( /,/, ${$uid.$login}{'addgroups'} ), $mainbanid );
 	${$uid.$login}{'position'}  = $newid;
-	UserAccount $login, 'update';
+	UserAccount ( $login, 'update' );
 
 	push_ban_log ( $username, $login, $newid, $termin, $reason )
-			or fatal_error $bangroup_txt{'cannotlog'};
+			or fatal_error ( $bangroup_txt{'cannotlog'} );
 
-	our $yySetLocation = "$scripturl?action=bwglog";
-	redirectexit;
+	$yySetLocation = "$scripturl?action=bwglog";
+	redirectexit ();
 }
 
-#=head2 unban_with_group
-
-#B<URL> username
-
-#Forcely unbans B<username> (before termin expiration) (admin, gmod)
-
-#=cut
-
+## unban_with_group
+## Forcely unbans 'username' (before termin expiration) (admin, gmod)
 sub unban_with_group {
 	my $login = $INFO{'username'};
 
 	if ( $login !~ /^[A-Za-z0-9\@#_\-.]+$/ ) {
-		fatal_error $bangroup_txt{'invaluname'} . $login
+		fatal_error ( $bangroup_txt{'invaluname'} . $login );
 	}
 
 	if ( not ( $iamadmin or $iamgmod ) ) {
-		fatal_error $bangroup_txt{'notallowed'}
+		fatal_error ( $bangroup_txt{'notallowed'} );
 	}
 
 	my $mainbanid = group_gid ( 'Banned' );
+	if ( not defined $mainbanid ) {
+		fatal_error ( $bangroup_txt{'nogroup'} . 'Banned' );
+	}
 	
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
-			or fatal_error $bangroup_txt{'cannotloaduser'} . $login
+			or fatal_error ( $bangroup_txt{'cannotloaduser'} . $login );
 	}
 
 	if ( ${$uid.$login}{'addgroups'} !~ /(^|,)$mainbanid(,|$)/ ) {
-		fatal_error $bangroup_txt{'notbanned'}
+		fatal_error ( $bangroup_txt{'notbanned'} );
 	}
 	
 	my $addid = ${$uid.$login}{'position'};
 
 	if ( $NoPost{$addid} !~ /^\[banned=\d+,(.*?)\]\|/i ) {
-		fatal_error $bangroup_txt{'noaddid'}
+		fatal_error ( $bangroup_txt{'noaddid'} );
 	}
 
 	${$uid.$login}{'position'}  =  $1;
 	${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/;
-	UserAccount $login, 'update';
+	UserAccount ( $login, 'update' );
 
 	delete $NoPost{$addid};
 	save_groups;
 
 	push_ban_log ( $username, $login, $addid, 'unban', '' )
-			or fatal_error $bangroup_txt{'cannotlog'};
+			or fatal_error ( $bangroup_txt{'cannotlog'} );
 
 	our $yySetLocation = "$scripturl?action=bwglog";
-	redirectexit
+	redirectexit ();
 }
 
-#=head2 ban_with_group_passthrough
-
-#B<URL> [username, termin, reason]
-
-#Shows form to send request for banning B<username>
-
-#=cut
-
+## ban_with_group_passthrough
+## Shows form to send request for banning 'username'.
 sub ban_with_group_passthrough {
 
 	my $login  = $INFO{'username'};
@@ -303,9 +276,9 @@ sub ban_with_group_passthrough {
 
 	$login  =~ s/[^A-Za-z0-9\@#_\-.]+//g;
 	$termin =~ s/[^\dmhdM]+/ /g;
-	$reason =~ s/[\x00-\x1F\x7F]+//g; # FIXME
+	$reason =~ s/[\x00-\x1F\x7F]+//g; # XXX
 
-	ToHTML $reason;
+	ToHTML ( $reason );
 	
 	my  @ti = $login ? ( 4, 1, 2, 3 ) : ( 1, 2, 3, 4 );
 
@@ -324,24 +297,70 @@ sub ban_with_group_passthrough {
 		<td class="windowbg">$bangroup_txt{'reasonfield'}</td>
 		<td class="windowbg2"><input type="text" name="reason" value="$reason" tabindex="$ti[2]" style="width: 100%" /></td>
 	</tr><tr>
-		<td colspan="2" class="catbg"><input type="submit" name="submit" value="$bangroup_txt{'submit'}" tabindex="$ti[3]" style="width: 100%" /></td>
+		<td colspan="2" class="catbg"><input type="submit" name="submit" value="$bangroup_txt{'bansubmit'}" tabindex="$ti[3]" style="width: 100%" /></td>
+	</tr></table>
+	</form>
+~;
+
+	template ();
+
+	exit;
+}
+
+## bwg_message_form
+## Shows form to add message to bwglog.
+sub bwg_message_form {
+	my $message = $INFO{'message'} || '';
+
+	$message =~ s/[\x00-\x1F\x7F]+//g; # XXX
+
+	ToHTML ( $message );
+	
+	our $yytitle = $bangroup_txt{'titlemesg'};
+	our $yymain  = qq~
+	<form action="$scripturl?action=mbwg" method="post" >
+	<table cellpadding="4" cellspacing="1" border="0" width="60%" align="center" class="bordercolor" style="margin: 1em 20%;"><tr>
+		<td colspan="2" class="titlebg"><b>$yytitle</b></td>
+	</tr><tr>
+		<td class="windowbg">$bangroup_txt{'mesgfield'}</td>
+		<td class="windowbg2"><input type="text" name="message" value="$message" tabindex="1" style="width: 100%" /></td>
+	</tr>v<tr>
+		<td colspan="2" class="catbg"><input type="submit" name="submit" value="$bangroup_txt{'mesgsubmit'}" tabindex="2" style="width: 100%" /></td>
 	</tr></table>
 	</form>
 ~;
 
-	template;
+	template ();
 
 	exit;
 }
 
-#=head2 expire_ban_with_group
+## bwg_add_message
+## Processes request to add message to log.
+sub bwg_add_message {
+	my $message = $FORM{'message'} || $INFO{'message'} || '';
+
+	# XXX
+	if ( $message =~ /[\x00-\x1F\x7F]/ ) {
+		fatal_error ( $bangroup_txt{'invalreason'} . $message ); # FIXME
+	}
+
+	FromChars ( $message );
+	ToHTML    ( $message );
 
-#B<URL> username
+	unless ( ( $iamadmin or $iamgmod or $iammod ) and $sessionvalid ) {
+		fatal_error ( $bangroup_txt{'notallowed'} );
+	}
 
-#Removes expired ban from B<username>
+	push_ban_log ( $username, '', '', 'message', $message )
+			or fatal_error ( $bangroup_txt{'cannotlog'} );
 
-#=cut
+	our $yySetLocation = "$scripturl?action=bwglog";
+	redirectexit ();
+}
 
+## expire_ban_with_group
+## Removes expired ban from 'username'.
 sub expire_ban_with_group {
 
 	my $login = $INFO{'username'};
@@ -351,6 +370,9 @@ sub expire_ban_with_group {
 	}
 
 	my $mainbanid = group_gid ( 'Banned' );
+	if ( not defined $mainbanid ) {
+		fatal_error ( $bangroup_txt{'nogroup'} . 'Banned' );
+	}
 
 	unless ( exists ${$uid.$login}{'addgroups'} ) {
 		LoadUser ( $login )
@@ -373,7 +395,7 @@ sub expire_ban_with_group {
 
 	${$uid.$login}{'position'}  =  $2;
 	${$uid.$login}{'addgroups'} =~ s/(^|,)$mainbanid(,|$)/$1/;
-	UserAccount $login, 'update';
+	UserAccount ( $login, 'update' );
 
 	delete $NoPost{$addid};
 	save_groups;
@@ -382,62 +404,49 @@ sub expire_ban_with_group {
 			or fatal_error $bangroup_txt{'cannotlog'};
 	
 	our $yySetLocation = "$scripturl?action=bwglog";
-	redirectexit
+	redirectexit ();
 }
 
-#=head2 show_ban_log
-
-#Generates ban log page
-
-#=cut
-
+## show_ban_log
+## Generates ban log page
 sub show_ban_log {
 
-	fopen ( BANLOG, "< $vardir/banwithgroup.log" )
-			or fatal_error $bangroup_txt{'cof'} . "$vardir/banwithgroup.log";
+	fopen ( *BANLOG, "< $vardir/banwithgroup.log" )
+			or fatal_error ( $bangroup_txt{'cof'} . "$vardir/banwithgroup.log" );
+	binmode BANLOG, ":encoding(UTF-8)"; # XXX
 
 	our $yytitle = $bangroup_txt{'banlogtitle'};
-	
 	our $yymain  = qq(<div class="windowbg"><div class="catbg">$bangroup_txt{'banlogtitle'}</div>);
-	
 	while ( <BANLOG> ) {
 		chomp;
 
-		my ( $date, $who, $whom, $gid, $termin, $reason ) = split /\|/, $_;
+		my ( $cdate, $who, $whom, $gid, $termin, $reason ) = split /\|/, $_;
+		$reason = encode ( $yycharset, $reason ); # XXX
 		
-		LoadUser  $who  if not exists ${$uid.$who}{'realname'};
-		LoadUser  $whom if not exists ${$uid.$whom}{'realname'};
-		$who    = ${$uid.$who}{'realname'}  || $bangroup_txt{'nonick'};
-		$whom   = ${$uid.$whom}{'realname'} || $bangroup_txt{'nonick'};
-		$date   = timeformat $date;
+		LoadUser ( $who )  if not exists ${$uid.$who}{'realname'};
+		LoadUser ( $whom ) if not exists ${$uid.$whom}{'realname'};
+		$who   = ${$uid.$who}{'realname'}  || $bangroup_txt{'nonick'};
+		$whom  = ${$uid.$whom}{'realname'} || $bangroup_txt{'nonick'};
+		$cdate = timeformat $cdate;
 		ToChars   $reason;
 
 		# FIXME: organize as table? make it template?
 		if ( $termin eq 'expire' or $termin eq 'unban' ) {
-
-			$yymain .= qq([$date] $who$bangroup_txt{'blog4'}$whom$bangroup_txt{'blog3'}$gid<br/>\n);
-
+			$yymain .= qq([$cdate] $who$bangroup_txt{'blog4'}$whom$bangroup_txt{'blog3'}$gid<br/>\n);
+		} elsif ( $termin eq 'message' ) {
+			$yymain .= qq([$cdate] $who: $reason<br/>\n);
 		} else {
-
 			$termin = timeformat $termin;
-			$yymain .= qq([$date] $who$bangroup_txt{'blog1'}$whom$bangroup_txt{'blog2'}$termin$bangroup_txt{'blog3'}$gid$bangroup_txt{'blog5'}$reason<br/>\n);
+			$yymain .= qq([$cdate] $who$bangroup_txt{'blog1'}$whom$bangroup_txt{'blog2'}$termin$bangroup_txt{'blog3'}$gid$bangroup_txt{'blog5'}$reason<br/>\n);
 		}
 	}
-
 	$yymain .= qq(</div>);
 
-	fclose ( BANLOG );
+	fclose ( *BANLOG );
 
-	template;
+	template ();
 	exit;
 }
 
 1;
 
-#=head1 AUTHORS
-
-#Myhailo Danylenko <isbear@ukrpost.net>
-
-#=cut
-
-# The End
diff --git a/lib/yabb-2.1/Sources/SubList.pl b/lib/yabb-2.1/Sources/SubList.pl
index 77c1ed2..1d92d1f 100644
--- a/lib/yabb-2.1/Sources/SubList.pl
+++ b/lib/yabb-2.1/Sources/SubList.pl
@@ -14,16 +14,6 @@
 #               Your source for web hosting, web design, and domains.         #
 ###############################################################################
 
-#=head1 Sub List
-#
-#List of url B<action>s and corresponding files/subs to use for it's processing
-#
-#=head1 Actions provided:
-#
-#
-#
-#=cut
-#
 $sublistplver = 'YaBB 2.1 $Revision: 1.1 $';
 if($action eq 'detailedversion') { return 1; }
 
@@ -32,41 +22,20 @@ if($action eq 'detailedversion') { return 1; }
 'newmesg',"Recent.pl&new_messages",
 'newmarkread',"Recent.pl&nm_mark_read",
 
-#=head3 Snark actions (commented)
-#
-#'regenfullog',"Snark.pl&regenfullog",
-#'huntlog',"Snark.pl&huntlog_show",
-#'showguns',"Snark.pl&show_guns",
-#'ghd',"Snark.pl&give_him_damage",
-#'rmgwogu',"Snark.pl&revive_me_gwog",
-#
-#=head3 Safety lock actions
-#
-#=cut
-
 'safetylock',"BanWithGroup.pl&safety_lock",
 'safetyunlock',"BanWithGroup.pl&safety_unlock",
 
-#=head3 Ban with group actions
-#
-#=cut
-
 'bwg',"BanWithGroup.pl&ban_with_group",
 'ubwg',"BanWithGroup.pl&unban_with_group",
 'ebwg',"BanWithGroup.pl&expire_ban_with_group",
 'pbwg',"BanWithGroup.pl&ban_with_group_passthrough",
-'bwglog',"BanWithGroup.pl&show_ban_log",
 
-#=head3 Novyny actions
-#
-#=cut
+'nbwg', "BanWithGroup.pl&bwg_message_form",
+'mbwg', "BanWithGroup.pl&bwg_add_message",
+'bwglog',"BanWithGroup.pl&show_ban_log",
 
 'novyny',"Novyny.pl&Novyny",
 
-#=head3 Other actions
-#
-#=cut
-
 'activate',"Register.pl&user_activation",
 'favorites',"Favorites.pl&Favorites",
 'addfav',"Favorites.pl&AddFav",
diff --git a/lib/yabb-2.1/Sources/Subs.pl b/lib/yabb-2.1/Sources/Subs.pl
index bb7ff2e..a2c4816 100644
--- a/lib/yabb-2.1/Sources/Subs.pl
+++ b/lib/yabb-2.1/Sources/Subs.pl
@@ -248,13 +248,13 @@ sub template {
 
 	### SAFETY LOCK ###
 	if ( $iamadmin or $iamgmod ) {
-		$yymenu .= qq~$menusep<a href="$scripturl?action=safetylock">$img{'safetylock'}</a>~;
+		$yymenu .= qq~$menusep<a href="$scripturl?action=nbwg">$img{'bwgmessage'}</a>$menusep<a href="$scripturl?action=safetylock">$img{'safetylock'}</a>~;
 	} elsif ( ${$uid.$username}{'addgroups'} ) {
 		require "$sourcedir/BanWithGroup.pl"
 			if not $loaded{'BanWithGroup.pl'};
 		my $lockgid = group_gid ( 'Safety Lock' );
 		if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
-			$yymenu .= qq~$menusep<a href="$scripturl?action=safetyunlock">$img{'safetyunlock'}</a>~;
+			$yymenu .= qq~$menusep<a href="$scripturl?action=bwglog">$img{'bwglog'}</a>$menusep<a href="$scripturl?action=safetyunlock">$img{'safetyunlock'}</a>~;
 		}
 	}
 	### SAFETY LOCK ###
diff --git a/var/yabb-2.1/Variables/Menu1.def b/var/yabb-2.1/Variables/Menu1.def
index 6fc0644..2836f65 100644
--- a/var/yabb-2.1/Variables/Menu1.def
+++ b/var/yabb-2.1/Variables/Menu1.def
@@ -35,6 +35,8 @@ $menusep = ' | ';
 ### SAFETY LOCK ###
 'safetylock' => "Поставити на запобіжник",
 'safetyunlock' => "Зняти з запобіжника",
+'bwgmessage' => "Запис до логу",
+'bwglog' => "Лог",
 ### SAFETY LOCK ###
 
 'rules' => "<a  class=\"imgmenu\" style=\"color:red\" href=\"YaBB.pl?num=1075310952\">Правила</a>",
diff --git a/lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng b/lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng
index 946e300..0532e58 100644
--- a/lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng
+++ b/lib/yabb-2.1/Languages/Ukrainian_isb/BanWithGroup.lng
@@ -1,5 +1,7 @@
 
-%bangroup_txt = (
+our %loaded;
+
+our %bangroup_txt = (
 
 'notallowed'  => 'Вам не дозволено',
 'invaluname'  => 'Невірне ім\'я користувача: ',
@@ -21,9 +23,12 @@
 'unamefield'  => 'Логін користувача',
 'terminfield' => 'Термін бану<br /><span class="small">m - хвилин, h - годин, d - діб, M - місяців, без суфіксу - годин</span>',
 'reasonfield' => 'Причина бану',
-'submit'    => 'Забанити',
-'title'     => 'Бан',
-'titleuser' => 'Забанити ',
+'mesgfield'   => 'Повідомлення до часопису',
+'bansubmit'   => 'Забанити',
+'mesgsubmit'  => 'Записати',
+'title'       => 'Бан',
+'titleuser'   => 'Забанити ',
+'titlemesg'   => 'Повідомлення',
 
 'banlogtitle' => 'Часопис банів',
 'nonick' => 'невідомий',


Mon, 09 Mar 2009 12:25:20 +0200
Patch fixes "Start new thread" on recent reply, enforces strict.
diff --git a/lib/yabb-2.1/Sources/Recent.pl b/lib/yabb-2.1/Sources/Recent.pl
index a7de77f..7433eca 100644
--- a/lib/yabb-2.1/Sources/Recent.pl
+++ b/lib/yabb-2.1/Sources/Recent.pl
@@ -14,9 +14,25 @@
 #               Your source for web hosting, web design, and domains.         #
 ###############################################################################
 
-$recentplver = 'YaBB 2.1 $Revision: 1.1 $';
+our $action;
+
+our $recentplver = 'YaBB 2.1 $Revision: 1.1 $';
 if ($action eq 'detailedversion') { return 1; }
 
+use strict;
+use warnings;
+no strict qw(refs); # ${$uid.$username}{...}
+
+our (%INFO, %FORM);
+our (%img, %img_txt, %img_polltxt, %txt, %recent_txt, %maintxt);
+our (%board, @categoryorder, %catinfo, %cat);
+our ($mbname, $max_log_days_old, $tlnomodflag, $tlnomodtime, $tlnodelflag, $tlnodeltime, $enable_ubbc, $enable_notification);
+our ($memberdir, $datadir, $imagesdir, $boardsdir, $uploaddir, $sourcedir);
+our ($scripturl, $forumstylesurl, $uploadurl, $usestyle, $imgext, $menusep);
+our ($yymain, $yytitle, $yyinlinestyle, %yyuserlog, $yySetLocation, $yyYaBBCloaded);
+our ($iamguest, $iamadmin, $username, $uid, $date, %useraccount);
+our ($mloaded, %loaded);
+
 LoadLanguage ( 'Recent' );
 
 # Sub RecentTopics shows all the most recently posted topics
@@ -75,7 +91,7 @@ sub nm_menu_struct {
 	return map {
 		\{
 			url  => "$scripturl?action=$_",
-			name => "$img{$_}"
+			name => "$img{$_}",
 		}
 	} @_;
 }
@@ -110,7 +126,7 @@ sub nm_poll_struct {
 	
 	my $tid = shift;
 
-	if ( not fopen ( POLL, "< $datadir/$tid.poll" ) ) {
+	if ( not fopen ( *POLL, "< $datadir/$tid.poll" ) ) {
 		return undef;
 	}
 
@@ -134,23 +150,25 @@ sub nm_poll_struct {
 		}
 	}
 	
-	fclose ( POLL );
+	fclose ( *POLL );
 
 	# FIXME
 	my @pollmenu;
 
+	# FIXME
+	our $have_poll_access;
 	if ( not $locked and $puid eq $username and $have_poll_access ) { # FIXME
 		if ( not $tlnomodflag or $pdate + $tlnomodtime * 60 * 60 * 24 > $date ) {
 			push @pollmenu, {
 				name => $img_polltxt{39},
-				url  => qq($scripturl?action=modify;thread=$tid;message=Poll) # FIXME
+				url  => qq($scripturl?action=modify;thread=$tid;message=Poll), # FIXME
 			}
 		}
 
 		if ( not $tlnodelflag or $pdate + $tlnodeltime * 60 * 60 * 24 > $date ) {
 			push @pollmenu, {
 				name => $img_polltxt{27},
-				url  => qq($scripturl?action=post;num=$tid;title=AddPoll) # FIXME
+				url  => qq($scripturl?action=post;num=$tid;title=AddPoll), # FIXME
 			}
 		}
 	}
@@ -166,7 +184,7 @@ sub nm_poll_struct {
 
 	$retpoll{menu} = \@pollmenu if @pollmenu;
 
-	return \%retpoll
+	return \%retpoll;
 }
 
 # template - I separated this to see, how it will be,
@@ -246,6 +264,7 @@ sub nm_template {
 					my $author = nm_template_user $curpoll->{owner};
 					my $posted = timeformat       $curpoll->{date};
 					my $menu   = nm_template_menu $curpoll->{menu};
+					my $text   = $curpoll->{text}; # FIXME
 
 					$yymain .= qq(
 					<div class="poll" >
@@ -297,8 +316,9 @@ sub nm_template {
 							require "$sourcedir/YaBBC.pl"
 						}
 
+						our $ns;
 						if ( exists $curpost->{nosm} ) {
-							our $ns = 'NS'; # the same...
+							$ns = 'NS'; # the same...
 						} else {
 							undef $ns
 						}
@@ -428,7 +448,7 @@ sub new_messages {
 				$oldest_date = $yyuserlog{"$curboard--mark"}
 			}
 			
-			if ( not fopen ( BOARD, "< $boardsdir/$curboard.txt" ) ) {
+			if ( not fopen ( *BOARD, "< $boardsdir/$curboard.txt" ) ) {
 
 				push @err, {
 					func => 'new_messages',
@@ -498,7 +518,7 @@ sub new_messages {
 					}
 				}
 
-				if ( not fopen ( THREAD, "< $datadir/$tid.txt" ) ) {
+				if ( not fopen ( *THREAD, "< $datadir/$tid.txt" ) ) {
 
 					push @err, {
 						func => 'new_messages',
@@ -594,7 +614,7 @@ sub new_messages {
 					push @retthread, \%retpost;
 				}
 
-				fclose ( THREAD );
+				fclose ( *THREAD );
 
 				next if not @retthread;
 
@@ -602,23 +622,23 @@ sub new_messages {
 				my @threadmenu = (
 					{
 						name => $img_txt{627},
-						url  => qq($scripturl?action=markunread;board=$curboard;thread=$tid)
+						url  => qq($scripturl?action=markunread;board=$curboard;thread=$tid),
 					},
 					{ # FIXME: Check for presence of fav and reverse to 72/remfav
 						name => $img_txt{71},
-						url  => qq($scripturl?action=addfav;fav=$tid)
+						url  => qq($scripturl?action=addfav;fav=$tid),
 					},
 					{ # FIXME: Check for presence
 						name => $img_txt{131},
-						url  => qq($scripturl?action=notify;thread=$tid)
+						url  => qq($scripturl?action=notify;thread=$tid),
 					},
 					{
 						name => $img_txt{707},
-						url  => qq($scripturl?action=sendtopic;thread=$tid)
+						url  => qq($scripturl?action=sendtopic;thread=$tid),
 					},
 					{
 						name => $img_txt{465},
-						url  => qq($scripturl?action=print;num=$tid)
+						url  => qq($scripturl?action=print;num=$tid),
 					}
 				);
 
@@ -626,14 +646,14 @@ sub new_messages {
 					if ( $have_reply_access ) {
 						push @threadmenu, {
 							name => $img_txt{146},
-							url  => qq($scripturl?action=post;num=$tid;title=PostReply)
+							url  => qq($scripturl?action=post;num=$tid;title=PostReply),
 						}
 					}
 
 					if ( $have_poll_access and not -e "$datadir/$tid.poll" ) {	
 						push @threadmenu, {
 							name => $img_polltxt{2},
-							url  => qq($scripturl?action=post;num=$tid;title=AddPoll)
+							url  => qq($scripturl?action=post;num=$tid;title=AddPoll),
 						}
 					}
 				}
@@ -646,7 +666,7 @@ sub new_messages {
 					icon  => $ticon,
 					state => $state, # instead, supply possible actions?
 					menu  => \@threadmenu,
-					n     => \@retthread
+					n     => \@retthread,
 				);
 
 				$retthread{poll} = $retpoll if $retpoll;
@@ -654,14 +674,14 @@ sub new_messages {
 				push @retboard, \%retthread;
 			}
 
-			fclose ( BOARD );
+			fclose ( *BOARD );
 
 			next if not @retboard;
 
 			push @retcat, {
 				id   => $curboard,
 				name => $boardname,
-				n    => \@retboard
+				n    => \@retboard,
 			}
 		}
 
@@ -670,13 +690,13 @@ sub new_messages {
 		push @retall, {
 			id   => $curcat,
 			name => $catname,
-			n    => \@retcat
+			n    => \@retcat,
 		}
 	}
 
 	nm_template {
 		err     => \@err,
-		content => \@retall
+		content => \@retall,
 	};
 
 	exit;
@@ -685,7 +705,7 @@ sub new_messages {
 sub nm_mark_read {
 	
 	if ( $iamguest ) {
-		fatal_error $recent_txt{'err_noguest'}
+		fatal_error ( $recent_txt{'err_noguest'} );
 	}
 
 	my $mark_with = $INFO{'date'};
@@ -695,7 +715,7 @@ sub nm_mark_read {
 	     $mark_with > $date or
  	     $mark_with < $date - $max_log_days_old * 60 * 60 * 24 ) {
 
-		$mark_with = $date
+		$mark_with = $date;
 	}
 
 	getlog;
@@ -706,32 +726,33 @@ sub nm_mark_read {
 		next if $FORM{$key} eq '';
 		next if not -e "$datadir/$1.txt";
 
-		modlog $1, $mark_with
+		modlog $1, $mark_with;
 	}
 
 	dumplog;
 
 	$yySetLocation = "$scripturl?action=newmesg";
-	redirectexit
+	redirectexit;
 }
 
 sub RecentPosts {
 	&spam_protection;
 	my $display = $INFO{'display'} ||= 10;
-	my (@memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
+	my (@data, %boardname, %catid, @memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
 
 	$numfound = 0;
 
 	unless ($mloaded == 1) { require "$boardsdir/forum.master"; }
-	foreach $catid (@categoryorder) {
-		$boardlist = $cat{$catid};
+	foreach my $catid (@categoryorder) {
+		my $boardlist = $cat{$catid};
 
-		(@bdlist) = split(/\,/, $boardlist);
-		($catname, $catperms) = split(/\|/, $catinfo{"$catid"});
-		$cataccess = &CatAccess($catperms);
+		my (@bdlist) = split(/\,/, $boardlist);
+		my ($catname, $catperms) = split(/\|/, $catinfo{"$catid"});
+		my $cataccess = &CatAccess($catperms);
 		if (!$cataccess) { next; }
 
-		foreach $curboard (@bdlist) {
+		foreach my $curboard (@bdlist) {
+			my ($boardperms, $boardview);
 			($boardname{$curboard}, $boardperms, $boardview) = split(/\|/, $board{"$curboard"});
 
 			my $access = &AccessCheck($curboard, '', $boardperms);
@@ -740,7 +761,8 @@ sub RecentPosts {
 			$catname{$curboard} = $catname;
 			$catid{$curboard} = $catid;
 
-			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
+			fopen(*REC_BDTXT, "$boardsdir/$curboard.txt");
+			my $buffer;
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
 				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
 				unless ($tstate =~ /[hm]/) {
@@ -749,25 +771,25 @@ sub RecentPosts {
 					$numfound++;
 				}
 			}
-			fclose(REC_BDTXT);
+			fclose(*REC_BDTXT);
 		}
 	}
 
 	@data = reverse sort @data;
 
-	$numfound    = 0;
-	$threadfound = @data > $display ? $display : @data;
+	$numfound       = 0;
+	my $threadfound = @data > $display ? $display : @data;
 
 	for ($i = 0; $i < $threadfound; $i++) {
 		($mtime, $curboard, $tnum, $treplies, $tusername, $tname, $tstate) = split(/\|/, $data[$i]);
 		unless ($tstate =~ /h/) {
-			$tstart = $mtime;
-			fopen(REC_THRETXT, "$datadir/$tnum.txt") || next;
-			@mess = <REC_THRETXT>;
-			fclose(REC_THRETXT);
+			my $tstart = $mtime;
+			fopen(*REC_THRETXT, "$datadir/$tnum.txt") || next;
+			my @mess = <REC_THRETXT>;
+			fclose(*REC_THRETXT);
 
-			$threadfrom = @mess > $display ? @mess - $display : 0;
-			for ($ii = $threadfrom; $ii < @mess + 1; $ii++) {
+			my $threadfrom = @mess > $display ? @mess - $display : 0;
+			for (my $ii = $threadfrom; $ii < @mess + 1; $ii++) {
 				next if not $mess[$ii];
 
 				chomp $mess[$ii];
@@ -793,7 +815,7 @@ sub RecentPosts {
 	for ($i = 0; $i < $numfound; $i++) {
 		my ( undef, $board, $tnum, $c, $tusername, $tname, $msub, $mname, $memail, $mdate, $musername, $micon, $mip, $text, $mns, $mfn, $tstate, $trstart )
 					= split /\|/, $messages[$i];
-		$displayname = $mname;
+		my $registrationdate;
 
 		if ($tusername ne 'Guest' && -e ("$memberdir/$tusername.vars")) { &LoadUser($tusername); }
 		if (${$uid.$tusername}{'regtime'}) {
@@ -823,11 +845,11 @@ sub RecentPosts {
 			$mname .= $recent_txt{guest};
 		}
 
-		$message = &Censor($text); # damned global...
+		our $message = &Censor($text); # damned global...
 		$msub    = &Censor($msub);
 		&wrap;
 		if ($enable_ubbc) {
-			$ns = $mns;
+			our $ns = $mns;
 			if (!$yyYaBBCloaded) { require "$sourcedir/YaBBC.pl"; }
 			&DoUBBC;
 		}
@@ -846,7 +868,7 @@ sub RecentPosts {
 ~;
 		}
 
-		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum/$startnum">$img{'notify'}</a>~; }
+		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a>~; } #"# XXX: /0?
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
@@ -861,12 +883,12 @@ sub RecentPosts {
 	</tr><tr>
 		<td colspan="2" class="catbg" align="right">~;
 		if ($tstate != 1) {
-			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum/$c#$c;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
+			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
 		}
 		$yymain .= qq~</td>
 	</tr>
 </table><br />
-~;
+~; #/
 		++$counter;
 	}
 
@@ -881,22 +903,23 @@ sub RecentTopicsList {
 	# Can pass items to this sub, to decide what to show:
 	my ($show_count, $show_board, $show_poster, $show_date) = @_;
 
-	$display = $INFO{'display'} ||= 10;
+	my $display = $INFO{'display'} ||= 10;
 	if    ($display < 0)   { $display = 5; }
 	elsif ($display > 100) { $display = 100; }
 
-	my (@memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
+	my (@data, %boardname, @memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
 	$numfound = 0;
 
-	foreach $catid (@categoryorder) {
-		$boardlist = $cat{$catid};
+	foreach my $catid (@categoryorder) {
+		my $boardlist = $cat{$catid};
 
-		(@bdlist) = split(/\,/, $boardlist);
-		($catname, $catperms) = split(/\|/, $catinfo{"$catid"});
-		$cataccess = &CatAccess($catperms);
+		my (@bdlist) = split(/\,/, $boardlist);
+		my ($catname, $catperms) = split(/\|/, $catinfo{"$catid"});
+		my $cataccess = &CatAccess($catperms);
 		if (!$cataccess) { next; }
 
-		foreach $curboard (@bdlist) {
+		foreach my $curboard (@bdlist) {
+			my ($boardperms, $boardview);
 			($boardname{$curboard}, $boardperms, $boardview) = split(/\|/, $board{"$curboard"});
 
 			my $access = &AccessCheck($curboard, '', $boardperms);
@@ -904,7 +927,8 @@ sub RecentTopicsList {
 
 			$catname{$curboard} = $catname;
 
-			fopen(REC_BDTXT, "$boardsdir/$curboard.txt");
+			fopen(*REC_BDTXT, "$boardsdir/$curboard.txt");
+			my $buffer;
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
 				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
 				unless ($tstate =~ /[hm]/) {
@@ -913,7 +937,7 @@ sub RecentTopicsList {
 					$numfound++;
 				}
 			}
-			fclose(REC_BDTXT);
+			fclose(*REC_BDTXT);
 		}
 	}
 
@@ -921,17 +945,18 @@ sub RecentTopicsList {
 	$numfound = 0;
 
 	for ($i = 0; $i < @data; $i++) {
+		our $message;
 		($mtime, $curboard, $tnum, $treplies) = split(/\|/, $data[$i]);
 
-		fopen(REC_THRETXT, "$datadir/$tnum.txt") || next;
+		fopen(*REC_THRETXT, "$datadir/$tnum.txt") || next;
 		while (<REC_THRETXT>) { $message = $_; }
 
 		# get only the last post for this thread.
-		fclose(REC_THRETXT);
+		fclose(*REC_THRETXT);
 		chomp $message;
 
 		if ($message) {
-			($msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns) = split(/\|/, $message);
+			my ($msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns) = split(/\|/, $message);
 			$messages[$numfound] = "$curboard|$tnum|$treplies|$msub|$mname|$mdate|$musername";
 			$numfound++;
 		}
@@ -949,7 +974,7 @@ sub RecentTopicsList {
         <table width="100%" cellpadding="0" align="center" class="windowbg2">
 ~;
 	for ($i = 0; $i < $numfound; $i++) {
-		($board, $tnum, $c, $msub, $mname, $mdate, $musername) = split(/\|/, $messages[$i]);
+		my ($board, $tnum, $c, $msub, $mname, $mdate, $musername) = split(/\|/, $messages[$i]);
 		$msub = &Censor($msub);
 		&ToChars($msub);
 		if ($musername ne 'Guest' && -e "$memberdir/$musername.vars") {
@@ -1027,4 +1052,4 @@ sub RecentTopicsList {
 
 1;
 
-# vim: set tabstop=4: # The End
+# vim: se ts=4: #

Various fixes for previous patch:
diff --git a/lib/yabb-2.1/Sources/Recent.pl b/lib/yabb-2.1/Sources/Recent.pl
index 7433eca..84f825f 100644
--- a/lib/yabb-2.1/Sources/Recent.pl
+++ b/lib/yabb-2.1/Sources/Recent.pl
@@ -133,9 +133,13 @@ sub nm_poll_struct {
 	my $line = <POLL>;
 	chomp $line;
 
+	# hmm, there can be 9, 11, 12, 13 fields. What is 13th?
 	my ( $sub, $locked, $puid, $nick, $mail, $pdate,
 	     $guest_vote, $hide_results, $multi_vote,
-		 undef, undef, $comment ) = split /\|/, $line;
+		 undef, undef, $comment, undef ) = split /\|/, $line;
+	if (not defined $comment) {
+		$comment = '';
+	}
 
  	my @retopts;
 
@@ -482,6 +486,9 @@ sub new_messages {
 
 				my ( $tid, $tsub, $tnick, $tmail, $lpdate, $replies,
 				     $tuid, $ticon, $state ) = split /\|/, $_;
+				if ( not defined $state ) {
+					$state = '';
+				}
 
 				my $oldest_date = $oldest_date;
 
@@ -539,6 +546,12 @@ sub new_messages {
 					my ( $sub, $nick, undef, $pdate, $puid, $icon, undef,
 					     undef, $text, $nosmil, undef, undef, $attfile )
 									= split /\|/, $_;
+					if (not defined $nosmil) {
+						$nosmil = '';
+					}
+					if (not defined $attfile) {
+						$attfile = '';
+					}
 
 					my %retpost = (
 						num   => $postnum,
@@ -764,7 +777,14 @@ sub RecentPosts {
 			fopen(*REC_BDTXT, "$boardsdir/$curboard.txt");
 			my $buffer;
 			for ($i = 0; $i < $display && ($buffer = <REC_BDTXT>); $i++) {
-				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split(/\|/, $buffer);
+				
+				chomp $buffer;
+				# There are still many records with 8 fields in it.
+				($tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate) = split ( /\|/, $buffer );
+				if (not defined $tstate) {
+						$tstate = '';
+				}
+
 				unless ($tstate =~ /[hm]/) {
 					$mtime = $tdate;
 					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
@@ -793,9 +813,14 @@ sub RecentPosts {
 				next if not $mess[$ii];
 
 				chomp $mess[$ii];
-
-				my ( $msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $mlm, $mlmb, $mfn )
-						= split /\|/, $mess[$ii];
+				# There situation is more complicated. There are 9, 10, 12 and 13-field records.
+				my ( $msub, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $message, $mns, $mlm, $mlmb, $mfn ) = split ( /\|/, $mess[$ii] );
+				if (not defined $mns) {
+						$mns = '';
+				}
+				if (not defined $mfn) {
+						$mfn = '';
+				}
 				
 				$messages[$numfound] = "$mdate|$curboard|$tnum|$ii|$tusername|$tname|$msub|$mname|$memail|$mdate|$musername|$micon|$mip|$message|$mns|$mfn|$tstate|$tstart";
 				$numfound++;
@@ -858,7 +883,6 @@ sub RecentPosts {
 		&ToChars($message);
 		&ToChars($boardname{$board});
 		&ToChars($catname{$board});
-#		$msub =~ s/\A\[m\]/$maintxt{'758'}/;
 
 		my $attach='';
 		if ( $mfn and -e "$uploaddir/$mfn" ) {
diff --git a/lib/yabb-2.1/Sources/Recent.pl b/lib/yabb-2.1/Sources/Recent.pl
index 84f825f..9e52f66 100644
--- a/lib/yabb-2.1/Sources/Recent.pl
+++ b/lib/yabb-2.1/Sources/Recent.pl
@@ -889,10 +889,10 @@ sub RecentPosts {
 			$attach = qq~
 			<hr class="hr" style="width: 100%" />
 			<span class="small" style="float: left; width: 49%" ><a href="$uploadurl/$mfn" target="_blank"><img src="$imagesdir/paperclip.gif" border="0" align="middle" alt="" /> $mfn</a></span>
-~;
+~; #"
 		}
 
-		if ($enable_notification) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a>~; } #"# XXX: /0?
+		if ($enable_notification and not $iamguest) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a>~; } #"# XXX: /0?
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
@@ -906,7 +906,7 @@ sub RecentPosts {
 		<td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span>$attach</td>
 	</tr><tr>
 		<td colspan="2" class="catbg" align="right">~;
-		if ($tstate != 1) {
+		if ($tstate !~ /l/) {
 			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
 		}
 		$yymain .= qq~</td>
diff --git a/lib/yabb-2.1/Sources/Recent.pl b/lib/yabb-2.1/Sources/Recent.pl
index 9e52f66..e2f577c 100644
--- a/lib/yabb-2.1/Sources/Recent.pl
+++ b/lib/yabb-2.1/Sources/Recent.pl
@@ -892,7 +892,10 @@ sub RecentPosts {
 ~; #"
 		}
 
-		if ($enable_notification and not $iamguest) { $notify = qq~$menusep<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a>~; } #"# XXX: /0?
+		if ( $enable_notification and not $iamguest ) {
+			$notify = 1;
+		}
+
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
@@ -907,7 +910,18 @@ sub RecentPosts {
 	</tr><tr>
 		<td colspan="2" class="catbg" align="right">~;
 		if ($tstate !~ /l/) {
-			$yymain .= qq~<a href="$scripturl?board=$board;action=post;num=$tnum;title=PostReply">$img{'reply'}</a>$menusep<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$notify &nbsp;~;
+			if ( $notify ) {
+				$yymain .= qq~
+				<a href="$scripturl?board=$board;action=post;num=$tnum;title=PostReply">$img{'reply'}</a>$menusep
+				<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a>$menusep
+				<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a> &nbsp;~;
+			} else {
+				$yymain .= qq~
+				<a href="$scripturl?board=$board;action=post;num=$tnum;title=PostReply">$img{'reply'}</a>$menusep
+				<a href="$scripturl?board=$board;action=post;num=$tnum;quote=$c;title=PostReply">$img{'recentquote'}</a> &nbsp;~;
+			}
+		} elsif ( $notify ) {
+				$yymain .= qq~<a href="$scripturl?board=$board;action=notify;thread=$tnum">$img{'notify'}</a> &nbsp;~;
 		}
 		$yymain .= qq~</td>
 	</tr>


Tue, 10 Mar 2009 23:55:18 +0200
Safety lock returns to invocation page, slight cap_t_cha improvements.
diff --git a/lib/yabb-2.1/Sources/BanWithGroup.pl b/lib/yabb-2.1/Sources/BanWithGroup.pl
index 128e3e3..e38d02f 100644
--- a/lib/yabb-2.1/Sources/BanWithGroup.pl
+++ b/lib/yabb-2.1/Sources/BanWithGroup.pl
@@ -96,7 +96,8 @@ sub safety_lock {
 		UserAccount ( $username, 'update' );
 	}
 	
-	$yySetLocation = "$scripturl?action=viewprofile;username=$username";
+#	$yySetLocation = "$scripturl?action=viewprofile;username=$username";
+	$yySetLocation = $ENV{'HTTP_REFERER'};
 	redirectexit ();
 }
 
@@ -120,7 +121,8 @@ sub safety_unlock {
 		UserAccount ( $username, 'update' );
 	}
 	
-	our $yySetLocation = "$scripturl?action=viewprofile;username=$username";
+#	$yySetLocation = "$scripturl?action=viewprofile;username=$username";
+	$yySetLocation = $ENV{'HTTP_REFERER'};
 	redirectexit;
 }
 
diff --git a/lib/yabb-2.1/Sources/Decoder.pl b/lib/yabb-2.1/Sources/Decoder.pl
index 453d33b..abef183 100644
--- a/lib/yabb-2.1/Sources/Decoder.pl
+++ b/lib/yabb-2.1/Sources/Decoder.pl
@@ -27,28 +27,40 @@ if ($action eq 'detailedversion') { return 1; }
 our (%INFO, %FORM);
 our $vardir;
 our ($user_ip, $username, $date);
-our $yycharset;
-our $capcha_dict_file ||= "$vardir/wordlist.txt";
+our (%floodtxt);
+our ($yycharset, $scripturl);
+our ($codemaxchars);
+our $captcha_dict_file ||= "$vardir/wordlist.txt";
 
-# CAPCHA SWITCHER
+LoadLanguage ('flood');
 
-sub newcapcha     { return &newcapcha_dict (@_);    }
-sub checkcapcha   { return &checkcapcha_dict (@_);  }
-sub getcapchatext { return &getcapchatext_log (@_); }
+# CAPTCHA SWITCHER
 
-# CAPCHA LOG
+## Generates new capcha and returns fields to insert into a form.
+## R: string (field description), string (field content), ...
+sub newcaptcha     { return &newcaptcha_dict (@_);    }
 
-## Writes capcha ansver for current user into log.
+## Checks if captcha ansver supplied by user is valid.
+## R: boolean
+sub checkcaptcha   { return &checkcaptcha_dict (@_);  }
+
+## Gets captcha text in a form of array of characters for graphical representation.
+## R: array or undef
+sub getcaptchatext { return &getcaptchatext_log (@_); }
+
+# CAPTCHA LOG
+
+## Writes captcha ansver for current user into log.
 ## Returns string, that was written to log (there can be changes in that string).
-## Pass undef to remove capcha entry for current user/ip.
+## Pass undef to remove captcha entry for current user/ip.
 ## A: string
 ## R: string
-sub write_capcha_log_entry {
+sub write_captcha_log_entry {
 	my $value = $_[0];
 	if (defined $value) {
 		$value =~ s/[\n|]+//go;
 	}
-	fopen (*LOG, "+<$vardir/capcha.log") or return undef;
+	fopen (*LOG, "+<$vardir/captcha.log") or return undef;
 	binmode LOG, ':encoding(UTF-8)';
 	my @log;
 	while (<LOG>) {
@@ -67,18 +79,18 @@ sub write_capcha_log_entry {
 	return $value;
 }
 
-## Finds in log associated with a given IP and username capcha ansver value and returns it.
+## Finds in log associated with a given IP and username captcha ansver value and returns it.
 ## R: string or undef
-sub read_capcha_log_entry {
-	fopen (*LOG, "<$vardir/capcha.log") or return undef;
+sub read_captcha_log_entry {
+	fopen (*LOG, "<$vardir/captcha.log") or return undef;
 	binmode LOG, ':encoding(UTF-8)';
 	my $value = undef;
 	my $vtimestamp = 0;
 	while (<LOG>) {
 		chomp;
-		my ($ip, $uname, $timestamp, $capchaansver) = split /\|/o;
+		my ($ip, $uname, $timestamp, $captchaansver) = split /\|/o;
 		if ($user_ip eq $ip and $username eq $uname and $timestamp + 15 * 60 > $date and $vtimestamp < $timestamp) {
-			$value      = $capchaansver;
+			$value      = $captchaansver;
 			$vtimestamp = $timestamp;
 		}
 	}
@@ -86,22 +98,20 @@ sub read_capcha_log_entry {
 	return $value;
 }
 
-## Gets capcha text for graphical representation and returns characters of it in list.
-## R: array or undef
-sub getcapchatext_log {
-	my $word = read_capcha_log_entry ();
+sub getcaptchatext_log {
+	my $word = read_captcha_log_entry ();
 	if (defined $word) {
 		return split (//o, $word);
 	}
 	return undef;
 }
 
-## Checks given capcha ansver against capcha log entry.
-## A: string
+## As log does not provides form fields, this routine gets ansver from argument.
+## A: string (ansver)
 ## R: boolean
-sub checkcapcha_log {
+sub checkcaptcha_log {
 	my $ansver = $_[0];
-	my $word   = read_capcha_log_entry ();
+	my $word   = read_captcha_log_entry ();
 
 	if (not defined $word) {
 		return undef;
@@ -112,44 +122,95 @@ sub checkcapcha_log {
 	return $ansver eq $word;
 }
 
-# DICT CAPCHA
+# DICT CAPTCHA
 
-## Reads random word from dictionary, writes to capcha log and returns written word.
-## R: string or undef
-sub newcapcha_dict {
-	my $maxwordlen = 15;
+sub newcaptcha_dict {
+	my $maxwordlen = 14;
 	my $minwordlen = 4;
 	# No need for flock here.
-	open DICT, '<', $capcha_dict_file or return undef;
+	open DICT, '<', $captcha_dict_file or return undef;
 	my $size = (stat DICT)[7];
 	my $value;
 	do {
+		# XXX: ukrainian utf8 is suitable for that thing, but...
 		my $pos = (int (rand ($size/2 - $maxwordlen)) - $maxwordlen)*2;
 		seek DICT, $pos, 0;
 		<DICT>;
 		$value = <DICT>;
 		chomp $value;
-	} while (length ($value) < $minwordlen);
+	} while (length ($value) / 2 < $minwordlen or length ($value) / 2 >= $maxwordlen);
 	close DICT;
 	$value = decode ('UTF-8', $value);
-	return write_capcha_log_entry ($value);
+	write_captcha_log_entry ($value);
+	# XXX: how about tabindex?
+  	return "$floodtxt{'1'}:", qq(<img src="$scripturl?action=validate" border="0" />),
+	       "$floodtxt{'3'}:", qq(<input type="text" maxlength="$maxwordlen" name="verification" id="verification" size="$maxwordlen" />);
 }
 
-sub checkcapcha_dict {
-	if (not checkcapcha_log ($_[0])) {
-		newcapcha_dict ();
+sub checkcaptcha_dict {
+	if (not checkcaptcha_log ($FORM{'verification'})) {
+		newcaptcha_dict ();
 		return 0;
 	}
-	write_capcha_log_entry (undef);
+	write_captcha_log_entry (undef);
 	return 1;
 }
 
-# URI CAPCHA
+# URI CAPTCHA
+
+## Generates session id and regdate.
+## R: string (session id), string (regdate)
+sub validation_code {
+	srand();
+	# set the max length of the shown verification code
+	if (!$codemaxchars || $codemaxchars < 3) { $codemaxchars = 3; }
+	my $regdate   = int(time);
+	my $randtime1 = substr($regdate, (length $regdate) - 5, 2);
+	my $randtime2 = substr($regdate, (length $regdate) - 4, 2);
+	my $randtime3 = substr($regdate, (length $regdate) - 6, 2);
+	my $checknum  = int(rand(100));
+	my $chunk;
+	$checknum =~ tr/0123456789/ymifxupbck/;
+	$chunk = int(rand(78));
+	$chunk =~ tr/0123456789/q8dv7w4jm3/;
+	$checknum .= $chunk;
+	$chunk = int(rand(99));
+	$chunk =~ tr/0123456789/7v4sq3dam3/;
+	$checknum .= $chunk;
+	$chunk = int(rand($randtime1));
+	$chunk =~ tr/0123456789/poiuyt5ewq/;
+	$checknum .= $chunk;
+	$chunk = int(rand($randtime2));
+	$chunk =~ tr/0123456789/2qrt7go0ws/;
+	$checknum .= $chunk;
+	$chunk = int(rand($randtime2));
+	$chunk =~ tr/0123456789/lk9hgfdaut/;
+	$checknum .= $chunk;
+	$checknum = substr($checknum, 0, $codemaxchars);
+	# making a mess of the validation code
+
+	my $scramble = &encode_password($regdate);
+	for (my $n = 0; $n < 9; $n++) {
+		$scramble .= &encode_password($scramble);
+	}
+	$scramble =~ s/\//y/g;
+	$scramble =~ s/\+/x/g;
+	$scramble =~ s/\-/Z/g;
+	$scramble =~ s/\:/Q/g;
+
+	$regdate = substr($regdate x 2, 0, length $checknum);
+	my $value = 13;
+	for (my $n = 0; $n < length $checknum; $n++) {
+		$value = (substr($regdate, $n, 1)) + $value + 1;
+		substr($scramble, $value, 1) = substr($checknum, $n, 1);
+	}
+	return $scramble, $regdate;
+}
 
-## Gets capcha text from given two string (usually extracted from form or uri params).
+## Gets captcha text from given two string (usually extracted from form or uri params).
 ## A: string (regdate), string (session id)
 ## R: string or undef
-sub extractcapchatext_uri {
+sub extractcaptchatext_uri {
 	my $value       = 13;
 	my $testdate    = $_[0];
 	my $testsession = $_[1];
@@ -170,10 +231,16 @@ sub extractcapchatext_uri {
 	return $text;
 }
 
-## Gets capcha text for graphical representation from user-specified url params regdate and _session_id_.
-## R: string or undef
-sub getcapchatext_uri {
-	my $text = extractcapchatext_uri ( $INFO{'regdate'}, $INFO{'_session_id_'} );
+sub newcaptcha_uri {
+	my ($sessionid, $regdate) = validation_code ();
+  	return "$floodtxt{'1'}:", qq(<img src="$scripturl?action=validate\;_session_id_=$sessionid\;regdate=$regdate" border="0" />),
+	       "$floodtxt{'3'}:", qq(<input type="text" maxlength="30" name="verification" id="verification" size="30" />).
+	                          qq(<input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" />).
+	                          qq(<input type="hidden" name="regdate" id="regdate" value="$regdate" /></td>);
+}
+
+sub getcaptchatext_uri {
+	my $text = extractcaptchatext_uri ( $INFO{'regdate'}, $INFO{'_session_id_'} );
 	
 	if (not defined $text) {
 		return undef;
@@ -182,12 +249,9 @@ sub getcapchatext_uri {
 	return split (//o, $text);
 }
 
-## Checks capcha ansver, obtained from form, using uri params for image generation.
-## A: string
-## R: boolean or undef
-sub checkcapcha_uri {
-	my $ansver = $_[0];
-	my $text   = extractcapchatext_uri ( $FORM{'regdate'}, $FORM{'_session_id_'} );
+sub checkcaptcha_uri {
+	my $ansver = $FORM{'verification'};
+	my $text   = extractcaptchatext_uri ( $FORM{'regdate'}, $FORM{'_session_id_'} );
 
 	if (not defined $text) {
 		return undef;
@@ -196,13 +260,13 @@ sub checkcapcha_uri {
 	return $text eq $ansver;
 }
 
-# CAPCHA IMAGE GENERATOR
+# CAPTCHA IMAGE GENERATOR
 
-## Generates image with capcha.
-## Calls one of getcapchatext_* routines to get text value.
+## Generates image with captcha.
+## Calls one of getcaptchatext_* routines to get text value.
 ## Otherwise, image will contain "internal error" string.
 sub convert {
-	my @verificationtest = getcapchatext ();
+	my @verificationtest = getcaptchatext ();
 	if (not defined $verificationtest[0]) {
 		@verificationtest = ( qw(I N T E R N A L . E R R O R) );
 	}
@@ -218,7 +282,7 @@ sub convert {
 		$im->colorAllocate (rand(128), rand(64)+128, rand(128)+64)
 	);
 	$im->transparent ($bg);
-	my $i = $letcnt + 5;
+	my $i = int($letcnt * 4 / 5) + 5;
 	$im->line (rand($imgx), rand($imgy), rand($imgx), rand($imgy), $foreground[rand(@foreground)])
 			while ($i--);
 	my $x = 12;
diff --git a/lib/yabb-2.1/Sources/LogInOut.pl b/lib/yabb-2.1/Sources/LogInOut.pl
index e7d4afd..37a5dab 100644
--- a/lib/yabb-2.1/Sources/LogInOut.pl
+++ b/lib/yabb-2.1/Sources/LogInOut.pl
@@ -216,44 +216,36 @@ $border_bottom
 }
 
 sub Reminder {
-	if ($regcheck) {
-		&validation_code;
-		require "$sourcedir/Decoder.pl";
-		&newcapcha;
-	}
 	$yymain .= qq~<br /><br />
 <form action="$scripturl?action=reminder2" method="post">
 <table border="0" width="400" cellspacing="1" cellpadding="3" align="center" class="bordercolor">
 	<tr>
-	<td class="titlebg">
+	<td class="titlebg" colspan="2">
 	<span class="text1"><b>$mbname $loginout_txt{'36'} $loginout_txt{'194'}</b></span>
 	</td>
-	</tr><tr>
-	<td class="windowbg">
-	<span class="text1"><b> $loginout_txt{'35'} $maintxt{'377'} $loginout_txt{'33'}: </b></span>
-	<input type="text" name="user"$regstyle /><input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" /><input type="hidden" name="regdate" id="regdate" value="$regdate" />
-	</td>
+	</tr><tr class="windowbg">
+		<td><span class="text1"><b> $loginout_txt{'35'} $maintxt{'377'} $loginout_txt{'33'}: </b></span></td>
+		<td><input type="text" name="user"$regstyle /></td>
 	</tr>
 ~;
 
 	if ($regcheck) {
-		$yymain .= qq~
-	<tr>
-	<td class="windowbg">
-	<span class="text1"><b>$floodtxt{'1'}: </b></span>
-	$showcheck
-	</td>
-	</tr><tr>
-	<td class="windowbg">
-	<span class="text1"><b>$floodtxt{'3'}: </b></span>
-	<span class="text1"><input type="text" maxlength="30" name="verification" id="verification" size="20" /></span>
-	</td>
-	</tr>
-~;
+		require "$sourcedir/Decoder.pl";
+		my @fields = newcaptcha ();
+		while (@fields) {
+			my $desc = shift @fields;
+			my $cont = shift @fields;
+			$yymain .= qq(
+		<tr class="windowbg">
+			<td><b>$desc</b></td>
+			<td>$cont</td>
+		</tr>);
+		}
 	}
+
 	$yymain .= qq~
 	<tr>
-	<td align="center" class="windowbg">
+	<td align="center" class="windowbg" colspan="2">
 	<input type="submit" value="$loginout_txt{'339'}" />
 	</td>
 	</tr>
@@ -296,7 +288,7 @@ sub Reminder2 {
 
 	if ($regcheck) {
 		require "$sourcedir/Decoder.pl";
-		if (not checkcapcha ($FORM{'verification'})) {
+		if (not checkcaptcha ()) {
 			&fatal_error ("$floodtxt{'4'}");
 		}
 	}
diff --git a/lib/yabb-2.1/Sources/Post.pl b/lib/yabb-2.1/Sources/Post.pl
index 06e7897..5fffd38 100644
--- a/lib/yabb-2.1/Sources/Post.pl
+++ b/lib/yabb-2.1/Sources/Post.pl
@@ -580,23 +580,19 @@ function showimage() {
 
 	}
 
-	# Capcha for guests on posting
+	# Captcha for guests on posting
 	if ($iamguest && $enable_guestposting && $regcheck) {
-		&LoadLanguage ('flood');
-		&validation_code;
 		require "$sourcedir/Decoder.pl";
-		&newcapcha;
-		$yymain .= qq~
-  <tr class="windowbg">
-    <td><b>$floodtxt{'1'}:</b></td>
-    <td>$showcheck</td>
-  </tr><tr class="windowbg">
-    <td><b>$floodtxt{'3'}:</b></td>
-    <td><input type="text" maxlength="30" name="verification" id="verification" size="30" tabindex="5" />
-    <input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" />
-    <input type="hidden" name="regdate" id="regdate" value="$regdate" /></td>
-  </tr>
-~;
+		my @fields = newcaptcha ();
+		while (@fields) {
+			my $desc = shift @fields;
+			my $cont = shift @fields;
+			$yymain .= qq(
+		<tr class="windowbg">
+			<td><b>$desc</b></td>
+			<td>$cont</td>
+		</tr>);
+		}
 	}
 
 	if ($enable_ubbc && $showyabbcbutt) {
@@ -1461,10 +1457,10 @@ sub Post2 {
 		$email = ${$uid.$username}{'email'};
 	} else {
 		&LoadLanguage ('Register');
-		# Check capcha.
+		# Check captcha.
 		if ($regcheck) {
 			require "$sourcedir/Decoder.pl";
-			if (not checkcapcha ($FORM{'verification'})) {
+			if (not checkcaptcha ()) {
 				&fatal_error ("$floodtxt{'4'}");
 			}
 		}
diff --git a/lib/yabb-2.1/Sources/Register.pl b/lib/yabb-2.1/Sources/Register.pl
index 6a2ca6e..dbc2735 100644
--- a/lib/yabb-2.1/Sources/Register.pl
+++ b/lib/yabb-2.1/Sources/Register.pl
@@ -53,11 +53,6 @@ sub Register {
 	}
 	close(DIR);
 
-	if ($regcheck) {
-		&validation_code;
-		require "$sourcedir/Decoder.pl";
-		&newcapcha;
-	}
 	if (!$iamguest) { &fatal_error("$register_txt{'2'}"); }
 
 	$yymain .= qq~
@@ -100,8 +95,6 @@ sub Register {
     <td>
 		<form action="$scripturl?action=register2" method="post" name="creator">
 		<input type="text" name="username" size="30" value="$tmpregname" maxlength="18"$regstyle />
-		<input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" />
-		<input type="hidden" name="regdate" id="regdate" value="$regdate" />
 		<input type="hidden" name="language" id="language" value="$language" />
 	</td>
   </tr><tr class="windowbg">
@@ -140,15 +133,17 @@ sub Register {
 	}
 
 	if ($regcheck) {
-		$yymain .= qq~
-  <tr class="windowbg">
-    <td><b>$floodtxt{'1'}:</b></td>
-    <td>$showcheck</td>
-  </tr><tr class="windowbg">
-    <td><b>$floodtxt{'3'}:</b></td>
-    <td><input type="text" maxlength="30" name="verification" id="verification" size="30" /></td>
-  </tr>
-~;
+		require "$sourcedir/Decoder.pl";
+		my @fields = newcaptcha ();
+		while (@fields) {
+			my $desc = shift @fields;
+			my $cont = shift @fields;
+			$yymain .= qq(
+		<tr class="windowbg">
+			<td><b>$desc</b></td>
+			<td>$cont</td>
+		</tr>);
+		}
 	}
 
 	if ($RegAgree) {
@@ -276,7 +271,7 @@ sub Register2 {
 
 	if ($regcheck) {
 		require "$sourcedir/Decoder.pl";
-		if (not checkcapcha ($member{'verification'})) {
+		if (not checkcaptcha ()) {
 			&fatal_error ("$floodtxt{'4'}");
 		}
 	}
@@ -387,7 +382,8 @@ sub Register2 {
 		# create pre-registration .pre file and write log and inactive list
 		$regpassword = $member{'passwrd1'};
 		$regtime     = int(time);
-		&validation_code;
+		require "$sourcedir/Decoder.pl";
+		my ($sessionid, $regdate) = validation_code ();
 		$activationcode = substr($sessionid, 0, 20);
 
 		&UserAccount($reguser, "preregister");
diff --git a/lib/yabb-2.1/Sources/SendTopic.pl b/lib/yabb-2.1/Sources/SendTopic.pl
index e4c2187..2681667 100644
--- a/lib/yabb-2.1/Sources/SendTopic.pl
+++ b/lib/yabb-2.1/Sources/SendTopic.pl
@@ -77,28 +77,24 @@ sub SendTopic {
 ~;
 
 	if ($regcheck) {
-		&validation_code;
-		$yymain .= qq~
-	<tr>
-        <td class="windowbg" align="center" valign="top" colspan="2">
-        <hr width="100%" size="1" class="hr" />
-        </td>
-      </tr><tr>
-        <td align="right" valign="middle"><b>$floodtxt{'1'}</b></td>
-        <td>$showcheck</td>
-      </tr><tr>
-        <td align="right" valign="middle"><b>$floodtxt{'3'}</b></td>
-        <td><input type="text" maxlength="30" name="verification" id="verification" size="20" /></td>
-      </tr>
-~;
+		require "$sourcedir/Decoder.pl";
+		my @fields = newcaptcha ();
+		while (@fields) {
+			my $desc = shift @fields;
+			my $cont = shift @fields;
+			$yymain .= qq(
+		<tr class="windowbg">
+			<td><b>$desc</b></td>
+			<td>$cont</td>
+		</tr>);
+		}
 	}
+
 	$yymain .= qq~
 	<tr>
         <td class="windowbg" align="center" valign="middle" colspan="2">
 		<input type="hidden" name="board" value="$board" />
 		<input type="hidden" name="topic" value="$topic" />
-		<input type="hidden" name="_session_id_" id="_session_id_" value="$sessionid" />
-		<input type="hidden" name="regdate" id="regdate" value="$regdate" />
         <input type="submit" name="Send" value="$sendtopic_txt{'339'}" />
         </td>
       </tr>
@@ -130,19 +126,12 @@ sub SendTopic2 {
 	$rname =~ s/\s+\Z//;
 
 	if ($regcheck) {
-		&fatal_error("$floodtxt{'4'}") if ($FORM{'verification'} eq '');
-		&fatal_error("$sendtopic_txt{'240'} $floodtxt{'3'} $sendtopic_txt{'241'}") if ($FORM{'verification'} !~ /\A[0-9a-z]+\Z/);
-
-		$lastvalue        = 13;
-		$verificationtest = "";
-		for ($n = 0; $n < length "$FORM{'regdate'}"; $n++) {
-			$value = (substr("$FORM{'regdate'}", $n, 1)) + $lastvalue + 1;
-			$letter = substr("$FORM{'_session_id_'}", $value, 1);
-			$lastvalue = $value;
-			$verificationtest .= qq~$letter~;
+		require "$sourcedir/Decoder.pl";
+		if (not checkcaptcha ()) {
+			&fatal_error ("$floodtxt{'4'}");
 		}
-		&fatal_error("$floodtxt{'4'}") if ($verificationtest ne $FORM{'verification'});
 	}
+
 	&fatal_error($sendtopic_txt{'75'}) unless ($yname ne '' && $yname ne '_' && $yname ne ' ');
 	&fatal_error($sendtopic_txt{'568'}) if (length($yname) > 25);
 	&fatal_error("$sendtopic_txt{'76'}") if ($yemail eq '');
diff --git a/lib/yabb-2.1/Sources/Subs.pl b/lib/yabb-2.1/Sources/Subs.pl
index a2c4816..d592655 100644
--- a/lib/yabb-2.1/Sources/Subs.pl
+++ b/lib/yabb-2.1/Sources/Subs.pl
@@ -1417,65 +1417,6 @@ sub YaBBsort {
 	}
 }
 
-sub validation_code {
-#	require "$sourcedir/Decoder.pl";
-	srand();
-	# set the max length of the shown verification code
-	if (!$codemaxchars || $codemaxchars < 3) { $codemaxchars = 3; }
-	$regdate   = int(time);
-	$randtime1 = substr($regdate, (length $regdate) - 5, 2);
-	$randtime2 = substr($regdate, (length $regdate) - 4, 2);
-	$randtime3 = substr($regdate, (length $regdate) - 6, 2);
-	$checknum  = int(rand(100));
-	$checknum =~ tr/0123456789/ymifxupbck/;
-	$_ = int(rand(78));
-	$_ =~ tr/0123456789/q8dv7w4jm3/;
-	$checknum .= $_;
-	$_ = int(rand(99));
-	$_ =~ tr/0123456789/7v4sq3dam3/;
-	$checknum .= $_;
-	$_ = int(rand($randtime1));
-	$_ =~ tr/0123456789/poiuyt5ewq/;
-	$checknum .= $_;
-	$_ = int(rand($randtime2));
-	$_ =~ tr/0123456789/2qrt7go0ws/;
-	$checknum .= $_;
-	$_ = int(rand($randtime2));
-	$_ =~ tr/0123456789/lk9hgfdaut/;
-	$checknum .= $_;
-	$checknum = substr($checknum, 0, $codemaxchars);
-	# making a mess of the validation code
-
-	$scramble = &encode_password($regdate);
-	for ($n = 0; $n < 9; $n++) {
-		$scramble .= &encode_password($scramble);
-	}
-	$scramble =~ s/\//y/g;
-	$scramble =~ s/\+/x/g;
-	$scramble =~ s/\-/Z/g;
-	$scramble =~ s/\:/Q/g;
-
-	$positioner = $regdate;
-	$positioner .= $regdate;
-	$regdate   = substr($positioner, 0, length $checknum);
-	@position  = ();
-	@character = ();
-	$sessionid = "";
-	$showcheck = "";
-	$lastvalue = 13;
-	for ($n = 0; $n < length $checknum; $n++) {
-		$letter = substr($checknum, $n, 1);
-		$value = (substr($regdate, $n, 1)) + $lastvalue + 1;
-		$lastvalue = $value;
-		substr($scramble, $value, 1) = $letter;
-	}
-	$sessionid = $scramble;
-	$showcheck = qq(<img src="$scripturl?action=validate\;_session_id_=$sessionid\;regdate=$regdate" border="0" alt="" />);
-	return $sessionid;
-	return $showcheck;
-	return $regdate;
-}
-
 sub referer_check {
 	$referencedomain = substr($boardurl, 7, (index($boardurl, "/", 7)) - 7);
 	$refererdomain = substr($ENV{HTTP_REFERER}, 7, (index($ENV{HTTP_REFERER}, "/", 7)) - 7);


Thu, 12 Mar 2009 20:50:38 +0200
diff --git a/lib/yabb-2.1/Sources/Recent.pl b/lib/yabb-2.1/Sources/Recent.pl
index 3bf3cd2..04f86a7 100644
--- a/lib/yabb-2.1/Sources/Recent.pl
+++ b/lib/yabb-2.1/Sources/Recent.pl
@@ -99,7 +99,7 @@ sub nm_menu_struct {
 sub nm_template_menu {
 	my $menu = shift;
 
-	if ( not @$menu ) {
+	if ( not ref $menu or not @$menu ) {
 		return '';
 	}
 
@@ -448,7 +448,7 @@ sub new_messages {
 
 			my $oldest_date = $oldest_date;
 
-			if ( $yyuserlog{"$curboard--mark"} > $oldest_date ) {
+			if ( exists $yyuserlog{"$curboard--mark"} and $yyuserlog{"$curboard--mark"} > $oldest_date ) {
 				$oldest_date = $yyuserlog{"$curboard--mark"}
 			}
 			
@@ -751,9 +751,7 @@ sub nm_mark_read {
 sub RecentPosts {
 	&spam_protection;
 	my $display = $INFO{'display'} ||= 10;
-	my (@data, %boardname, %catid, @memset, @categories, %data, $numfound, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board, $notify);
-
-	$numfound = 0;
+	my (@data, %boardname, %catid, @memset, @categories, %data, $curcat, %catname, %cataccess, %catboards, $openmemgr, @membergroups, %openmemgr, $curboard, @threads, @boardinfo, $i, $c, @messages, $tnum, $tsub, $tname, $temail, $tdate, $treplies, $tusername, $ticon, $tstate, $mname, $memail, $mdate, $musername, $micon, $mattach, $mip, $mns, $mtime, $counter, $board);
 
 	unless ($mloaded == 1) { require "$boardsdir/forum.master"; }
 	foreach my $catid (@categoryorder) {
@@ -787,8 +785,7 @@ sub RecentPosts {
 
 				unless ($tstate =~ /[hm]/) {
 					$mtime = $tdate;
-					$data[$numfound] = "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
-					$numfound++;
+					push @data, "$mtime|$curboard|$tnum|$treplies|$tusername|$tname|$tstate";
 				}
 			}
 			fclose(*REC_BDTXT);
@@ -797,7 +794,7 @@ sub RecentPosts {
 
 	@data = reverse sort @data;
 
-	$numfound       = 0;
+	my $numfound    = 0;
 	my $threadfound = @data > $display ? $display : @data;
 
 	for ($i = 0; $i < $threadfound; $i++) {
@@ -841,6 +838,7 @@ sub RecentPosts {
 		my ( undef, $board, $tnum, $c, $tusername, $tname, $msub, $mname, $memail, $mdate, $musername, $micon, $mip, $text, $mns, $mfn, $tstate, $trstart )
 					= split /\|/, $messages[$i];
 		my $registrationdate;
+		our $displayname = $mname; # for DoUBBC
 
 		if ($tusername ne 'Guest' && -e ("$memberdir/$tusername.vars")) { &LoadUser($tusername); }
 		if (${$uid.$tusername}{'regtime'}) {
@@ -892,10 +890,6 @@ sub RecentPosts {
 ~; #"
 		}
 
-		if ( $enable_notification and not $iamguest ) {
-			$notify = 1;
-		}
-
 		$mdate = &timeformat($mdate);
 		$yymain .= qq~
 <table border="0" width="100%" cellspacing="1" class="bordercolor" style="table-layout: fixed;">
@@ -909,6 +903,10 @@ sub RecentPosts {
 		<td colspan="2" class="windowbg2" valign="top"><span class="message">$message</span>$attach</td>
 	</tr><tr>
 		<td colspan="2" class="catbg" align="right">~;
+		my $notify = 0;
+		if ($enable_notification and not $iamguest) {
+				$notify = 1;
+		}
 		if ($tstate !~ /l/) {
 			if ( $notify ) {
 				$yymain .= qq~


Some improvements to novyny
diff --git a/lib/yabb-2.1/Sources/Novyny.pl b/lib/yabb-2.1/Sources/Novyny.pl
index 93cf1fe..131a7e0 100644
--- a/lib/yabb-2.1/Sources/Novyny.pl
+++ b/lib/yabb-2.1/Sources/Novyny.pl
@@ -1,6 +1,24 @@
-# Myhailo Danylenko, Lys 2007, (c). This code underly the terms of GNU GPL v2 or later.
+
+#
+# (c) 2007-2009 Myhailo Danylenko <isbear@ukrpost.net>
+#
+# Main page generator
+#
+
 # TODO:
-# * fix start urlparam, add pages navbar
+# * fix start urlparam
+# * add footer navbar
+
+use strict;
+use warnings;
+
+our %INFO;
+our (%img);
+our (%board, %cat, @categoryorder);
+our ($forumstylesdir, $forumstylesurl);
+our ($scripturl, $iamguest, $user_ip, $username);
+# template stuff
+our ($novynynewsitem, $novynyboardtopic, $novynyboard, $novynyimage, $novynypolloption, $novynypoll, $novyny_template);
 
 sub Novyny {
 
@@ -66,9 +84,9 @@ sub Novyny {
 
 	my $nynews = '';
 
-	fopen (NOVYNY, "<$boardsdir/$newsboard.txt");
+	fopen (*NOVYNY, "<$boardsdir/$newsboard.txt");
 	my @novyny = reverse sort grep /\|[^m\|]*?$/, <NOVYNY>;
-	fclose (NOVYNY);
+	fclose (*NOVYNY);
 
 	$start = $display < $#novyny ? $#novyny - $display : 0
 		if ($start > $#novyny);
@@ -88,9 +106,10 @@ sub Novyny {
 
 		$message = $novyny_txt{'threaderr'};
 		if (-e "$datadir/$tid.txt") {
-			fopen (MSG, "<$datadir/$tid.txt");
+			fopen (*MSG, "<$datadir/$tid.txt");
 			$message = (split /\|/, <MSG>, 10)[8];
-			fclose (MSG);
+			fclose (*MSG);
+			$message =~ s/\s*\[hr\].*?$//; # cut hr'ed comments
 			$message = &Censor ($message);
 			our $linewrap=76;
 			&wrap;
@@ -106,7 +125,7 @@ sub Novyny {
 
 		my $item = $novynynewsitem;
 		$item =~ s~<novyny news topic>~<a href="$scripturl?num=$tid">$topic</a>~sig;
-		$item =~ s~<novyny news icon>~<img src="$imagesdir/$icon.gif" alt="*" />~sig;
+		$item =~ s~<novyny news icon>~<img src="$imagesdir/$icon.gif" alt="*" />~sig; #/
 		$item =~ s~<novyny news author>~$unick~sig;
 		$item =~ s~<novyny news start>~$startdate~sig;
 		$item =~ s~<novyny news replies>~$replieslink~sig;
@@ -165,7 +184,7 @@ sub Novyny {
 
 		my $display = $sidedisplay;
 		my $nyboardtopics = '';
-		fopen (BRD, "<$boardsdir/$board.txt");
+		fopen (*BRD, "<$boardsdir/$board.txt");
 		while (<BRD>) {
 			my ($tid, $topic, undef, undef, undef, $replies, undef, $icon, $status)
 					= split /\|/, $_;
@@ -181,7 +200,7 @@ sub Novyny {
 
 			last unless (--$display);
 		}
-		fclose (BRD);
+		fclose (*BRD);
 
 		my ($boardname, undef) = split /\|/, $board{$board};
 
@@ -197,9 +216,9 @@ sub Novyny {
 
 	my $nyimages = '';
 
-	fopen (ATT, "<$vardir/attachments.txt");
+	fopen (*ATT, "<$vardir/attachments.txt");
 	my @images = (sort {(split /\|/, $b)[6] <=> (split /\|/, $a)[6]} grep /\.(gif|jpg|jpeg|png)$/i, <ATT>)[0..$sideimages-1];
-	fclose (ATT);
+	fclose (*ATT);
 	chomp @images;
 
 	foreach (@images) {
@@ -223,14 +242,14 @@ sub Novyny {
 	my $pollnum  = substr ($poll, 0, length ($poll) - 5);
 	my $hasvoted = 0;
 
-	fopen (POLL, "<$datadir/$poll");
+	fopen (*POLL, "<$datadir/$poll");
 	my ($question, $locked, undef, undef, undef, undef, $guestvote, undef, $multivote, undef, undef, $comment, undef)
 				= split /\|/, <POLL>;
 
 	if ($locked || ($iamguest && !$guestvote)) {
 		$hasvoted = 1;
 	} else {
-		fopen (POLLED, "<$datadir/$pollnum.polled");
+		fopen (*POLLED, "<$datadir/$pollnum.polled");
 		while (<POLLED>) {
 			my ($ip, $uname, undef) = split /\|/, $_;
 			if (($ip eq $user_ip && $iamguest) || (!$iamguest && lc $uname eq lc $username)) {
@@ -238,7 +257,7 @@ sub Novyny {
 				last;
 			}
 		}
-		fclose (POLLED);
+		fclose (*POLLED);
 	}
 
 	my $nypollopts = '';
@@ -256,7 +275,7 @@ sub Novyny {
 
 			my $item = $novynypolloption;
 			$item =~ s~<novyny poll variant>~$variant~sig; 
-			$item =~ s~<novyny poll control>~<img src="$imagesdir/poll_left.gif" alt="[ " /><img src="$imagesdir/poll_middle.gif" height="12" width="$width" alt="$voted" /><img src="$imagesdir/poll_right.gif" alt=" ]" />~is;
+			$item =~ s~<novyny poll control>~<img src="$imagesdir/poll_left.gif" alt="[ " /><img src="$imagesdir/poll_middle.gif" height="12" width="$width" alt="$voted" /><img src="$imagesdir/poll_right.gif" alt=" ]" />~is; #"
 			$nypollopts .= $item;
 		}
 	} else {
@@ -270,9 +289,9 @@ sub Novyny {
 			my $item = $novynypolloption;
 			$item =~ s~<novyny poll variant>~$variant~sig; 
 			if ($multivote) {
-				$item =~ s~<novyny poll control>~<input type="checkbox" name="option$i" value="$i" />~is;
+				$item =~ s~<novyny poll control>~<input type="checkbox" name="option$i" value="$i" />~is; #/
 			} else {
-				$item =~ s~<novyny poll control>~<input type="radio" name="option" value="$i" />~is;
+				$item =~ s~<novyny poll control>~<input type="radio" name="option" value="$i" />~is; #/
 			}
 			$nypollopts .= $item;
 			$i++;
@@ -282,7 +301,7 @@ sub Novyny {
 			<input type="submit" value="$novyny_txt{'vote_butt'}" />
 		</form>~;
 	}
-	fclose (POLL);
+	fclose (*POLL);
 
 	$question  = qq~[url=$scripturl?num=$pollnum]$question\[/url\]~;
 	$question .= qq~ [i]$comment\[/i\]~ if ($comment ne '');
@@ -295,7 +314,7 @@ sub Novyny {
 	&ToChars ($nypoll);
 
 	## LOGIN ##
-	
+
 	my $nylogin = qq~<a href="$scripturl?action=logout">$img{'logout'}</a>~;
 	$nylogin = qq~<form action="$scripturl?action=login2" method="post">
 			<input type="text" name="username" maxlength="30" title="$novyny_txt{'logintip'}" />
@@ -307,11 +326,18 @@ sub Novyny {
 	
 	## FOOT ##
 
-	my $nyfoot = q~Unimplemented~;
+	my $nyfoot = q~
+	<a href="$scripturl?board=$newsboard;action=post;title=StartNewTopic">[Add news]</a>
+	<a href="yabb2rss?group=$newsboard">[RSS]</a>
+	<a href="yabb2rss?group=$newsboard&body=yes">[RSS/FULL]</a>
+	<!-- here go two js links to add sidebar, dunno how it works... -->
+	<a href='http://linux.org.ua/rss/linux.org.ua-short.rss.html' rel="sidebar">[Sidebar(Opera)]</a>
+	<a href='http://linux.org.ua/rss/linux.org.ua.rss.html' rel="sidebar">[Sidebar(Opera)/FULL]</a>
+	<a class="blind" href="http://www.tsua.net"><img style="border:0;width:88px;height:31px" src="/images/tsua.gif" alt="Hosted by TSUA" title="Hosted by TSUA" /></a>~;
 
 	## MAIN ##
 
-	our $yymain =  "<h1>Status: 184 Under ConstruKCtion</h1><br />$novyny_template";
+	our $yymain =  "<h1>Status: 184 Under Constructon</h1><br />$novyny_template";
 	$yymain =~ s/<novyny poll>/$nypoll/is;
 	$yymain =~ s/<novyny pages>/$nypages/isg;
 	$yymain =~ s/<novyny news>/$nynews/is;
@@ -324,14 +350,14 @@ sub Novyny {
 	if (-e "$forumstylesdir/$usestyle/novyny.css") {
 		our $yyinlinestyle = qq~
 <link rel="stylesheet" href="$forumstylesurl/$usestyle/novyny.css" type="text/css" />
-~;
+~; #/
 	} elsif (-e "$forumstylesdir/default/novyny.css") {
 		our $yyinlinestyle = qq~
 <link rel="stylesheet" href="$forumstylesurl/default/novyny.css" type="text/css" />
-~;
+~; #/
 	} else {
 		our $yyinlinestyle = qq~
-<!-- :( Here should be a css link, bu css cannot be found. -->
+<!-- :( Here should be a css link, but css cannot be found. -->
 ~;
 	}
 


Fri, 13 Mar 2009 15:03:24 +0200
Disable topicstarter feature
diff --git a/lib/yabb-2.1/Sources/Security.pl b/lib/yabb-2.1/Sources/Security.pl
index 32643f2..6e8ca3f 100644
--- a/lib/yabb-2.1/Sources/Security.pl
+++ b/lib/yabb-2.1/Sources/Security.pl
@@ -26,7 +26,7 @@ $scripturl = qq~$boardurl/YaBB.$yyext~;
 if ($INFO{'board'}  =~ m~/~) { ($INFO{'board'},  $INFO{'start'}) = split('/', $INFO{'board'}); }
 if ($INFO{'num'}    =~ m~/~) { ($INFO{'num'},    $INFO{'start'}) = split('/', $INFO{'num'}); }
 if ($INFO{'letter'} =~ m~/~) { ($INFO{'letter'}, $INFO{'start'}) = split('/', $INFO{'letter'}); }
-if ($INFO{'thread'} =~ m~/~) { ($INFO{'thread'}, $INFO{'start'}) = split('/', $INFO{'thread'}); }
+if ($INFO{'thread'} =~ m~/~) { ($INFO{'thread'}, $INFO{'start'}) = split('/', $INFO{'thread'}); } #'
 
 if (-d "$uploaddir") {
 	$fa_ok = 1;
@@ -258,6 +258,9 @@ sub CheckIcon {
 	}
 }
 
+## Checks whether access is granted to a given board
+## Second argument can be 1 - posting, 2 - replying, 3 - polls, 4 - attachments, 5 - board access
+## A: string (board), integer (what to check), string (permissions for board)
 sub AccessCheck {
 	my ($curboard, $checktype, $boardperms) = @_;
 
@@ -303,7 +306,8 @@ sub AccessCheck {
 		${$uid.$curboard}{'replyperms'} =~ s/\, /\,/g;
 		@allowed_groups = split(/\,/, ${$uid.$curboard}{'replyperms'});
 		if (${$uid.$curboard}{'replyperms'} eq "") { $access = "granted"; }
-		if ($replyperms == 1 && !$topicstart{$username}) { $access = "notgranted"; }
+#		if ($replyperms == 1 && !$topicstart{$username}) { $access = "notgranted"; }
+		if ($replyperms == 1) { $access = "notgranted"; }
 	} elsif ($checktype == 3) {    # Poll access check
 		${$uid.$curboard}{'pollperms'} =~ s/\, /\,/g;
 		@allowed_groups = split(/\,/, ${$uid.$curboard}{'pollperms'});
@@ -346,7 +350,7 @@ sub AccessCheck {
 				chomp $memberaddgroups;
 				if ($element eq $memberaddgroups) { $access = "granted"; last; }
 			}
-			if ($element eq $topicstart{$username}) { $access = "granted"; }
+#			if ($element eq $topicstart{$username}) { $access = "granted"; }
 			if ($element eq "Global Moderator" && ($iamadmin || $iamgmod)) { $access = "granted"; }
 			if ($element eq "Moderator" && ($iamadmin || $iamgmod || $boardmod)) { $access = "granted"; }
 			if ($access eq "granted") { last; }


Fri, 13 Mar 2009 22:23:29 +0200
Text capcha added
diff --git a/lib/yabb-2.1/Languages/Ukrainian/flood.lng b/lib/yabb-2.1/Languages/Ukrainian/flood.lng
deleted file mode 100644
index 87be435..dd1deb4
--- a/lib/yabb-2.1/Languages/Ukrainian/flood.lng
+++ /dev/null
@@ -1,56 +0,0 @@
-################################################################################
-###############################################################################
-## flood.lng (flooding security protection text definitions)                   #
-# flood.lng (flooding security protection text definitions)                   #
-################################################################################
-###############################################################################
-## YaBB: Yet another Bulletin Board                                            #
-# YaBB: Yet another Bulletin Board                                            #
-## Open-Source Community Software for Webmasters                               #
-# Open-Source Community Software for Webmasters                               #
-## Version:        YaBB 2 RC 3                                                 #
-# Version:        YaBB 2 RC 3                                                 #
-## Released:       June 20, 2005                                               #
-# Released:       June 20, 2005                                               #
-## Distributed by: http://www.yabbforum.com                                    #
-# Distributed by: http://www.yabbforum.com                                    #
-## =========================================================================== #
-# =========================================================================== #
-## Copyright (c) 2000-2005 YaBB (www.yabbforum.com) - All Rights Reserved.     #
-# Copyright (c) 2000-2005 YaBB (www.yabbforum.com) - All Rights Reserved.     #
-## Software by: The YaBB Development Team                                      #
-# Software by: The YaBB Development Team                                      #
-##              with assistance from the YaBB community.                       #
-#              with assistance from the YaBB community.                       #
-## Sponsored by: Xnull Internet Media, Inc. - http://www.ximinc.com            #
-# Sponsored by: Xnull Internet Media, Inc. - http://www.ximinc.com            #
-##               Your source for web hosting, web design, and domains.         #
-#               Your source for web hosting, web design, and domains.         #
-################################################################################
-###############################################################################
-#
-
-#%floodtxt=(
-%floodtxt=(
-#'1' => "Your Verification Code is",
-'1' => "Your Verification Code is",
-#'2' => "Activate Automatic Flood Security",
-'2' => "Activate Automatic Flood Security",
-#'3' => "Verification Code",
-'3' => "Verification Code",
-#'4' => "Verification Code is wrong",
-'4' => "Verification Code is wrong",
-#'5' => "Max messages returned on recent posts by user<br /> <span class=\"small\">-1 will disable this option</span>",
-'5' => "Max messages returned on recent posts by user<br /> <span class=\"small\">-1 will disable this option</span>",
-#'6' => "Max messages returned on a search<br /> <span class=\"small\">-1 will disable this option</span>",
-'6' => "Max messages returned on a search<br /> <span class=\"small\">-1 will disable this option</span>",
-#'7' => "The requested number of results is higher then the maximum number allowed by the system",
-'7' => "The requested number of results is higher then the maximum number allowed by the system",
-#'8' => "The search option has been disabled"
-'8' => "The search option has been disabled"
-#);
-);
-#
-
-#1;
-1;
\ No newline at end of file
diff --git a/lib/yabb-2.1/Languages/Ukrainian/flood.lng b/lib/yabb-2.1/Languages/Ukrainian/flood.lng
new file mode 120000
index 87be435..dd1deb4
--- /dev/null
+++ b/lib/yabb-2.1/Languages/Ukrainian/flood.lng
@@ -0,0 +1 @@
+../Ukrainian_isb/flood.lng
\ No newline at end of file
diff --git a/lib/yabb-2.1/Sources/Decoder.pl b/lib/yabb-2.1/Sources/Decoder.pl
index abef183..691ba85 100644
--- a/lib/yabb-2.1/Sources/Decoder.pl
+++ b/lib/yabb-2.1/Sources/Decoder.pl
@@ -31,6 +31,7 @@ our (%floodtxt);
 our ($yycharset, $scripturl);
 our ($codemaxchars);
 our $captcha_dict_file ||= "$vardir/wordlist.txt";
+our $captcha_text_file ||= "$vardir/qalist.txt";
 
 LoadLanguage ('flood');
 
@@ -156,6 +157,40 @@ sub checkcaptcha_dict {
 	return 1;
 }
 
+# TEXT CAPCHA
+
+sub newcaptcha_text {
+	my $maxwordlen = 20;
+	# No need for flock here.
+	open DICT, '<', $captcha_text_file or return undef;
+	my $size = (stat DICT)[7];
+	my $value;
+	do {
+		my $pos = (int (rand ($size - $maxwordlen)) - $maxwordlen);
+		seek DICT, $pos, 0;
+		<DICT>;
+		$value = <DICT>;
+		chomp $value;
+	} until ($value =~ /.+\|.+/);
+	close DICT;
+	$value = decode ('UTF-8', $value);
+	my ($question, $ansver) = split /\|/, $value;
+	write_captcha_log_entry ($ansver);
+	# XXX: how about tabindex?
+	# XXX: tohtml question?
+  	return "$floodtxt{'1'}:", $question,
+	       "$floodtxt{'3'}:", qq(<input type="text" maxlength="$maxwordlen" name="verification" id="verification" size="$maxwordlen" />);
+}
+
+sub checkcaptcha_text {
+	if (not checkcaptcha_log ($FORM{'verification'})) {
+		newcaptcha_text ();
+		return 0;
+	}
+	write_captcha_log_entry (undef);
+	return 1;
+}
+
 # URI CAPTCHA
 
 ## Generates session id and regdate.


Fri, 27 Mar 2009 21:23:00 +0200
diff --git a/lib/yabb-2.1/Sources/BanWithGroup.pl b/lib/yabb-2.1/Sources/BanWithGroup.pl
index e38d02f..8aea810 100644
--- a/lib/yabb-2.1/Sources/BanWithGroup.pl
+++ b/lib/yabb-2.1/Sources/BanWithGroup.pl
@@ -76,7 +76,7 @@ sub save_groups {
 ## Adds current user (admin or gmod) to group 'Safety Lock'
 sub safety_lock {
 
-	unless ( $iamadmin or $iamgmod ) {
+	unless ( $iamadmin or $iamgmod or $iammod ) {
 		fatal_error $bangroup_txt{'notallowed'};
 	}
 
@@ -154,8 +154,7 @@ sub ban_with_group {
 	FromChars ( $reason );
 	ToHTML    ( $reason );
 
-	unless ( ( ( $iamadmin or $iamgmod or $iammod ) and $sessionvalid )
-		 or $login eq $username ) {
+	unless ( ( $iamadmin or $iamgmod or $iammod ) and $sessionvalid ) {
 		fatal_error ( $bangroup_txt{'notallowed'} );
 	}
 
@@ -174,6 +173,10 @@ sub ban_with_group {
 	$termin .= $date;
 	$termin  = eval "int($termin)"; # XXX
 
+	if ( $termin > 4000000000 ) {
+		$termin = 4000000000; # XXX this value is determined by experiment...
+	}
+
 	my $mainbanid = group_gid ( 'Banned' );
 	if ( not defined $mainbanid ) {
 		fatal_error ( $bangroup_txt{'nogroup'} . 'Banned' );
diff --git a/lib/yabb-2.1/Sources/Load.pl b/lib/yabb-2.1/Sources/Load.pl
index 50c95a1..7749e1c 100644
--- a/lib/yabb-2.1/Sources/Load.pl
+++ b/lib/yabb-2.1/Sources/Load.pl
@@ -157,15 +157,18 @@ sub LoadUserSettings {
 			if ($iamadmin or $iamgmod) {
 				### FIXME: Kludge for right admin column show
 				$iammod = 0;
+			}
+			if ($iamadmin or $iamgmod or $iammod) {
 				### SAFETY LOCK ###
 				if ( ${$uid.$username}{'addgroups'} ) {
 					# FIXME: move to Subs.pl...
 					# FIXME: how to deal with usual moderators?
 					require "$sourcedir/BanWithGroup.pl" if not $loaded{'BanWithGroup.pl'};
 					my $lockgid = group_gid ( 'Safety Lock' );
-					if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+					if ( defined $lockgid and ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 						$iamadmin = 0;
 						$iamgmod  = 0;
+						$iammod   = 0;
 						$staff    = 0;
 					};
 				};
@@ -630,10 +633,8 @@ sub LoadMiniUser {
 		}
 	}
 
-	if ( not $is_banned and ( ( $staff and $sessionvalid == 1 ) or
-				  $user eq $username ) ) {
-
-		$addmembergroup{$user} .= qq~<a href="$scripturl?action=pbwg;username=$user">$maintxt{'banwithgroup'}</a><br />~;
+	if ( not $is_banned and $staff and $sessionvalid == 1 ) {
+		$addmembergroup{$user} .= qq~<a href="$scripturl?action=pbwg;username=$user">$maintxt{'banwithgroup'}</a><br />~; #/
 	}
 
 	$addmembergroup{$user} =~ s/<br \/>\Z//;
diff --git a/lib/yabb-2.1/Sources/Security.pl b/lib/yabb-2.1/Sources/Security.pl
index 6e8ca3f..f39847c 100644
--- a/lib/yabb-2.1/Sources/Security.pl
+++ b/lib/yabb-2.1/Sources/Security.pl
@@ -259,7 +259,7 @@ sub CheckIcon {
 }
 
 ## Checks whether access is granted to a given board
-## Second argument can be 1 - posting, 2 - replying, 3 - polls, 4 - attachments, 5 - board access
+## Second argument can be 1 - posting, 2 - replying, 3 - polls, 4 - attachments, anything other - board access
 ## A: string (board), integer (what to check), string (permissions for board)
 sub AccessCheck {
 	my ($curboard, $checktype, $boardperms) = @_;
diff --git a/lib/yabb-2.1/Sources/Subs.pl b/lib/yabb-2.1/Sources/Subs.pl
index d592655..915d1e4 100644
--- a/lib/yabb-2.1/Sources/Subs.pl
+++ b/lib/yabb-2.1/Sources/Subs.pl
@@ -247,13 +247,13 @@ sub template {
 	}
 
 	### SAFETY LOCK ###
-	if ( $iamadmin or $iamgmod ) {
+	if ( $iamadmin or $iamgmod or $iammod ) {
 		$yymenu .= qq~$menusep<a href="$scripturl?action=nbwg">$img{'bwgmessage'}</a>$menusep<a href="$scripturl?action=safetylock">$img{'safetylock'}</a>~;
 	} elsif ( ${$uid.$username}{'addgroups'} ) {
 		require "$sourcedir/BanWithGroup.pl"
 			if not $loaded{'BanWithGroup.pl'};
 		my $lockgid = group_gid ( 'Safety Lock' );
-		if ( ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
+		if ( defined $lockgid and ${$uid.$username}{'addgroups'} =~ /(^|,)$lockgid(,|$)/ ) {
 			$yymenu .= qq~$menusep<a href="$scripturl?action=bwglog">$img{'bwglog'}</a>$menusep<a href="$scripturl?action=safetyunlock">$img{'safetyunlock'}</a>~;
 		}
 	}
@@ -1925,7 +1925,8 @@ sub reg_banning {
 			}
 		} elsif ($dummy eq "U") {    # USERNAME BANNING
 			foreach my $namebanned (@banned) {
-				if (lc $namebanned eq lc $ban_user) {
+				my $rx = quotemeta $namebanned;
+				if ($ban_user =~ m/\b$rx\b/i) {
 					fopen(LOG, ">>$vardir/ban_log.txt");
 					print LOG "$ban_time|$namebanned ($user_ip)\n";
 					fclose(LOG);



Wed, 07 Oct 2009 00:26:00 +0300
Fix wrong thread status in thread list.
--- MessageIndex.pl~	2009-10-07 00:19:35 +0300
+++ MessageIndex.pl	2009-10-07 00:24:34 +0300
@@ -275,11 +275,11 @@
 	$countnosticky = 0;
 	if ($numanns) { push(@stickythreadlist, @anns); }
 	for ($i = 0; $i <= $threadcount; $i++) {
-		my @array        = split(/\|/, $threadlist[$i]);
-		my $threadstatus = pop(@array);                    #get only status
-		my $mnum         = shift(@array);                  # get only number
-		undef @array;
+		my ($mnum, $threadstatus) = (split /\|/, $threadslist[$i])[0,8];
+#		my @array        = split(/\|/, $threadlist[$i]);
+#		my $threadstatus = pop(@array);                    #get only status
+#		my $mnum         = shift(@array);                  # get only number
+#		undef @array;
 		if ($threadstatus =~ /s/i) {
 			unless(!$iamadmin && !$iamgmod && !$iammod && $threadstatus =~ /h/i) {
 				$stickythreadlist[$countsticky] = $threadlist[$i];


Fri, 09 Oct 2009 18:59:37 +0300
fix typo in previous patch
diff missing :(

Sat, 17 Oct 2009 22:55:14 +0300
yabb2rss now have maxlength parameter with default value of 350.
diff missing too.


Wed, 11 Nov 2009 22:54:36 +0200
Copied back missing css and js files for main page from directory 'obsolete'.
Dunno, who moved them there... :/



Mon, 23 Nov 2009 17:20:30 +0200
added temporary kludge
--- Post.pl~	2009-03-10 23:16:56 +0200
+++ Post.pl	2009-11-23 17:14:59 +0200
@@ -1476,6 +1476,13 @@
 				&fatal_error ($register_txt{473});
 			}
 		}
+		### FIXME -- remove this after spiritlert's pranks will be eliminated -- ###
+		if ($name =~ /^Re\.\s*$/) {
+			if ($email ne 're@re.re' or not $user_ip =~ /^9[145]\..*$/) {
+				$name .= ' (fake)';
+			}
+		}
+		### /FIXME ###
 #		$name .= "(Guest)";
 	}
 

Sat, 12 Dec 2009 19:23:19 +0200
--- linux.org.ua/lib/yabb-2.1/Sources/Subs.pl~	2009-03-27 21:14:46 +0200
+++ linux.org.ua/lib/yabb-2.1/Sources/Subs.pl	2009-12-12 19:22:23 +0200
@@ -322,15 +322,19 @@
 					$boardlist = $cat{$catid};
 					(@bdlist) = split(/\,/, $boardlist);
 					my ($catname, $catperms, $catallowcol) = split(/\|/, $catinfo{"$catid"});
-					my $access = &CatAccess($catperms);
-					if (!$access) { next; }
-					foreach $curboard (@bdlist) {
-						chomp $curboard;
-						$cat_boardcnt{$catid}++;
-						my ($boardname, $boardperms, $boardview) = split(/\|/, $board{"$curboard"});
-						my $access = &AccessCheck($curboard, '', $boardperms);
-						if (!$iamadmin && $access ne "granted") { next; }
-						$checklist .= qq~$curboard, ~;
+					# On early errors this may be called before Security.pl was loaded.
+					# Hack to not bail out with error.
+					if (defined &CatAccess) {
+						my $access = &CatAccess($catperms);
+						if (!$access) { next; }
+						foreach $curboard (@bdlist) {
+							chomp $curboard;
+							$cat_boardcnt{$catid}++;
+							my ($boardname, $boardperms, $boardview) = split(/\|/, $board{"$curboard"});
+							my $access = &AccessCheck($curboard, '', $boardperms);
+							if (!$iamadmin && $access ne "granted") { next; }
+							$checklist .= qq~$curboard, ~;
+						}
 					}
 				}
 				$checklist =~ s/, \Z//;


Sun, 03 Jan 2010 15:55:08 +0200
Add guid to rss item to (maybe) inform client, that edited items are the same.
--- linux.org.ua/cgi-bin/yabb/yabb2rss~	2009-10-17 22:54:45 +0300
+++ linux.org.ua/cgi-bin/yabb/yabb2rss	2010-01-03 15:54:34 +0200
@@ -200,6 +200,7 @@
 <item>
  <title>$subject</title>
  <link>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</link>
+ <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</guid>
  <description>$body</description>
 </item>
 ITEM
@@ -209,6 +210,7 @@
 <item>
  <title>$subject</title>
  <link>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</link>
+ <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</guid>
 </item>
 ITEM
   }

Change guid - remove useless action, add post number (to be sure)
--- linux.org.ua/cgi-bin/yabb/yabb2rss~	2010-01-03 15:54:34 +0200
+++ linux.org.ua/cgi-bin/yabb/yabb2rss	2010-01-03 15:58:39 +0200
@@ -200,7 +200,7 @@
 <item>
  <title>$subject</title>
  <link>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</link>
- <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</guid>
+ <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;num=$ctime/0</guid>
  <description>$body</description>
 </item>
 ITEM
@@ -210,7 +210,7 @@
 <item>
  <title>$subject</title>
  <link>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</link>
- <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;action=display;num=$ctime</guid>
+ <guid>http://linux.org.ua/cgi-bin/yabb/YaBB.pl?board=$group;num=$ctime</guid>
 </item>
 ITEM
   }



Mon, 22 Feb 2010 11:26:13 +0200
Escape & in rss thread header
--- linux.org.ua/cgi-bin/yabb/yabb2rss~	2010-02-22 11:25:46 +0200
+++ linux.org.ua/cgi-bin/yabb/yabb2rss 	2010-01-03 15:59:48 +0200
@@ -155,7 +155,7 @@
     $subject=$converter->convert($subject);
   }
 
+  $subject =~ s/&/\&amp;/ig; 
-#  $subject =~ s/&/\&amp;/ig; 
   $subject =~ s/\[ch(\d{3,})\]/&#$1;/sig;
   $subject =~ s/&nbsp;/\&#160;/ig;
  



